create proc dbo.sqlBackup (
 @method varchar(50) = 'backup',
 @brwid int = null,
 @areYouSure varchar(5) = 'NO',
 @useSqlCompression varchar(5) = null,
 @filesBlob varchar(max) = null output
) as 
begin
 set nocount on

 declare
  @backupFile varchar(max),
  @sql varchar(max),
  @database varchar(50) = db_name()

 declare
  @jobId BINARY(16),
  @jobName nvarchar(1000) = 'ktsBackup',
  @jobSQL nvarchar(1000) = 'exec dbo.sqlBackup @method = ''backup''',
--  @dbName nvarchar(1000) = db_name(),
--  @serverName nvarchar(1000) = @@servername,
  @jobStatus int

 set @useSqlCompression = coalesce(@useSqlCompression,dbo.settingsF('site.sqlCompression','TRUE'))

-- just a one time backup
 if @method = 'backup'
 begin
  select @backupFile = path from dbo.paths() where name = 'backup'

  select @sql = 'backup database ' + db_name() + ' to disk=''' + @backupFile + ''' with retaindays=0, INIT'
   + case when @useSqlCompression = 'TRUE' then ', compression' else '' end
  exec dbo.logit @@procid, @sql
  exec(@sql)

  return
 end

 if @method in ('destroy') and @brwid is not null
 begin
  declare
   @pathAndFileName varchar(max),
   @cmd varchar(8000),
   @cmdOutput varchar(8000)
   select @pathAndFileName = pathAndFileName From dbo.sqlBackupBRW() where brwid = @brwid
   if @areYouSure = 'NO'
   begin
    select '@code=2;@message=Are you sure you want to destroy|' + @pathAndFileName + ' ?;'
    return
   end
   if @areYouSure = 'YES'
   begin
    set @cmd = 'del ' + @pathAndFileName
    exec @cmdOutput = master..xp_cmdshell @cmd, no_output
    exec dbo.logit @@procid, '@cmdOutput', @cmdOutput
   end

   return
 end

 if @method in ('show')
 begin
  declare
   @backupFolder varchar(max)
   select @backupFolder = path From dbo.paths() where name = 'backupPath'
   select * from dbo.dirFiles(@backupFolder,@database+'_%')
   return
 end


/*
 if @method = 'toggle'
 begin

 If not exists(select * from msdb..sysJobs where name = 'apiJob_' + @resource)
   exec dbo.apiJobs @resource

  select
   @jobStatus = case when enabled = 0 then 1 else 0 end,
   @jobId = job_id
  from msdb..sysJobs where name = 'apiJob_' + @resource
  exec msdb..sp_update_job @job_id = @jobId, @enabled = @jobStatus
  exec dbo.logit @@procid, '@resource', @resource, '@method', @method, '@jobStatus', @jobStatus
 end

-- create the backup job
 if @method = 'create' 
 begin
 --Add job
  exec msdb.dbo.sp_add_job
   @job_name = @jobName, 
   @job_id = @jobId OUTPUT
 
 --Add step to job
  exec msdb.dbo.sp_add_jobstep
   @job_id = @jobId,
   @step_name = N'Do SQL Stuff', 
   @step_id = 1, 
   @subsystem = N'TSQL', 
   @command = @jobSQL, 
   @database_name = @dbName, 
   @flags=0
 
 --Add schedule to job
  exec msdb.dbo.sp_add_jobschedule
   @job_id = @jobId,
   @name = N'Every few minutes', 
   @freq_type=4, 
   @freq_interval=1, 
   @freq_subday_type = 0x4, 
   @freq_subday_interval=2, 
 --  @freq_relative_interval=0, 
 --  @freq_recurrence_factor=1, 
   @active_start_date=20100302, 
   @active_end_date=99991231 
--   @active_start_time=60000, 
--   @active_end_time=190000
 
  exec msdb.dbo.sp_add_jobserver
   @job_id = @jobId, 
   @server_name = @serverName
 end
*/ 


end