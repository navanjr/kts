create proc dbo.conversion_mikeVouchersOutstanding(
 @mode varchar(50) = 'conversion',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as 
begin
 set nocount on

 if @mode != 'conversion'
  return


/*
set @sql = 'select dptno,vchno+'',''+vchdate+'',''+paywhom+'',''+cast(vchamt as varchar)+'',''comment FROM openrowset(''VFPOLEDB'',''' + @mikePath
 + ''';'''';'''',''select * from ovoureg where !deleted() and pcdate = " " and vchamt != 0.00'')  order by dptno,vchno'

--vchno,vchdate,paywhom,vchamt,dptno + '' - '' + comment
*/

 declare @st table(
  dptno varchar(50),
  officialAccountCode varchar(50),
  vchno varchar(50),
  vchdate varchar(50),
  paywhom varchar(50),
  vchamt money,
  comment varchar(1000),
  ktsPaymentId int,
  ktsAmount money,
  csv varchar(max),
  ord varchar(50)
 )

 declare
  @mikeTableName varchar(50) = 'ovoureg',
  @mikePath varchar(max),
  @sql nvarchar(max)

 select
  @mikePath = dbo.settingsF('conversion.mikepath','') + '\' + @mikeTableName + '.dbf',
  @sql = 'select dptno,null,vchno,vchdate,paywhom,vchamt,comment,null,null,null,null from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT * FROM ' + @mikeTableName + ' where pcdate = " " and vchamt != 0.00 and !deleted()'') order by dptno, vchno'

 insert @st exec(@sql)

 update a set a.officialAccountCode = b.officialDepositAccountcode
 from @st a, dbo.officers b
 where a.dptno = b.departmentNumber
 
 update a set a.ktsPaymentId = b.id, a.ktsAmount = b.amount
 from @st a, dbo.payments b
 where a.officialAccountCode = b.debitAccountCode 
  and cast(a.vchno as int) = cast(b.clerksNumber as int)

 update @st set
  ord = officialAccountCode + 'b',
  csv = ltrim(rtrim(vchno)) + ',' + vchdate + ',' + ltrim(rtrim(paywhom)) + ',' + cast(vchamt as varchar) + ',' + ltrim(rtrim(comment))
 insert @st (ord,csv) select officialAccountCode + 'a','officialAccountCode: '+officialAccountCode from @st group by officialAccountCode
 insert @st (ord,csv) select officialAccountCode,'' from @st where officialAccountCode is not null group by officialAccountCode

 if @method = 'GET'
 begin  
  select 
   @class = 'conversion',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = COUNT(*),  
   @message = 'Outstanding Vouchers not found in KTS'
  from @st
  where ktsPaymentId is null
 end

 if @method = 'SHOW'
 begin  

  select * 
  from @st
--  where kpofund not in (select clerksFundCode from dbo.clerksFundList)
  order by ord

 end

 if @method = 'FIX'
 begin
-- let's paste the csv in the importer for them...
  declare @objId int
  select top 1 @objId = id from object where typ=4770 and lasteditini = dbo.settingsF('conversion.initials','')

  if @objId is null
   exec dbo.logit @@procid, 'No Importer record exists for initials:'
--  select vchno, vchdate, paywhom, vchamt, comment
--  exec dbo.logit @@procid, 'just inserted clerks funds into object typ 4704 @@rowCount', @@rowCount
  
  return

 end

end





