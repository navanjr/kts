create function dbo.dailyledgerdata(@date varchar(50))
 returns @rt table(
 accountCode varchar(50),
 accountDesc varchar(50),
 beginbalance money,
 paid money,
 tranout money,
 tranin money,
 deposits money,
 endbalance money,
 accountType varchar(50),
 reportOrder varchar(50)
)
as 
begin 
declare @wt table(accountCode varchar(50), accountDesc varchar(50), beginbalance money, paid money, tranout money, tranin money, deposits money, endbalance money, accountType varchar(50))

declare @wt2 table(accountCode varchar(50), accountDesc varchar(50), beginbalance money, paid money, tranout money, tranin money, deposits money, endbalance money, accountType varchar(50))

insert @wt (accountCode, accountDesc, beginbalance, accountType)
select accountCode, accountDesc,sum(amount) as amount, accountType from dbo.glDetailReports 
where sourceDate<@date 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, paid, accountType)
select accountCode, accountDesc,sum(amount) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and sourceType in ('4771') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, deposits, accountType)
select accountCode, accountDesc,sum(amount) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and sourceType in ('4502','4513','4522') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, tranout, accountType)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, tranin, accountType)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, tranin, accountType)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, tranout, accountType)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType from dbo.glDetailReports 
where sourceDate=@date 
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
group by accountCode, accountDesc, accountType

insert @wt (accountCode, accountDesc, endbalance, accountType)
select accountCode, accountDesc,sum(amount) as amount, accountType from dbo.glDetailReports 
where sourceDate<=@date 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by accountCode, accountDesc, accountType


insert @wt2
select accountCode, accountDesc, sum(beginbalance), sum(paid), sum(tranout), sum(tranin), sum(deposits), sum(endbalance), accountType from @wt
 group by accountCode, accountDesc, accountType
 
update @wt2 set beginbalance=beginbalance*-1, deposits=deposits*-1, endbalance=endbalance*-1 where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
update @wt2 set paid=paid*-1 where accountType in (select accountType from dbo.glBankFundTypes('BANK'))

declare @currentTaxYear varchar(4),
        @priorTaxYear varchar(4)

select @currentTaxYear = left(max(accountCode),4) from @wt2 where right(accountCode,9)='ADVALOREM'
select @priorTaxYear = cast(cast(@currentTaxYear as int)-1 as varchar(4))


update @wt2 set accountType='BACK TAX' where right(accountCode,9)='ADVALOREM' and left(accountCode,4) < @priorTaxYear

insert @rt
 select *,'' from @wt2 where accountType in ('BANK','FUND')

insert @rt
select accountType, accountType+case when accountType <> 'BACK TAX' then 'S' else '' end, sum(beginbalance), sum(paid), sum(tranout), sum(tranin), sum(deposits), sum(endbalance), accountType,'' from @wt2
 where accountType in (select accountType from dbo.glBankFundTypes('BOTH') union select 'BACK TAX') and accountType not in ('BANK','FUND')
 group by accountType

update @rt set accountDesc = 'PENDING DEPOSITS' where accountType = 'SUSPENSE'
update @rt set accountType='BANK' where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
update @rt set accountType='FUND' where accountType in (select accountType from dbo.glBankFundTypes('FUND') union select 'BACK TAX')
update r set reportOrder = a.reportOrder from @rt r, glaccounts a where r.accountCode=a.accountCode
update r set reportOrder = a.reportOrder from @rt r, (select max(reportOrder) as reportOrder,accountType as accountCode from glaccounts group by accountType) a where r.accountCode=a.accountCode
return
end