create function dbo.dailyledgerdata(@beginDate varchar(50),@endDate varchar(50),@showDetail varchar(20))
 returns @rt table(
 accountCode varchar(50),
 accountDesc varchar(50),
 beginbalance money,
 paid money,
 appout money,
 appin money,
 specappout money,
 specappin money,
 tranout money,
 tranin money,
 fundtranout money,
 fundtranin money,
 deposits money,
 elecdeposits money,
 endbalance money,
 accountType varchar(50),
 ledgerGroup varchar(50),
 financialReportGroup varchar(50),
 reportOrder varchar(50),
 origin int,
 chartnumber varchar(60)
)
as 
begin 
declare @wt table(
 accountCode varchar(50),
 accountDesc varchar(50),
 beginbalance money,
 paid money,
 appout money,
 appin money,
 specappout money,
 specappin money,
 tranout money,
 tranin money,
 fundtranout money,
 fundtranin money,
 deposits money,
 elecdeposits money,
 endbalance money,
 accountType varchar(50),
 ledgerGroup varchar(50),
 reportOrder varchar(50),
 origin int
)

declare @wtwork table(
 accountCode varchar(50),
 accountDesc varchar(50),
 amount money,
 debit money,
 credit money,
 accountType varchar(50),
 ledgerGroup varchar(50),
 reportOrder varchar(50),
 sourceType varchar(50),
 sourcea18 varchar(50),
 comment varchar(250),
 apportionContraCode varchar(60),
 sourcekey3 varchar(60)
)

declare @wt2 table(
 accountCode varchar(50),
 accountDesc varchar(50),
 beginbalance money,
 paid money,
 appout money,
 appin money,
 specappout money,
 specappin money,
 tranout money,
 tranin money,
 fundtranout money,
 fundtranin money,
 deposits money,
 elecdeposits money,
 endbalance money,
 accountType varchar(50),
 ledgerGroup varchar(50),
 blank1 varchar(50),
 reportOrder varchar(50),
 origin int
)

insert @wt (accountCode, accountDesc, beginbalance, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 1 from dbo.glDetailReports 
where sourceDate<@beginDate 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, beginbalance, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,0 as amount, accountType, ledgerGroup, reportOrder, 2 from dbo.glaccounts 
where accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
 and accountcode not in (select accountcode from @wt)
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wtwork (accountCode, accountDesc, amount, debit, credit, accountType, ledgerGroup, reportOrder,sourceType, sourcea18, comment,
apportionContraCode, sourcekey3)
select accountCode, accountDesc,amount,case when amount > 0 then amount else 0 end,case when amount < 0 then abs(amount) else 0 end, 
  accountType, ledgerGroup, reportOrder,sourceType, sourcea18, comment, apportionContraCode, sourcekey3
 from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate 
 and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))

insert @wt (accountCode, accountDesc, paid, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 3 from @wtwork 
where accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and sourceType in ('4771') 
and left(sourcea18,4) not in ('CANC','VOID','STOP','TRAN')
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 4 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('CANC','VOID','STOP')
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount)*-1 as amount, accountType, ledgerGroup, reportOrder, 5 from @wtwork 
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('CANC','VOID','STOP')
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 6 from @wtwork 
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('TRAN')
and amount > 0.00
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount)*-1 as amount, accountType, ledgerGroup, reportOrder, 7 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('TRAN')
and amount < 0.00
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, deposits, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 8 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and (sourceType in ('4502','4513','4522') or (sourceType='4512' and sourcea18='Miscellaneous Deposit'))
and isnull(comment,'') not in (select key1 from object where typ=4505 and a2 in ('E','C','B'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, elecdeposits, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 9 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and (sourceType in ('4502','4513','4522') or (sourceType='4512' and sourcea18='Miscellaneous Deposit'))
and isnull(comment,'') in (select key1 from object where typ=4505 and a2 in ('E','C','B'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup, reportOrder, 10 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup, reportOrder, 11 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, fundtranout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup, reportOrder, 12 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType = '4512'
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, fundtranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup, reportOrder, 13 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType = '4512'
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, appout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 15 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512'
and sourcea18 = 'APPORTIONMENT'
and (case when isnull(apportionContraCode,'')='' then left(accountdesc,len(sourceKey3)) else 'NULL' end=sourceKey3 or isnull(apportionContraCode,'NULL')=accountcode)
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, appin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount*-1) as amount, accountType, ledgerGroup, reportOrder, 16 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512'
and sourcea18 = 'APPORTIONMENT'
and (case when isnull(apportionContraCode,'')='' then left(accountdesc,len(sourceKey3)) else 'NULL' end<>sourceKey3 and isnull(apportionContraCode,'NULL')<>accountcode)
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, specappout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup, reportOrder, 18 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and left(sourcea18,13) = 'APPORTIONMENT'
and sourcea18 <> 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))=sourceKey3 or isnull(apportionContraCode,'NULL')=accountcode)
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, specappin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(amount*-1) as amount, accountType, ledgerGroup, reportOrder, 19 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and left(sourcea18,13) = 'APPORTIONMENT'
and sourcea18 <> 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))<>sourceKey3 and isnull(apportionContraCode,'NULL')<>accountcode)
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

--End Apportionment

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup, reportOrder, 20 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and left(sourcea18,13) = 'APPORTIONMENT')
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup, reportOrder, 21 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and left(sourcea18,13) = 'APPORTIONMENT')
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, fundtranin, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup, reportOrder, 22 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512' 
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, fundtranout, accountType, ledgerGroup, reportOrder, origin)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup, reportOrder, 23 from @wtwork
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512' 
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder

insert @wt (accountCode, accountDesc, endbalance, accountType, ledgerGroup, reportOrder, origin)
select a.accountCode, a.accountDesc, 
       isnull(w.beginbalance,0) + isnull((select sum(ww.amount) from @wtwork ww where ww.accountcode = a.accountcode),0) as amount, 
       a.accountType, a.ledgerGroup, a.reportOrder, 24 
 from glaccounts a
  LEFT JOIN @wt as w ON w.accountcode = a.accountcode and w.beginbalance <> 0.00
where a.accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by a.accountCode, a.accountDesc, a.accountType, a.ledgerGroup, a.reportOrder, w.beginbalance


if @showdetail = 'FINANCIAL'
begin
 delete from @wt where accountcode in (select accountcode from glaccounts where financialGroup='X')
 set @showdetail = 'FALSE'
end

insert @wt2
select accountCode, accountDesc, sum(isnull(beginbalance,0)), sum(isnull(paid,0)), sum(isnull(appout,0)), sum(isnull(appin,0)), sum(isnull(specappout,0)), sum(isnull(specappin,0)), sum(isnull(tranout,0)), sum(isnull(tranin,0)), sum(isnull(fundtranout,0)), sum(isnull(fundtranin,0)), sum(isnull(deposits,0)), sum(isnull(elecdeposits,0)), sum(isnull(endbalance,0)), accountType, ledgerGroup,'',reportOrder, max(origin) from @wt
 group by accountCode, accountDesc, accountType, ledgerGroup, reportOrder
 
update @wt2 set
 beginbalance=beginbalance*-1,
 deposits=deposits*-1,
 elecdeposits=elecdeposits*-1,
 endbalance=endbalance*-1
where accountType in (select accountType from dbo.glBankFundTypes('FUND'))

update @wt2 set
 paid=paid*-1 
where accountType in (select accountType from dbo.glBankFundTypes('BANK'))

if @showDetail <> 'TRUE'
begin

-- Grouping begins
declare @currentTaxYear varchar(4),
        @priorTaxYear varchar(4),
        @detailBackTax varchar(5)

select @detailBackTax = settingValue from settings where settingname='site.dailyLedgerDetailBackTax'

if @detailBackTax <> 'TRUE'
-- rename all the back tax lines the same 
begin
 update @wt2 set accountType = 'BACK TAX' 
  where right(accountCode,9) = 'ADVALOREM' and left(accountCode,4) in (select year from dbo.taxyears(@endDate) where yearCode = 'Back')
end

-- why are we inserting into @rt twice?
insert @rt
 select *, '' from @wt2 where accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType <>'SUSPENSE' union select 'FUND')
  and ledgerGroup <= ' 0'

 insert @rt
 select 
  ledgerGroup,
  ledgerGroup,
  sum(beginbalance), sum(paid), sum(appout), sum(appin), sum(specappout), sum(specappin),
  sum(tranout), sum(tranin), sum(fundtranout), sum(fundtranin), sum(deposits), sum(elecdeposits),
  sum(endbalance), accounttype, ledgerGroup,
  '',min(case when reportOrder > '  0' then reportOrder else 'zzzzz' end), 2, ''  -- maybe this will be useful 
 from @wt2
 where accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType <>'SUSPENSE' union select 'FUND')
  and ledgerGroup > ' 0' group by accountType, ledgerGroup

 insert @rt
 select 
  case when isnull(ledgerGroup,'')>'0' then ledgerGroup else accounttype end,
  case when accountType = 'CITY' then 'CITIES' else accountType + case when accountType <> 'BACK TAX' then 'S' else '' end end + ' ' + rtrim(ledgerGroup),
  sum(beginbalance), sum(paid), sum(appout), sum(appin), sum(specappout), sum(specappin),
  sum(tranout), sum(tranin), sum(fundtranout), sum(fundtranin), sum(deposits), sum(elecdeposits),
  sum(endbalance), accountType, ledgerGroup,
  '',min(case when reportOrder > '  0' then reportOrder else 'xxxxx' end), 2, ''  -- maybe this will be useful 
 from @wt2
 where accountType in (select accountType from dbo.glBankFundTypes('BOTH') union select 'BACK TAX')
  and accountType not in (select accountType from dbo.glBankFundTypes('BANK') where accountType <>'SUSPENSE' union select 'FUND')
 group by accountType, ledgerGroup
 update @rt set accountDesc = 'PENDING DEPOSITS' where accountType = 'SUSPENSE'
 update @rt set accountType='BANK' where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
 update @rt set accountType='FUND' where accountType in (select accountType from dbo.glBankFundTypes('FUND') union select 'BACK TAX')


end
else
begin
insert @rt
 select *, '' from @wt2 where accountType in (select accountType from dbo.glBankFundTypes('BOTH') where accounttype <> 'SUSPENSE')

 insert @rt
 select 
  case when isnull(ledgerGroup,'')>'0' then ledgerGroup else accounttype end,
  case when accountType = 'CITY' then 'CITIES' else accountType + case when accountType <> 'BACK TAX' then 'S' else '' end end + ' ' + rtrim(ledgerGroup),
  sum(beginbalance), sum(paid), sum(appout), sum(appin), sum(specappout), sum(specappin),
  sum(tranout), sum(tranin), sum(fundtranout), sum(fundtranin), sum(deposits), sum(elecdeposits),
  sum(endbalance), accountType, ledgerGroup,
  '',min(case when reportOrder > '  0' then reportOrder else 'xxxxx' end), 2, ''  -- maybe this will be useful 
 from @wt2
 where accountType = 'SUSPENSE'
 group by accountType, ledgerGroup
 update @rt set accountDesc = 'PENDING DEPOSITS' where accountType = 'SUSPENSE'
 update @rt set ledgerGroup = accountType where ledgerGroup < ' 0' and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
 update @rt set accountType='BANK' where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
 update @rt set accountType='FUND' where accountType in (select accountType from dbo.glBankFundTypes('FUND') union select 'BACK TAX')

end


update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end,
  chartnumber = a.chartnumber 
 from @rt r, glaccounts a where r.accountcode=a.accountcode

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, (select max(financialGroup) as financialGroup,accountType as accountCode, ledgerGroup from glaccounts where accountcode in (select distinct accountcode from @wt) group by    accountType, ledgerGroup) a where r.accountCode=a.accountCode and (r.ledgerGroup < ' 0') and r.accountType='FUND'

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, (select max(financialGroup) as financialGroup,'Back Tax' as accountCode from glaccounts where right(accountcode,9)='ADVALOREM') a where r.accountCode=a.accountCode and (r.ledgerGroup < ' 0') and r.accountType='FUND'

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, glaccounts a where r.ledgerGroup=a.ledgerGroup and r.ledgerGroup>' 0' and a.accountcode in (select distinct accountcode from @wt)

return
end