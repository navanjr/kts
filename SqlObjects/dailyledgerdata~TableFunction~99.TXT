create function dbo.dailyledgerdata(@beginDate varchar(50),@endDate varchar(50))
 returns @rt table(
 accountCode varchar(50),
 accountDesc varchar(50),
 beginbalance money,
 paid money,
 appout money,
 appin money,
 specappout money,
 specappin money,
 tranout money,
 tranin money,
 fundtranout money,
 fundtranin money,
 deposits money,
 elecdeposits money,
 endbalance money,
 accountType varchar(50),
 ledgerGroup varchar(50),
 financialReportGroup varchar(50),
 reportOrder varchar(50)
)
as 
begin 
declare @wt table(accountCode varchar(50), accountDesc varchar(50), beginbalance money, paid money, appout money, appin money, specappout money, specappin money, tranout money, tranin money, fundtranout money, fundtranin money, deposits money, elecdeposits money, endbalance money, accountType varchar(50), ledgerGroup varchar(50))

declare @wt2 table(accountCode varchar(50), accountDesc varchar(50), beginbalance money, paid money, appout money, appin money, specappout money, specappin money, tranout money, tranin money, fundtranout money, fundtranin money, deposits money, elecdeposits money, endbalance money, accountType varchar(50), ledgerGroup varchar(50))

insert @wt (accountCode, accountDesc, beginbalance, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate<@beginDate 
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, beginbalance, accountType, ledgerGroup)
select accountCode, accountDesc,0 as amount, accountType, ledgerGroup from dbo.glaccounts 
where accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
 and accountcode not in (select accountcode from @wt)
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, paid, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and sourceType in ('4771') 
and left(sourcea18,4) not in ('CANC','VOID','STOP','TRAN')
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('CANC','VOID','STOP')
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount)*-1 as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('CANC','VOID','STOP')
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('TRAN')
and amount > 0.00
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount)*-1 as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType in ('4771') 
and left(sourcea18,4) in ('TRAN')
and amount < 0.00
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, deposits, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and (sourceType in ('4502','4513','4522') or (sourceType='4512' and sourcea18='Miscellaneous Deposit'))
and isnull(comment,'') not in (select key1 from object where typ=4505 and a2 in ('E','C'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, elecdeposits, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
and (sourceType in ('4502','4513','4522') or (sourceType='4512' and sourcea18='Miscellaneous Deposit'))
and isnull(comment,'') in (select key1 from object where typ=4505 and a2 in ('E','C'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, fundtranout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType = '4512'
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, fundtranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BANK'))
and sourceType = '4512'
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup

--Apportionment - Month End

insert @wt (accountCode, accountDesc, appin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512'
and sourcea18 = 'APPORTIONMENT'
and amount < 0
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, appout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and sourcea18 = 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))=sourceKey3 or isnull(apportionContraCode,'NULL')=accountcode)
and amount > 0
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, appin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)*-1) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and sourcea18 = 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))<>sourceKey3 and isnull(apportionContraCode,'NULL')<>accountcode)
and amount > 0
group by accountCode, accountDesc, accountType, ledgerGroup

--Apportionment - Special

insert @wt (accountCode, accountDesc, specappin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512'
and left(sourcea18,13) = 'APPORTIONMENT'
and sourcea18 <> 'APPORTIONMENT'
and amount < 0
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, specappout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and left(sourcea18,13) = 'APPORTIONMENT'
and sourcea18 <> 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))=sourceKey3 or isnull(apportionContraCode,'NULL')=accountcode)
and amount > 0
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, specappin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)*-1) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and sourceType ='4512'
and left(sourcea18,13) = 'APPORTIONMENT'
and sourcea18 <> 'APPORTIONMENT'
and (left(accountdesc,len(sourceKey3))<>sourceKey3 and isnull(apportionContraCode,'NULL')<>accountcode)
and amount > 0
group by accountCode, accountDesc, accountType, ledgerGroup

--End Apportionment


insert @wt (accountCode, accountDesc, tranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and left(sourcea18,13) = 'APPORTIONMENT')
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, tranout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType not in ('4502','4513','4522','4771') 
and not (sourceType='4512' and left(sourcea18,13) = 'APPORTIONMENT')
and not (sourceType='4512' and sourcea18 in ('Miscellaneous Deposit','TRANSFER'))
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, fundtranin, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(credit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512' 
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, fundtranout, accountType, ledgerGroup)
select accountCode, accountDesc,sum(cast(debit as money)) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate>=@beginDate and sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('FUND'))
and sourceType ='4512' 
and sourcea18 = 'TRANSFER'
group by accountCode, accountDesc, accountType, ledgerGroup

insert @wt (accountCode, accountDesc, endbalance, accountType, ledgerGroup)
select accountCode, accountDesc,sum(amount) as amount, accountType, ledgerGroup from dbo.glDetailReports 
where sourceDate<=@endDate
and accountType in (select accountType from dbo.glBankFundTypes('BOTH'))
group by accountCode, accountDesc, accountType, ledgerGroup


insert @wt2
select accountCode, accountDesc, sum(isnull(beginbalance,0)), sum(isnull(paid,0)), sum(isnull(appout,0)), sum(isnull(appin,0)), sum(isnull(specappout,0)), sum(isnull(specappin,0)), sum(isnull(tranout,0)), sum(isnull(tranin,0)), sum(isnull(fundtranout,0)), sum(isnull(fundtranin,0)), sum(isnull(deposits,0)), sum(isnull(elecdeposits,0)), sum(isnull(endbalance,0)), accountType, ledgerGroup from @wt
 group by accountCode, accountDesc, accountType, ledgerGroup
 
update @wt2 set beginbalance=beginbalance*-1, deposits=deposits*-1, elecdeposits=elecdeposits*-1, endbalance=endbalance*-1 where accountType in (select accountType from dbo.glBankFundTypes('FUND'))
update @wt2 set paid=paid*-1 where accountType in (select accountType from dbo.glBankFundTypes('BANK'))

-- Grouping begins
declare @currentTaxYear varchar(4),
        @priorTaxYear varchar(4),
        @detailBackTax varchar(5)

select @detailBackTax = settingValue from settings where settingname='site.dailyLedgerDetailBackTax'

if @detailBackTax <> 'TRUE'
-- rename all the back tax lines the same 
begin
 update @wt2 set accountType = 'BACK TAX' 
  where right(accountCode,9) = 'ADVALOREM' and left(accountCode,4) in (select year from dbo.taxyears(@endDate) where yearCode = 'Back')
end

-- why are we inserting into @rt twice?
insert @rt
 select *,'','' from @wt2 where accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType <>'SUSPENSE' union select 'FUND')

insert @rt
select 
 ledgerGroup,
 accountType+case when accountType <> 'BACK TAX' then 'S' else '' end+' '+rtrim(ledgerGroup), sum(beginbalance), sum(paid), sum(appout), sum(appin), sum(specappout), sum(specappin), sum(tranout), sum(tranin), sum(fundtranout), sum(fundtranin), sum(deposits), sum(elecdeposits), sum(endbalance), accountType, ledgerGroup,'','' from @wt2
 where accountType in (select accountType from dbo.glBankFundTypes('BOTH') union select 'BACK TAX') and accountType not in (select accountType from dbo.glBankFundTypes('BANK') where accountType <>'SUSPENSE' union select 'FUND')
 group by accountType, ledgerGroup

update @rt set accountDesc = 'PENDING DEPOSITS' where accountType = 'SUSPENSE'
update @rt set accountType='BANK' where accountType in (select accountType from dbo.glBankFundTypes('BANK'))
update @rt set accountType='FUND' where accountType in (select accountType from dbo.glBankFundTypes('FUND') union select 'BACK TAX')

-- here is where we set the report order
 update @rt set reportOrder = accountDesc

 update r set
  r.reportOrder = 
  (select case when max(a.reportOrder) > '  0' then max(a.reportOrder) else max(a.ledgerGroup) end from dbo.glAccounts a where a.ledgerGroup = r.ledgerGroup)
 from @rt r
 where r.ledgerGroup > '  0'

 update r set reportOrder = a.reportOrder
  from @rt r, glaccounts a
  where r.accountCode = a.accountCode
   and a.reportOrder > '  0'
   and a.ledgerGroup < '  0'

-- that was were we set the report order

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, glaccounts a where r.accountcode=a.accountcode

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, (select max(financialGroup) as financialGroup,accountType as accountCode, ledgerGroup from glaccounts group by    accountType, ledgerGroup) a where r.accountCode=a.accountCode and (r.ledgerGroup < ' 0') and r.accountType='FUND'

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, (select max(financialGroup) as financialGroup,'Back Tax' as accountCode from glaccounts where right(accountcode,9)='ADVALOREM') a where r.accountCode=a.accountCode and (r.ledgerGroup < ' 0') and r.accountType='FUND'

update r set financialReportGroup = case when a.financialGroup='A' then 'Trust and Agency Funds' when a.financialGroup='X' then 'X' else 'County Funds' end 
 from @rt r, glaccounts a where r.ledgerGroup=a.ledgerGroup and r.ledgerGroup>' 0'

return
end