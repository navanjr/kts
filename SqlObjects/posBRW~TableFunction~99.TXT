create function dbo.posBRW() returns @rt table(
 id int identity(-1,-1),
 display varchar(500),
 depositDate int,
 receiptType varchar(50),
 amount money,
 accountId int,
 blob varchar(1000) default '',
 postDate int,
 ord varchar(50),
 rowType int,
 rowColor int
) as 
begin

 declare
  @whoAmI varchar(500) = dbo.whoAmI(),
  @voucherTotal money,
  @warrantTotal money

 insert @rt (depositDate,receiptType,amount,accountId,ord,rowType,blob,postDate)
 select
  max(depositDate), 
  receiptType,
  sum(amount),
  min(accountId),
  cast(max(depositDate) as varchar) + 'b',
  0,
  '@defaultAction=browse;@menu=2;'
   + @whoamI
   + '@receiptType='+receiptType+';@receiptMaxDate='
   + cast((select max(p.depositDate) from dbo.posTF() p where p.receiptType = receiptType) as varchar)+';@Date='
   + cast(max(depositDate) as varchar)+';',
  max(postDate)
 from dbo.posTF()
 group by
  id, 
  receiptType
-- having sum(amount) != 0

-- depositDate grouping
 insert @rt (depositDate,amount,accountId,ord,blob,rowType,rowColor)
 select
  depositdate,
  sum(amount),
  1, 
  cast(depositDate as varchar) + 'a',
  '@defaultAction=report;@menu=1;'
  + @whoamI + '@Date='+cast(depositDate as varchar)+';'+'@receiptType=ALL;',
  1,2
 from @rt
 where depositDate is not null
 group by depositDate

 update @rt set display = 
  dbo.padRight(dbo.date1(depositDate),' ',21) + dbo.padLeft('$ ' + convert(varchar,isnull(amount,0),1),' ',20)
 where rowType = 1

 update @rt set blob = replace(replace(blob,'@defaultAction=browse','@defaultAction=browseOfficial;'),'@menu=2','@menu=4')
 where rowType = 0 and receiptType = 'OFFICIAL'

-- update @rt set displayAmount = convert(varchar,amount,1) where rowType = 0
--  '   ' + dbo.padRight(receiptType,' ',10) + dbo.padLeft('$ ' + convert(varchar,sum(amount),1),' ',20),

-- add payment totals
 if dbo.settingsF('site.showPaymentsOnDashboard','FALSE') = 'TRUE'
 begin
  declare @paymentDate int = cast(dbo.settingsF('dashboard.' + dbo.readstring('@station=',dbo.whoami()) + '.paymentDate',cast(dbo.clarionToday() as varchar)) as int)
  insert @rt (display,ord) select '', 'za'
  insert @rt (display,rowColor,ord,blob) select 'Payment Date: ' + dbo.date1(@paymentDate), 2, 'zb', '@menu=3;'
  insert @rt (receiptType,rowType,ord,amount)
  select paymentType, 2, 'zc' + paymentType, sum(amount)
   from dbo.payments
   where createdIni = dbo.readstring('@ini=',@whoami) and dateRegistered = @paymentDate
   group by paymentType
 end



 update @rt set display = 
    dbo.padRight('  ' + receiptType,' ',10) 
  + dbo.padright(case when dbo.settingsf('site.dashBoardPostDate','FALSE') = 'TRUE' then  
  case when isnull(postdate,0) != isnull(depositDate,0) and  dbo.readstring('@receiptMaxDate=',blob) = isnull(depositDate,0) then '  '  + dbo.date1(postdate) else 
   case when isnull(postdate,0) > isnull(depositDate,0) and  dbo.readstring('@receiptMaxDate=',blob) = isnull(depositDate,0) then '  '
  + dbo.date1(postdate) end  end else '' end,' ',12) 
  + case when amount > 0 then dbo.padLeft('$ ' + convert(varchar,amount,1),' ',19) else '' end
 where rowType = 0
 update @rt set display = 
    dbo.padRight('  ' + receiptType,' ',22) 
  + case when amount > 0 then dbo.padLeft('$ ' + convert(varchar,amount,1),' ',19) else '' end
 where rowType = 2
 update @rt set rowColor = case when accountId > 0 then 0 else 1 end where rowType = 0

 return
end