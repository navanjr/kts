create function dbo.nextTaxReceiptAutoNumber(
 @taxYear varchar(50),
 @invoiceTyp varchar(10) 
) returns varchar(50) as 
begin

 declare
  @retval varchar(50),
  @padLength int,
  @keyCodeOptions varchar(50),
  @lastReceiptNumber varchar(50)

 select @lastReceiptNumber = cast(cast(case when isnumeric(a17) = 1 then a17 else '0' end as int) + 1 as varchar) 
  from object where typ = 4000 and key1 = @taxYear

 select @keyCodeOptions = dbo.readKeyCode(4502,'\0002')

 if isnull(@invoiceTyp,'NULL')='NULL'
  begin
   select @retval =  cast(cast(max(case when isnumeric(a.receiptNumber) = 1 then a.receiptNumber else '0' end) as int) + 1 as varchar) 
    from receiptLink a, invoices b
    where a.invoiceId = b.id
     and b.taxYear = @taxYear 
  end
 else
  begin
   select @retval =  cast(cast(max(case when isnumeric(a.receiptNumber) = 1 then a.receiptNumber else '0' end) as int) + 1 as varchar) 
    from receiptLink a, invoices b
    where a.invoiceId = b.id
     and b.taxYear = @taxYear 
     and (b.typ=@invoiceTyp or @invoiceTyp not in ('O','S'))
  end

 if isnull(cast(@lastReceiptNumber as int),0) > isnull(cast(@retval as int),0)
  set @retval = @lastReceiptNumber

 select 
  @padLength = cast(substring(@keyCodeOptions,1,2) as int)

 select @retval = dbo.padLeft(isnull(@retval,'1'),'0',@padLength)

 return @retval 
end