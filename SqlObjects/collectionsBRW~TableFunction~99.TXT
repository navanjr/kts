create function dbo.collectionsBRW(
 @dtype varchar(50),
 @documentId int,
 @date int,
 @days int
) returns @rt table(
 id int,
 invoiceIdMain int,
 taxrollDetailId int,
 display varchar(250),
 keyCode varchar(50),
 parcel varchar(50),
 item numeric(7,1),
 taxYearMax varchar(5),
 taxYearMin varchar(5),
 invoiceCount int,
 totalDue money,
 invoiceDue money,
 subInvoiceDue money,
 taxRuleDue money,
 invoiceBlob varchar(max),
 rowType int,
 ord varchar(250),
 documentStatus varchar(50)
) as
begin

 declare @printed table(keyCode varchar(50))
 insert @printed select keyCode from dbo.collectionsPrintedTF(@dtype,@documentId,@date, @days)

 insert @rt( id, taxrollDetailId, keyCode, parcel, item, taxYearMax, taxYearMin, invoiceCount, invoiceDue, subInvoiceDue, taxRuleDue, invoiceBlob, rowType, documentStatus )
 select
  a.id,
  a.taxrollDetailId,
  a.keyCode,
  a.parcel,
  a.item,
  a.taxYearMax,
  a.taxYearMin,
  a.invoiceCount,
  a.invoiceDue,
  a.subInvoiceDue,
  a.taxRuleDue,
  a.invoiceBlob,
  a.rowType,
  case when b.keyCode is null then '' else 'Printed' end 
 from dbo.collectionsDtypeToggleTF(@dtype) a
 left outer join @printed b on a.keyCode = b.keyCode

 update @rt set
  invoiceIdMain = left(invoiceBlob,9),
  display = replace(dbo.splitF(invoiceBlob,':',2),'&amp;','&'),
  ord = replace(dbo.splitF(invoiceBlob,':',2),'&amp;','&') + keyCode,
  totalDue = invoiceDue + subInvoiceDue + taxRuleDue

 --insert @rt (display, ord)
 -- select '   -', display + 'b' from @rt 

 insert @rt (totalDue, ord, rowType) select sum(totalDue), ' ', 2  from @rt where rowType = 0

 return
end