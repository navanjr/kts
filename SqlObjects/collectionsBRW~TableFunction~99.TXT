create function dbo.collectionsBRW(
 @dtype varchar(50),
 @documentId int,
 @date int,
 @days int,
 @taxrollDetailId int
) returns @rt table(
 id int,
 invoiceIdMain int,
 AddFeeToinvoiceId int,
 taxrollDetailId int,
 display varchar(250),
 keyCode varchar(50),
 parcel varchar(50),
 item numeric(7,1),
 taxYearMax varchar(5),
 taxYearMin varchar(5),
 invoiceCount int,
 totalDue money,
 invoiceDue money,
 subInvoiceDue money,
 taxRuleDue money,
 invoiceBlob varchar(max),
 rowType int,
 ord varchar(250),
 ordB varchar(250),
 documentStatus varchar(50),
 name varchar(max)
) as
begin

declare 
 @AddFeeNewest varchar(50) = case when @dtype='taxwarrant' then dbo.settingsF('site.collectionsAttachFeesNewestTaxwarrant','FALSE') else dbo.settingsF('site.collectionsAttachFeesNewestResale','FALSE') end,
 @taxYear int = datepart(year,dbo.date1(@date))-1


 declare @printed table(keyCode varchar(50))
 insert @printed select keyCode from dbo.collectionsPrintedTF(@dtype,@documentId,@date, @days)

 declare @fees table(keyCode varchar(50))
 insert @fees select keyCode from dbo.collectionsAddFeesTF(@dtype,@documentId,@date, @days)

 insert @rt( id, taxrollDetailId, keyCode, parcel, item, taxYearMax, taxYearMin, invoiceCount, invoiceDue, subInvoiceDue, taxRuleDue, invoiceBlob, rowType, documentStatus, name )
 select
  a.id,
  a.taxrollDetailId,
  a.keyCode,
  a.parcel,
  a.item,
  a.taxYearMax,
  a.taxYearMin,
  a.invoiceCount,
  a.invoiceDue,
  a.subInvoiceDue,
  a.taxRuleDue,
  a.invoiceBlob,
  a.rowType,
  case when c.keyCode is null then '' else 'Fees Added' end + case when b.keyCode is null then '' else case when c.keyCode is null then '' else ',' end + 'Printed' end,
  name 
 from dbo.collectionsDtypeToggleTF(@dtype,@taxrollDetailId,@taxYear,@date,@days) a
 left outer join @printed b on a.keyCode = b.keyCode
 left outer join @fees c on a.keyCode = c.keyCode
 where case when @dtype='RESALE' then a.parcel else '00000' end > ' 0'

delete r from @rt r,taxrolldetail t where t.dtype='bankrupt' and isnull(actionDate,0) = 0   and (r.parcel>'  0' and r.parcel = t.parcelnumber or r.item=t.itemNumber)


 update @rt set
  invoiceIdMain = left(invoiceBlob,9),
  AddFeeToinvoiceId = (select top 1 left(data,9) from  dbo.split(invoiceBlob,'|') order by case when @AddFeeNewest = 'FALSE' then id  else 10000-id end desc),
  display = replace(name,'&amp;','&'),
  ord = replace(name,'&amp;','&') + keyCode,
  ordB = keyCode + replace(name,'&amp;','&'),
  totalDue = invoiceDue + subInvoiceDue + taxRuleDue--,
  --item = case when dbo.splitF(invoiceBlob,':',2) = '' then 0.0 else dbo.splitF(invoiceBlob,':',2) end

 --insert @rt (display, ord)
 -- select '   -', display + 'b' from @rt 

if @taxrollDetailId = 0
 insert @rt (keyCode, totalDue, ord, rowType)
 select cast(count(*) as varchar) + ' - ' + case when @dtype = 'RESALE' then 'Parcels' else 'Items' end, sum(totalDue), ' ', 2  from @rt where rowType = 0

delete from @rt where totaldue is null


 return
end