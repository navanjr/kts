create function dbo.taxrollSearchBRW(
 @receiptId int,
 @selectedId int
) returns @rt table(
 invoiceId int,
 display varchar(250),
 name nvarchar(30),
 parcel nvarchar(24),
 taxYear numeric(5,0),
 item numeric(7,1),
 taxType nvarchar(1),
 amount money,
 due money,
 slink varchar(15),
 selectedFlag char(1),
 colorFlag int,
 ord varchar(100)
)
begin

 declare
  @name varchar(50),
  @parcel varchar(50)

 select 
  @name = name,
  @parcel = parcel
 from invoices where id = @selectedId
 
 if @name > '  0'
 begin
  insert @rt
  select id*-1,'   ' + parcel,name,parcel,taxYear,item,typ,invoiceAmount,invoiceDue,'t'+cast(id as varchar),'',1,'b'+cast(taxYear as varchar)+parcel
  from dbo.invoices
  where name = @name and id != @selectedId
  insert @rt (invoiceId,display,colorFlag,ord) select 0,'Matched By Name: '+ name,0, 'a'+cast(min(taxyear) as varchar)+min(parcel) from @rt where colorFlag = 1 group by name
 end

 if @parcel > '  0'
 begin
  insert @rt
  select id*-1,'   ' + name,name,parcel,taxYear,item,typ,invoiceAmount,invoiceDue,'t'+cast(id as varchar),'',2,'b'+cast(taxYear as varchar)+name
  from dbo.invoices
  where parcel = @parcel and id != @selectedId and id not in (select invoiceId*-1 from @rt)
  insert @rt (invoiceId,display,colorFlag,ord) select 0,'Matched By Parcel: '+ parcel,0, 'a'+cast(min(taxyear) as varchar)+min(name) from @rt where colorFlag = 2 group by parcel
 end

 if @parcel > '  0'
  insert @rt (display, parcel, ord)
   select 'Certificate: '+rtrim(a4), key1, 'z' from object where typ=4100 and key2='A' and key1=@parcel

/*  declare @glSum table(slink varchar(15),arAmount money, srcAmount money)
  insert @glsum
  select a.slink,
   sum(case when b.accountType = 'RECEIVABLE' then a.amount else 0.0 end),
   sum(case when b.accountType != 'RECEIVABLE' then a.amount else 0.0 end)
  from glDetail a, glAccounts b 
  where a.accountId = b.accountId and a.slink in (select slink from @rt) 
  group by a.slink

  update a set
   a.due = b.arAmount,
   a.amount = b.srcAmount 
  from @rt a, @glSum b where a.slink = b.slink
*/  
-- removed this for performance. TODO: keep an eye on this...  also, replaced 0,0 with invoiceAmount,invoiceDue in the two inserts above
--  update @rt set
--   due = isnull((select sum(amount) from dbo.invoiceGLTotalTF(invoiceId*-1) where accountType='RECEIVABLE'),0),
--   amount = isnull((select sum(amount) from dbo.invoiceGLTotalTF(invoiceId*-1) where accountType='SOURCE'),0)
  
 delete from @rt where due < 0.01
  
 return
end