create function dbo.dailyDataPendingDeposits() 
returns @rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 brwBGColor int,
 depositAccountCode varchar(50),
 depositAccountDesc varchar(50),
 receiptType varchar(50),
 amount money
) as 
begin

 declare
  @seedString varchar(10) = 'D',
  @siteSetting varchar(50) = dbo.settingsF('site.dailyDataPendingDepositsShowBankAccounts')

 if @siteSetting != 'TRUE'
 begin
  insert @rt
  select 
   cast('7'+cast(b.id as varchar) as int) * -1, 
   'DC',
   '   ' + dbo.padRight(receiptType + '      '
    + case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,' ',48)
   + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   '',
   '   ' + dbo.padRight(receiptType + '      ',' ',48),
   case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,
   '',
   dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   null,null,null,null,null
  from dbo.depositPaidUnPosted() a, object b
  where a.receiptType = b.key1 and b.typ = 4503
  group by receiptType, b.id

  insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceAmt) 
      select 0,'DD',dbo.padLeft('Total',' ',51) + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),'',dbo.padLeft('Total',' ',50),dbo.padLeft(convert(varchar,sum (amount),1),' ',16)
      from dbo.depositPaidUnPosted()
 end
 else
 begin
-- get the raw data
 insert @rt (id,recordCnt,sourceAmt,depositAccountCode,depositAccountDesc,receiptType,amount,brwBGColor)
 select
  cast('7'+cast(0 as varchar) as int) * -1, 
  count(a.id),
  sum(a.amount),
  coalesce(nullif(b.key2,''),'VARIOUS'),
  coalesce(nullif(b.a18,''),'Various Accounts'),
  a.receiptType,
  sum(a.amount),
  0
 from dbo.depositPaidUnPosted() a
 join object b on a.receiptType = b.key1 and b.typ = 4503
 group by b.Key2,b.A18,a.receiptType
 order by b.Key2,a.receiptType

 update @rt set
  ord = @seedString + 'C' + depositAccountCode + receiptType, 
  rowString = '      ' + dbo.padRight(receiptType + ' ('+cast(recordCnt as varchar)+')',' ',45) + dbo.padLeft(convert(varchar,amount,1),' ',16)

-- add grouping 
 insert @rt (ord,rowstring,recordCnt,sourceAmt,amount,depositAccountCode,depositAccountDesc,brwBGColor)
 select 
  @seedString + 'C' + depositAccountCode + '  a',
  '   ' + dbo.padRight(depositAccountDesc,' ',48) + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
  COUNT(*),
  SUM(amount),
  SUM(amount),
  depositAccountCode,depositAccountDesc,
  2
 from @rt
 group by depositAccountCode, depositAccountDesc

 insert @rt (ord)
 select 
  @seedString + depositAccountCode + 'z'
 from @rt
 group by depositAccountCode, depositAccountDesc
 end

 insert @rt (id,ord,rowstring,glBalanceString) select 0,@seedString + ' ','',''
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,brwBGColor) select 0,@seedString + 'A','  Un-Posted Deposits','','  Un-Posted Deposits', 1
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceNo,recordCnt,sourceAmt) select 0,@seedString + 'B',' ' + replicate('-',69),'',' ' + replicate('-',69),replicate('-',22),replicate('-',10),replicate('-',16)
  
 return
end