create function dbo.dailyDataPendingDeposits() 
returns @rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 brwBGColor int,
 depositAccountCode varchar(50),
 depositAccountDesc varchar(50),
 receiptType varchar(50),
 amount money,
 depositAmount money,
 actionId int,
 existingDepositId int,
 minId int,
 blob varchar(max)
) as 
begin

 declare
  @seedString varchar(10) = 'D',
  @siteSetting varchar(50) = dbo.settingsF('site.dailyDataPendingDepositsShowBankAccounts','FALSE')

 if @siteSetting != 'TRUE'
 begin
  insert @rt
  select 
   cast('7'+cast(b.id as varchar) as int) * -1, 
   'DC',
   '   ' + dbo.padRight(receiptType + '      '
    + case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,' ',48)
   + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   '',
   '   ' + dbo.padRight(receiptType + '      ',' ',48),
   case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,
   '',
   dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   null,null,null,null,null,null,null,null,null,null
  from dbo.depositPaidUnPosted() a, object b
  where a.receiptType = b.key1 and b.typ = 4503
  group by receiptType, b.id

  insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceAmt) 
  select 0,'DD',dbo.padLeft('Total',' ',51)
   + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),'',dbo.padLeft('Total',' ',50),dbo.padLeft(convert(varchar,sum (amount),1),' ',16)
  from dbo.depositPaidUnPosted()
 end
 else
 begin
-- get the raw data
 insert @rt (id,recordCnt,sourceAmt,depositAccountCode,depositAccountDesc,receiptType,amount,brwBGColor,actionId,existingDepositId,minId)
  select
   cast('-6' + cast(min(a.id) as varchar) as int),
   count(a.id),
   sum(a.amount),
   depositAccountCode,
   depositAccountDesc,
   a.receiptType,
   sum(a.amount),
   0,
   min(b.id),
   case when receiptType = 'AAATRUST' then
    max(coalesce(nullif(isnull(a.officialDepositId,0),0),nullif(isnull(a.depositId,0),0)))
   else
    max(coalesce(nullif(isnull(a.depositId,0),0),nullif(isnull(a.officialDepositId,0),0)))
   end,
   min(a.id)
  from dbo.depositPaidUnPosted() a
  left join object b on a.receiptType = b.key1 and b.typ = 4503 --and b.Key1 != 'TRUST'
  group by
   depositAccountCode,
   depositAccountDesc,
   a.receiptType

  update @rt set
   ord = @seedString + 'C' + depositAccountCode + receiptType, 
   rowString = '      ' + dbo.padRight(receiptType + ' ('+cast(recordCnt as varchar)+')',' ',34) + dbo.padLeft(convert(varchar,amount,1),' ',20) 
    + case when existingDepositId > 0 then ' *' else '' end,
   blob = 
    case when isnull(existingDepositId,0) > 0 then '@changeId=' + cast(existingDepositId as varchar)+';@depositCount=1;' else '@depositCount=0;' end

-- add grouping  
  insert @rt (id,ord,rowstring,recordCnt,sourceAmt,amount,depositAccountCode,depositAccountDesc,brwBGColor,blob,receiptType)
  select 
   cast('-5' + cast(min(a.minId) as varchar) as int),
   @seedString + case when depositAccountCode = 'AAATRUST' then 'A' else 'C' end + depositAccountCode + '  a',
   case when depositAccountCode = 'AAATRUST' then
    '   ' + dbo.padRight(depositAccountDesc,' ',57) + dbo.padLeft(convert(varchar,sum(amount),1),' ',20)
    + case when max(existingDepositId) > 0 then ' *' else '' end
   else
    '   ' + dbo.padRight(depositAccountDesc,' ',37) + dbo.padLeft(convert(varchar,sum(amount),1),' ',20)
    + case when max(existingDepositId) > 0 then ' *' else '' end
   end,
   COUNT(*),
   SUM(amount),
   SUM(amount),
   depositAccountCode,depositAccountDesc,
   2,
   case when COUNT(distinct existingDepositId) > 1 then '@deposits=' else '@changeId=' end
   +stuff((select distinct '|' + cast(existingDepositId as varchar) from @rt b where b.depositAccountCode = a.depositAccountCode and existingDepositId is not null FOR XML PATH('')),1,1,'')+';'
   + '@depositCount=' + cast(COUNT(distinct existingDepositId) as varchar) + ';',
   stuff((select distinct '|', rtrim(receiptType) from @rt c where c.depositAccountCode = a.depositAccountCode for XML path('')),1,1,'')
  from @rt a
  group by depositAccountCode, depositAccountDesc
  
  insert @rt (ord)
  select 
   @seedString + case when depositAccountCode = 'AAATRUST' then 'A' else 'C' end + depositAccountCode + 'z'
  from @rt
  group by depositAccountCode, depositAccountDesc

  delete @rt where brwBGColor = 0 and receiptType = 'AAATRUST'  
--  update @rt set id = cast(id as varchar) + CAST(actionId as varchar) 
  update @rt set brwBGColor = 0 where depositAccountCode = 'AAATRUST'

 end

 insert @rt (id,ord,rowstring,glBalanceString) select 0,@seedString + ' ','',''
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,brwBGColor) select 0,@seedString + 'BA','  Un-Posted Deposits','','  Un-Posted Deposits', 1
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceNo,recordCnt,sourceAmt) select 0,@seedString + 'BB',' ' + replicate('-',69),'',' ' + replicate('-',69),replicate('-',22),replicate('-',10),replicate('-',16)
  
 return
end  --  select * from dbo.dailyDataPendingDeposits() order by ord

