create function dbo.dailyDataPendingDeposits() 
returns @rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 brwBGColor int,
 depositAccountCode varchar(50),
 depositAccountDesc varchar(50),
 receiptType varchar(50),
 amount money
) as 
begin

 declare
  @seedString varchar(10) = 'D',
  @siteSetting varchar(50) = dbo.settingsF('site.dailyDataPendingDepositsShowBankAccounts')

 if @siteSetting != 'TRUE'
 begin
  insert @rt
  select 
   cast('7'+cast(b.id as varchar) as int) * -1, 
   'DC',
   '   ' + dbo.padRight(receiptType + '      '
    + case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,' ',48)
   + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   '',
   '   ' + dbo.padRight(receiptType + '      ',' ',48),
   case when MAX(depositId) > 0 then '(deposit #'+(select key1 from object where id=max(depositId))+' started)' else '' end,
   '',
   dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   null,null,null,null,null
  from dbo.depositPaidUnPosted() a, object b
  where a.receiptType = b.key1 and b.typ = 4503
  group by receiptType, b.id

  insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceAmt) 
      select 0,'DD',dbo.padLeft('Total',' ',51) + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),'',dbo.padLeft('Total',' ',50),dbo.padLeft(convert(varchar,sum (amount),1),' ',16)
      from dbo.depositPaidUnPosted()
 end
 else
 begin
-- get the raw data
  insert @rt (id,recordCnt,sourceAmt,depositAccountCode,depositAccountDesc,receiptType,amount,brwBGColor)
  select
   cast('7'+cast(0 as varchar) as int) * -1, 
   count(a.id),
   sum(a.amount),
   coalesce(d.a4,b.key2,'AAATRUST'),
   coalesce(d.b3,b.a18,'Create an Official Deposit for Trust'),
   a.receiptType,
   sum(a.amount),
   0
  from dbo.depositPaidUnPosted() a
  left join object b on a.receiptType = b.key1 and b.typ = 4503 and b.Key1 != 'TRUST'
  left join Object c on a.objLinkId = c.ID and c.Typ = 4522
  left join Object d on c.Link2 = d.ID and d.Typ = 4601
  group by
   coalesce(d.a4,b.key2,'AAATRUST'),
   coalesce(d.b3,b.a18,'Create an Official Deposit for Trust'),
   a.receiptType

  update @rt set
   ord = @seedString + 'C' + depositAccountCode + receiptType, 
   rowString = '      ' + dbo.padRight(receiptType + ' ('+cast(recordCnt as varchar)+')',' ',45) + dbo.padLeft(convert(varchar,amount,1),' ',16)

-- add grouping 
  insert @rt (ord,rowstring,recordCnt,sourceAmt,amount,depositAccountCode,depositAccountDesc,brwBGColor)
  select 
   @seedString + 'C' + depositAccountCode + '  a',
   '   ' + dbo.padRight(depositAccountDesc,' ',48) + dbo.padLeft(convert(varchar,sum(amount),1),' ',16),
   COUNT(*),
   SUM(amount),
   SUM(amount),
   depositAccountCode,depositAccountDesc,
   2
  from @rt
  group by depositAccountCode, depositAccountDesc

  insert @rt (ord)
  select 
   @seedString + 'C' + depositAccountCode + 'z'
  from @rt
  group by depositAccountCode, depositAccountDesc

  delete @rt where brwBGColor = 0 and receiptType = 'TRUST'

 end

 insert @rt (id,ord,rowstring,glBalanceString) select 0,@seedString + ' ','',''
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,brwBGColor) select 0,@seedString + 'A','  Un-Posted Deposits','','  Un-Posted Deposits', 1
 insert @rt (id,ord,rowstring,glBalanceString,rowstring1,sourceNo,recordCnt,sourceAmt) select 0,@seedString + 'B',' ' + replicate('-',69),'',' ' + replicate('-',69),replicate('-',22),replicate('-',10),replicate('-',16)
  
 return
end