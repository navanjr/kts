create function dbo.taxrollSearchCommentBRW(
 @selectedId int
) returns @rt table(
 Id int,
 noteDate nvarchar(50),
 actionDate nvarchar(12),
 comment text,
 commentType varchar(20)
)
begin

if @selectedId > 0
 begin

 declare
  @name varchar(50),
  @item numeric (7,1),
  @parcel varchar(50),
  @taxYear numeric (5,0)

 select 
  @name = name,
  @item = item,
  @parcel = parcel,
  @taxYear = taxyear
 from invoices where id = @selectedId

 if @selectedId > 9000000
 begin
  select 
   @name = ownername,
   @item = ITEMNUMBER,
   @parcel = FULLPIDNUMBER,
   @taxYear = realtaxyear
  from adtax where id = @selectedId-9000000
 end
 
-- comments from object
  insert @rt
  select id,a2,a3,case when a4 = '1' then '<private> ' else '' end + cast(e1 as varchar(max)),'COMMENT'
  from dbo.object
  where typ=4002 
   and (key3=left(@name,len(key3)) or len(key3)<1) 
   and (key2=left(@parcel,len(key2)) or len(key2)<1) 
   and (case when isnumeric(key1)=1 then cast(key1 as numeric (7,1)) else 0 end=@item 
    or 
   case when isnumeric(key1)=1 then cast(key1 as numeric (7,1)) else 0 end<1) 
   and (case when isnumeric(a1)=1 then cast(a1 as numeric (5,0)) else 0 end =@taxyear or len(a1)<2)

  insert @rt
  select 
	id*-1,
	dbo.clariondate(left(Stamp,10)),
	'',
	case when name>'  0' then name+' ' else '' end
	+case when businessName>'  0' then businessName+' ' else '' end
	+case when address1>'  0' then address1+' ' else '' end
	+case when address2>'  0' then address2+' ' else '' end
	+case when address3>'  0' then address3+' ' else '' end
	+case when city>'  0' then city else '' end
	+case when state>'  0' then ', '+state else '' end
	+case when zip1>'  0' then ' '+zip1 else '' end
	+case when zip2>'  0' then '-'+zip2 else '' end,
        'ADDRESS'
	from dbo.taxRollDetail
	where	(name=@name or len(name)<1 or name<>@name) 
		and (parcelNumber=@parcel or len(parcelNumber)<1) 
		and (case when isnumeric(itemNumber)=1 then cast(itemNumber as numeric (7,1)) else 0 end = @item or len(itemNumber)<2) 
		and (case when isnumeric(taxYear)=1 then cast(taxYear as numeric (5,0)) else 0 end = @taxyear or len(taxYear)<2)
                and Dtype = 'A'
        order by id desc 

-- print comments
 if @selectedId > 0 
  insert @rt select id*-1, dbo.clarionDate(documentDateTime), dbo.clarionDate(documentDateTime), comments, dtype from taxrollDetail where invoiceLinkId = @selectedId

-- dtype records
  insert @rt select id*-1, dbo.clarionDate(documentDateTime), dbo.clarionDate(documentDateTime), comments, dtype
   from taxrollDetail where parcelNumber > '  0' and parcelNumber = @parcel and dtype in ('RESALE','BANKRUPT','PROBATE')
  insert @rt select id*-1, dbo.clarionDate(documentDateTime), dbo.clarionDate(documentDateTime), comments, dtype
   from taxrollDetail where itemNumber > 0 and itemNumber = @item and dtype in ('item','BANKRUPT','PROBATE')

insert @rt
    select	Id*-1,
		key2,
		'',
		'Field Name:'+rtrim(key3)+'; Original Info:'+case when a3 = '@d2;' then dbo.date1(a1) else a1 end+'; Corrected Info:'+case when a3 = '@d2;'                         then dbo.date1(a2) else a2 end,
                'CORRECTION' 
		from object 
		  where typ=4005 
		  and link1 in (select taxrollId from invoices where id=@selectedId) 
		  order by key1 desc

insert @rt
    select	i.Id*-1,
		'',
		'',
		'Physical Address: '+a.proploc,
                ' Address' 
		from adtax a ,invoices i 
		  where  a.id = i.taxrollId and i.id=@selectedId and a.proploc>'  0'
--voided invoice comments		  
  insert @rt
     select     i.id*-1,
                i.postdate,
                i.postdate,
                rtrim(rd.description)+'         SOURCECODE:'+rtrim(rd.sourcecode)+'    AMOUNT:'+cast(rd.amount as varchar(50)),
                'ADJUSTMENT'
            from dbo.invoices i, receiptDetail rd
               where i.typ='A' 
                  and i.invoiceId=@selectedId
                  and rd.slink='t'+cast(i.id as varchar(15))

--Receipt Payments
  declare @wt table(invoiceId varchar(50),receipt varchar(50),name varchar(50),controlNum varchar(50),Amount money,receiptId int,recDate varchar(50),typ varchar(50))

  insert @wt
     select 

       c.id,
       a.receiptNumber,
       c.NAME,
       '',
       sum(b.amount),
       a.receiptId,
       '', 
       ' Receipt'
   
      from receiptLink a, receiptDetail b, invoices c
     where 't'+CAST(a.invoiceId as varchar) = b.slink
         and a.invoiceId = c.ID
         and c.id = @selectedId and a.receiptNumber>'  0'
        group by c.invoiceId, c.id, a.protestAmount, a.receiptNumber, c.taxyear, c.NAME,a.receiptId
 
 update @wt set
       name =   case when a1>'  0' then a1 else name end,
       controlNum = key1,
       recDate = key2,
       amount =  dbo.taxReceiptTaxPaid(receiptId,invoiceId,0)
      from @wt,object where id = receiptId

 insert @rt
  select 
    invoiceId*-1,
    recDate,
    '',
    'Tax Receipt: '+receipt+'   '+NAME+'   Control: '+controlNum+'   Amount: '+cast(dbo.formatcurr(amount) as varchar),
    typ
    from @wt

--Journal Entries
  delete from @wt where invoiceId<>0
  insert @wt
     select 
       @selectedId,
       '',
       '',
       o.key1,
       sum(b.amount)*-1,
       a.jeId,
       o.key2, 
       ' Journal'
      from journalLink a, glDetail b, invoices c, glaccounts ac, object o
     where 'j'+CAST(a.id as varchar) = b.slink
         and o.typ = 4512
         and o.id = a.jeId
         and b.accountCode=ac.accountCode
         and a.invoiceId = c.ID
         and (c.id = @selectedId or c.invoiceId = @selectedId) 
         and ac.accountType = 'RECEIVABLE'
        group by o.key1, a.jeId, o.key2

 update @wt set
       name = key3
      from @wt,object where id = receiptId

 
 insert @rt
  select 
    invoiceId*-1,
    recDate,
    '',
    'Journal: '+controlNum+'   '+NAME+'  Amount: '+cast(dbo.formatcurr(amount) as varchar),
    typ
    from @wt
 end

 return
end