create function dbo.taxrollSearchCommentBRW(
 @selectedId int
) returns @rt table(
 Id int,
 noteDate nvarchar(50),
 actionDate nvarchar(12),
 comment text,
 commentType varchar(20),
 origin int,
 color int
)
begin

if @selectedId > 0
 begin

 declare
  @name varchar(50),
  @item numeric (7,1),
  @parcel varchar(50),
  @taxYear numeric (5,0),
  @pubFlag varchar(10)

 select @pubFlag = case when charindex('@group=publicuser;',options)>0 then 'TRUE' else 'FALSE' end from users where ini = dbo.readstring('@ini=',dbo.whoami())

 select 
  @name = name,
  @item = item,
  @parcel = parcel,
  @taxYear = taxyear
 from invoices where id = @selectedId

 if @selectedId > 9000000
 begin
  select 
   @name = ownername,
   @item = ITEMNUMBER,
   @parcel = FULLPIDNUMBER,
   @taxYear = realtaxyear
  from adtax where id = @selectedId-9000000
 end

if @pubFlag = 'FALSE'
 begin 
-- comments from object
  insert @rt
  select 
   cast('-8'+cast(id as varchar) as int),
   a2,
   a3,
   case when a4 = '1' then '<private> ' else '' end + rtrim(left(Attributes,5)) + ' - ' + cast(e1 as varchar(max)),'COMMENT',
   1,
   1
  
  from dbo.object
  where typ=4002 
   and cast(e1 as varchar(max)) > '  0'
   and (key3=left(@name,len(key3)) or len(key3)<1) 
   and (key2=left(@parcel,len(key2)) or len(key2)<1) 
   and (case when isnumeric(key1)=1 then cast(key1 as numeric (7,1)) else 0 end=@item 
    or 
   case when isnumeric(key1)=1 then cast(key1 as numeric (7,1)) else 0 end<1) 
   and (case when isnumeric(a1)=1 then cast(a1 as numeric (5,0)) else 0 end =@taxyear or len(a1)<2)

  insert @rt
  select 
	cast('-1'+cast(id as varchar) as int),
	dbo.clariondate(left(Stamp,10)),
	'',
	(select top 1 data from dbo.split(stamp,' ') order by id desc) + ' - ' 
        +case when name>'  0' then name+' ' else '' end
	+case when businessName>'  0' then businessName+' ' else '' end
	+case when address1>'  0' then address1+' ' else '' end
	+case when address2>'  0' then address2+' ' else '' end
	+case when address3>'  0' then address3+' ' else '' end
	+case when city>'  0' then city else '' end
	+case when state>'  0' then ', '+state else '' end
	+case when zip1>'  0' then ' '+zip1 else '' end
	+case when zip2>'  0' then '-'+zip2 else '' end,
        'ADDRESS',
         2,
         0
	from dbo.taxRollDetail
	where	(name=@name or len(name)<1 or name<>@name) 
		and (parcelNumber=@parcel or len(parcelNumber)<1) 
		and (case when isnumeric(itemNumber)=1 then cast(itemNumber as numeric (7,1)) else 0 end = @item or len(itemNumber)<2) 
		and (case when isnumeric(taxYear)=1 then cast(taxYear as numeric (5,0)) else 0 end = @taxyear or len(taxYear)<2)
                and Dtype = 'A'
        order by id desc 

-- print comments
 if @selectedId > 0 
  insert @rt select cast('-1'+cast(id as varchar) as int), dbo.clarionDate(documentDateTime), dbo.clarionDate(documentDateTime), comments, dtype,3,case when dtype='addfee' then 1 else 0 end from taxrollDetail where invoiceLinkId = @selectedId

-- dtype records
  insert @rt select cast('-1'+cast(id as varchar) as int), dbo.clarionDate(documentDateTime), dbo.clarionDate(actionDate), comments, dtype,4,1
   from taxrollDetail where (itemNumber > 0 and itemNumber = @item  or parcelNumber > '  0' and parcelNumber = @parcel) and dtype in ('RESALE','PROBATE','TAXWARRANT')

---dtype bankrupt records
  insert @rt select cast('-7'+cast(id as varchar) as int), dbo.clarionDate(documentDateTime), dbo.clarionDate(actionDate), comments, ' '+dtype,5,1
   from taxrollDetail where (itemNumber > 0 and itemNumber = @item  or parcelNumber > '  0' and parcelNumber = @parcel) and dtype in ('BANKRUPT','EXEMPT')
    and cast('-7'+cast(id as varchar) as int) not in (select id from @rt)

---collection notes
  insert @rt select cast('-7'+cast(id as varchar) as int), dbo.clarionDate(documentDateTime), dbo.clarionDate(actionDate), comments, dtype,5,0
   from taxrollDetail where (itemNumber > 0 and itemNumber = @item  or parcelNumber > '  0' and parcelNumber = @parcel) and dtype in ('print')
    and cast('-7'+cast(id as varchar) as int) not in (select id from @rt)


---corrections
 declare @x varchar(max)

 declare @wtc table (id int,crtdate varchar(50),comments varchar(max))

 insert @wtc
   select	
	cast('-1'+cast(min(id) as varchar) as int),
	date,
	case when isnull(ini,'')>'  0' then ini + ' - ' + comment + ' - ' else comment + ' - ' end
    from taxrollCorrectionsView where taxrollId in (select taxrollId from invoices where id=@selectedId) 
	group by date,ini,comment

 while exists (select * from @wtc where comments='')
  begin
   declare @tokenDate varchar(10)
    select @tokenDate = crtdate from @wtc where comments='' order by crtdate
     begin
      select @x = STUFF((select '|' + 'Field Name: '+rtrim(field)+'; '+original+' / '+corrected from taxrollCorrectionsView where taxrollId in (select taxrollId from invoices where id=@selectedId) and date=@tokenDate for XML path('')),1,1,'') 
      update @wtc set comments = comments +'Correction: '+ replace(@x,'&amp;','&') where crtdate = @tokenDate
     end
     
  end


 insert @rt
     select	id,
		crtdate,
		'',
		comments,
                ' CORRECTION' ,6,1
		from @wtc
		  


--voided invoice comments		  
  insert @rt
     select     cast('-1'+cast(i.id as varchar) as int),
                i.postdate,
                i.postdate,
                rtrim(rd.description)+'         SOURCECODE:'+rtrim(rd.sourcecode)+'    AMOUNT:'+cast(rd.amount as varchar(50)),
                'ADJUSTMENT',8,1
            from dbo.invoices i, receiptDetail rd
               where i.typ='A' 
                  and i.invoiceId=@selectedId
                and rd.slink='t'+cast(i.id as varchar(15))
--adjusted fees
  insert @rt
     select     cast('-1'+cast(i.id as varchar) as int),
                i.postdate,
                i.postdate,
                'Fee Adjustment: '+rtrim(rd.description)+'         SOURCECODE:'+rtrim(rd.sourcecode)+'    AMOUNT:'+cast(rd.amount as varchar(50)),
                'ADJUSTMENT',8,1
            from dbo.invoices i, receiptDetail rd
               where i.invoiceId = @selectedId
                  and rd.slink='t'+cast(i.id as varchar(15))
                  and invoiceAmount<0.00 and blob=''

--Fee Invoices
  insert @rt
      select    cast('-1'+cast(i.id as varchar) as int),
                i.postdate,
                i.postdate,
                dbo.splitf(blob,char(13)+char(10),1),
                'Fee',9,0
            from dbo.invoices i where i.invoiceId =  @selectedId and i.typ='F' and blob>'  0'


end

--Physical Address
insert @rt
    select	cast('-1'+cast(i.id as varchar) as int),
		'',
		'',
		'Physical Address: '+a.proploc,
                ' Address' ,7,0
		from adtax a ,invoices i 
		  where  a.id = i.taxrollId and i.id=@selectedId and a.proploc>'  0'

--Receipt Payments
  declare @wt table(invoiceId varchar(50),receipt varchar(50),name varchar(50),controlNum varchar(50),Amount money,receiptId int,recDate varchar(50),typ varchar(50),receiptlinkId int)

  insert @wt
     select 

       c.id,
       a.receiptNumber,
       c.NAME,
       '',
       sum(b.amount),
       a.receiptId,
       '', 
       ' Receipt',
       a.id
   
      from receiptLink a, receiptDetail b, invoices c
     where 't'+CAST(a.invoiceId as varchar) = b.slink
         and a.invoiceId = c.ID
         and c.id = @selectedId and a.receiptNumber>'  0'
        group by c.invoiceId, c.id, a.protestAmount, a.receiptNumber, c.taxyear, c.NAME,a.receiptId, a.Id
 
 update @wt set
       name =   case when a1>'  0' then a1 else name end,
       controlNum = key1,
       recDate = key2,
       amount =  dbo.taxReceiptTaxPaid(receiptId,invoiceId,0)
      from @wt,object where id = receiptId

 insert @rt
  select 
    cast('-9'+cast(receiptLinkId as varchar) as int),
    recDate,
    '',
    'Tax Receipt: '+receipt+'   '+NAME+'   Control: '+controlNum+'   Amount: '+cast(dbo.formatcurr(amount) as varchar),
    typ,9,2
    from @wt

if @pubFlag = 'FALSE'
 begin
--Journal Entries
  delete from @wt where invoiceId<>0
  insert @wt
     select 
       @selectedId,
       '',
       '',
       o.key1,
       sum(b.amount)*-1,
       a.jeId,
       o.key2, 
       ' Journal',
       a.Id
      from journalLink a, glDetail b, invoices c, glaccounts ac, object o
     where 'j'+CAST(a.id as varchar) = b.slink
         and o.typ = 4512
         and o.id = a.jeId
         and b.accountCode=ac.accountCode
         and a.invoiceId = c.ID
         and (c.id = @selectedId or c.invoiceId = @selectedId) 
         and ac.accountType = 'RECEIVABLE'
        group by o.key1, a.jeId, o.key2, a.Id

 update @wt set
       name = key3
      from @wt,object where id = receiptId

 
 insert @rt
  select 
    cast('-1'+cast(invoiceId as varchar) as int),
    recDate,
    '',
    'Journal: '+controlNum+'   '+NAME+'  Amount: '+cast(dbo.formatcurr(amount) as varchar),
    typ,10,0
    from @wt
 end
end

 return
end