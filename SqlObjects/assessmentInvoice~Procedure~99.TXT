CREATE procedure [dbo].[assessmentInvoice](
 @assessmentId int
)
as
begin

 declare 
  @slink varchar(15),
  @invoiceId int,
  @code int,
  @message varchar(150),
  @currentDate int,
  @year int 

  select @currentDate = dbo.clariondate(getdate()), @year = a18 from object where id = @assessmentId

--create any missing collection receivable accounts
  exec dbo.createAdtaxCollectionReceivables  @method = 'special',@taxYear = @year 

-- we need to preform the check first
 exec dbo.taxrollCheckProc @assessmentId, 'S', 0, @code = @code output, @message = @message output

 if @code = 1
 begin
  select '@code=1;@message='+@message+';'
  return
 end


  exec dbo.assessReferenceCRUD @assessmentId, @newId = @invoiceId output, @addAdtaxOnly = 'FALSE'
  
  exec dbo.taxrollInvoiceCRUD @assessmentId, 0, 'S', @invoiceId=@invoiceId
  exec dbo.taxRollAddressInsert @assessmentId, 'S'  
  
  select @slink = slink from dbo.taxrollCheck(@assessmentId,'S',null)


 declare @feedescription varchar(60),
         @feesourceCode varchar(60),
         @feefundCode varchar(60),
         @feeAmount money,
         @taxyear varchar(60),
         @interestDate int
         
    select
    @feedescription=feedescription,
    @feesourceCode=feesourceCode,
    @feefundCode=feefundCode,
    @feeAmount=feeAmount,
    @interestDate = interestDate
    from (select top 1 * from dbo.assessmentDetailCheck(@assessmentId)) data

   exec dbo.subInvoiceCRUD @invoiceId, @currentDate, @feedescription, @feesourceCode, @feefundCode, 'F', @feeAmount,  0, ''


  if dbo.glPostCheck(@slink) = 0
   begin
    select '@code=0;@message=OK;'
   end
  else
   begin 
    select '@code=1;@message=Assessment failed to process correctly, Contact Support. (as.inv);'
   end

  exec dbo.invoiceUpdate @invoiceId
end

