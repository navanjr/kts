create function dbo.interestWorkSheetDetail(@date varchar(20), @schoolfund varchar(20))
returns @rt table(
tableType varchar(50), 
apmonth varchar(20), 
apyear varchar(20), 
accountCode varchar(60), 
accountDesc varchar(50),
comment2 varchar(50),
amount money,
bankAccount varchar(60),
bankDesc varchar(60))
as
begin
declare @datetime datetime = dbo.date1(@date)
declare @firstDayPriorMonth varchar(20),
        @lastDayPriorMonth varchar(20)

select @firstDayPriorMonth = dbo.clariondate(dateadd(month, datediff(month, 0, @datetime) - 1, 0))
select @lastDayPriorMonth = dbo.clariondate(dateadd(month, datediff(month, 0, @datetime), -1))

declare @wt table(accountCode varchar(60), accountDesc varchar(50),comment2 varchar(50),amount money)

declare @investments table(bankaccountcode varchar(60),fundaccountcode varchar(60),interestTo varchar(60),amount money)
declare @investmentTotal table(interestTo varchar(60),amount money)

insert @investments
 select distinct bankAccountCode,fundDrawnOnCode,'',0 from dbo.investmentheader where (isnull(liquidationdate,0)=0 or liquidationdate>@lastDayPriorMonth) and purchaseDate<=@lastDayPriorMonth

delete from @investments where fundAccountCode not in (select accountcode from glaccounts where accounttype in (select accounttype from dbo.glbankfundtypes('FUND') where accounttype<>'OFFICIAL'))

 update i set i.amount=g.amount from @investments i,
(select sum(amount) as amount,accountcode 
 from gldetail 
 where [date]<=cast(@lastDayPriorMonth as int)
  and accountcode in (select bankaccountcode from @investments)
 group by accountcode
) g
where i.bankAccountCode=g.accountcode
 
 update i set interestTo = a.b7 from @investments i, glaccounts a where i.fundaccountcode = a.accountcode

insert @investmentTotal
  select interestTo, sum(amount)
 from @investments
 group by interestTo

insert @wt 
select a.interesttoaccountcode as interestTo,'' as accountDesc, case when comment2 <> w.accountDesc and @schoolfund='SPLIT' then comment2 else '' end as comment2,total
from dbo.apportionmentSchoolPagesDetailByFund(@firstDayPriorMonth, @lastDayPriorMonth, 'FALSE') w, glaccounts a
 where w.accountCode=a.accountCode 
  and w.accountType <> 'SCHOOL TOTAL'

insert @rt 
 select 'Apportionment',datepart(mm,dbo.date1(@firstDayPriorMonth)),datepart(yyyy,dbo.date1(@lastDayPriorMonth)), w.accountcode, a.accountDesc, w.comment2, sum(w.amount) as amount,'' ,''
 from @wt w, glaccounts a 
 where w.accountCode=a.accountCode
 group by w.accountcode, a.accountDesc, w.comment2
 having sum(w.amount) <> 0.00
 
insert @rt
 select 'Balance '+o.b3,datepart(mm,dbo.date1(@firstDayPriorMonth)),datepart(yyyy,dbo.date1(@lastDayPriorMonth)), a.interesttoaccountcode, ita.accountDesc, '', sum(g.amount)*-1, o.a4, o.b3
   from object o, gldetail g, glaccounts a, glaccounts ita
    where o.typ=4601 
     and g.accountcode=o.a3
     and a.accountcode = o.a3
     and ita.accountCode = a.interesttoaccountcode
     and g.[date]<= cast(@lastDayPriorMonth as int)
    group by o.b3, a.interesttoaccountcode, ita.accountDesc, o.a4
    having sum(g.amount) <> 0.00

--Johnstons General Balance Routine
insert @rt
select 'GENERAL BALANCE',datepart(mm,dbo.date1(@firstDayPriorMonth)),datepart(yyyy,dbo.date1(@lastDayPriorMonth)),accountcode,accountdesc,comment2,amount,bankaccount,bankdesc from @rt where accountcode in (
    select accountcode from glaccounts where accounttype in ('SCHOOL','CITY','VOTECH')
)

insert @rt
 select 'GENERAL BALANCE',datepart(mm,dbo.date1(@firstDayPriorMonth)),datepart(yyyy,dbo.date1(@lastDayPriorMonth)), a.accountcode, a.accountDesc, '', 
  sum(g.amount)*-1 - isnull((select amount from @investmentTotal where interestTo=a.accountcode),0),
   '', ''
   from gldetailreports g, glaccounts a
    where g.[sourcedate]<= @lastDayPriorMonth
     and g.accountcode=a.accountcode
     and a.b7 = a.accountcode 
     and a.accounttype in (select accounttype from dbo.glbankfundtypes('FUND'))
    group by a.accountcode, a.accountDesc
    having sum(g.amount) <> 0.00

insert @rt
 select 'GENERAL BALANCE',datepart(mm,dbo.date1(@firstDayPriorMonth)),datepart(yyyy,dbo.date1(@lastDayPriorMonth)), ita.accountcode, ita.accountDesc, '', 
 (sum(g.amount)*-1
 -
 isnull((select sum(amount) from @rt where tableType='GENERAL BALANCE'),0))
 - isnull((select i.amount from @investmentTotal i where (i.interestTo=ita.accountcode or isnull(i.interestTo,'')<'     0')),0)
 , '', ''
   from gldetailreports g, glaccounts ita, 
   (select max(interesttoaccountcode) as accountcode from glaccounts 
    where accounttype in (select accounttype from dbo.glbankfundtypes('FUND'))
     and accounttype <> 'OFFICIAL'
     and b7 <> accountcode 
     and b7>' 0') itacct
    where g.[sourcedate]<= @lastDayPriorMonth
     and itacct.accountcode=ita.accountcode
     and g.accounttype <> 'OFFICIAL'
     and g.accounttype in (select accounttype from dbo.glbankfundtypes('FUND'))
    group by ita.accountcode, ita.accountDesc
    having sum(g.amount) <> 0.00

 
 return
end