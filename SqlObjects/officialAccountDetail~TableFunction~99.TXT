create function dbo.officialAccountDetail(@begindate varchar(20),@enddate varchar(20)) 
returns @rt table(accountCode varchar(60),
                  detailDate varchar(60),
                  registerNumber varchar(60),
                  officerNumber varchar(60),
                  person varchar(60),
                  purpose varchar(60),
                  creditmemo money,
                  deposits money,
                  withdrawals money,
                  balance money,
                  DeptNo varchar(60),
                  OfficerName varchar(60),
                  OfficerTitle varchar(60))
as
begin
insert @rt
select * from (

select accountCode,@begindate as sourceDate,'' as sourcekey1,'' as sourcekey3,'' as person,'BeginBalance' as purpose,0 as creditmemo,0 as deposits,0 as withdrawals,sum(amount*-1) as balance,'' as DeptNo,'' as OfficerName,'' as OfficerTitle from dbo.gldetailreports where sourceDate<@begindate group by accountCode

union all     

select accountCode,
   sourcedate,
   sourcekey1,
   sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   'Cancel' as purpose,
   amount*-1 as creditmemo,
   0 as deposits,
   0 as withdrawals,
   0 as balance 
   ,'' as DeptNo,'' as OfficerName,'' as OfficerTitle
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType = '4771'
     and credit > ' 0'
     
union all

select accountCode,
   sourcedate,
   sourcekey1,
   sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   0 as creditmemo,
   0 as deposits,
   amount*-1 as withdrawals,
   0 as balance  
   ,'' as DeptNo,'' as OfficerName,'' as OfficerTitle
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType = '4771'
     and debit > ' 0'
     
union all

select accountCode,
   sourcedate,
   sourcekey1,
   '' as sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   0 as creditmemo,
   amount*-1 as deposits,
   0 as withdrawals,
   0 as balance  
   ,'' as DeptNo,'' as OfficerName,'' as OfficerTitle
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType in ('4522','4502')
     
union all

select accountCode,
   sourcedate,
   sourcekey1,
   '' as sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   amount*-1 as creditmemo,
   0 as deposits,
   0 as withdrawals,
   0 as balance  
   ,'' as DeptNo,'' as OfficerName,'' as OfficerTitle
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType not in ('4522','4502','4771')
) a order by balance desc,sourcedate,deposits desc,sourcekey1,sourcekey3

update r
 set DeptNo=o.a1,
     OfficerName=o.key2,
     OfficerTitle=o.key3
 from @rt r, object o where o.typ=4601 and o.a3=r.accountCode


return
end     
