create proc dbo.apiLooper(
 @resource varchar(50)
) as
begin
 SET DEADLOCK_PRIORITY LOW
 
 declare
  @sql nvarchar(max),
  @result varchar(max),
  @method varchar(50) = 'JOB',
  @dropRawFile varchar(5) = 'TRUE'

 declare @availableResources table(
  name varchar(50)
 )
 insert @availableResources select 'Invoices'
 insert @availableResources select 'Taxroll'
 insert @availableResources select 'Receipts'
 insert @availableResources select 'Legal'
 insert @availableResources select 'MortgageCodes'
 insert @availableResources select 'MortgageLinks'
 insert @availableResources select 'TaxRollInvoicing'


 if @resource in (select name from @availableResources)
 begin

  set @sql = 'dbo.api' + @resource + ' @method=''JOB'', @dropRawFile=''True'''

  while 1 = 1
  begin
   if dbo.settingsF('api.looperEnabled','FALSE') = 'FALSE'
    break

   if (select stale from dbo.apiControlBRW() where resource = @resource) = 0
    break
   
   if @resource = 'Invoices'
    exec dbo.apiInvoices @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT
   if @resource = 'Taxroll'
    exec dbo.apiTaxroll @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT
   if @resource = 'Receipts'
    exec dbo.apiReceipts @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT
   if @resource = 'Legal'
    exec dbo.apiLegal @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT
   if @resource = 'MortgageCodes'
    exec dbo.apiMortgageCodes @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT
   if @resource = 'MortgageLinks'
    exec dbo.apiMortgageLinks @method = @method, @dropRawFile = @dropRawFile, @result = @result OUTPUT

  end

 end

end
