create function dbo.rpMonthEndDetail(
 @beginDate int,
 @endDate int,
 @includeUnapportioned varchar(10)
) returns @rt table(
 accountType varchar(50),
 accountId int,
 accountCode varchar(60),
 accountDesc varchar(50),
 comment varchar(50),
 comment2 varchar(50),
 sourceCode varchar(60),
 amount money,
 journalType varchar(50),
 sourceDesc varchar(50),
 sourceSECA varchar(50),
 journalDesc varchar(50),
 monthEndCategory varchar(50),
 apportiondate varchar(50),
 apportionContraCode varchar(50)
) as
begin


 if @includeUnapportioned = 'PROTEST'
  begin
   declare @protestAccountId int
   select top 1 @protestAccountId = accountId 
    from glaccounts 
    where right(accountcode,7)='PROTEST' 
      and accountId in (select contraId from gldetail where isnull(bsId,0)=0)
      and isnumeric(left(accountcode,4))=1
    order by accountcode desc

   insert @rt 
   select
    b.accountType,
    a.accountId,
    a.creditCode as accountCode,
    b.accountDesc,
    comment,
    a.stepDesc as comment2, 
    a.sourceCode,
    sum(amount*-1) as amount,
    'APPORTIONMENT' as journalType,
    '' as sourceDesc,
    '' as  sourceSECA,
    left(a.contraAccountDesc,4)+' ADVALOREM' as journalDesc,
    '' as monthEndCategory,
    @enddate as apportiondate,
    a.contraAccountCode
   from (select * from apportioncollectionsWT(@protestAccountId,@endDate,'', null, null)) a, glAccounts b
   where a.creditCode=b.accountCode
    and b.accountType not in ('EXPENSE')
   group by b.accountType, a.accountId, a.creditCode, b.accountDesc, a.comment, a.stepDesc, a.sourceCode, a.contraAccountDesc, a.contraAccountCode
   having sum(amount)<>0.00
 
   insert @rt 
   select
    b.accountType,
    a.accountId, 
    a.debitCode as accountCode,
    b.accountDesc,
    comment,
    a.stepDesc as comment2, 
    a.sourceCode,
    sum(amount*-1) as amount,
    'APPORTIONMENT' as journalType,
    '' as sourceDesc,
    '' as  sourceSECA,
    left(a.contraAccountDesc,4)+' ADVALOREM' as journalDesc,
    '' as monthEndCategory,
    @enddate as apportiondate,
    a.contraAccountCode
   from (select * from apportioncollectionsWT(@protestAccountId,@endDate,'', null, null)) a, glAccounts b
   where a.debitCode=b.accountCode
    and b.accountType not in ('EXPENSE')
   group by b.accountType, a.accountId, a.debitCode, b.accountDesc, a.comment, a.stepDesc, a.sourceCode, a.contraAccountDesc, a.contraAccountCode
   having sum(amount)<>0.00 

  end
 else
 begin
  insert @rt 
  select
   b.accountType,
   a.accountId,
   a.accountCode,
   a.accountDesc,
   comment,
   a.comment2,
   a.sourceCode,
   sum(amount) as amount,
   c.journalType,
   '' as sourceDesc,
   '' as  sourceSECA,
   o.key3 as journalDesc,
   '' as monthEndCategory,
   o.key2 as apportiondate,
   a.apportionContraCode
  from gldetail a, glAccounts b, (select * from dbo.rpMonthEndSLinks(@beginDate,@endDate)) c, object o  
  where o.typ=4512
   and left(slink,1)='o' and dbo.slinkId(slink)=o.id
   and a.accountCode=b.accountCode 
   and slink = c.journalSlink
   and accountType not in ('EXPENSE')
  group by b.accountType, a.accountId, a.accountCode, a.accountDesc, a.comment, a.comment2, a.sourceCode, c.journalType, o.key3, o.key2, a.apportionContraCode
  having sum(amount)<>0.00  

  if @includeUnapportioned = 'TRUE'
  begin 

   insert @rt 
   select
    b.accountType,
    a.accountId,
    a.creditCode as accountCode,
    b.accountDesc,
    comment,
    a.stepDesc as comment2, 
    a.sourceCode,
    sum(amount) as amount,
    'APPORTIONMENT' as journalType,
    '' as sourceDesc,
    '' as  sourceSECA,
    a.contraAccountDesc as journalDesc,
    '' as monthEndCategory,
    @enddate as apportiondate,
    a.contraAccountCode
   from (select * from apportioncollectionsWT(0,@endDate,'', null, null)) a, glAccounts b
   where a.creditCode=b.accountCode
    and b.accountType not in ('EXPENSE')
   group by b.accountType, a.accountId, a.creditCode, b.accountDesc, a.comment, a.stepDesc, a.sourceCode, a.contraAccountDesc, a.contraAccountCode
   having sum(amount)<>0.00
 
   insert @rt 
   select
    b.accountType,
    a.accountId, 
    a.debitCode as accountCode,
    b.accountDesc,
    comment,
    a.stepDesc as comment2, 
    a.sourceCode,
    sum(amount) as amount,
    'APPORTIONMENT' as journalType,
    '' as sourceDesc,
    '' as  sourceSECA,
    a.contraAccountDesc as journalDesc,
    '' as monthEndCategory,
    @enddate as apportiondate,
    a.contraAccountCode
   from (select * from apportioncollectionsWT(0,@endDate,'', null, null)) a, glAccounts b
   where a.debitCode=b.accountCode
    and b.accountType not in ('EXPENSE')
   group by b.accountType, a.accountId, a.debitCode, b.accountDesc, a.comment, a.stepDesc, a.sourceCode, a.contraAccountDesc, a.contraAccountCode
   having sum(amount)<>0.00 
  end
 end

 update a set
  sourceDesc = b.accountDesc,
  sourceSECA = b.SECA,
  monthEndCategory = b.monthEndCategory
 from @rt a, glaccounts b
 where len(a.sourceCode) > 2
  and  a.sourceCode=b.accountCode


 return
end
