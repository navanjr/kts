create procedure dbo.journalEntryDetailImport ( @jeId int, @adjustToFlag varchar(10) = 'FALSE') as
begin

 exec dbo.logit @@procid, '@jeId', @jeId

 declare @wt table(
  id int identity(1,1),
  accountId int,
  amount money,
  comment varchar(50),
  processflag int
 )
 insert @wt select accountId, amount, comment, 0 from dbo.journalEntryBRW(@jeId, 0) where importFlag = 1
 
 declare 
  @idToken int,
  @accountIdToken int,
  @amountToken money,
  @commentToken varchar(500),
  @currentAccountBalance money,
  @endDate varchar(50)

 select @endDate = key2 from object where typ=4512 and id=@jeId

 while exists( select * from @wt where processFlag = 0 )
 begin
  select top 1 
   @idToken = id,
   @accountIdToken = accountId,
   @amountToken = amount,
   @commentToken = comment
  from @wt where processFlag = 0

  if @adjustToFlag = 'TRUE'
  begin
   select @currentAccountBalance = sum(amount) from gldetailreports where accountId=@accountIdToken and sourcedate<=@endDate
   select @amountToken = @amountToken - isnull(@currentAccountBalance,0)   
  end

  exec dbo.glDetailStageAdd @jeId, 'o', @accountIdToken, @amountToken, @comment = @commentToken
 
  update @wt set processFlag = 1 where id = @idToken
 end

end