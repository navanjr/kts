create function dbo.receiptDetailBRW(@receiptId int, @showGL int, @showFunds int) returns 
@rettable table(
 ord varchar(80),
 id int,
 description varchar(100), 
 subdescription varchar(100), 
 amount money,
 sName varchar(100),
 fName Varchar(100),
 adtaxId int,
 origin int,
 colorFlag int,
 subDescription2 varchar(125),
 trustAccount varchar(50),
 trustAccountDesc varchar(50) 
)
begin

 declare @styp char(1) = 'o'
 declare @slink varchar(15) = @styp + cast(@receiptId as varchar),
         @receiptTyp int,
         @receiptAccount varchar(60),
         @trustAccount varchar(60)

 select @receiptTyp=typ, @receiptAccount = a2 from object where id = @receiptId
 select top 1 @trustAccount = key3 from object where typ=4503 and key1='TRUST'

 insert @rettable (ord,id,description,subdescription,amount)
 select 'aa',cast('9'+cast(id as varchar) as int)*-1,description,lower(subDescription),amount from receiptDetail where slink = @slink 
 if isnull(@showFunds,0) = 1
 begin
  insert @rettable (ord,id,description,subdescription,amount)
  select 'aa1',cast('9'+cast(r.id as varchar) as int)*-1,
         '     '+rtrim(s.accountdesc),
         '     '+rtrim(f.accountdesc),
         amount 
   from receiptDetail r, glaccounts s, glaccounts f 
   where r.slink = @slink 
     and s.accountcode = r.sourceCode
     and f.accountcode = r.fundCode
 end
 
 update @rettable 
      set sName = dbo.proper(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)+' / '+accountDesc),subDescription2 = dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=SUBSTRING(subdescription,1,charindex('/',subdescription)-1) and ord<>'aa1'

  update @rettable 
      set fName = left(dbo.proper(SUBSTRING(subdescription,charindex('/',subdescription)+1,50)+' / '+accountDesc),50),subDescription2 = subDescription2 +'/'+ dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=SUBSTRING(subdescription,charindex('/',subdescription)+1,50) and ord<>'aa1'

  update @rettable 
      set subDescription = subDescription2 where ord<>'aa1'



 if exists(select * from dbo.journalLink where receiptId = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bf1',0,'','',0,4
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bf2',0,'Journal(s)','',0,5

  insert @rettable (ord,id,description,subdescription,origin)
  select 'bf3'+cast(c.id as varchar)+'a',cast('4'+cast(c.id as varchar) as int)*-1,
   max(c.key1)+' '+max(c.a18),
   max(c.key3), 10
  from journalLink a, object c
  where a.jeId = c.ID
   and a.receiptId = @receiptId
  group by c.id
 end


 if exists(select * from dbo.receiptLink where receiptId = @receiptId)
 begin

  declare @invoices table(id int, due money)
  declare @receiptPostDate int
   select @receiptPostDate = case when isnumeric(key2)=1 then cast(key2 as int) else dbo.clariondate(getdate()) end from object where typ=4502 and id=@receiptId

  insert @invoices
   select distinct r.invoiceId, 
     isnull((select sum(amount) from gldetail where slink in (select slink from dbo.invoiceSLinks(r.invoiceId)) and [date]<=@receiptPostDate and accountcode in (select accountcode from glaccounts where accounttype='RECEIVABLE') and slink <> 'l'+cast(r.id as varchar)) ,0.00)
    from dbo.receiptLink r 
    where r.receiptId = @receiptId



  insert @rettable (ord,id,description,subdescription,amount,adtaxid,origin)
  select 'aa'+cast(c.id as varchar)+'a',cast('6'+cast(c.id as varchar) as int)*-1,
   max(c.name)+case when a.protestAmount>0.00 then ' Protesting: '+cast(a.protestAmount as varchar) else '' end
   +case when a.methodrate>1.00 then ' Apply: '+cast(a.methodrate as varchar) else '' end,
   max(c.parcel),
   i.due, max(c.taxrollId), 1
  from receiptLink a, receiptDetail b, invoices c, @invoices i
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.id=i.id
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount, i.due, a.methodrate

-- mobile home 

  insert @rettable (ord,id,description,colorFlag,origin)
  select a.ord + 'b',0,
   ' ** MOBILE HOME **',
   2,
   20
  from @rettable a, adtax b
  where a.adtaxid = b.id and a.origin = 1 and a.adtaxId > 0 and b.mfghomeassessed > 0

-- individual certificate

  insert @rettable (ord,id,description,colorFlag,origin)
  select a.ord + 'b',0,
   ' ** INDIVIDUAL CERTIFICATE **',
   2,
   20
  from @rettable a, object o
  where o.typ=4100 and o.key2='A' and o.key1=subdescription and subdescription>' 0'

  insert @rettable (ord,id,description,subdescription,origin)
  select 'aa'+cast(c.id as varchar)+'aa',cast('3'+cast(max(a.id) as varchar) as int)*-1,
   'Tax Year: '+cast(c.taxyear as varchar(4)),
   'Tax Receipt: '+a.receiptNumber, 2
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount, a.receiptNumber, c.taxyear

  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'aa'+cast(c.invoiceId as varchar)+'az',cast('7'+cast(max(c.id) as varchar) as int)*-1,
   max('   '+b.description),
   max('   '+lower(b.subDescription)),
   i.due,3
   from receiptLink a, receiptDetail b, invoices c, @invoices i
   where 't'+CAST(a.invoiceId as varchar) = b.slink
    and a.invoiceId = c.ID
    and receiptId = @receiptId
    and c.id=i.id
    and c.invoiceId > 0
  group by c.invoiceId, c.typ, i.due

 update @rettable 
      set sName = dbo.proper(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)+' / '+accountDesc),subDescription2 = dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=ltrim(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)) and  RIGHT(ord,2)='az' 

  update @rettable 
      set fName = left(dbo.proper(SUBSTRING(subdescription,charindex('/',subdescription)+1,50)+' / '+accountDesc),50),subDescription2 = subDescription2 +'/'+ dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=SUBSTRING(subdescription,charindex('/',subdescription)+1,50) and RIGHT(ord,2)='az' 

  update @rettable 
      set subDescription = subDescription2 where RIGHT(ord,2)='az'   

  if @showFunds = 1
  begin
-- get subInvoice and Invoices exclude tax invoice
  insert @rettable (ord,id,description,subdescription,amount,colorFlag)
  select
   'aa'+cast(case when c.invoiceId = 0 then c.id else c.invoiceId end as varchar)+'b',
   cast(case when isnull(b.fundCode,'') < '  0' then '5' else '5' end +cast(max(b.id) as varchar) as int) * -1,
   max('   fund: '+lower(isnull(b.fundCode,''))),
   '',  --max('   '+b.description),
   sum(b.amount),
   case when isnull(b.fundCode,'') < '  0' then 1 else 0 end
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
--   and c.invoiceId > 0
  group by c.id, c.invoiceId, c.typ, b.fundCode, b.id
  end
 end

-- here are all the payments applied
 if exists(select * from dbo.paid where slink = @slink)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'ba',0,'','',0,4
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bb',0,'Payment(s)','',0,5
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bc',cast('8'+cast(id as varchar) as int)*-1,'   '+paycode+case when isnull(depositId,0) > 0 then isnull((select ' dep#:'+key1+' '+dbo.date1(key2) from object where id = depositId),'') else '' end,case when len(checkno+''+drawnon+''+location)=0 then '' else checkno+'/'+drawnon+'/'+location end,amount,6 from dbo.paid where slink = @slink
 end
 if exists(select * from dbo.paid where officialDepositId = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bda',0,'','',0,7
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bdb',0,'Payment(s) - via Trust Receipt','',0,8
  insert @rettable (ord,id,description,subdescription,amount,origin,trustAccount)
  select 'bdc',cast('4'+cast(id as varchar) as int)*-1,'   '+paycode+case when isnull(depositId,0) > 0 then isnull((select ' dep#:'+key1+' '+dbo.date1(key2) from object where id = depositId),'') else '' end,case when len(checkno+''+drawnon+''+location)=0 then '' else checkno+'/'+drawnon+'/'+location end,amount,9,
  isnull((select a.accountcode 
 from gldetail g, glAccounts a 
 where g.slink=paid.slink
  and g.accountcode=a.accountcode 
  and a.accountType='OFFICIAL' 
),@trustAccount)
 from dbo.paid where officialDepositId = @receiptId
 update r set trustAccountDesc = a.accountdesc from @rettable r, glaccounts a where r.trustaccount=a.accountcode
 end


 if @showGl = 1
 begin
  if exists(select * from dbo.glDetailStage where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ca',0,'','',0,10
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'cb',0,'GL Detail (staged)','',0,2,11

   declare @stageScratch table(accountId int, amount money, accountType varchar(50), accountDesc varchar(50), ord varchar(50))
   insert @stageScratch
   select accountId, sum(amount),'','','' 
    from dbo.glDetailStage 
    where slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink)!='t')
    group by accountId 
   update a set
    a.accountType = b.accountType,
    a.accountDesc = b.accountDesc,
    a.ord = 'cc' + b.accountType
   from @stageScratch a, dbo.glAccounts b where a.accountId = b.accountId
   update @stageScratch set accountType = 'suspense', accountDesc = 'Temporary Suspense', ord = 'ccZsuspense' where isnull(accountId,0) = 0

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select ord,0,'   '+accountDesc,lower(accountType),sum(amount),12
   from @stageScratch
   group by accountType, accountDesc, ord

  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ca',0,'','',0,13
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'cb',0,'GL Detail (posted)','',0,2,14
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'cc'+b.subord,0,'   '+rtrim(a.accountDesc)+case when count(*)>1 then ' ('+CAST(COUNT(*) as varchar)+')' else '' end,lower(b.accountType),sum(a.amount),15
   from dbo.glDetail a, glaccounts b where a.accountId = b.accountId
    and a.slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink) not in ('t','j'))
   group by b.subord,a.accountDesc,lower(b.accountType)
  end

  if exists(select * from dbo.journalLink where receiptId = @receiptId)
  begin
   declare @journals table (
    slink varchar(15),
    realslink varchar(15),
    description varchar(50),
    subDescription varchar(50),
    subInvoiceId int,
    ord char(1)
   )

  -- get the journals
   insert @journals
   select
    'o'+cast(o.id as varchar) as slink,
    'j'+cast(j.id as varchar) as realslink,
    rtrim(key1)+' '+rtrim(a18) as description,
    rtrim(key3) as subDescription,
    o.id as invoiceId,
    'a' as ord
   from object o, journalLink j 
    where o.id=j.jeId 
      and j.receiptId = @receiptId

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ea',0,'','',0,16
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'eb',0,'GL Detail (posted via Journal Entry)','',0,2,17

  --Invoice Header
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + slink + ord + min(realslink) + 'a',
    0,
    '   ' + description,
    subDescription,
    0,18
   from @journals
   group by slink,description,subdescription, ord

  -- invoice GL Detail
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + c.slink + c.ord + max(c.realslink) + 'b',
    0,
    left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
    lower(b.accountType),
    sum(a.amount),19
   from dbo.glDetail a, glaccounts b, @journals c
   where a.accountCode = b.accountCode
    and a.slink in (c.slink,c.realslink)
   group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 
  end


  if exists(select * from dbo.receiptLink where receiptId = @receiptId)
  begin

   declare @taxInvoices table (
    slink varchar(15),
    realslink varchar(15),
    description varchar(50),
    subDescription varchar(50),
    subInvoiceId int,
    ord char(1)
   )

  -- get the taxInvoices
   insert @taxInvoices
   select
    slink,
    realslink,
    description,
    subDescription,
    invoiceId,
    ord
   from invoiceAll where id in (select invoiceId from receiptLink where receiptId = @receiptId)

   update @taxInvoices set description = (select top 1 description from receiptDetail where slink = realslink) 
   where description = 'sub invoice'

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ea',0,'','',0,16
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'eb',0,'GL Detail (posted via Tax Invoice)','',0,2,17

  --Invoice Header
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + slink + ord + min(realslink) + 'a',
    0,
    '   ' + description,
    subDescription,
    0,18
   from @taxInvoices
   group by slink,description,subdescription, ord

  -- invoice GL Detail
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + c.slink + c.ord + max(c.realslink) + 'b',
    0,
    left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
    lower(b.accountType),
    sum(a.amount),19
   from dbo.glDetail a, glaccounts b, @taxInvoices c
   where a.accountId = b.accountId
    and a.slink = c. realslink
   group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 

 
  end

 end

 return
end