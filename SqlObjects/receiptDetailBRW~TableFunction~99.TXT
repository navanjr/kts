create function dbo.receiptDetailBRW(@receiptId int, @showGL int) returns 
@rettable table(
 ord varchar(80),
 id int,
 description varchar(100), 
 subdescription varchar(100), 
 amount money,
 sName varchar(50),
 fName Varchar(50) 
)
begin

 declare @styp char(1) = 'o'
 declare @slink varchar(15) = @styp + cast(@receiptId as varchar)

 insert @rettable (ord,id,description,subdescription,amount)
 select 'aa',cast('9'+cast(id as varchar) as int)*-1,description,lower(subDescription),amount from receiptDetail where slink = @slink 
 
 update @rettable 
      set sName = dbo.proper(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)+' / '+accountDesc)  from glaccounts where accountCode=SUBSTRING(subdescription,1,charindex('/',subdescription)-1)

 update @rettable 
      set fName = left(dbo.proper(SUBSTRING(subdescription,charindex('/',subdescription)+1,50)+' / '+accountDesc),50)  from glaccounts where accountCode=SUBSTRING(subdescription,charindex('/',subdescription)+1,50)

 if exists(select * from dbo.receiptLink where receiptId = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount)
  select 'aa'+cast(c.id as varchar)+'a',cast('6'+cast(c.id as varchar) as int)*-1,
   max(c.name)+case when a.protestAmount>0.00 then ' Protesting: '+cast(a.protestAmount as varchar) else '' end,
   max(c.parcel),
   sum(b.amount)
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount

  insert @rettable (ord,id,description)
  select 'aa'+cast(c.id as varchar)+'aa',cast('6'+cast(c.id as varchar) as int)*-1,
   'Tax Receipt: '+a.receiptNumber
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount, a.receiptNumber

  insert @rettable (ord,id,description,subdescription,amount)
  select 'aa'+cast(c.invoiceId as varchar)+'b',cast('7'+cast(max(c.id) as varchar) as int)*-1,
   max('   '+b.description),
   max('   '+lower(b.subDescription)),
   sum(b.amount)
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.invoiceId > 0
  group by c.invoiceId, c.typ
 end

 if exists(select * from dbo.paid where slink = @slink)
 begin
  insert @rettable (ord,id,description,subdescription,amount)
  select 'ba',0,'','',0
  insert @rettable (ord,id,description,subdescription,amount)
  select 'bb',0,'Payment(s)','',0
  insert @rettable (ord,id,description,subdescription,amount)
  select 'bc',cast('8'+cast(id as varchar) as int)*-1,'   '+paycode,case when len(checkno+''+drawnon+''+location)=0 then '' else checkno+'/'+drawnon+'/'+location end,amount from dbo.paid where slink = @slink
 end

 if @showGl = 1
 begin
  if exists(select * from dbo.glDetailStage where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount)
   select 'ca',0,'','',0
   insert @rettable (ord,id,description,subdescription,amount)
   select 'cb',0,'GL Detail (staged)','',0

   declare @stageScratch table(accountId int, amount money, accountType varchar(50), accountDesc varchar(50), ord varchar(50))
   insert @stageScratch
   select accountId, sum(amount),'','','' 
    from dbo.glDetailStage 
    where slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink)!='t')
    group by accountId 
   update a set
    a.accountType = b.accountType,
    a.accountDesc = b.accountDesc,
    a.ord = 'cc' + b.accountType
   from @stageScratch a, dbo.glAccounts b where a.accountId = b.accountId
   update @stageScratch set accountType = 'suspense', accountDesc = 'Temporary Suspense', ord = 'ccZsuspense' where isnull(accountId,0) = 0

   insert @rettable (ord,id,description,subdescription,amount)
   select ord,0,'   '+accountDesc,lower(accountType),sum(amount)
   from @stageScratch
   group by accountType, accountDesc, ord

/*
   insert @rettable (ord,id,description,subdescription,amount)
   select 'cc'+b.accountType,0,'   '+a.accountDesc,lower(b.accountType),sum(a.amount)
   from dbo.glDetailStage a, glaccounts b where a.accountId = b.accountId
    and a.slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink)!='t')
   group by b.accountType, a.accountDesc
*/
  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount)
   select 'ca',0,'','',0
   insert @rettable (ord,id,description,subdescription,amount)
   select 'cb',0,'GL Detail (posted)','',0
   insert @rettable (ord,id,description,subdescription,amount)
   select 'cc'+b.subord,0,'   '+rtrim(a.accountDesc)+case when count(*)>1 then ' ('+CAST(COUNT(*) as varchar)+')' else '' end,lower(b.accountType),sum(a.amount)
   from dbo.glDetail a, glaccounts b where a.accountId = b.accountId
    and a.slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink)!='t')
   group by b.subord,a.accountDesc,lower(b.accountType)
  end

  if exists(select * from dbo.receiptLink where receiptId = @receiptId)
  begin

   declare @taxInvoices table (
    slink varchar(15),
    realslink varchar(15),
    description varchar(50),
    subDescription varchar(50),
    subInvoiceId int,
    ord char(1)
   )

  -- get the taxInvoices
   insert @taxInvoices
   select
    slink,
    realslink,
    description,
    subDescription,
    invoiceId,
    ord
   from invoiceAll where id in (select invoiceId from receiptLink where receiptId = @receiptId)

   update @taxInvoices set description = (select top 1 description from receiptDetail where slink = realslink) 
   where description = 'sub invoice'

   insert @rettable (ord,id,description,subdescription,amount)
   select 'ea',0,'','',0
   insert @rettable (ord,id,description,subdescription,amount)
   select 'eb',0,'GL Detail (posted via Tax Invoice)','',0

  --Invoice Header
   insert @rettable (ord,id,description,subdescription,amount)
   select
    'ec' + slink + ord + min(realslink) + 'a',
    0,
    '   ' + description,
    subDescription,
    0
   from @taxInvoices
   group by slink,description,subdescription, ord

  -- invoice GL Detail
   insert @rettable (ord,id,description,subdescription,amount)
   select
    'ec' + c.slink + c.ord + max(c.realslink) + 'b',
    0,
    left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
    lower(b.accountType),
    sum(a.amount)
   from dbo.glDetail a, glaccounts b, @taxInvoices c
   where a.accountId = b.accountId
    and a.slink = c. realslink
   group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 

 
  end

 end

 return
end