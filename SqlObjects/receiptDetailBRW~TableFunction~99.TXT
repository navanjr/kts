create function dbo.receiptDetailBRW(@receiptId int, @showGL int, @showFunds int) returns 
@rettable table(
 ord varchar(80),
 id int,
 description varchar(100), 
 subdescription varchar(100), 
 amount money,
 sName varchar(100),
 fName Varchar(100),
 adtaxId int,
 origin int,
 colorFlag int,
 subDescription2 varchar(125),
 trustAccount varchar(50),
 trustAccountDesc varchar(50), 
 sCode varchar(60),
 fCode varchar(60),
 blob varchar(max))
begin

 declare @styp char(1) = 'o'
 declare @slink varchar(15) = @styp + cast(@receiptId as varchar),
         @receiptTyp int,
         @receiptAccount varchar(60),
         @trustAccount varchar(60),
         @receiptKEY3 varchar(50),
         @useChartNumber varchar(5) = dbo.settingsf('site.use2017ChartofAccounts','FALSE')

 declare @paycodes table(paycode varchar(60), amount money)

 select @receiptTyp=typ, @receiptAccount = a2, @receiptKEY3 = key3 from object with (NOLOCK) where id = @receiptId
 select top 1 @trustAccount = key3 from object with (NOLOCK) where typ=4503 and key1='TRUST'

-- Bail if TAX receipt with too many items
 if @receiptKEY3 = 'TAX'
 begin
  declare @itemCount int
  select @itemCount = count(*) from receiptlink where receiptId = @receiptId
  if @itemCount > 2000
  begin
   insert @rettable (ord,id,description,subdescription,amount,colorflag)
    select 'aaa', 0, 'Maximum tax items exceeded', 'Please abandon and start over',0.00,0
   return
  end
 end



-- Insert MISC receiptdetail
 insert @rettable (ord,id,description,subdescription,amount,sCode,fCode)
 select 'aa',cast('9'+cast(id as varchar) as int)*-1,description,lower(subDescription),amount,sourcecode,fundcode from receiptDetail with (NOLOCK) where slink = @slink 

-- Insert Decision info
 insert @rettable (ord,id,description,subdescription)
  select 'ab1',0,requestnotes,approvednotes from dbo.securityDecisionView where slink = @slink and len(requestnotes)>0

 insert @rettable (ord,id,description,subdescription)
  select top 1 'ab0',0,'Security Decision Notes','' from dbo.securityDecisionView where slink = @slink and len(requestnotes)>0
   union 
  select top 1 'ab 0',0,'','' from dbo.securityDecisionView where slink = @slink and len(requestnotes)>0


-- Insert showfunds info
 if isnull(@showFunds,0) = 1
 begin
  insert @rettable (ord,id,description,subdescription,amount)
  select 'aa1',cast('9'+cast(r.id as varchar) as int)*-1,
         '     '+rtrim(s.accountdesc),
         '     '+rtrim(f.accountdesc),
         amount 
   from receiptDetail r with (NOLOCK), glaccounts s, glaccounts f 
   where r.slink = @slink 
     and s.accountcode = r.sourceCode
     and f.accountcode = r.fundCode
 end
 
 update @rettable 
      set sName = dbo.proper(case when @useChartNumber = 'TRUE' then chartnumber else sCode end+' / '+accountDesc),subDescription2 = dbo.padright(accountDesc,' ',12) from glaccounts 
  where accountCode=sCode and ord<>'aa1'

 update @rettable 
      set fName = left(dbo.proper(case when @useChartNumber = 'TRUE' then chartnumber else fCode end+' / '+accountDesc),50),subDescription2 = subDescription2 +'/'+ dbo.padright(accountDesc,' ',12) from glaccounts 
  where accountCode=fCode and ord<>'aa1'

  update @rettable 
      set subDescription = subDescription2 where ord<>'aa1'



-- Insert Message for MV Stamps Needed
 declare @mvStampRdTotal money,
         @mvStampTotal money,
         @mvStampDiff money

 select @mvStampRdTotal = isnull(sum(amount),0.00) 
  from receiptdetail with (NOLOCK) 
  where slink = @slink 
   and fundcode in (select accountcode from glaccounts where accounttype='PURPOSE' and code = 'MOTORSTAMP')

 select @mvStampTotal = isnull(sum(cast(a2 as money)),0.00) from object with (NOLOCK) where typ=4302 and link1 = @receiptId

 select @mvStampDiff = isnull(@mvStampRdTotal,0.00) - isnull(@mvStampTotal,0.00)

 if @mvStampDiff > 0.00 
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'az',0,'','',0,4
  insert @rettable (ord, id, description, subdescription, blob, colorFlag)
   select 'aza',-89999999,'MV Stamp Detail Needed...',dbo.formatCurr(@mvStampDiff),'@new=4302;@number='+cast(cast(@mvStampDiff/3.5 as int) as varchar)+';@amount='+cast(@mvStampDiff as varchar)+';', 1
 end

-- Insert MV Stamps
 if exists(select * from object with (NOLOCK) where typ=4302 and link1 = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'azb',0,'','',0,4
  insert @rettable (ord, id, description, amount)
   select 'azc', id, rtrim(cast(cast(a1 as int) as varchar))+' MV Stamps @ '+dbo.formatCurr(cast(key1 as money))+' ('+a3+'-'+a4+')', cast(a2 as money)
    from object with (NOLOCK) where typ=4302 and link1 = @receiptId
 end


-- Insert Message for Farm Stamps Needed
 declare @farmStampRdTotal money,
         @farmStampTotal money,
         @farmStampDiff money

 select @farmStampRdTotal = isnull(sum(amount),0.00) 
  from receiptdetail with (NOLOCK) 
  where slink = @slink 
   and fundcode in (select accountcode from glaccounts where accounttype='PURPOSE' and code = 'FARMSTAMP')

 select @farmStampTotal = isnull(sum(cast(a2 as money)),0.00) from object with (NOLOCK) where typ=4303 and link1 = @receiptId

 select @farmStampDiff = isnull(@farmStampRdTotal,0.00) - isnull(@farmStampTotal,0.00)

 if @farmStampDiff > 0.00 
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'az',0,'','',0,4
  insert @rettable (ord, id, description, subdescription, blob, colorFlag)
   select 'aza',-89999999,'Farm Stamp Detail Needed...',dbo.formatCurr(@farmStampDiff),'@new=4303;', 1
 end

-- Insert Farm Stamps
 if exists(select * from object with (NOLOCK) where typ=4303 and link1 = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'azb',0,'','',0,4
  insert @rettable (ord, id, description, amount)
   select 'azc', id, rtrim(cast(cast(a1 as int) as varchar))+' Farm Stamps @ '+dbo.formatCurr(cast(key1 as money))+' ('+a3+'-'+a4+')', cast(a2 as money)
    from object with (NOLOCK) where typ=4303 and link1 = @receiptId
 end

-- Insert Trust Vouchers
 if exists(select * from gldetail with (NOLOCK) where contraid = @receiptId and slink <> @slink and dbo.slinktype(slink)='o')
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'azd',0,'','',0,4
  insert @rettable (ord, id, description, subdescription, amount, blob)
   select 'aze', '-8'+cast(dbo.slinkId(slink) as varchar(15)), case when o.typ=4771 then 'Voucher #'+rtrim(o.key3) when o.typ=4512 then 'JE: '+rtrim(o.key1) else o.key1 end,
  case when o.typ=4771 then 'Vendor: '+rtrim(o.a2) when o.typ=4512 then 'Purpose: '+rtrim(o.a18) else o.key3 end,
    amount*-1,'@change=Y;'
    from gldetail g with (NOLOCK), object o with (NOLOCK) where g.contraid = @receiptId and g.slink <> @slink and o.id = dbo.slinkid(slink)
 end


 if exists(select * from dbo.journalLink with (NOLOCK) where receiptId = @receiptId)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bf1',0,'','',0,4
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bf2',0,'Journal(s)','',0,5

  insert @rettable (ord,id,description,subdescription,origin)
  select 'bf3'+cast(c.id as varchar)+'a',cast('4'+cast(c.id as varchar) as int)*-1,
   max(c.key1)+' '+max(c.a18),
   max(c.key3), 10
  from journalLink a with (NOLOCK), object c with (NOLOCK)
  where a.jeId = c.ID
   and a.receiptId = @receiptId
  group by c.id
 end


 if exists(select * from dbo.receiptLink with (NOLOCK) where receiptId = @receiptId)
 begin

  declare @invoices table(id int, due money)
  declare @receiptPostDate int
   select @receiptPostDate = case when isnumeric(key2)=1 then cast(key2 as int) else dbo.clariondate(getdate()) end from object with (NOLOCK) where typ=4502 and id=@receiptId

  insert @invoices
   select distinct r.invoiceId, 
     isnull((select sum(amount) from gldetail where slink in (select slink from dbo.invoiceSLinks(r.invoiceId)) and [date]<=@receiptPostDate and accountcode in (select accountcode from glaccounts where accounttype='RECEIVABLE') and slink <> 'l'+cast(r.id as varchar)) ,0.00)
    from dbo.receiptLink r with (NOLOCK) 
    where r.receiptId = @receiptId



  insert @rettable (ord,id,description,subdescription,amount,adtaxid,origin)
  select 'aa'+cast(c.id as varchar)+'a',cast('6'+cast(c.id as varchar) as int)*-1,
   max(c.name)+case when a.protestAmount>0.00 then ' Protesting: '+cast(a.protestAmount as varchar) else '' end
   +case when a.methodrate>1.00 then ' Apply: '+cast(a.methodrate as varchar) else '' end,
   max(c.parcel),
   i.due, max(c.taxrollId), 1
  from receiptLink a with (NOLOCK), receiptDetail b with (NOLOCK), invoices c with (NOLOCK), @invoices i
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.id=i.id
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount, i.due, a.methodrate

-- mobile home 

  insert @rettable (ord,id,description,colorFlag,origin)
  select a.ord + 'b',0,
   ' ** MOBILE HOME **',
   2,
   20
  from @rettable a, adtax b with (NOLOCK)
  where a.adtaxid = b.id and a.origin = 1 and a.adtaxId > 0 and b.mfghomeassessed > 0

-- individual certificate

  insert @rettable (ord,id,description,colorFlag,origin)
  select a.ord + 'b',0,
   ' ** INDIVIDUAL CERTIFICATE **',
   2,
   20
  from @rettable a, object o with (NOLOCK)
  where o.typ=4100 and o.key2='A' and o.key1=subdescription and subdescription>' 0'

  insert @rettable (ord,id,description,subdescription,origin)
  select 'aa'+cast(c.id as varchar)+'aa',cast('3'+cast(max(a.id) as varchar) as int)*-1,
   'Tax Year: '+cast(c.taxyear as varchar(4)),
   'Tax Receipt: '+a.receiptNumber, 2
  from receiptLink a with (NOLOCK), receiptDetail b with (NOLOCK), invoices c with (NOLOCK)
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
   and c.invoiceId < 1
  group by c.invoiceId, c.id, a.protestAmount, a.receiptNumber, c.taxyear

  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'aa'+cast(c.invoiceId as varchar)+'az',cast('7'+cast(c.id as varchar) as int)*-1,
   max('   '+b.description),
   max('   '+lower(b.subDescription)),
   i.due,3
   from receiptLink a with (NOLOCK), receiptDetail b with (NOLOCK), invoices c with (NOLOCK), @invoices i
   where 't'+CAST(a.invoiceId as varchar) = b.slink
    and a.invoiceId = c.ID
    and receiptId = @receiptId
    and c.id=i.id
    and c.invoiceId > 0
  group by c.invoiceId, c.typ, i.due, c.id

 update @rettable 
      set sName = dbo.proper(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)+' / '+accountDesc),subDescription2 = dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=ltrim(SUBSTRING(subdescription,1,charindex('/',subdescription)-1)) and  RIGHT(ord,2)='az' 

  update @rettable 
      set fName = left(dbo.proper(SUBSTRING(subdescription,charindex('/',subdescription)+1,50)+' / '+accountDesc),50),subDescription2 = subDescription2 +'/'+ dbo.padright(accountDesc,' ',12) from glaccounts where accountCode=SUBSTRING(subdescription,charindex('/',subdescription)+1,50) and RIGHT(ord,2)='az' 

  update @rettable 
      set subDescription = subDescription2 where RIGHT(ord,2)='az'   

  if @showFunds = 1
  begin
-- get subInvoice and Invoices exclude tax invoice
  insert @rettable (ord,id,description,subdescription,amount,colorFlag)
  select
   'aa'+cast(case when c.invoiceId = 0 then c.id else c.invoiceId end as varchar)+'b',
   cast(case when isnull(b.fundCode,'') < '  0' then '5' else '5' end +cast(max(b.id) as varchar) as int) * -1,
   max('   fund: '+lower(isnull(b.fundCode,''))),
   '',  --max('   '+b.description),
   sum(b.amount),
   case when isnull(b.fundCode,'') < '  0' then 1 else 0 end
  from receiptLink a with (NOLOCK), receiptDetail b with (NOLOCK), invoices c with (NOLOCK)
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
--   and c.invoiceId > 0
  group by c.id, c.invoiceId, c.typ, b.fundCode, b.id
  end
 end

-- here are all the payments applied
 if exists(select * from dbo.paid where slink = @slink)
 begin
  insert @paycodes select paycode, amount from dbo.paid where slink = @slink

  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'ba',0,'','',0,4
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bb',0,'Payment(s)','',0,5
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bc',cast('8'+cast(id as varchar) as int)*-1,'   '+paycode+case when isnull(depositId,0) > 0 then isnull((select ' dep#:'+key1+' '+dbo.date1(key2) from object where id = depositId),'') else '' end,case when len(checkno+''+drawnon+''+location)=0 then '' else checkno+'/'+drawnon+'/'+location end,amount,6 from dbo.paid with (NOLOCK) where slink = @slink
 end
 if exists(select * from dbo.paid where officialDepositId = @receiptId)
 begin
  insert @paycodes select paycode, amount from dbo.paid with (NOLOCK) where officialDepositId = @receiptId

  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bda',0,'','',0,7
  insert @rettable (ord,id,description,subdescription,amount,origin)
  select 'bdb',0,'Payment(s) - via Trust Receipt','',0,8
  insert @rettable (ord,id,description,subdescription,amount,origin,trustAccount)
  select 'bdc'+paycode,cast('4'+cast(id as varchar) as int)*-1,'   '+paycode+case when isnull(depositId,0) > 0 then isnull((select ' dep#:'+key1+' '+dbo.date1(key2) from object with (NOLOCK) where id = depositId),'') else '' end,case when len(checkno+''+drawnon+''+location)=0 then '' else checkno+'/'+drawnon+'/'+location end,amount,9,
  isnull((select top 1 a.accountcode 
 from gldetail g with (NOLOCK), glAccounts a 
 where g.slink=paid.slink
  and g.accountcode=a.accountcode 
  and a.accountType='OFFICIAL' 
),@trustAccount)
 from dbo.paid with (NOLOCK) where officialDepositId = @receiptId

  insert @rettable (ord,id,description,subdescription2,amount,origin)
  select 'bdc'+paycode+'z',0,'','   '+paycode+' TOTAL',sum(amount),99
 from dbo.paid with (NOLOCK) where officialDepositId = @receiptId
  group by paycode

 update r set trustAccountDesc = a.accountdesc from @rettable r, glaccounts a where r.trustaccount=a.accountcode
 end

-- Paycode totals
 if @receipttyp = 4522 and exists(select * from @paycodes)
 begin
  insert @rettable (ord,id,description,subdescription,amount,origin)
    select 'bpa',0,'','',0.00,98
  insert @rettable (ord,id,subdescription,amount,origin)
    select 'bpc',0,'         Total '+case when pc.deposittype in ('B','C','E') then 'EFT' when requireCheck='1' then 'Check' else p.paycode end,sum(p.amount),99 from @paycodes p, dbo.paycodes pc where p.paycode=pc.paycode group by case when pc.deposittype in ('B','C','E') then 'EFT' when requireCheck='1' then 'Check' else p.paycode end
 end



 if @showGl = 1
 begin
  if exists(select * from dbo.glDetailStage with (NOLOCK) where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ca',0,'','',0,10
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'cb',0,'GL Detail (staged)','',0,2,11

   declare @stageScratch table(accountId int, amount money, accountType varchar(50), accountDesc varchar(50), ord varchar(50))
   insert @stageScratch
   select accountId, sum(amount),'','','' 
    from dbo.glDetailStage with (NOLOCK) 
    where slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink)!='t')
    group by accountId 
   update a set
    a.accountType = b.accountType,
    a.accountDesc = b.accountDesc,
    a.ord = 'cc' + b.accountType
   from @stageScratch a, dbo.glAccounts b where a.accountId = b.accountId
   update @stageScratch set accountType = 'suspense', accountDesc = 'Temporary Suspense', ord = 'ccZsuspense' where isnull(accountId,0) = 0

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select ord,0,'   '+accountDesc,lower(accountType),sum(amount),12
   from @stageScratch
   group by accountType, accountDesc, ord

  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ca',0,'','',0,13
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'cb',0,'GL Detail (posted)','',0,2,14
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'cc'+b.subord,0,'   '+rtrim(a.accountDesc)+case when count(*)>1 then ' ('+CAST(COUNT(*) as varchar)+')' else '' end,lower(b.accountType),sum(a.amount),15
   from dbo.glDetail a with (NOLOCK), glaccounts b where a.accountId = b.accountId
    and a.slink in (select slink from dbo.receiptSLinks(@receiptId) where dbo.slinkType(slink) not in ('t','j'))
   group by b.subord,a.accountDesc,lower(b.accountType)
  end

  if exists(select * from dbo.journalLink with (NOLOCK) where receiptId = @receiptId)
  begin
   declare @journals table (
    slink varchar(15),
    realslink varchar(15),
    description varchar(50),
    subDescription varchar(50),
    subInvoiceId int,
    ord char(1)
   )

  -- get the journals
   insert @journals
   select
    'o'+cast(o.id as varchar) as slink,
    'j'+cast(j.id as varchar) as realslink,
    rtrim(key1)+' '+rtrim(a18) as description,
    rtrim(key3) as subDescription,
    o.id as invoiceId,
    'a' as ord
   from object o with (NOLOCK), journalLink j with (NOLOCK) 
    where o.id=j.jeId 
      and j.receiptId = @receiptId

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ea',0,'','',0,16
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'eb',0,'GL Detail (posted via Journal Entry)','',0,2,17

  --Invoice Header
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + slink + ord + min(realslink) + 'a',
    0,
    '   ' + description,
    subDescription,
    0,18
   from @journals
   group by slink,description,subdescription, ord

  -- invoice GL Detail
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + c.slink + c.ord + max(c.realslink) + 'b',
    0,
    left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
    lower(b.accountType),
    sum(a.amount),19
   from dbo.glDetail a with (NOLOCK), glaccounts b, @journals c
   where a.accountCode = b.accountCode
    and a.slink in (c.slink,c.realslink)
   group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 
  end


  if exists(select * from dbo.receiptLink with (NOLOCK) where receiptId = @receiptId)
  begin

   declare @taxInvoices table (
    slink varchar(15),
    realslink varchar(15),
    description varchar(50),
    subDescription varchar(50),
    subInvoiceId int,
    ord char(1)
   )

  -- get the taxInvoices
   insert @taxInvoices
   select
    slink,
    realslink,
    description,
    subDescription,
    invoiceId,
    ord
   from invoiceAll where id in (select invoiceId from receiptLink with (NOLOCK) where receiptId = @receiptId)

   update @taxInvoices set description = (select top 1 description from receiptDetail with (NOLOCK) where slink = realslink) 
   where description = 'sub invoice'

   insert @rettable (ord,id,description,subdescription,amount,origin)
   select 'ea',0,'','',0,16
   insert @rettable (ord,id,description,subdescription,amount,colorFlag,origin)
   select 'eb',0,'GL Detail (posted via Tax Invoice)','',0,2,17

  --Invoice Header
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + slink + ord + min(realslink) + 'a',
    0,
    '   ' + description,
    subDescription,
    0,18
   from @taxInvoices
   group by slink,description,subdescription, ord

  -- invoice GL Detail
   insert @rettable (ord,id,description,subdescription,amount,origin)
   select
    'ec' + c.slink + c.ord + max(c.realslink) + 'b',
    0,
    left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
    lower(b.accountType),
    sum(a.amount),19
   from dbo.glDetail a with (NOLOCK), glaccounts b, @taxInvoices c
   where a.accountId = b.accountId
    and a.slink = c. realslink
   group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 

 
  end

 end

 return
end