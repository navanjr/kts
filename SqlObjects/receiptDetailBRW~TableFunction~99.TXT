create function dbo.receiptDetailBRW(@receiptId int, @showGL int) returns 
@rettable table(
 ord varchar(50),
 id int,
 description varchar(50), 
 subdescription varchar(50), 
 amount money 
)
begin

 declare @styp char(1) = 'o'
 declare @slink varchar(15) = @styp + cast(@receiptId as varchar)

 insert @rettable
 select 'aa',cast('9'+cast(id as varchar) as int)*-1,description,lower(subDescription),amount from receiptDetail where slink = @slink

 if exists(select * from dbo.receiptLink where receiptId = @receiptId)
 begin
  insert @rettable
  select 'aa',0,
   max(c.NAME),
   max(c.PARCEL),
   sum(b.amount)
  from receiptLink a, receiptDetail b, invoices c
  where 't'+CAST(a.invoiceId as varchar) = b.slink
   and a.invoiceId = c.ID
   and receiptId = @receiptId
  group by c.id
 end

 if exists(select * from dbo.paid where slink = @slink)
 begin
  insert @rettable
  select 'ba',0,'','',0
  insert @rettable
  select 'bb',0,'Payment(s)','',0
  insert @rettable
  select 'bc',cast('8'+cast(id as varchar) as int)*-1,'   '+paycode,checkno,amount*-1 from dbo.paid where slink = @slink
 end

 if @showGl = 1
 begin
  if exists(select * from dbo.glDetailStage where slink = @slink)
  begin
   insert @rettable
   select 'ca',0,'','',0
   insert @rettable
   select 'cb',0,'GL Detail (staged)','',0
   insert @rettable
   select 'cc',0,'   '+a.accountDesc,lower(b.accountType),a.amount
   from dbo.glDetailStage a, glaccounts b where a.accountId = b.accountId and a.slink = @slink
  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rettable
   select 'ca',0,'','',0
   insert @rettable
   select 'cb',0,'GL Detail (posted)','',0
   insert @rettable
   select 'cc'+b.subord,0,'   '+a.accountDesc,lower(b.accountType),a.amount
   from dbo.glDetail a, glaccounts b where a.accountId = b.accountId and a.slink = @slink
  end

  if exists(select * from dbo.receiptLink where receiptId = @receiptId)
  begin

   declare @taxInvoices table (slink varchar(15))
   insert @taxInvoices select 't'+cast(id as varchar) from invoices where id in (select invoiceId from receiptLink where receiptId = @receiptId)

   insert @rettable
   select 'ea',0,'','',0
   insert @rettable
   select 'eb',0,'GL Detail (posted via Tax Invoice)','',0
   insert @rettable
   select 'ec'+a.slink+'b',0,'      '+a.accountDesc,lower(b.accountType),a.amount
   from dbo.glDetail a, glaccounts b where a.accountId = b.accountId and a.slink in (select slink from @taxInvoices)

   insert @rettable
   select 'ec'+a.slink+'a',0,'   '+b.name,b.parcel,0
   from @taxInvoices a, invoices b
   where a.slink = 't'+cast(b.id as varchar)
 
  end

 end

 return
end












