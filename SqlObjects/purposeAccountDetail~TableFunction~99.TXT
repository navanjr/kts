create function dbo.purposeAccountDetail(@begindate varchar(20),@enddate varchar(20)) 
returns @rt table(accountCode varchar(60),
                  detailDate varchar(60),
                  registerNumber varchar(60),
                  officerNumber varchar(60),
                  person varchar(60),
                  purpose varchar(60),
                  creditmemo money,
                  deposits money,
                  withdrawals money,
                  balance money,
                  DeptNo varchar(60),
                  OfficerName varchar(60),
                  OfficerTitle varchar(60),
                  purposeAmount money,
                  ord varchar(10))
as
begin
insert @rt
select accountCode,@begindate as sourceDate,'' as sourcekey1,'' as sourcekey3,'' as person,'BeginBalance' as purpose,0 as creditmemo,0 as deposits,0 as withdrawals,sum(amount) as balance,'' as DeptNo,'' as OfficerName,'' as OfficerTitle,0 as purposeAmount,'a' as ord 
from dbo.gldetailreports 
where sourceDate<@begindate 
 and accounttype='PURPOSE'
group by accountCode

insert @rt

select accountCode,
   sourcedate,
   sourcekey1,
   sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   'Cancel - '+left(sourcee1,50) as purpose,
   amount as creditmemo,
   0 as deposits,
   0 as withdrawals,
   0 as balance, 
   '' as DeptNo,
   '' as OfficerName,
   '' as OfficerTitle,
   0,
   'da'
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType = '4771'
     and amount < 0
 and accounttype='PURPOSE'
     
insert @rt

select accountCode,
   sourcedate,
   sourcekey1,
   sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   left(sourcee1,59) as purpose,
   0 as creditmemo,
   0 as deposits,
   amount as withdrawals,
   0 as balance,
   '' as DeptNo,
   '' as OfficerName,
   '' as OfficerTitle,
   0,
   'db'
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType = '4771'
     and amount > 0
 and accounttype='PURPOSE'
     
insert @rt

select accountCode,
   sourcedate,
   sourcekey1,
   '' as sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   0 as creditmemo,
   amount as deposits,
   0 as withdrawals,
   0 as balance,
   '' as DeptNo,
   '' as OfficerName,
   '' as OfficerTitle,
   0,
   'ba'
   from dbo.gldetailreports g
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType in ('4522','4502')
     and accountcode in (select key3 from object where typ=4503 and key1='TRUST')
 and accounttype='PURPOSE'
     
insert @rt

select accountCode,
   sourcedate,
   sourcekey1,
   '' as sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   0 as creditmemo,
   amount*-1 as deposits,
   0 as withdrawals,
   0 as balance,
   '' as DeptNo,
   '' as OfficerName,
   '' as OfficerTitle,
   0,
   'ba'
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType in ('4522','4502')
     and accountcode not in (select key3 from object where typ=4503 and key1='TRUST')
 and accounttype='PURPOSE'

insert @rt

select accountCode,
   sourcedate,
   sourcekey1,
   '' as sourcekey3,
   case when sourcetype in ('4502','4522') then sourcea1 when sourcetype in ('4771') then sourcea2 end as person,
   '' as purpose,
   amount*-1 as creditmemo,
   0 as deposits,
   0 as withdrawals,
   0 as balance, 
   '' as DeptNo,
   '' as OfficerName,
   '' as OfficerTitle,
   0,
   'c'
   from dbo.gldetailreports 
   where sourceDate>=@begindate 
     and sourceDate<=@enddate
     and sourceType not in ('4522','4502','4771')
 and accounttype='PURPOSE'

return
end     
