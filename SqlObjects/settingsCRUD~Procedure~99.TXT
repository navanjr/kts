create proc dbo.settingsCRUD(
 @settingName varchar(50) = null,
 @settingDescription varchar(500) = null,
 @settingValue varchar(150) = null,
 @settingId int = null,
 @method varchar(20) = 'POST',
 @verbose varchar(5) = 'FALSE',
 @parentId varchar(50) = '',
 @valueOut varchar(max) = null output
) as
begin
 set nocount on

 if @method = 'POST'
 begin

-- setup default settings Here
  declare @defaultSettings table(
   name varchar(50),
   value varchar(50),
   description varchar(500),
   parentId varchar(15)
  )

  insert @defaultSettings 
  select 'site.voucherPostDateEqualsVoucherDate', 'FALSE', 'Default the Vouchers postdate to the VoucherDate',
   'o' + cast((select top 1 id from object where typ = 40 order by id) as varchar)

  insert settings (settingName,settingValue,description,parentId)
  select * from @defaultSettings where name not in (select settingName from settings)

  if @@rowcount > 0
   exec dbo.logit @@procid, 'inserted default settings... @@rowCount', @@rowcount

-- back to the real POST
  if exists(select * from settings where settingName = @settingName)
   update settings set settingValue = @settingValue, parentId = case when @parentId>'  0' then @parentId else parentId end where settingName = @settingName
  else
   insert settings (settingName, settingValue, parentId) select @settingName, @settingValue, @parentId

 end

 if @method = 'TOGGLE'
 begin
  if @settingId is not null
   update settings set settingValue = coalesce( nullif(dbo.toggle(settingValue),''), settingValue) where id = @settingId
  else
   update settings set settingValue = coalesce( nullif(dbo.toggle(settingValue),''), settingValue) where settingName = @settingName
 end

 if @method = 'GET'
 begin
  if @settingId is null
  begin
   select @valueOut = settingValue from dbo.settings where settingName = @settingName
   if @verbose = 'TRUE'
    select @valueOut as settingValue
   return
  end
  else
  begin
   select @valueOut ='@name=' + settingName + ';@value=' + isnull(settingValue,'') + ';@description=' + isnull(description,'') +  ';'  from dbo.settings where id = @settingId
   if @verbose = 'TRUE'
    select @valueOut as settingValue
   return
  end
 end

 if @method = 'DELETE' and @settingId is not null
 begin
  delete settings where id = @settingId
 end

 if @method = 'POSTNAME' and @parentId>'  0'
 begin
  if exists(select * from settings where parentId = @parentId)
   update settings set settingName=@settingName+'.'+rtrim(substring(settingName,CHARINDEX('.',settingName)+1,len(settingName))) where parentId = @parentId
 end

 if @method = 'DELETEALL' 
 begin
  if exists(select * from settings where parentId = @parentId)
   delete from settings where parentId = @parentId
 end



end