create proc dbo.docFeeProcessingCRUD(
 @batchId int,
 @invoiceId int,
 @status varchar(50),
 @lcContinue varchar(50) = '' output,
 @invoiceDate int = null,
 @debugMode varchar(5) = 'FALSE'
) as
begin

 set nocount on

 declare @invoicesToProcess table(id int)
 declare @wt table(
  id int identity(1,1),
  invoiceId int,
  feeDescription varchar(50),
  source varchar(50),
  fund varchar(50),
  amount money
 )

 declare
  @tally int,
  @documentId int,
  @documentDate int,
  @documentName varchar(50),
  @processCode varchar(50),
  @tokenId int,
  @tokenInvoiceId int,
  @tokenInvoiceDate int,
  @tokenFeeDescription varchar(50),
  @tokenSource varchar(50),
  @tokenFund varchar(50),
  @tokenAmount money

 select 
  @documentId = documentId,
  @documentDate = documentDate,
  @documentName = documentName,
  @processCode = processCode
 from dbo.docBRWDecoder(@batchId)
 
 if @status in ('ALL','STAGEALL')
 begin
-- get all the invoices that are printed but not processed for fees

  insert @invoicesToProcess select invoiceId from dbo.docBatchBRW(@batchId, null, null)
   where printed > '  0' and invoiceId not in (select invoiceId from invoices where queue = @processCode and printed = @documentName)

  select @tally = @@rowcount

  exec dbo.logit @@procId, '@status', @status, '@batchId', @batchId, '@invoiceId', @invoiceId, '@tally', @tally

  if @status = 'STAGEALL'
  begin
   select '@code=1;@message=Stage Message;@tally=' + cast(@tally as varchar) + ';'
   return
  end

  insert @wt
  select
   i.id,
   f.key2,
   f.key3,
   f.a1,
   cast(f.a2 as money)
  from @invoicesToProcess i
  join object f on f.link1 = @documentId and typ = 4902

  select @tally = @@rowcount

  if @debugMode = 'TRUE'
  begin
   select * from @wt
   return
  end

  while exists(select * from @wt)
  begin
   select top 1 
    @tokenId = id,
    @tokenInvoiceId = invoiceId,
    @tokenInvoiceDate = coalesce(@invoiceDate, @documentDate),
    @tokenFeeDescription = feeDescription,
    @tokenSource = source,
    @tokenFund = fund,
    @tokenAmount = amount
   from @wt order by id

   exec dbo.subInvoiceCRUD
    @mainInvoiceId = @tokenInvoiceId,
    @invoiceDate = @tokenInvoiceDate,
    @description = @tokenFeeDescription,
    @sourceCode = @tokenSource,
    @fundCode  = @tokenFund,
    @amount = @tokenAmount,
    @printed = @documentName,
    @queue = @processCode,
    @tallyEcho = @tally
   
   delete @wt where id = @tokenId
   set @tally = @tally - 1
  end   

 end
 
end