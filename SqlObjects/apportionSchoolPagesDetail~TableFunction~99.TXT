create function dbo.apportionSchoolPagesDetail(@beginDate int, @endDate int, @includeUnapportioned varchar(10)) returns @sd table(id int identity(1,1),
  accountCode varchar(60), accountType varchar(60), 
  col1 money, col2 money, col3 money, col4 money, col5 money,
  col6 money, col7 money, col8 money, col9 money, col10 money,
  ada money, millcontribution money, milljoint money, milltotal money, total money, totalcheck money, journalDesc varchar(60), 
  heading1 varchar(60), heading2 varchar(60), heading3 varchar(60), heading4 varchar(60), heading5 varchar(60),
  heading6 varchar(60), heading7 varchar(60), heading8 varchar(60), heading9 varchar(60), heading10 varchar(60))
  as
  begin

declare @wd table(accountCode varchar(60), accountType varchar(60), 
  col1 money, col2 money, col3 money, col4 money, col5 money,
  col6 money, col7 money, col8 money, col9 money, col10 money,
  ada money, millcontribution money, milljoint money, milltotal money, total money, totalcheck money, journalDesc varchar(60), 
  heading1 varchar(60), heading2 varchar(60), heading3 varchar(60), heading4 varchar(60), heading5 varchar(60),
  heading6 varchar(60), heading7 varchar(60), heading8 varchar(60), heading9 varchar(60), heading10 varchar(60))

declare @head table(id int,
 ord int,
 heading varchar(60),
 accountCode varchar(60),
 accountDesc varchar(60),
 tableType varchar(60),
 toSchool varchar(1),
 toCity varchar(1),
 toVotech varchar(1))

declare @det table(
    id int identity(1,1),
	[accountType] [varchar](50) NULL,
	[accountId] [int] NULL,
	[accountCode] [varchar](60) NULL,
	[accountDesc] [varchar](50) NULL,
	[comment] [varchar](50) NULL,
	[comment2] [varchar](50) NULL,
	[sourceCode] [varchar](60) NULL,
	[amount] [money] NULL,
	[journalType] [varchar](50) NULL,
	[sourceDesc] [varchar](50) NULL,
	[sourceSECA] [varchar](50) NULL,
	[journalDesc] [varchar](50) NULL,
 monthEndCategory varchar(50),
 apportiondate varchar(50),
 apportionContraCode varchar(50)
)

insert @det
select * from rpMonthEndDetail(@beginDate,@endDate, @includeUnapportioned) 
 where isnull(sourceCode,'') > ' 0'
  and accountCode not in (select accountCode from glaccounts where bsSummary> ' 0')

update d set journalDesc = a.accountDesc from @det d, glaccounts a where d.apportionContraCode=a.accountcode and isnull(d.apportionContraCode,'')>' 0'
  
update d set comment2=left(comment2,len(b.heading)) from @det d, (select * from dbo.apportionHeadings()) b
   where b.heading=left(d.comment2, len(b.heading))

update @det set journalDesc=rtrim(journalDesc)+' SPECIAL' where journalType like '%SPECIAL%'

declare @types table(id int identity(1,1), accountType varchar(60), ord varchar(60), processflag int)
insert @types
 select distinct d.accountType, t.ord, 0 from @det d, (select * from dbo.glBankFundTypes('FUND')) t
  where t.accountType=d.accountType order by t.ord

declare @typetoken varchar(60), @headingtoken varchar(60)

while exists(select * from @types where processflag=0)
begin
 select top 1 @typetoken=accountType from @types where processflag=0 order by ord

 insert @head
  select * from dbo.apportionHeadings() where heading in (select comment2 from @det where accountType=@typetoken)
  union 
  select distinct 999,999,sourceDesc,accountCode,accountDesc,'','','','' from @det 
    where isnull(comment2,'Extra Headings')='Extra Headings'
     and accountType=@typetoken
   order by id
 
  update @det set comment2 = sourceDesc where isnull(comment2,'Extra Headings')='Extra Headings' and accountType=@typetoken
   
  insert @wd (accountType, accountCode, total, journalDesc)
  select accountType,accountCode,sum(amount*-1),journalDesc from @det 
   where isnull(accountCode,'Not Found') in (select accountCode from glAccounts)
--    and journalDesc like '%ADVALOREM%'
    and accountType=@typetoken
   group by accountType, accountCode, journalDesc
   
    update a set millcontribution=c.amount 
    from @wd a, 
    (select top 1 * from @head where tableType='A' order by id) b, 
    (select comment as accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by comment, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   select top 1 @headingtoken = heading from @head order by id
  
   update a set col1=c.amount, heading1=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)
     
   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col2=c.amount, heading2=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col3=c.amount, heading3=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col4=c.amount, heading4=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col5=c.amount, heading5=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col6=c.amount, heading6=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col7=c.amount, heading7=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col8=c.amount, heading8=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col9=c.amount, heading9=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken
   select top 1 @headingtoken = heading from @head order by id
   
   update a set col10=c.amount, heading10=b.heading 
    from @wd a, 
    (select * from @head where heading = @headingtoken) b, 
    (select accountCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by accountCode, comment2, journalDesc) c
    where a.accountCode = c.accountCode
     and a.journalDesc=c.journalDesc 
     and b.heading=c.comment2
     and c.accountCode in (select accountCode from glAccounts where accountType=@typetoken)

   delete from @head where heading=@headingtoken

 insert @sd 
  select * from @wd

 delete @head
 delete @wd 
 
 update @types set processflag=1 where accountType=@typetoken
end

 update a set totalcheck=isnull(col1,0)+isnull(col2,0)+isnull(col3,0)+isnull(col4,0)+isnull(col5,0)+isnull(col6,0)+isnull(col7,0)+
 isnull(col8,0)+isnull(col9,0)+isnull(col10,0) from @sd a


return 
end