create function dbo.dailyDataDeposits(@theDate int, @days int, @ordSeed varchar(50), @filterFlag varchar(10)) returns 
@rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 rowType char(10),
 brwBGColor int
)
begin

 declare @wt table(
  id int,
  ord varchar(50),
  reportOrder varchar(50),
  description varchar(50),
  subDescription varchar(50),
  minControlNumber varchar(50),
  maxControlNumber varchar(50),
  rowCnt int,
  amount money,
  glBalance money
 )
 declare @wtRaw table(
  id int,
  ord varchar(50),
  description varchar(50),
  subDescription varchar(50),
  depositNumber varchar(50),
  amount money,
  slink2 varchar(15),
  typ int
 )
  declare @accounts table(
  accountId int,
  collectionDescription varchar(50),
  reportOrder varchar(50)
 )

--check for grouping
declare @byAccount int = 0
 select @byAccount = a17 from object where typ = 4703 and key1 = 'Deposits & Disbursements'

-- get the bank accounts 
 insert @accounts select accountId,collectionDescription,reportOrder from dbo.glBankAccounts

-- insert all raw receipt data
 insert @wtRaw
 select
  b.accountId,
  a.reportOrder,
  b.accountCode,
  b.accountDesc,
  c.key1,
  b.amount,
  b.slink,
  c.typ
 from @accounts a, glDetail b, object c
 where a.accountId = b.accountId
  and c.typ in (4513,4771)
  and dbo.slinkType(b.slink) = 'o'
  and dbo.slinkId(b.slink) = c.id
  and case when isnumeric(c.key2)=1 then cast(c.key2 as int) else 0 end between @theDate and @theDate + @days

 insert @wtRaw
 select
  b.accountId,
  a.reportOrder,
  b.accountCode,
  b.accountDesc,
  c.key1,
  b.amount,
  b.slink,
  c.typ
 from @accounts a, glDetail b, object c
 where a.accountId = b.accountId
  and c.typ in (4512) and c.a18='Miscellaneous Deposit'
  and dbo.slinkType(b.slink) = 'o'
  and dbo.slinkId(b.slink) = c.id
  and case when isnumeric(c.key2)=1 then cast(c.key2 as int) else 0 end between @theDate and @theDate + @days

if @byAccount = 1
begin

-- this will get just the account
 insert @wt
 select
  id,
  ord + cast(id as varchar) + 'a',
  ord,
  description,
  subDescription,
  null,
  null,
  null,
  null,
  0
 from @wtRaw
 group by
  id,
  ord,
  description,
  subDescription
 order by ord

-- this will get both the deposit and disbursement rows
 insert @wt
 select
  0,
  ord + cast(id as varchar) + 'b',
  ord,
  description,
  case when typ = 4771 then '   Disbursements' else '   Deposits' end, --subDescription,
  min(depositNumber),
  max(depositNumber),
  COUNT(depositNumber),
  SUM(amount), -- removed abs()
  0
 from @wtRaw
 group by
  id,
  ord,
  description,
  subDescription,
  typ
 order by ord

--insert main data
 insert @rt
 select
  cast('9' + cast(id as varchar) as int),
  @ordSeed + ord + '', -- removed b
  dbo.dailyDataFormatCollections(subDescription,minControlNumber,maxControlNumber,rowCnt,amount),
  dbo.padLeft(convert(varchar,glBalance,1),' ',16),
  '   ' + dbo.padRight(subDescription,' ',61),  
  case when minControlNumber is null then '' else dbo.padLeft(minControlNumber, 0, 5) + ' - ' + dbo.padLeft(maxControlNumber, 0, 5) end,
  dbo.padLeft(cast(rowCnt as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,amount,1),' ',16),
  'detail',0
 from @wt

 -- headers
 insert @rt select 0,@ordSeed+'00a','','','','','','','lineFeed',0
 insert @rt select 0,@ordSeed+'00aa','  Deposits & Disbursements','','  Deposits & Disbursements','','','','sHeader',1
 insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0


-- get the balance of the accounts
 update a set a.glBalance = (select sum(amount) from glDetail where accountId = a.id) from @wt a

-- insert subtotals
 insert @rt
 select
  0,
  @ordSeed + reportOrder + cast(max(id) as varchar) + 'c',
  ' ' + replicate('-',79),
  replicate('-',16),
  ' ' + replicate('-',79),
  replicate('-',22),
  replicate('-',10),
  replicate('-',16),
  'line',0
 from @wt 
 group by reportOrder,description

 insert @rt
 select
  0,
  @ordSeed + reportOrder + cast(max(id) as varchar) + 'd',
  dbo.padRight('      Total ' + description, ' ', 60)
  + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
  + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
  '',
  dbo.padRight('      Total ' + description, ' ', 60),
  '',
  dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
  'gFooter',0
 from @wt 
 group by reportOrder,description


 insert @rt
 select
  0,
  @ordSeed + reportOrder + cast(max(id) as varchar) + 'e',
  replicate(' ',80),
  '',
  '',
  '',
  '',
  '',
  'lineFeed',0
 from @wt 
 group by reportOrder,description

-- insert grand total
 if exists(select * from @wt)
 begin
  insert @rt select 0,@ordSeed+'ZZZZZ'+'dza',dbo.padLeft(replicate('=',20),' ',80),replicate('=',16),dbo.padLeft(replicate('=',20),' ',80),replicate('=',22),replicate('=',10),replicate('=',16),'line',0

  insert @rt
  select
   0,
   @ordSeed + 'ZZZZZ' + 'dzb',
   dbo.padLeft('Total Deposits & Disbursements ', ' ', 60)
   + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
   + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   dbo.padLeft(convert(varchar,sum(glBalance),1), ' ', 16),
   dbo.padLeft('Total Deposits & Disbursements  ', ' ', 35),
   '',
   dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
   dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   'grandTotal',0
  from @wt 
 end

end 
else
begin
 insert @wt
 select
  id,
  ord  + case when typ = 4771 then 'Dis' else 'Dep' end + CAST(id as varchar) + 'b',
  ord,
  case when typ = 4771 then 'Disbursements' else 'Deposits' end,
  '   '+subDescription,
  min(depositNumber),
  max(depositNumber),
  COUNT(depositNumber),
  SUM(amount), -- removed abs()
  0
 from @wtRaw
 group by
  id,
  ord,
  case when typ = 4771 then 'Disbursements' else 'Deposits' end,
  subDescription,
  typ
  order by ord
  
insert @wt (id,ord,reportOrder,description,subDescription)
 select
  0,
  ord  + case when typ = 4771 then 'Dis' else 'Dep' end + '000' + 'a',
  ord,
  case when typ = 4771 then 'Disbursements' else 'Deposits' end,
  case when typ = 4771 then 'Disbursements' else 'Deposits' end
 
 from @wtRaw
 group by
  typ,
  ord
  
--insert main data
 insert @rt
 select
  cast('9' + cast(id as varchar) as int),
  @ordSeed + ord + '', -- removed b
  dbo.dailyDataFormatCollections(subDescription,minControlNumber,maxControlNumber,rowCnt,abs(amount)),
  dbo.padLeft(convert(varchar,glBalance,1),' ',16),
  '   ' + dbo.padRight(subDescription,' ',61),  
  case when minControlNumber is null then '' else dbo.padLeft(minControlNumber, 0, 5) + ' - ' + dbo.padLeft(maxControlNumber, 0, 5) end,
  dbo.padLeft(cast(rowCnt as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,abs(amount),1),' ',16),
  'detail',0
 from @wt

 -- headers
 insert @rt select 0,@ordSeed+'00a','','','','','','','lineFeed',0
 insert @rt select 0,@ordSeed+'00aa','  Deposits & Disbursements','','  Deposits & Disbursements','','','','sHeader',1
 insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0

 insert @rt
 select
  0,
  @ordSeed + reportOrder + substring(ord,len(reportOrder)+1,3) + cast(max(id) as varchar) + 'c',
  ' ' + replicate('-',79),
  replicate('-',16),
  ' ' + replicate('-',79),
  replicate('-',22),
  replicate('-',10),
  replicate('-',16),
  'line',0
 from @wt 
 group by reportOrder,description,substring(ord,len(reportOrder)+1,3)

 insert @rt
 select
  0,
  @ordSeed + reportOrder + substring(ord,len(reportOrder)+1,3) +  cast(max(id) as varchar) + 'd',
  dbo.padRight('      Total ' + description, ' ', 60)
  + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
  + dbo.padLeft(convert(varchar,abs(sum(amount)),1), ' ', 16),
  '',
  dbo.padRight('      Total ' + description, ' ', 60),
  '',
  dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,abs(sum(amount)),1), ' ', 16),
  'gFooter',0
 from @wt 
 group by reportOrder,description,substring(ord,len(reportOrder)+1,3)


 insert @rt
 select
  0,
  @ordSeed + reportOrder + substring(ord,len(reportOrder)+1,3) + cast(max(id) as varchar) + 'e',
  replicate(' ',80),
  '',
  '',
  '',
  '',
  '',
  'lineFeed',0
 from @wt 
 group by reportOrder,description,substring(ord,len(reportOrder)+1,3)

-- insert grand total
 if exists(select * from @wt)
 begin
  insert @rt select 0,@ordSeed+'ZZZZZ'+'dza',dbo.padLeft(replicate('=',20),' ',80),replicate('=',16),dbo.padLeft(replicate('=',20),' ',80),replicate('=',22),replicate('=',10),replicate('=',16),'line',0

  insert @rt
  select
   0,
   @ordSeed + 'ZZZZZ' + 'dzb',
   dbo.padLeft('Total Deposits & Disbursements ', ' ', 60)
   + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
   + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   dbo.padLeft(convert(varchar,sum(glBalance),1), ' ', 16),
   dbo.padLeft('Total Deposits & Disbursements  ', ' ', 35),
   '',
   dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
   dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   'grandTotal',0
  from @wt 
 end

update @rt set glBalanceString = ''

end



/*
 if exists(select * from @wt where description = 'Depository')
 begin
  declare @reportSub varchar(50)
  select @reportSub = max(ord) from @wt where description = 'Depository'
  insert @rt select 0,@ordSeed+@reportSub+'a','','','','','','','lineFeed'
  insert @rt select 0,@ordSeed+@reportSub+'aa','  Deposits by Officers','','  Deposits by Officers','','','','sHeader'
  insert @rt select 0,@ordSeed+@reportSub+'ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line'
 end
*/ 



 return
end