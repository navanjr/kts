create function dbo.depositPaidAndPosted() returns @rt table(
 id int,
 slink varchar(15),
 objLinkId int,
 receiptType varchar(50),
 receiptTypeId int,
 paycode varchar(10),
 checkno varchar(50),
 amount money,
 depositId int,
 depositDate int,
 parentControlNumber varchar(50),
 officialDepositId int,
 depositAccountCode varchar(50),
 origin int
)
begin

-- get the paid records that are linked to unposted receipts so we can filter them out of the results
 declare @unpostedPaid table( id int )
 insert @unpostedPaid select id from paid where dbo.slinkId(slink) not in (select id from object where typ in (4502,4522) and a17 = 'Posted')

-- get paid records that are not linked to a deposit
 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId, officialDepositId, origin)
  select id, slink, substring(slink,2,14), amount, paycode, checkno, depositId, officialDepositId, 1
   from paid 
   where isnull(depositId,0) = 0
    and slink is not null
    and id not in (select id from @unpostedPaid)
    and officialDepositId = 0

 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId, officialDepositId, origin)
  select id, 'o'+cast(officialDepositId as varchar(15)), officialDepositId, amount, paycode, checkno, depositId, officialDepositId, 2 
   from paid 
   where isnull(depositId,0) = 0
    and slink is not null
    and id not in (select id from @unpostedPaid)
    and officialDepositId > 0

-- get paid records that are linked to a deposit that is not yet posted
 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId, officialDepositId, origin)
  select id, slink, substring(slink,2,14), amount, paycode, checkno, depositId, officialDepositId, 3
   from paid
   where depositId in (select id from object where typ=4513 and a17 != 'Posted')
    and slink is not null
    and id not in (select id from @unpostedPaid)
    and officialDepositId = 0

 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId, officialDepositId, origin)
  select id, 'o'+cast(officialDepositId as varchar(15)), officialDepositId, amount, paycode, checkno, depositId, officialDepositId, 4
   from paid
   where depositId in (select id from object where typ=4513 and a17 != 'Posted')
    and slink is not null
    and id not in (select id from @unpostedPaid)
    and officialDepositId > 0

 update a set
  a.receiptType = b.key3,
  a.depositDate = cast(b.key2 as int),
  a.parentControlNumber = b.key1
 from @rt a, object b
 where a.objLinkId = b.id

 update a set
  a.receiptTypeId = b.id,
  a.depositAccountCode = b.key2
 from @rt a, object b
 where b.typ = 4503 and a.receiptType = b.key1

 update a set
  a.depositAccountCode = d.a4
 from @rt a
  join Object c on c.ID = dbo.slinkId(a.slink) and c.Typ = 4522
  join Object d on d.ID = c.Link2 and d.Typ = 4601

 return
end
