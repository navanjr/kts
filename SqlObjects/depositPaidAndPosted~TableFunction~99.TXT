create function dbo.depositPaidAndPosted() returns @rt table(
 id int,
 slink varchar(15),
 objLinkId int,
 receiptType varchar(50),
 receiptTypeId int,
 paycode varchar(10),
 checkno varchar(50),
 amount money,
 depositId int,
 depositDate int
)
begin

-- get the paid records that are linked to unposted receipts so we can filter them out of the results
 declare @unpostedPaid table( id int )
 insert @unpostedPaid select id from paid where dbo.slinkId(slink) not in (select id from object where typ in (4502,4522) and a17 = 'Posted')

-- get paid records that are not linked to a deposit
 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId)
  select id, slink, substring(slink,2,14), amount, paycode, checkno, depositId 
   from paid 
   where isnull(depositId,0) = 0
    and slink is not null
    and id not in (select id from @unpostedPaid)

-- get paid records that are linked to a deposit that is not yet posted
 insert @rt (id, slink, objLinkId, amount, paycode, checkno, depositId)
  select id, slink, substring(slink,2,14), amount, paycode, checkno, depositId
   from paid
   where depositId in (select id from object where typ=4513 and a17 != 'Posted')
    and slink is not null
    and id not in (select id from @unpostedPaid)

 update a set a.receiptType = b.key3, a.depositDate = cast(b.key2 as int)
 from @rt a, object b
 where a.objLinkId = b.id

 update a set a.receiptTypeId = b.id
 from @rt a, object b
 where b.typ = 4503 and a.receiptType = b.key1

 return
end
