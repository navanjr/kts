create proc dbo.diagFix_resaleRedeemed(
 @mode varchar(5) = 'heavy',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as
begin

----gather the data
  declare @resaleTaxyear varchar(5) = ''
   select @resaleTaxyear = MAX(realTaxYear)-3 from AdTax 
--Resale
declare @wt table(taxrollId int,invoiceIdMain int,display varchar(50),keycode varchar(50),invoiceBlob varchar(max),unPaid int null)
	insert @wt
	select id,invoiceIdMain,display, keyCode, invoiceBlob,null 
	 from dbo.collectionsBRW('RESALE',0,0,0,0) where id is not null order by display

	insert @wt
	select id,invoiceIdMain,display, keyCode, invoiceBlob,null 
	 from dbo.collectionsBRW('taxwarrant',0,0,0,0) where id is not null order by display

declare @tokenId int,@invoiceBlob varchar(max)
--select * from @wt
while
 exists(select * from @wt where unPaid is null)
 begin
  select top 1 @tokenId = taxrollId, @invoiceBlob = invoiceBlob from @wt where unPaid is null
  if @tokenId>0
  begin
   update @wt set unPaid = (select count(id) from dbo.split(invoiceBlob,'|') where isnumeric(dbo.splitF(data,':',4))>0 and dbo.splitF(data,':',4)<=@resaleTaxyear)
    
  end
 end 




--taxWarrants
     insert @wt
    select id,invoiceIdMain,display, keyCode, invoiceBlob,0
       from dbo.collectionsBRW('taxwarrant',0,0,0,0) where id is not null and isnull(totalDue,0)=0 order by display

 
 update @wt set invoiceIdMain=(select top 1 id from invoices where keycode= case when PARCEL = '' then item else parcel end order by taxYear asc) where unpaid=0
 


 if @method = 'GET'
 begin  

  select
   @class = 'Collections',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = count(taxrollid),  
   @message = 'Redeemed tax items in resale'
  from @wt  where unpaid=0

  return
 end

 if @method = 'SHOW'
 begin  

  select * from @wt where unpaid=0

  return
 end

 if @method = 'FIX'
 begin  
  declare @fixTable table(id int)
     insert @fixTable select invoiceIdMain from @wt where unpaid=0
  while exists(select * from @fixTable)
   begin
    select @tokenId = id from @fixTable 
    if @tokenId>0
     begin
      exec dbo.dTypeCommentCrud @mode = 'REDEEMED',@invoiceId = @tokenId
      delete from @fixTable where id = @tokenId
     end
   end

  return  
 end


end


