create procedure dbo.importAlladtx
as
begin

declare @path varchar(max) = dbo.pathFile(dbo.settingsF('taxroll.importFile',''),'path'),
        @nameToken varchar(1000),
        @pathToken varchar(1000),
        @year varchar(4)
        
declare @infoTable table(name varchar(1000), filepath varchar(1000), processcode int)

insert @infoTable
select name,[path],0 from dbo.dirRead(@path) where name like '%adtx.tps' and isnumeric(left(name,4))=1 order by name desc

while exists(select * from @infoTable where processcode=0)
begin
 select top 1 @nameToken = name, @pathToken = filepath from @infoTable where processcode = 0
   exec dbo.settingsCRUD 'taxroll.importFile', @pathToken

   select @year = left(dbo.pathFile(dbo.settingsF('taxroll.importFile',''),'file'),4)

   if cast(isnull(@year,'0') as int) not in (select distinct realtaxyear from adtax)
   begin
     exec dbo.taxrollCRUD @method = 'importTax'

     exec dbo.taxrollCRUD @method = 'adTaxAdd'

     delete from adtax where balancedue = 0.00 -- remove this line for importing paid items
   end 
 update @infoTable set processcode = 1 where name = @nameToken
end
/*
  -- Alternate code for importing paid items
 insert into invoices (TAXROLLID,TYP,PARCEL,ITEM,TAXYEAR,NAME,BUSINESSNAME,POSTDATE,STATUS)
	select	
        id,
	RECORDTYPE,
	FULLPIDNUMBER,
	ITEMNUMBER,
	REALTAXYEAR,
	OWNERNAME,
	BUSINESSNAME,
	'',
	'Exempt'

      from AdTax where 
	id not in (select taxrollId from invoices) 
	and OWNERNAME>'  0'
        and balanceDUE<=0

*/
end