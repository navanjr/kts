CREATE procedure [dbo].[taxrollPenaltyBatch](@receiptId int)
as

begin

 declare 
  @idToken int,
  @invoiceDate varchar(10),
  @description varchar(50),
  @sourceCode varchar(50),
  @fundCode varchar(50), 
  @amount money,
  @existingpenaltyId int,
  @parentType int,
  @penaltyDate int


 select @parentType=typ from object where id = @receiptId

 if @parentType = 4003
  begin
   select @penaltyDate = a16 from object where id = @receiptId
  end
 else
  begin
   select @penaltyDate = dbo.clariondate(getdate())
  end

 select top 1 @invoiceDate = dbo.clariondate(getdate()),
  @description = b2,
  @sourceCode = b3,
  @fundCode = b4
 from object where typ=40 order by id 

 declare @pt table(invoiceId int, amount money)

 insert @pt
  select a.invoiceId,
         dbo.invoiceTotalAR(a.invoiceId) * dbo.penaltyPercent(a.invoiceId,dbo.date1(@penaltyDate))/100
   from receiptLink a
   where a.receiptId=@receiptId and a.invoiceId not in (select id from invoices where typ='A')


 while exists(select * from @pt)
 begin
  select top 1 @idToken = invoiceId, @amount = amount from @pt
  
  -- Issue penalty invoice for this tax item or update an existing one
  set @existingpenaltyId = isnull((select top 1 id from invoices where typ='P' and invoiceId=@idToken),0)
  if @existingpenaltyId=0
   begin
    exec dbo.subInvoiceCRUD  @idToken, @invoiceDate, @description, @sourceCode, @fundCode, 'P', @amount
   end
  else
   begin
    exec subInvoiceAdjust @existingpenaltyId, @amount,0
   end
  delete @pt where invoiceId = @idToken
 end


end