create proc dbo.taxStatementStatus(
 @invoiceId int,
 @status varchar(50),
 @lcContinue varchar(50) = '' output ) as
begin

 set nocount on

 declare
  @queue varchar(50),
  @taxYear varchar(50),
  @InvoiceStatus varchar(50),
  @name varchar(50),
  @item varchar(50),
  @tally int,
  @log varchar(max)

 select
  @name = name,
  @item = cast(item as varchar), 
  @queue = queue,
  @taxYear = taxyear,
  @invoiceStatus = printed
 from invoices where id = @invoiceId

 exec dbo.logit @@procid, '@invoiceId', @invoiceId, '@status', @status, '@taxYear', @taxYear, '@queue', @queue

 if @status in ( 'markOne', 'markAll' )
 begin
  if @status = 'markOne'
   update invoices set printed = getDate() where id = @invoiceId and queue = @queue and taxyear = @taxyear
  else
   update invoices set printed = getDate()
   where queue = @queue and printed < '  0'
    and name + cast(item as varchar) <= @name + @item
    and taxyear = @taxyear
 end

 if @status in ( 'resetPrintedStage', 'resetPrintedCommit')
 begin
  select @tally = count(*) from invoices where name + cast(item as varchar) >= @name + @item and queue = @queue and taxyear = @taxyear
  select @log = '@name=' + @name + ';@item=' + @item + ';@tally=' + cast(@tally as varchar) + ';' 
  exec dbo.logit @@procid, @log
  if @status = 'resetPrintedStage'
   select @log 
  if @status = 'resetPrintedCommit'
   update invoices set printed = '' where name + cast(item as varchar) >= @name + @item and queue = @queue and taxyear = @taxyear
  return
 end

 if @status = 'resetFailed'
 begin
  update invoices set printed = '' where taxyear = @taxYear and queue = @queue and printed = 'Failed' 
  exec dbo.logit @@procid, 'reset Complete'
  return
 end

 if isnull(@invoiceStatus,'') = 'Failed'
 begin
  set @lcContinue = 'False'
  select @lcContinue
  exec dbo.logit @@procid, '@invoiceStatus', @invoiceStatus, '@lcContinue', @lcContinue
  return  
 end

-- Pre check
 if @status = 'initialize'
 begin

  if exists(select * from invoices where taxyear = @taxYear and queue = @queue and printed = 'Failed')
   set @lcContinue = 'False'
  else
   set @lcContinue = 'True'

  select @lcContinue
  exec dbo.logit @@procid, '@lcContinue', @lcContinue
  return
 end

 if @status = 'Failed'
 begin

  if not exists(select * from invoices where taxyear = @taxYear and queue = @queue and printed = 'Failed')
   update invoices set printed = 'Failed' where id = @invoiceId

  set @lcContinue = 'False'
  select @lcContinue
  exec dbo.logit @@procid, '@lcContinue', @lcContinue
  return

 end

 if @status = 'Success'
 begin
  if exists(select * from invoices where taxyear = @taxYear and queue = @queue and printed = 'Failed')
  begin
   set @lcContinue = 'False'
  end
  else
  begin
   update invoices set printed = getdate() where id = @invoiceId
   set @lcContinue = 'True'
  end

  select @lcContinue
  exec dbo.logit @@procid, '@lcContinue', @lcContinue
  return  
 end


end