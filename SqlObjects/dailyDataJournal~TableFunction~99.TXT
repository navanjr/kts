CREATE function dbo.dailyDataJournal(@theDate int, @days int, @ordSeed varchar(50), @filterFlag varchar(10)) returns 
@rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 rowType char(10),
 brwBGColor int,
 journalIn varchar(50),
 journalOut varchar(50)
)
begin

 declare @wt table(
  id int,
  ord varchar(100),
  reportOrder varchar(50),
  description varchar(50),
  subDescription varchar(50),
  minControlNumber varchar(50),
  maxControlNumber varchar(50),
  rowCnt int,
  amount money,
  glBalance money,
  controlNumber varchar(50),
  jeType varchar(60),
  journalIn money,
  journalOut money
 )
 declare @wtRaw table(
  id int,
  ord varchar(100),
  description varchar(50),
  subDescription varchar(50),
  jeNumber varchar(50),
  amount money,
  slink2 varchar(15),
  typ int,
  jeType varchar(60),
  journalIn money,
  journalOut money
 )
  declare @accounts table(
  accountId int,
  collectionDescription varchar(50),
  reportOrder varchar(50)
 )

-- get the bank accounts 
 insert @accounts select accountId,accountType,reportOrder from dbo.glAccounts

-- insert all raw receipt data
 insert @wtRaw
  select
   Id,
   rtrim(sourcea18)+rtrim(accountType),
   accountcode,
   accountdesc,
   sourcekey1,
   amount,
   slink,
   case when isnumeric(sourceType)=1 then cast(sourceType as int) else 0 end,
   sourcea18,
   case when (accounttype not in (select accounttype from dbo.glbankfundtypes('FUND')) and amount > 0) then amount 
        when (accounttype in (select accounttype from dbo.glbankfundtypes('FUND')) and amount < 0) then amount*-1
        else 0 end as journalIn,
      case when (accounttype not in (select accounttype from dbo.glbankfundtypes('FUND')) and amount < 0) then amount*-1 
        when (accounttype in (select accounttype from dbo.glbankfundtypes('FUND')) and amount > 0) then amount
        else 0 end as journalOut
  from dbo.gldetailreports
  where sourcetype='4512'
   and sourcea18 <> 'Miscellaneous Deposit' 
   and sourcea18 <> 'Apportionment'
   and sourcedate >= cast(@theDate as varchar)
   and sourcedate <= cast(@theDate + @days as varchar)


-- this will get just the account
 insert @wt
 select
  id,
  ord + jeNumber + cast(id as varchar) + 'b',
  ord,
  description,
  subDescription,
  '',
  '',
  0,
  amount,
  0,
  jeNumber,
  jeType,
  journalIn,
  journalOut
 from @wtRaw
 order by ord

-- get the balance of the accounts
-- update a set a.glBalance = (select sum(amount) from glDetail where accountId = a.id) from @wt a

--insert main data
 insert @rt
 select
  cast('9' + cast(id as varchar) as int),
  @ordSeed + ord + '', -- removed b
  dbo.dailyDataFormatCollections(subDescription,minControlNumber,'',rowCnt,amount,43),
  dbo.padLeft(convert(varchar,glBalance,1),' ',16),
  '   ' + dbo.padRight(subDescription,' ',61),  
  case when minControlNumber is null then '' else controlNumber /*dbo.padLeft(minControlNumber, 0, 5) + ' - ' + dbo.padLeft(maxControlNumber, 0, 5)*/ end,
  dbo.padLeft(cast(rowCnt as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,amount,1),' ',16),
  'detail',0,
  dbo.padLeft(convert(varchar,journalIn,1),' ',16),
  dbo.padLeft(convert(varchar,journalOut,1),' ',16)
 from @wt

 -- headers
 insert @rt select 0,@ordSeed+'00a','','','','','','','lineFeed',0,'',''
 insert @rt select 0,@ordSeed+'00aa','  Transactions Effected by Journal Entry','','  Transactions Effected by Journal Entry','','','','sHeader',1,'Journal In','Journal Out'
 insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,'',''

 insert @rt select distinct 0,@ordSeed+jeType+'00aa','  '+jeType,'','  '+jeType,'','','','sjHeader',1,'','' from @wtRaw



-- insert grand total
 if exists(select * from @wt)
 begin
  insert @rt select 0,@ordSeed+'ZZZZZ'+'da',dbo.padLeft(replicate('=',20),' ',80),replicate('=',16),dbo.padLeft(replicate('=',20),' ',80),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,'',''

  insert @rt
  select
   0,
   @ordSeed + 'ZZZZZ' + 'db',
   dbo.padLeft('Total Journal Entry ', ' ', 60)
   + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
   + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   dbo.padLeft(convert(varchar,sum(glBalance),1), ' ', 16),
   dbo.padLeft('Total Journal Entry  ', ' ', 50),
   '',
   dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
   dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   'grandTotal',0,
   dbo.padLeft(convert(varchar,sum(journalIn),1),' ',16),
   dbo.padLeft(convert(varchar,sum(journalOut),1),' ',16)
  from @wt 
 end

 return
end