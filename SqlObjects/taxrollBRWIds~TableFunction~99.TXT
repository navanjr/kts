create function dbo.taxrollBRWIds(
 @taxYear varchar(10),
 @searchString varchar(50),
 @AdvancedSearch varchar(1)
) returns @rt table(
 invoiceId int
)
Begin

/*
--get the tax years we will return
  declare @taxYears table(yr varchar(4))
  if lower(@taxYear) = 'all'
   insert @taxYears select cast(taxyear as varchar (4)) from invoices group by taxyear
  else
   insert @taxYears select @taxYear


 insert @rt
   select 
    id
   from dbo.invoices
   where name+' '+parcel+' '+cast(item as varchar) like '%'+@searchString+'%'
    and cast(taxYear as varchar) in (select yr from @taxYears)
    and invoiceId = 0

--search for taxyear&item
 insert @rt
   select 
    id
   from dbo.invoices
   where cast(taxyear as varchar(4))+cast(item as varchar(20)) like '%'+@searchString+'%'
    and cast(taxYear as varchar) in (select yr from @taxYears)
    and invoiceId = 0
*/


if @AdvancedSearch = '1'

begin

  insert @rt 
  select i.id
  from dbo.invoices i
  inner join adtax a on i.taxrollId=a.id 
  where i.invoiceId = 0 and i.typ<>'s'
   and i.taxyear = case when @taxyear = 'all' then i.taxyear else cast(@taxyear as numeric) end
   --and i.taxrollId=a.id and 
    and name+' '+parcel+' '+cast(item as varchar)+cast(taxyear as varchar(4))+cast(i.item as varchar)+a.OWNERNAME+a.BUSINESSNAME+'OWNER='+CAST(OWNERNUMBER AS VARCHAR)+a.ADDRESS1+a.ADDRESS2+a.ADDRESS3+a.CITY+a.STATE+a.ZIP1+a.ZIP2+a.ZIP3+a.proploc+cast(a.mortgagecode as varchar(50))+a.mort_cd+a.treamort+a.trcode+cast(a.LEGALDESCRIPTION as varchar(8000)) like '%'+@searchString+'%'


  insert @rt 
  select i.id
  from dbo.invoices i
  where i.invoiceId = 0 
   and i.taxyear = case when @taxyear = 'all' then i.taxyear else cast(@taxyear as numeric) end
    and name+' '+parcel+' '+cast(item as varchar)+cast(taxyear as varchar(4))+cast(i.item as varchar) like '%'+@searchString+'%'
    and i.id not in (select invoiceId from @rt)


  insert @rt
  select 
   i.id
  from dbo.taxRollDetail td, invoices i
  where i.invoiceId = 0 
   and i.taxyear = case when @taxyear = 'all' then i.taxyear else cast(@taxyear as numeric) end
   and i.item=td.itemNumber
   and i.taxyear=td.taxyear
   and td.name+td.businessName+td.address1+td.address2+td.address3+td.city+td.state+td.zip1+td.zip2 like '%'+@searchString+'%'
   --and td.dtype in ('a') --and i.id not in (select invoiceId from @rt)

  insert @rt
  select 
   i.id
  from object o, invoices i
  where o.typ=4005 
   and o.link1 = i.taxrollId
   and i.invoiceId = 0 
   and i.taxyear = case when @taxyear = 'all' then i.taxyear else cast(@taxyear as numeric) end
   and a3 like '%'+@searchString+'%' --and i.id not in (select invoiceId from @rt)

  if isnumeric(@searchString)=1
  begin
   insert @rt
   select 
    i.id
   from invoices i
   where i.invoiceId = 0 
    and i.taxyear = case when @taxyear = 'all' then i.taxyear else cast(@taxyear as numeric) end
    and (i.invoiceAmount=cast(@searchString as money) or i.invoiceDue=cast(@searchString as money))
  end

end

return
end

