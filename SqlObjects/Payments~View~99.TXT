create view dbo.payments as

select 
 id,
 typ,
 key1 as treasurersNumber,
 key2 as dateRegistered,
 key3 as clerksNumber,
 a1 as clerksDate,
 ltrim(a2) as payee,
 isnull((select sum(amount) from gldetail where slink='o' + cast(object.id as varchar) and accountCode=object.a4),0) as amount,
 a4 as debitAccountCode,
 b3 as debitAccountDesc,
 a5 as creditAccountCode,
 b4 as creditAccountDesc,
 a6 as purposeAccountCode,
 b5 as purposeAccountDesc,
 a7 as official,
 a8 as depositAccountCode,
 a9 as bankAccountCode,
 c9 as detailAmount,
 a12 as createdIni,
 a13 as createdStation,
 a14 as reasonCanceled,
 a17 as status,
 a18 as paymentType,
 a19 treasurersWarrant,
 a20 as printStatus,
 e1 as comment,
 link1 as warrantLinkId,
 case when a18 = 'Treasurers Check' then c5 else '' end as warrantPayee,
 case when a18 = 'WARRANT' then a4 else a8 end as dailyDataAccountLinkCode,
 c10 as fiscalYear,
 'o' + cast(id as varchar) as slink,
 isnull((select max(isnull(dateCleared,'')) from gldetail where slink='o' + cast(object.id as varchar) ),0) as dateCleared,
 '' as otreasurersNumber,
 '' as odateRegistered,
 '' as oclerksNumber,
 '' as oclerksDate
from object where typ = 4771 and id not in (select link1 from object where typ=4771)

union all

select 
 c.id,
 c.typ,
 c.key1 as treasurersNumber,
 c.key2 as dateRegistered,
 c.key3 as clerksNumber,
 c.a1 as clerksDate,
 ltrim(c.a2) as payee,
 isnull((select sum(amount) from gldetail where slink='o' + cast(c.id as varchar) and accountCode=c.a4),0) as amount,
 c.a4 as debitAccountCode,
 c.b3 as debitAccountDesc,
 c.a5 as creditAccountCode,
 c.b4 as creditAccountDesc,
 c.a6 as purposeAccountCode,
 c.b5 as purposeAccountDesc,
 c.a7 as official,
 c.a8 as depositAccountCode,
 c.a9 as bankAccountCode,
 c.c9 as detailAmount,
 c.a12 as createdIni,
 c.a13 as createdStation,
 c.a14 as reasonCanceled,
 c.a17 as status,
 c.a18 as paymentType,
 c.a19 treasurersWarrant,
 c.a20 as printStatus,
 c.e1 as comment,
 c.link1 as warrantLinkId,
 case when c.a18 = 'Treasurers Check' then c.c5 else '' end as warrantPayee,
 case when c.a18 = 'WARRANT' then c.a4 else c.a8 end as dailyDataAccountLinkCode,
 c.c10 as fiscalYear,
 'o' + cast(c.id as varchar) as slink,
 isnull((select max(isnull(dateCleared,'')) from gldetail where slink='o' + cast(c.id as varchar) ),0) as dateCleared,
 p.key1 as otreasurersNumber,
 p.key2 as odateRegistered,
 p.key3 as oclerksNumber,
 p.a1 as oclerksDate
from object p, object c where p.typ = 4771 and c.typ=4771 and p.link1=c.id