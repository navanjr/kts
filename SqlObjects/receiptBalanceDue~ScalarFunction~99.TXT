CREATE function [dbo].[receiptBalanceDue](@receiptId int) returns money
as 
begin
 declare @totalDue money,
         @receiptType varchar(50),
         @posted varchar(5)
 
 
 declare @wt table(
  linkid int,
  invoiceId int,
  due money default 0,
  methodRate money,
  mainInvoiceid int,
  invoiceType varchar(1)
 )

 declare
  @glAmt money,
  @glAmtStage money,
  @amount money,
  @credit money,
  @due money

select @receiptType = key3, @posted = case when a17 = 'Posted' then 'TRUE' else 'FALSE' end from object where id = @receiptId

if @receiptType = 'TAX'
 begin
-- get the invoices linked to this receipt
 insert @wt (linkId, invoiceId, methodRate,mainInvoiceId,invoiceType)
  select a.id, a.invoiceId, case when a.methodRate > 1.0 then 1.0 when @posted = 'TRUE' then 1.00 else a.methodRate end,b.invoiceId,b.typ
  from receiptLink a, invoices b 
  where a.invoiceId = b.id and a.receiptId = @receiptId

-- calculate the balance due
 update @wt set due = round(dbo.invoiceTotalAR(invoiceId) * methodrate,2) where mainInvoiceId = 0 
 update @wt set due = dbo.invoiceTotalAR(invoiceId) where mainInvoiceId > 0 
 update @wt set due = 0 where invoiceType = 'A'

 set @totalDue = (select sum(due) from @wt)

 select @glAmtStage = sum(a.amount) 
 from glDetailStage a, glAccounts b 
  where a.accountId = b.accountId and 
  b.accountType = 'suspense' and 
  b.accountdesc <> 'temporary suspense' and 
  left(slink,1) <> 't' and 
  slink in (select slink from dbo.receiptSLinks(@receiptId))

 select @due = isnull(@totalDue,0) - isnull(@glAmtStage,0)
 return @due

 end

 select @glAmt = sum(a.amount) 
 from glDetail a, glAccounts b 
  where a.accountId = b.accountId and 
  b.accountType = 'RECEIVABLE' and 
  slink in (select slink from dbo.receiptSLinks(@receiptId))

 select @glAmtStage = sum(a.amount) 
 from glDetailStage a, glAccounts b 
  where a.accountId = b.accountId and 
  b.accountType = 'RECEIVABLE' and 
  slink in (select slink from dbo.receiptSLinks(@receiptId))


 set @totalDue = isnull(@glAmt,0) + isnull(@glAmtStage,0)

 return @totalDue
end
