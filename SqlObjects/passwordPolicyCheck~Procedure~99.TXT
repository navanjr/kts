create proc dbo.passwordPolicyCheck(
 @initials varchar(5),
 @code int = null output,
 @message varchar(max) = null output 
) as
begin
 set nocount on

 select
  @code = 0,
  @message = ''

 if not dbo.settingsF('site.enhancedSecurity','FALSE') = 'TRUE'
  return

 declare 
  @pswdDateTime varchar(50),
  @age int
 
-- must have password
 if not exists(select * from users where ini = @initials and pswd > '      0')
  select
   @code = 1,
   @message = 'Warning!|You are currently violating password policy...||Password can not be <blank>.||Please change your password as soon as you can :)'
 
-- change password frequency
 select @pswdDateTime = dbo.readstring('@datetime=',blob) from users where ini = @initials

 set @age = DATEDIFF(d,coalesce(nullif(@pswdDateTime,''),getdate()-400),getdate())

 if @age > cast(dbo.settingsF('site.passwordExpireDays','365') as int)
  select
   @code = 1,
   @message = 'Warning!|You are currently violating password policy...||Password must be changed once every ' + dbo.settingsF('site.passwordExpireDays','365') + ' days.||Please change your password as soon as you can :)'

 return

end