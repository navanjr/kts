create procedure dbo.interestWorksheetAccountVerification(@date varchar(20),@overWrite varchar(10),@split varchar(10))
as
begin
 declare @nameToken varchar(60)

 declare @wt table(name varchar(60),
                  fund varchar(60),
                  formulaAmount money,
                  schPagesCat varchar(50),
                  tableType varchar(50),
                  yearMonth varchar(10),
                  acrName varchar(60)
                  )
                  
 insert @wt
 select left(rtrim(apyear)+right('00'+rtrim(apmonth),2)+' '+rtrim(TableType),50) as Name,accountCode as fund,amount as formulaAmount,comment2 as schpagescat,
   'Interest '+case when left(tableType,7)='Balance' then left(tableType,len(tableType)-len(bankdesc)) else tableType end as TableType,rtrim(apyear)+right('00'+rtrim(apmonth),2) as yearmonth, '' 
   from dbo.interestWorkSheetDetail(@date, @split)

 update @wt set acrName=rtrim(name)+'_ACR'

 if @overWrite='TRUE' 
 begin
  update object set typ=-4022 where typ=4022 and key1 in (select rtrim(name) from @wt where acrName not in (select distinct accountcode from gldetail))
 end

 insert object (typ,key1,key2,key3,a1,a17,a18,k2)
  select 4022,rtrim(name),fund,formulaamount,schpagescat,tabletype,yearmonth,left(rtrim(name)+fund,30) from @wt
   where rtrim(name) not in (select key1 from object where typ = 4022)

 while exists(select name from @wt)
 begin
  select top 1 @nameToken=rtrim(name) from @wt
   exec dbo.apportionTableFundReceivableVerification @nameToken
  delete from @wt where rtrim(name)=@nameToken
 end
end


