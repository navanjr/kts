CREATE function dbo.dailydata(@theDate int, @days int, @filterString varchar(50)) returns 
@rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 brwBGColor int,
 blob varchar(max)
)
begin
 declare @showDetail table(id int)
 insert @showDetail select 4522

 declare @rawData table(
  amount money,
  tname varchar(50),
  typ int,
  num varchar(50),
  slink varchar(15),
  ord char(1)
 )

 -- get the raw data from glDetail, this yields receipts, vouchers, deposits

-- Collections
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataCollections(@theDate, @days, 'F', @filterString)

-- Deposits & Disbursments
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,null
  from dbo.dailyDataDeposits(@theDate, @days, 'G', @filterString)

-- Vouchers
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataPayments('Official Voucher','Official',@theDate, @days, 'H', @filterString)

-- Cancelled Vouchers
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataPayments('Cancel Voucher','Official',@theDate, @days, 'I', @filterString)
  union all
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataPayments('Void Voucher','Official',@theDate, @days, 'J', @filterString)

-- Journal
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,null
  from dbo.dailyDataJournal(@theDate, @days, 'K', @filterString)

-- Warrants
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataPayments('Treasurers Check|Paid Warrant','Fund',@theDate, @days, 'L', @filterString)
    
-- Miscellaneous Payments
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,blob
  from dbo.dailyDataPayments('Miscellaneous|Miscellaneous Payments','Fund',@theDate, @days, 'M', @filterString) order by ord

-- Miscellaneous Deposits
 if substring(@filterString,2,1) = '1'
  insert @rt 
  select id*-1,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,null
  from dbo.dailyDataMiscDeposit('Fund',@theDate, @days, 'N', @filterString) order by ord

-- Suspense
 if substring(@filterString,1,1) = '1'
 begin

  insert @rt 
  select id,ord,rowString,glBalanceString,rowString1,sourceNo,recordCnt,sourceAmt,brwBGColor,null
  from dbo.dailyDataSuspense(@theDate, @days, 'C',@filterString) order by ord

-- Pending Deposits
  insert @rt 
  select id,ord,rowstring,glBalanceString,rowstring1,sourceNo,recordCnt,sourceAmt,brwBGColor,null
  from dbo.dailyDataPendingDeposits(@theDate)

-- Vouchers Expired
  if not dbo.settingsF('site.voucherExpireDays','0') = 0
  begin
   insert @rt 
   select
    '-3' + cast(minPaymentId as varchar),
    'EexpiredVouchers',
    dbo.padRight(' --> ' + message,' ',65)
    + dbo.padLeft(dbo.formatCurr(amount),' ',15),'glBalanceString','rowstring1','sourceNo',tally,amount,3,
    '@tally=' + cast(tally as varchar) + ';@amount=' + cast(amount as varchar) + ';@ids=' + ids + ';'
   from dbo.vouchersExpiredTF()
  end

-- Incomplete Refunds
   insert @rt 
   select
    '-3',
    'IncompleteRefunds',
    dbo.padRight(' --> ' + message,' ',65)
    + dbo.padLeft(dbo.formatCurr(amount),' ',15),'glBalanceString','rowstring1','sourceNo',tally,amount,3,
    '@tally=' + cast(tally as varchar) + ';@amount=' + cast(amount as varchar) + ';@slinks=' + slinks + ';@IncompleteRefunds=1;'
   from dbo.incompleteRefundsTF()

-- Pending Refunds
   insert @rt 
   select
    case when minPaymentId = 0 then '0' else '-3'+cast(minPaymentId as varchar) end,
    'PendingRefunds'+cast(minPaymentId as varchar),
    dbo.padRight(message,' ',65)
    + dbo.padLeft(dbo.formatCurr(amount),' ',15),'glBalanceString','rowstring1','sourceNo',tally,amount,3,
    '@tally=' + cast(tally as varchar) + ';@amount=' + cast(amount as varchar) + ';@PendingRefunds=1;'
   from dbo.pendingRefundsTF()


-- Lock Fiscal Calendar
  if dbo.settingsF('site.autoLockFiscalCalendar','FALSE') = 'TRUE'
   and exists(select * from dbo.fiscalCalendar where endDate < dbo.clarionToday() and locked != '1')
  begin
   insert @rt 
   select
    '-2',
    'lockFiscalCalendar',
    dbo.padRight(' --> ' + 'Unlocked Fiscal Calendars',' ',65)
    + dbo.padLeft('',' ',15),'glBalanceString','rowstring1','sourceNo',0,0,3,
    '@tally=0;@amount=0;@ids=0;'
  end

-- blank line
   insert @rt 
   select
    '0',
    'Z',
    '','','','',0,0,0,
    ''

 end

 return

end