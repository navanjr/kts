create function dbo.rpform308(@begindate varchar(20),@enddate varchar(20))

returns @rt table(fundCode varchar(60), 
                  fundDesc varchar(50),
                  postDate1 varchar(30),
                  ReceiptNo varchar(50),
                  sourceDesc varchar(50),
                  amountToApportion money,
                  detCount int,
                  longSource int,
                  longDesc int,
                  receiptDescription varchar(250))
as
begin
                
 declare @miscCollectionAccountCode varchar(60),
         @excludeTaxes varchar(10)

 select @excludeTaxes = dbo.settingsF('site.form308ExcludesTaxes','FALSE')

 select @miscCollectionAccountCode = key3 from object where typ=4503 and key1='MISC'
 insert @rt
 select fundCode, FundDesc,postDate1, ReceiptNo, sourceDesc, amountToApportion,detCount,len(sourceDesc)/22,len([description])/20,[description] from dbo.reportMiscReceiptDetail(@begindate,@enddate) 
  where isnull(form308,0)=1 

 insert @rt
 select accountCode as fundCode,accountDesc as FundDesc,'' as postDate1,'' as receiptNo,sourceDesc,sum(amount)*-1 as amountToApportion, 0 as detCount,len(sourceDesc)/22,len(comment)/20, comment 
  from rpMonthEndDetail(@begindate,@enddate,'TRUE') 
  where apportionContraCode not in ((select @miscCollectionAccountCode union select case when @excludeTaxes = 'TRUE' then accountcode else '' end from glaccounts where bssummary = 'Ad Valorem Tax'))
   and apportionContraCode <> accountcode  
   and accountType in (select accounttype from dbo.glbankfundtypes('FUND'))
   and accountcode in (select accountcode from glaccounts where form308='1')
  group by accountcode,accountDesc,SourceDesc, comment
  
  update r set detcount = rs.detcount+case when rs.ls > rs.ld then rs.ls else 0 end+case when rs.ld >= rs.ls then rs.ld else 0 end
   from @rt r, 
     (select fundCode, count(*) as detcount,
       isnull((select sum(longSource) from @rt where fundcode=r.fundcode),0) as ls, 
       isnull((select sum(longDesc) from @rt where fundcode=r.fundcode),0) as ld from @rt r group by fundCode) rs
   where r.fundCode = rs.fundCode
 return
end