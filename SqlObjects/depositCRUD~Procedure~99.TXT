create proc dbo.depositCRUD( 
 @mode int,
 @depositId int = null,
 @depositDate int = null,
 @dailyDataBRWId int = null,
 @verbose varchar(5) = 'TRUE',
 @newObjectId int = null output
) as
begin
 
 declare 
  @slink varchar(15) = 'o' + cast(@depositId as varchar),
  @fpStatus varchar(10),
  @receiptType varchar(50),
  @bankAccountId int,
  @bankAccountCode varchar(50),
  @bankAccountDesc varchar(50),
  @bankAccountNumber varchar(50),
  @receiptTypeCanidate varchar(50)

 select
  @fpStatus = fpStatus from glStatus(@slink)

 if charindex('|',isnull(@receiptType,'')) > 0
  set @receiptTypeCanidate = ''
 else 
  set @receiptTypeCanidate = isnull(@receiptType,'')

 exec dbo.logit @@procid, '@mode', @mode, '@depositId', @depositId, '@fpStatus', @fpStatus

-- create a new deposit
 if @mode = 0 and isnull(@dailyDataBRWId,0) < 0
 begin

  set
   @depositDate = coalesce(@depositDate,dbo.clarionDate(getdate()))

  select
   @receiptType = isnull(receiptType,''),
   @bankAccountCode = isnull(depositAccountCode,''),
   @bankAccountDesc = isnull(depositAccountDesc,'')
  from dbo.dailyDataPendingDeposits(@depositDate)
  where id = @dailyDataBRWId

  select
   @bankAccountId = accountId,
   @bankAccountNumber = bankAccount
  from dbo.glaccounts where accountCode = @bankAccountCode

  exec dbo.logit @@procid, '@dailyDataBRWId', @dailyDataBRWId, '@receiptType', @receiptType, '@bankAccountCode', @bankAccountCode, '@bankAccountDesc', @bankAccountDesc
  
-- fork here for Depositing Trust into an Official Deposit
  if @bankAccountCode = 'AAATRUST'
  begin

   exec dbo.officialDepositCRUD @mode = 0,  @depositDate = @depositDate, @linkTrust = 'TRUE', @newObjectId = @newObjectId output

  end
  else
  begin

   select top 1 @newObjectId = id
   from Object
   where typ = 4513
    and A17 != 'Posted'
    and Key3 = @receiptTypeCanidate
    and ID not in (select isnull(depositId,0) from paid)
   order by id

   if isnull(@newObjectId,0) > 0
   begin   

    update object set
     key2 = isnull(@depositDate,''), 
     key3 = @receiptTypeCanidate,
     a1 = @bankAccountDesc,
     a2 = @bankAccountNumber,
     link1 = @bankAccountId
    where typ = 4513 and id = @newObjectId

    exec dbo.logit @@procid, '@existingObjectId', @newObjectId

   end
   else
   begin

-- create object record
    declare @newIdWt newIdWt
    insert object (typ,key2,key3,a1,a2,link1)
    output inserted.id into @newIdWt
    select 4513, isnull(@depositDate,''), @receiptTypeCanidate, @bankAccountDesc, @bankAccountNumber, @bankAccountId

    select @newObjectId = max(id) from @newIdWt
    exec dbo.logit @@procid, '@newObjectId', @newObjectId, '@receiptTypeCanidate', @receiptTypeCanidate

   end

-- link payments maybe
   exec dbo.depositLinkManyPayments @depositId = @newObjectId, @receiptType = @receiptType, @bankAccountCode = @bankAccountCode

  end

-- return the id for futher KTS processing
  if @verbose = 'TRUE'
   select '@code=0;@newObjectId=' + cast(@newObjectId as varchar) + ';'

  return
 end


-- delete a deposit
 if @mode = 3
 begin

-- period Check status
  if @fpStatus = 'locked'
   return
-- bail if linked to a bank statement
  if exists (select * from gldetail where slink=@slink and isnull(bsid,0)>0)
   begin
    exec dbo.logit @@procid, 'Linked to bankstatement... Bailing.'

   return
   end


  begin transaction

  delete dbo.glDetailStage where slink = @slink
  delete dbo.glDetail where slink = @slink
  delete object where typ = 4513 and id = @depositId
  update paid set depositId = 0 where depositId = @depositId

  commit transaction
  
 end
 
end