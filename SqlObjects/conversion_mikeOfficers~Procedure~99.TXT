create proc dbo.conversion_mikeOfficers(
 @mode varchar(50) = 'conversion',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as 
begin
 set nocount on

 if @mode != 'conversion'
  return

 declare @officers table(
  dptno varchar(50),
  name varchar(50),
  title varchar(50),
  bcode varchar(50),
  fcode varchar(50),
  lvchnbr int
 )

 declare
  @mikeTableName varchar(50) = 'OFICRS',
  @mikePath varchar(max),
  @sql nvarchar(max)

 select
  @mikePath = dbo.settingsF('conversion.mikepath','') + '\' + @mikeTableName + '.dbf',
  @sql = 'select * from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT * FROM ' + @mikeTableName + ' where !deleted()'')'

 insert @officers exec(@sql)

 if @method = 'GET'
 begin  
  select 
   @class = 'conversion',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = COUNT(*),  
   @message = 'officers not found in KTS'
  from @officers
  where title not in (select key1 from object where typ = 4601)
 end

 if @method = 'SHOW'
 begin  

  select * 
  from @officers
  where title not in (select key1 from object where typ = 4601)

 end

 if @method = 'FIX'
 begin  
  declare
   @acctTypeId int,
   @acctTypeCode varchar(50),
   @acctTypeDesc varchar(50),
   @acctTypeRepo varchar(50)
  
  select
   @acctTypeId = id,
   @acctTypeCode = key1,
   @acctTypeDesc = key2,
   @acctTypeRepo = key3
  from object where typ = 4702 and key1 = 'OFFICIAL'

  if not isnull(@acctTypeId,0) > 0
  begin
   select @code=1, @message='Sorry you are missing an OFFICIAL account type'
   exec dbo.logit @@procid, '@code',@code,'@message',@message
   return
  end

  insert object (typ,key1,key2,key3,a1,olink5)
  select 4601, title, name, title, dptno, 'mike'
   from @officers where title not in (select key1 from object where typ = 4601)

  exec dbo.logit @@procid, 'Inserted officers @@rowcount', @@rowCount

-- this is where we insert the official account on each official
  insert object (typ,key1,key2,a1,a2,link1,a3,olink5)
  select 4701, 'OFF' + ltrim(rtrim(dptno)), title, @acctTypeCode, @acctTypeDesc, @acctTypeId, @acctTypeRepo, 'mike'
   from @officers where title not in (select key1 from object where typ = 4601)

  exec dbo.logit @@procid, 'Inserted OFFICIAL accounts @@rowcount', @@rowCount

-- this is where we update the bank account and official account on each official
  update a set
   a.a3 = b.accountCode,
   a.b2 = b.accountDesc
  from object a, dbo.glaccounts b
  where a.typ = 4601
   and 'OFF' + ltrim(rtrim(a.a1)) = b.accountCode
  exec dbo.logit @@procid, 'updated OFFICIALS with their official account code and description @@rowcount', @@rowCount

/*
  update object set
   a4 = b.accountCode,
   b3 = b.accountDescription
  from object a, dbo.glaccounts b
  where a.typ = 4601
   and 'OFF' + ltrim(rtrim(a.a1)) = b.account
  exec dbo.logit @@procid, 'updated OFFICIALS with the official account code and description @@rowcount', @@rowCount
*/
 
  return

 end

end

/*
 select title,name,dptno from dbo.mike_officers()
 @imp5=
  lcid=kp('select id from object where typ=4601 and key1='''&obj5:a1&''''),
  -02=4601,
  002=obj5:a1,
  004=obj5:a2,
  006=obj5:a1,
  008=obj5:a3
*/

