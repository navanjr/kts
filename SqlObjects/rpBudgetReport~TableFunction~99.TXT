create function dbo.rpBudgetReport(@beginDate varchar(20),
        @endDate varchar(20),
        @fundCode varchar(20))

returns @rt table(accountCode varchar(60) default '',
                  accountDesc varchar(50) default '',
                  sourceSECA varchar(60) default '',
                  sourceDesc varchar(60) default '',
                  July varchar(60) default '',
                  August varchar(60) default '',
                  September varchar(60) default '',
                  October varchar(60) default '',
                  November varchar(60) default '',
                  December varchar(60) default '',
                  January varchar(60) default '',
                  February varchar(60) default '',
                  March varchar(60) default '',
                  April varchar(60) default '',
                  May varchar(60) default '',
                  June varchar(60) default '',
                  Total varchar(60) default '',
                  ord varchar(250)  default ''                
                  )
as
begin

declare @wt table(id int identity,
                   apportionmonth int,
                   accountCode varchar(60),
                   accountDesc varchar(50),
                   sourceCode varchar(60),
                   sourceDesc varchar(60),
                   sourceSECA varchar(50),
                   amount money)
        

declare @det table(apportionmonth int,
                   accountCode varchar(60),
                   accountDesc varchar(50),
                   sourceCode varchar(60),
                   sourceDesc varchar(60),
                   sourceSECA varchar(50),
                   journalDesc varchar(50),
                   amount money)
insert @det
select month(dbo.date1(apportiondate)) as apportionmonth,accountCode,accountDesc,sourceCode,sourceDesc,sourceSECA,journalDesc,sum(amount*-1) 
from dbo.rpMonthEndDetail(
 @beginDate,
 @endDate,
 'FALSE')
 where left(journalType,13)='APPORTIONMENT'
       and accountcode=@fundCode
group by 
 month(dbo.date1(apportiondate)),accountCode,accountDesc,sourceCode,sourceDesc,sourceSECA,journalDesc
 
 
declare @years table(id int identity(1,1),yearCode varchar(50),journalDesc varchar(50),ord varchar(50))

insert @years
select top 1 'Current Tax',journalDesc,'0001' from @det where journalDesc like '%ADVALOREM' order by journalDesc desc
insert @years
select top 1 'Prior Tax',journalDesc,'0002' from @det where journalDesc like '%ADVALOREM' and journalDesc not in (select journalDesc from @years) order by journalDesc desc
insert @years
select distinct 'Back Tax',journalDesc,'0003' from @det where journalDesc like '%ADVALOREM' and journalDesc not in (select journalDesc from @years)

update d set sourceCode = y.yearcode,sourceDesc = y.yearcode, sourceSECA = y.ord from @det d, @years y where d.journalDesc=y.journalDesc

insert @wt (apportionmonth,accountCode,accountDesc,sourceDesc,sourceSECA,amount)
 select apportionmonth,accountCode,accountDesc,sourceDesc,sourceSECA,sum(amount) from @det
  group by apportionmonth,accountCode,accountDesc,sourceDesc,sourceSECA
  
insert @rt (accountCode,accountDesc,sourceSECA,sourceDesc,ord)
select distinct accountCode,accountDesc,sourceSECA,sourceDesc,accountCode+rtrim(accountDesc)+sourceSECA+'b' from @wt

update r set January=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=1

update r set February=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=2

update r set March=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=3

update r set April=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=4

update r set May=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=5

update r set June=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=6

update r set July=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=7

update r set August=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=8

update r set September=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=9

update r set October=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=10

update r set November=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=11

update r set December=d.amount from @rt r, @det d
 where 
 r.accountCode=d.accountCode
 and r.accountDesc=d.accountDesc
 and r.sourceSECA=d.sourceSECA
 and r.sourceDesc=d.sourceDesc
 and d.apportionmonth=12

 update @rt set total = cast(july as money)+cast(august as money)+cast(september as money)+cast(october as money)+cast(november as money)+cast(december as money)+cast(january as money)+cast(february as money)+cast(march as money)+cast(april as money)+cast(may as money)+cast(june as money)

insert @rt (sourceDesc,july,august,september,october,november,december,january,february,march,april,may,june,total, ord)
 select 
  'Total Revenue Rec''d',
  sum(cast(July as money)),
  sum(cast(August as money)),
  sum(cast(September as money)),
  sum(cast(october as money)),
  sum(cast(november as money)),
  sum(cast(december as money)),
  sum(cast(January as money)),
  sum(cast(february as money)),
  sum(cast(march as money)),
  sum(cast(april as money)),
  sum(cast(may as money)),
  sum(cast(june as money)),
  sum(cast(total as money)),
  'zzzzzzzzzz'
  from @rt



return
end