create proc dbo.aamasterCheckInitialize(
 @taxYear varchar(10) = null
) as
begin

  set nocount on
 declare
  @c varchar(10) = ' | '

  set @taxYear = coalesce(@taxyear,(select dbo.splitF(dbo.date1(dbo.clarionToday()),'/',3)-1))

  exec dbo.logit @@procid, 'taxYear', @taxYear

---create indexes
IF not EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[aamasterCheck]') AND name = N'balanceDue Includes 1')
 CREATE NONCLUSTERED INDEX [balanceDue Includes 1]  ON [dbo].[aamasterCheck] ([balanceDue]) INCLUDE ([brwid],[selectedFlag],[reason],[ownername],[businessname],[ktsautonumber],[ktsownername],[ktsbusinessname])
IF not EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[aamasterCheck]') AND name = N'balanceDue Includes 2')
 CREATE NONCLUSTERED INDEX [balanceDue includes 2] ON [dbo].[aamasterCheck] ([balanceDue])INCLUDE ([brwid],[selectedFlag],[reason],[address1],[address2],[address3],[city],[state],[zip1],[zip2],[zip3],[country],[ktsautonumber])
IF not EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[aamasterCheck]') AND name = N'balanceDue Includes 3')
 CREATE NONCLUSTERED INDEX [balanceDue includes 3] ON [dbo].[aamasterCheck] ([balanceDue])INCLUDE ([brwid],[selectedFlag],[reason],[country],[ktsautonumber],[ktsaddress1],[ktsaddress2],[ktsaddress3],[ktscity],[ktsstate],[ktszip1],[ktszip2],[ktszip3])


if charindex('aamaster',dbo.settingsf('checkassessor.sourceFile','')) = 0 
  update aamasterCheck set autonumber = itemnumtaxid, afullpidnumber = fullpidnumber

  update a set
    a.invoiceId = b.id,
    a.balanceDue = isnull(b.invoiceDue,0) + isnull(b.subInvoiceDue,0) + isnull(b.taxRuleDue,0),
    a.ktsAutoNumber = b.ITEM,
    a.adtaxId = c.id,
    a.ktsownerName = c.OWNERNAME,
    a.ktsbusinessName = c.BUSINESSNAME,
    a.ktsaddress1 = c.ADDRESS1,
    a.ktsaddress2 = c.ADDRESS2,
    a.ktsaddress3 = c.ADDRESS3,
    a.ktscity = c.city,
    a.ktsstate = c.state,
    a.ktszip1 = c.zip1,
    a.ktszip2 = c.zip2,
    a.ktszip3 = c.zip3,
    a.ktscountry = c.country,
    a.fullpidnumber = c.fullpidnumber,
    a.taxYear = @taxYear
  from aamasterCheck a
  join invoices b on b.taxyear = @taxyear and cast(b.item as money) = cast(isnull(a.itemnumtaxid,a.autonumber) as money) and isnull(a.itemnumtaxid,a.autonumber)>'  0'
  join AdTax c on c.realtaxyear = @taxyear and b.TAXROLLID = c.ID
  exec dbo.logit @@procid, 'updated data from KTS... @@rowCount', @@ROWCOUNT

  -- ownername
  update aamasterCheck set reason = 'owner name'
  where ltrim(rtrim(ownername)) != ltrim(rtrim(ktsownername))
  exec dbo.logit @@procid, 'Found mismatching ownerName... @@rowCount', @@ROWCOUNT

  -- businessname
  update aamasterCheck set reason = 'business name'
  where ltrim(rtrim(businessname)) != ltrim(rtrim(ktsbusinessname))
   and isnull(reason,'') < '  0'
  exec dbo.logit @@procid, 'Found mismatching BusinessName... @@rowCount', @@ROWCOUNT

  -- address
/*
  update aamasterCheck set reason = 'address'
  where (
    ltrim(rtrim(address1)) != ltrim(rtrim(ktsaddress1))
    or ltrim(rtrim(address2)) != ltrim(rtrim(ktsaddress2))
    or ltrim(rtrim(address3)) != ltrim(rtrim(ktsaddress3))
    or ltrim(rtrim(city)) != ltrim(rtrim(ktscity))
    or ltrim(rtrim(state)) != ltrim(rtrim(ktsstate))
    or ltrim(rtrim(zip1)) != ltrim(rtrim(ktszip1))
    or ltrim(rtrim(zip2)) != ltrim(rtrim(ktszip2))
    or ltrim(rtrim(zip3)) != ltrim(rtrim(ktszip3))
--    or ltrim(rtrim(country)) != ltrim(rtrim(ktscountry))
   )
   and isnull(reason,'') < '  0'
*/
  update aamasterCheck set reason = 'address'
  where (
stuff(dbo.joinStr(@c,address1) + dbo.joinStr(@c,address2) + dbo.joinStr(@c,address3)
     + dbo.joinStr(@c,city) + dbo.joinStr(@c,state) + dbo.joinStr(@c,zip1) + dbo.joinStr(@c,zip2) + dbo.joinStr(@c,zip3) + dbo.joinStr(@c,country)
     ,1,len(@c),'') !=
stuff(dbo.joinStr(@c,ktsaddress1) + dbo.joinStr(@c,ktsaddress2) + dbo.joinStr(@c,ktsaddress3)
     + dbo.joinStr(@c,ktscity) + dbo.joinStr(@c,ktsstate) + dbo.joinStr(@c,ktszip1) + dbo.joinStr(@c,ktszip2) + dbo.joinStr(@c,ktszip3) + dbo.joinStr(@c,country)
     ,1,len(@c),'')
 )
   and isnull(reason,'') < '  0'

  exec dbo.logit @@procid, 'Found mismatching address... @@rowCount', @@ROWCOUNT

-- add default address blob for the items that are mis-matched
  update aamasterCheck set defaultAddressBlob = dbo.taxrollAddressBlob(taxyear, ktsAutoNumber)
  where isnull(reason,'') > '  0' and balanceDue > 0

end