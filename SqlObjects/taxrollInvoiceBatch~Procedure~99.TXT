CREATE procedure [dbo].[taxrollInvoiceBatch](
 @taxYear varchar(4),
 @processCount int
)
as

begin

 declare 
  @sql varchar(500),
  @idToken int
 
 set @sql = 'select top ' + cast(@processCount as varchar) + ' id into temp_taxrollInvoice from adtax where [RealTaxYear] = ''' + @taxYear + '''
  and [TOTALDUE]+[ORIGINALTOTALDUE] > 0 and id not in (select taxrollId from invoices where taxyear = '+@taxYear+')'

 exec( @sql )

 while exists(select * from temp_taxrollInvoice)
 begin
  select top 1 @idToken = id from temp_taxrollInvoice
  exec dbo.taxReferenceCRUD @idToken
  exec dbo.taxrollInvoiceCRUD @idToken
  delete temp_taxrollInvoice where id = @idToken
 end

 drop table temp_taxrollInvoice
  

end




