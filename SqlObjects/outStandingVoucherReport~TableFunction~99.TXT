CREATE function dbo.outStandingVoucherReport(
 @endDate int,
 @paymentType varchar(50)
) returns @rt table(
 registerDate varchar(50),
 controlNumber varchar(50),
 registerNumber varchar(50),
 toWhom varchar(50),
 fundAccount varchar(50),
 fundAccountCode varchar(50),
 paidAmount varchar(50),
 vType varchar(10),
 actionDate varchar(50),
 ord varchar(250),
 paymentId int,
 fiscalYear varchar(10)
) as
begin
 if isnull(@paymentType,'')<' 0'
  select @paymentType = 'voucher'
 
 insert @rt
 select 
  postDate,
  controlNumber,
  dbo.popro6(foreignNumber,6,1),
  payee,
  fundAccount,
  '',
  balanceAsOf*-1,
  case contraPaymentType when 'Cleared Bank' then 'P' when 'Cancel Voucher' then 'C' when 'Cancel Warrant' then 'C' else left(contraPaymentType,1) end,
  dbo.date1(contraPostDate),
  left(fundaccount,20)+cast(postDate as varchar)+cast(controlNumber as varchar)+cast(dbo.popro6(foreignNumber,6,1) as varchar)+'b',
  dbo.slinkId(slink),
  fiscalyear
 from dbo.paymentReports('Bank',@endDate,null) 
  where isnull(paymentType,'') like '%'+@paymentType+'%' 

 update @rt set fundAccountcode=key1 from object where typ=4701 and key2=fundAccount



--group header
 insert @rt (toWhom,ord,fundAccount,fundAccountCode)
 select 
  fundaccount,
  left(fundaccount,20)+'000a',
  fundaccount,
  fundaccountCode
 from @rt where fundAccount>'  0' group by fundaccount,fundaccountCode

--group footer
 insert @rt (toWhom,paidAmount,ord,fundAccount,fundAccountCode)
 select 
  left(fundaccount,20)+' Total',
  sum(cast(paidAmount as money)),
  left(fundaccount,20)+'c',
  fundAccount,fundAccountCode
 from @rt where fundAccount>'  0' group by fundaccount,fundaccountCode

--report footer
 insert @rt (toWhom,paidAmount,ord)
 select 
  'GRAND TOTAL',
  sum(cast(paidAmount as money)),
  +'zzzz'
 from @rt where right(ord,1)='b'   

 update @rt set paidAmount = dbo.formatcurr(paidAmount)

 return
end