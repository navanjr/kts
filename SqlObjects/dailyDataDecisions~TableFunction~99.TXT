CREATE function dbo.dailyDataDecisions(@theDate int, @days int, @ordSeed varchar(50), @filterFlag varchar(10)) returns 
@rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 rowType char(10),
 brwBGColor int,
 blob varchar(max)
)
begin
 declare @wt table(id int,
  slink varchar(16),
  location varchar(50),
  requestDateTime datetime,
  requestPerson varchar(300),
  requestNotes varchar(max),
  beforeData varchar(max),
  [level] int,
  requestini varchar(20),
  requestSecurityLevel int
  )

 declare @sectionTitle varchar(50) = 'Decisions',
  @approvedPerson varchar(max),
  @approvedSecurity int,
  @approvedIni varchar(20)
  
 select @approvedPerson = dbo.whoAmI()
 select @approvedSecurity = securityLevel,
        @approvedIni = dbo.readstring('@ini=', @approvedPerson)
  from Users where Ini = dbo.readstring('@ini=', @approvedPerson)

 insert @wt
 select id,
  slink,
  location,
  requestDateTime,
  requestPerson,
  requestNotes,
  beforeData,
  level,
  isnull((select dbo.readstring('@ini=', requestPerson)),''),
  0
 from securityDecision
 where deniedDateTime is null
  and ISNULL(approvedPerson,'') < ' 0'

 update w
   set requestSecurityLevel = u.SecurityLevel
  from @wt w, Users u
  where w.requestini = u.Ini
 
 delete from @wt where ([level] = 3 and requestSecurityLevel < 81 and @approvedSecurity < 81)
 delete from @wt where ([level] = 4 and (requestSecurityLevel < 81 or @approvedSecurity < 81))
 delete from @wt where [level] = 1
 delete from @wt where requestini = @approvedIni
 
if exists(select * from @wt)
begin
 --insert main data
  insert @rt
  select cast('3' + cast(id as varchar) as int), 
   @ordSeed + dbo.clariondate(requestDateTime) + rtrim(requestini) + left(location,10), 
   left('  ' + cast(requestDateTime as varchar(12)) + '  ' + rtrim(requestini) + ': ' + location + ' - Notes: ' + requestNotes,249),
   '', 
   left('  ' + cast(requestDateTime as varchar(12)) + '  ' + rtrim(requestini) + ': ' + location + ' - Notes: ' + requestNotes,249),
   '', '', '', 'detail',    0, '@Decisions=1;'
  from @wt

 -- headers
  insert @rt select 0,@ordSeed+'00a','','','','','','','lineFeed',0,''
  insert @rt
  select 0,@ordSeed+'00aa','  '
   + dbo.padRight('Decisions',' ',20),
   '','  ' + @sectionTitle,'','','','sHeader',1,''
  insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79),
   replicate(' ',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,''
 end
 return
end
