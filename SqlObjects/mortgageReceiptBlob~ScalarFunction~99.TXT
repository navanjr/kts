create function dbo.mortgageReceiptBlob(@RecId varchar(50)) returns varchar(2000) as
begin

declare @retval varchar(2000), @exempt varchar(10)

select @exempt = case when olink3='1' then 'EXEMPT' else '' end from object where id=@RecId

select 

    @retval='@Tax='+cast(max(case when charindex('tax',account)>0 and  @exempt<>'EXEMPT' then general else '0' end) as varchar(50))
  + ';@Fee='+cast(MAX(case when charindex('fee',account)>0 and  @exempt<>'EXEMPT' then general else '0' end) as varchar(50))
  + ';@Total='+case when @exempt<>'EXEMPT' then cast(SUM(general) as varchar(50)) else '' end
  + ';@Exempt='+ @exempt + ';'
 from receiptDetailView where reclink='o'+@RecId group by recLink

 return @retval

end