create function dbo.docTaxWarrant(@documentId int,@invoiceId int,@taxRollDetailId int,@batchId int,@addressOnly int, @interestDate varchar(50))
returns @rt table (invoiceId int,
		itemNumber varchar(50),
		taxYears varchar(50),
		taxAmount money,
		penalty money,
		publication money,
		lien money,
		cost money,
		warrantTotal money,
		statFee money,
		sheriffFee money,
		totalDue money,
		documentDate varchar(20),
		addressee varchar(2000),
                taxtype varchar(50))
as
begin		
declare
 @documentName varchar(50),
 @documentDate varchar(50),
 @item varchar(50),
 @taxYear varchar(10),
 @publication money,
 @lien money,
 @stat money,
 @sheriff money,
 @addressee varchar(2000)


--get address 
if isnull(@taxRollDetailId,0) < 1
 select @addressee = dbo.parseAddressAndName(dbo.getTaxInvoiceBlob(@invoiceId))
else
 select @addressee = dbo.docGetAddresseeFromTaxRollDetail(@taxrollDetailId)

 select @item = item, @taxYear = taxYear from invoices where ID = @invoiceId

if @addressOnly!=1
 begin
 select @documentName =  key1 from Object where ID = @documentId
 
 select  
   @interestDate = coalesce(@interestDate,settingValue) 
    from settings where settingName = @documentName+'.interestTo'
 select  @documentDate = settingValue from settings where settingName = @documentName+'.documentDate'

--insert invoices
declare @wt table(invoiceId int,itemNumber varchar(50),taxYear varchar(50),taxAmount money,penalty money,fees money,invoiceType varchar(5))

 insert @wt
   select id,
	  item,
	  taxYear,
	  taxdue,
	  penalty,
	  fees,
          invoiceType
         from docUnpaidTf(@invoiceid, @interestDate)
         where invoicetype is not null         
 
/* 
 insert @wt 
 select	id,
	item,
	taxYear,
	invoiceDue,
	0,
	0
	from invoices where ID = @invoiceId or ITEM = @item 

  update a set			
	 a.fees = isnull((select sum(i.invoiceAmount) from invoices i where i.invoiceId=a.invoiceId and i.typ='f'),0),
	 a.penalty = round((cast(a.taxAmount as money)*dbo.penaltyPercent(invoiceId,dbo.date1(@interestDateInt))/100),2)
         from @wt a	where invoiceId != @invoiceId	
		
  update a set			
	 a.fees = isnull((select sum(i.invoiceAmount) from invoices i where i.invoiceId=a.invoiceId and i.typ='f' and printed != @documentName),0),
	 a.penalty = round((cast(a.taxAmount as money)*dbo.penaltyPercent(invoiceId,dbo.date1(@interestDateInt))/100),2)
         from @wt a where invoiceId = @invoiceId
*/


--get document fees
 select	@publication = sum(case when Key2 = 'Publication Fee' then cast(A2 as money) else 0 end), 
	@lien = sum(case when Key2 = 'Lien Docket Fee' then cast(A2 as money) else 0 end), 
	@stat = sum(case when Key2 = 'Statutory fee' then cast(A2 as money) else 0 end), 
	@sheriff = sum(case when Key2 = 'Sheriffs fee' then cast(A2 as money) else 0 end) 
	from Object where TYP = 4902 and Link1 = @documentId

end
insert @rt 
 select	@invoiceId,
	@item,
	case when min(taxYear)!= MAX(taxYear) then MIN(taxYear)+'-'+MAX(taxYear) else min(taxyear) end,
	sum(taxAmount),
	sum(penalty),
	@publication,
	@lien,
	SUM(fees),
	0,
	@stat,
	@sheriff,
	0,
	@documentDate,
	@addressee,
        case when max(invoiceType) = 'B' then 'Business' when max(invoiceType) = 'I' then 'Individual' when max(invoiceType) = 'R' then 'Real Estate' else 'Personal' end
	from @wt

update
 @rt  set
	warrantTotal = taxAmount + penalty + publication + lien + cost,
	totalDue = taxAmount + penalty + publication + lien + statFee + sheriffFee  + cost
		
return 
end
