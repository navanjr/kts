create function [dbo].[invoiceSubSLinks](@invoiceId int, @invoiceType varchar(10)) returns @rt table(
 slink varchar(15)
)
begin
 declare @idToken int
 declare @wt table(slink varchar(15),invoiceId int)
 declare @wt2 table(slink varchar(15))

 if @invoiceType > ' 0'
  begin
   insert @wt select 't' + cast(Id as varchar), Id from invoices where invoiceId = @invoiceId and typ = @invoiceType 
--   insert @rt select 'l' + cast(id as varchar) from receiptLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ = @invoiceType)
--   insert @rt select 'j' + cast(id as varchar) from journalLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ = @invoiceType)
--   insert @rt select 'o' + cast(receiptId as varchar) from receiptLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ = @invoiceType)
  end
 else
  begin
   insert @wt select 't' + cast(Id as varchar), Id from invoices where invoiceId = @invoiceId and typ <> 'A' 
--   insert @rt select 'l' + cast(id as varchar) from receiptLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ<>'A')
--   insert @rt select 'j' + cast(id as varchar) from journalLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ<>'A')
--   insert @rt select 'o' + cast(receiptId as varchar) from receiptLink where invoiceId in (select id from invoices where invoiceId = @invoiceId and typ<>'A')
  end
 

 while exists (select * from @wt)
  begin
   select top 1 @idToken = invoiceId from @wt

   insert @wt2 select slink from dbo.invoiceSLinks(@idToken)

   delete from @wt where invoiceId=@idToken
  end
 insert @rt select distinct slink from @wt2 
 return




end

