create procedure dbo.importAllPay 
as

begin


 exec dbo.createTaxPayImport

 
declare @path varchar(max) = dbo.pathFile(dbo.settingsF('taxroll.importFile',''),'path'),

         @cmd varchar(8000),

         @cmdOutput varchar(8000),

         @nameToken varchar(1000),

         @pathToken varchar(1000),

         @year varchar(4)

 
declare @infoTable table(name varchar(1000), filepath varchar(1000), processcode int)


 insert @infoTable
select name,[path],0 from dbo.dirRead(@path) where name like '%pay.tps' and isnumeric(left(name,4))=1



 while exists(select * from @infoTable where processcode=0)
  
begin
 

   select top 1 @nameToken = name, @pathToken = filepath from @infoTable where processcode = 0


   exec dbo.settingsCRUD 'taxroll.importTaxPayFile', @pathToken

   set @cmd = 'conv importTaxPay'


   exec dbo.ktsBat @cmd, @output = @cmdOutput OUTPUT, @silentmode = 'FALSE'


   select @year = left(dbo.pathFile(dbo.settingsF('taxroll.importTaxPayFile',''),'file'),4)


   if isnumeric(@year)=1 and cast(@year as int) not in (select distinct importyear from dbo.TaxPayAll)

   begin

    insert dbo.TaxPayAll

     select cast(@year as int), * from dbo.TaxPayImport
--      where @year+TAXYEAR+cast(RECEIPTNUMBER as varchar) not in 
--       (select cast(importyear as varchar)+TAXYEAR+cast(RECEIPTNUMBER as varchar) from dbo.TaxPayAll)

   end
 
 

   update @infoTable set processcode = 1 where name = @nameToken

  end



end