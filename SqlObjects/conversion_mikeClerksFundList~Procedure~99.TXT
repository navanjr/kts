create proc dbo.conversion_mikeClerksFundList(
 @mode varchar(50) = 'conversion',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as 
begin
 set nocount on

 if @mode != 'conversion'
  return

 declare @st table(
  kpofund varchar(4),
  NAME varchar(30),
  kpsfund varchar(8),
  accountCode varchar(50),
  accountDesc varchar(50)
 )

 declare
  @mikeTableName varchar(50) = 'PICKLIST',
  @mikePath varchar(max),
  @sql nvarchar(max)

 select @mikePath = dbo.settingsF('conversion.mikepath','') + '\' + @mikeTableName + '.dbf'
 select @sql = 'select srt,substring(val2,9,30),left(val2,8),"","" from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT * FROM ' + @mikeTableName + ' where type="ASGN" and !deleted()'')'

 insert @st exec(@sql)

-- clean up the funds with missing descriptions...
 declare @funds table(fundCode varchar(10), name varchar(50))
 select @sql = 'select fundcode, name from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT fundcode, name FROM fund where !deleted()'')'

 insert @funds exec(@sql)

 update a set
  a.name = b.name
 from @st a, @funds b
 where a.kpsfund = b.fundCode

 update a set
  a.accountCode = b.accountCode,
  a.accountDesc = b.accountDesc
 from @st a, dbo.glAccounts b
 where a.kpsfund = b.accountCode and b.accountType = 'FUND'

 if @method = 'GET'
 begin  
  select 
   @class = 'conversion',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = COUNT(*),  
   @message = 'clerks fund list not found in KTS'
  from @st
  where kpofund not in (select clerksFundCode from dbo.clerksFundList)
   and kpsfund > '  0'
 end

 if @method = 'SHOW'
 begin  

  select * 
  from @st
  where kpofund not in (select clerksFundCode from dbo.clerksFundList)

 end

 if @method = 'FIX'
 begin

  insert object (typ,key1,key2,a2,b1,olink5)
  select 4704, ltrim(rtrim(name)), kpofund, accountCode, accountDesc, 'mike'
   from @st
   where accountCode > '  0'
    and kpofund not in (select clerksFundCode from dbo.clerksFundList)

  exec dbo.logit @@procid, 'just inserted clerks funds into object typ 4704 @@rowCount', @@rowCount
 
  exec dbo.paymentAccountsVerificationall
  
  return

 end

end



