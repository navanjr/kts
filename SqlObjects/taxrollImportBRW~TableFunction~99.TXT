 create function dbo.taxrollImportBRW() returns @rt table(
  brwid int,
  display varchar(max),
  blob varchar(max),
  ord varchar(50)
) as 
begin

declare 
 @path varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.importfile',''),'path'),
 @file varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.importfile',''),'file'),
 @lvpath varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.taxLevyfile',''),'path'),
 @lvFile varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.taxLevyfile',''),'file'),
 @implvpath varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.importTaxLevyFile',''),'path'),
 @implvFile varchar(1000) = dbo.pathFile(dbo.settingsF('taxroll.importTaxLevyFile',''),'file'),
 @adtaxCheck int = 0,
 @adtax int = 0,
 @missingTaxRates int =0

 select 
  @lvfile = case when dbo.settingsF('taxroll.assessorSys','STATE') = 'STATE' then @file else @lvfile end,
  @lvpath = case when dbo.settingsF('taxroll.assessorSys','STATE') = 'STATE' then @path else @lvpath end

 select 
  @file = case when left(right(@file,4),1)='.' then left(@file,len(@file)-4) else @file end,
  @lvfile = case when left(right(@lvfile,4),1)='.' then left(@lvfile,len(@lvfile)-4) else @lvfile end



 insert @rt (display, ord) select '', 'b_'
 insert @rt (display, ord) select 'Taxroll Import Settings', 'b_0'
 insert @rt (brwid, display, ord)
   select '7'+cast(id*-1 as varchar),' -'+description+':'+dbo.splitf(display,':',2)+dbo.splitf(display,':',3),'b_'+description from dbo.settingsBRW('taxroll') 
    where ord <> case when dbo.settingsF('taxroll.assessorSys','STATE') = 'STATE' then 'taxroll.taxLevyFile' else '' end
 insert @rt (brwid, display, ord)
   select '7'+cast(id*-1 as varchar),' -'+description+':'+dbo.splitf(display,':',2)+dbo.splitf(display,':',3),'b_'+description from dbo.settingsBRW('conversion') 
    where ord = case when dbo.settingsF('taxroll.assessorSys','STATE') = 'STATE' then 'conversion.aamasterpath' else '' end

          

---Load Import
 if exists(select * from dbo.dirRead(@path) where name = @file) and exists(select * from dbo.dirRead(@lvpath) where name = @lvfile)
  begin
   insert @rt (display, ord) select '', 'c_'
   insert @rt (brwid,display, ord) select 81,'Load Import', 'c_0'
  end

---Ready to Import
if exists(select * from dbo.sysobjects where id = object_id(N'[dbo].[adtaxCheck]') and OBJECTPROPERTY(id, N'IsTable') = 1)
 begin
  select @adtaxCheck =  count(id) from adtaxCheck where cast(realtaxyear as varchar)+''+cast(itemnumber as varchar) not in (select cast(realtaxyear as varchar)+''+cast(itemnumber as varchar) from AdTax)

  if @adtaxCheck>0
  begin
   insert @rt (display, ord) select '', 'c_0'
   insert @rt (brwid,display, ord) select 61,'Ready to Import', 'c_00'
 
   insert @rt (brwid, display, ord)
    select '9'+cast(realtaxYear as varchar),' -Tax Year: '+dbo.padright(cast(realTaxYear as varchar),' ',8) +' Count: '+dbo.padright(dbo.formatNum(count(id)),' ',10),'c_'+cast(realtaxYear as varchar) from adtaxCheck where cast(realtaxyear as varchar)+''+cast(itemnumber as varchar) not in (select cast(realtaxyear as varchar)+''+cast(itemnumber as varchar) from AdTax) group by realtaxyear

  end
 end

---Ready to Invoice
 select @adtax = count(id) from adtax where recordType>'  0' and id not in (select taxrollid from invoices)

if @adtax>0
 begin
  insert @rt (display, ord) select '', 'd_0'
  insert @rt (display, ord) select dbo.padright('Ready to Invoice',' ',18), 'd_00'
  insert @rt (display, ord) select dbo.padright('',' ',2)+dbo.padright('Tax Year',' ',10)+dbo.padLeft('Count',' ',7)+dbo.padLeft('Amount',' ',16), 'd_00'

  insert @rt (brwid, display, ord,Blob)
    select '5'+cast(realtaxYear as varchar),
     '  '+dbo.padright(cast(realTaxYear as varchar),' ',10) 
     +dbo.padleft(dbo.formatNum(count(id)),' ',7)
     +dbo.padleft(dbo.formatCurr(sum(balanceDue)),' ',16),
    'd_'+cast(realtaxYear as varchar),
     '@count=' + cast(count(id) as varchar) + ';@amount=' +  cast(sum(balanceDue) as varchar) + ';'
    from adtax where recordType>'  0' and id not in (select taxrollid from invoices where typ<>'s')
    group by realtaxyear


 while exists(select * from @rt where charindex('@missingTaxRates=',blob)=0 and len(cast(brwId as varchar))=5)
  begin
   declare @taxYear varchar(5)
    select @taxYear = substring(cast(brwId as varchar),2,4) from @rt where charindex('@missingTaxRates=',blob)=0
    if @taxYear>0
    begin
     select @missingTaxRates=SUM(case when millTotal is null then 1 else 0 end) from dbo.taxyearTrioBRW(@taxYear)
      update @rt set 
       blob = blob+'@missingTaxRates=' + cast(@missingTaxRates as varchar) +';', 
       display = display + case when @missingTaxRates>0 then ' *Missing Tax Rates' else '' end
       where brwid='5'+@taxYear
    end
  end


  insert @rt (display, ord)
    select 
     dbo.padright('  Totals:',' ',12) 
     + dbo.padleft(dbo.formatNum(sum(cast(dbo.readstring('@count=',blob) as money))),' ',7)
     + dbo.padleft(dbo.formatCurr(sum(cast(dbo.readstring('@amount=',blob) as money))),' ',16),
    'd_zz'
    from @rt where left(ord,2)='d_'

 end
  insert @rt (display, ord)
    select '','zzzzz'

 return
end
