create procedure dbo.imageViewCRUD(@scanId varchar(16),@reportname varchar(100)='')
as 
begin

 declare @ini varchar(50),
         @objectType int,
         @slinkTyp varchar(1),
         @slinkId int

 declare @slinks table(slink varchar(16))

 select @ini = dbo.readstring('@ini=',dbo.whoami())

 --bail if we failed to read the initials
 if len(isnull(@ini,''))<1
 begin
  select '@code=1;@message=No Initials were found;'
  return
 end

 --bail if scanid is zero or blank
 if len(isnull(@scanId,''))<2
 begin
  select '@code=1;@message=No Scan Id was chosen;'
  return
 end

 update object set typ=-9208 where typ=9208 and key2 = @ini

 if isnumeric(@scanId)=1
  begin
   insert into object (typ,link1,link2,link3,key1,key2,key3) 
    select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini,isnull((select key1 from object where id = @scanId),'') 
      from imglinks where objidref = @scanId
   
   select @objectType = typ from object where id = @scanId
   
   if @objectType in (4502,4522)
    begin
     insert into object (typ,link1,link2,link3,key1,key2,key3) 
      select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini,p.checkno 
      from imglinks il, object o, paid p 
       where il.objidref = o.id
        and o.typ=3209
        and o.key1 = 'p'+cast(p.id as varchar)
        and p.slink = 'o'+cast(@scanId as varchar)

     insert into object (typ,link1,link2,link3,key1,key2,key3) 
      select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini,
       isnull((select key1 from object where id = p.mailLogId),'') as key3
       from imglinks il, paid p
        where il.objidref = p.mailLogId
         and p.slink = 'o'+cast(@scanId as varchar)
   end   
   if @objectType = 4513
   begin
    insert into object (typ,link1,link2,link3,key1,key2,key3) 
     select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini,
       isnull((select key1 from object where id = dbo.slinkid(p.slink)),'') as key3
      from imglinks il, object o, paid p 
       where il.objidref = o.id
        and o.typ=3209
        and o.key1 = 'p'+cast(p.id as varchar)
        and p.depositId = cast(@scanId as int)

/*
     insert into object (typ,link1,link2,link3,key1,key2) 
      select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini from imglinks where objidref in
        (select mailLogId from paid where depositId = cast(@scanId as int))
*/
   end
   if @objectType = 4514
    insert into object (typ,link1,link2,link3,key1,key2) 
     select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini from imglinks where objidref in
       (select id from object where typ = 3209 and key1 in 
           (select 'p' + cast(id as varchar) from paid where mailLogId = cast(@scanId as int)))
   
   
  end
 else
  begin
   select @slinkTyp = left(@scanId,1)

   insert into object (typ,link1,link2,link3,key1,key2) 
    select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini from imglinks where objidref in
      (select id from object where typ = 3209 and key1 = @scanId)

   if @slinkTyp = 't'
   begin
    select @slinkId = cast(substring(@scanId,2,15) as int)

    insert into object (typ,link1,link2,link3,key1,key2) 
    select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini from imglinks where objidref in
      (select id from object where typ = 3209 and key1 in (select 'cb' + cast(Id as varchar) from dbo.taxrollSearchCommentBRW(@slinkId)))
 
   end

   if @slinkTyp = 'o' and @reportname='balanceReport'
   begin
    
    select @slinkId = cast(substring(@scanId,2,15) as int)

     declare @gcBeginDate varchar(6),
             @gcEndDate varchar(6),
             @gcReceiptType varchar(50),
             @gcDeputy varchar(50),
             @gcStation varchar(50),
             @gcBankAccount varchar(60)

     select top 1 
             @gcBeginDate = key1,
             @gcEndDate = key2,
             @gcReceiptType = case when key3 > ' 0' then key3 else '0' end,
             @gcDeputy = case when a1 > ' 0' then a1 else '0' end,
             @gcStation = case when a3 > ' 0' then a3 else '0' end,
             @gcBankAccount = b4
      from object where typ=4506 and id = @slinkId


     insert @slinks
      select 'p'+cast(paidid as varchar) 
        from dbo.depositBalanceTf(@gcBeginDate,@gcEndDate,@gcDeputy,0,@gcStation,@gcReceiptType,@gcBankAccount,'Y') 
       where isnull(paidid,0)>0



     insert into object (typ,link1,link2,link3,key1,key2,key3) 
      select 9208, ilinkid, objidref, imgline, ' ' as selected, @ini,p.checkno 
      from imglinks il, object o, paid p 
       where il.objidref = o.id
        and o.typ=3209
        and o.key1 = 'p'+cast(p.id as varchar)
        and 'p'+cast(p.id as varchar) in (select slink from @slinks)
 
   end

  end
 --bail if no images were found
 if not exists(select * from object where typ = 9208 and key2 = @ini)
 begin
  select '@code=1;@message=No Images were found for this item;'
  return
 end

 select top 1 cast(link2 as varchar)
  from object where typ = 9208 and key2 = @ini
  order by link2, link1

 
end