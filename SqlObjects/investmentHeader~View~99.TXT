create view investmentHeader as 
select 
  id,
  key1 as investmentNumber,
  case when isnumeric(key2)=1 then cast(key2 as int) else 0 end as purchaseDate,
  case when isnumeric(a18)=1 then cast(a18 as int) else 0 end as maturityDate,
  case when isnumeric(key3)=1 then cast(key3 as int) else 0 end as liquidationDate,
  a1 as bankName,
  a2 as purchaseCheck,
  a3 as fundDrawnOnName,
  b2 as fundDrawnOnCode,
  a4 as investmentType,
  a5 as interestRate,
  a9 as bankAccountCode,
  a10 as bankAccountName,
  isnull((select sum(amount) from gldetail where accountcode = a9 and date<=case when isnumeric(key2)=1 then cast(key2 as int) else 0 end),0) as principal,
  isnull((select sum(amount) from gldetailreports where accountcode = a9 and (date<case when isnumeric(key3)=1 then cast(key3 as int) else 0 end or case when isnumeric(key3)=1 then cast(key3 as int) else 0 end <'1') and sourcetype<>'4512'),0)-isnull((select sum(amount) from gldetailreports where accountcode = a9 and date<=case when isnumeric(key2)=1 then cast(key2 as int) else 0 end and sourcetype<>'4512'),0) as accruedInterest,
  case when b11='1' then a7 else isnull((select dbo.investmentInterestEarned(case when isnumeric(key2)=1 then cast(key2 as int) else 0 end,case when isnumeric(key3)=1 then cast(key3 as int) else 0 end,a9)),0) end as interest,
  isnull((select sum(amount) from gldetail where accountcode = a9 and (date<case when isnumeric(key3)=1 then cast(key3 as int) else 0 end or case when isnumeric(key3)=1 then cast(key3 as int) else 0 end <'1')),0) as endValue,
  dbo.investmentValue(id, dbo.clariondate(getdate())) as currentValue,
 d1 as comment
from object 
where typ=4706
  
