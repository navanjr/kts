create function dbo.reportMiscReceiptDetail(@beginDate varchar(15), @endDate varchar(15)) returns @rt table(postDate int, 
   postDate1 varchar(50),
   ReceiptNo varchar(50),
   FundDesc varchar(60),
   ReceivedOf varchar(60),
   amount money,
   PrevApportioned money,
   slink varchar(16),
   fundCode varchar(60),
   description varchar(150),
   sourceDesc varchar(60),
   detCount int,
   recId int,
   amountToApportion money,
   mrId int,
   form308 int)

as   
begin   

declare @wt table(postDate int, 
   postDate1 varchar(50),
   ReceiptNo varchar(50),
   FundDesc varchar(60),
   ReceivedOf varchar(60),
   amount money,
   PrevApportioned money,
   slink varchar(16),
   fundCode varchar(60),
   description varchar(150),
   sourceDesc varchar(60),
   detCount int,
   recId int,
   amountToApportion money,
   mrId int)

declare @mr table(id int,
   postDate int, 
   postDate1 varchar(50),
   ReceiptNo varchar(50),
   FundDesc varchar(60),
   ReceivedOf varchar(60),
   amount money,
   PrevApportioned money,
   slink varchar(16),
   fundCode varchar(60),
   [description] varchar(150),
   sourceCode varchar(60),
   sourceDesc varchar(60),
   detCount int,
   recId int,
   processFlag int,
   bsId int,
   bsSlink varchar(16))

declare @mrd table(id int identity(1,1),
   FundDesc varchar(60),
   amount money,
   PrevApportioned money,
   fundCode varchar(60),
   [description] varchar(150),
   sourceCode varchar(60),
   sourceDesc varchar(60),
   recId int,
   mrId int,
   processFlag int,
   bsId int,
   alreadyApportioned varchar(5))



declare @miscCollectionAccountCode varchar(60),
        @miscTaxAccountId int

select @miscCollectionAccountCode = key3 from object where typ=4503 and key1='MISC'

select @miscTaxAccountId = accountId from glAccounts where accountCode=@miscCollectionAccountCode


insert @mr
select r.id,d.[sourcedate],dbo.date1(d.[sourcedate]) as postDate,r.key1 as receiptNo,'',r.a1, sum(amount),
  0.00 as PrevApportioned, d.slink, '','','','',0, r.id, 0, d.bsId, 'o' + cast(d.bsId as varchar)  
from dbo.glDetailReports d, glAccounts a, object r 
where d.accountCode=a.accountCode 
 and (dbo.slinkId(d.slink)=r.id)
 and d.[sourcedate]>=@beginDate 
 and d.[sourcedate]<=@endDate 
 and contraId=@miscTaxAccountId
 and (isnull(d.bsId,0)=0 or isnull(d.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT'))
 and sourceType='4502'
group by r.id,d.[sourcedate],r.key1,r.a1,d.slink,r.id,d.bsId 

insert @mr
select r.id,d.[sourcedate],dbo.date1(d.[sourcedate]) as postDate,r.key1 as receiptNo,'',r.a1, sum(amount),
  0.00 as PrevApportioned, d.slink, '','','','',0, r.id, 0, d.bsId, 'o' + cast(d.bsId as varchar)  
from dbo.glDetailReports d, glAccounts a, object r 
where d.accountCode=a.accountCode 
 and (dbo.slinkId(d.slink)=r.id)
 and d.[sourcedate]>=@beginDate 
 and d.[sourcedate]<=@endDate 
 and contraId=@miscTaxAccountId
 and (isnull(d.bsId,0)=0 or isnull(d.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT'))
 and sourceType='4512'
 and left(sourcea18,13) <> 'APPORTIONMENT'
 and r.id not in (select jeId from journallink)
group by r.id,d.[sourcedate],r.key1,r.a1,d.slink,r.id,d.bsId 

insert @mr
select 0,d.[sourcedate],dbo.date1(d.[sourcedate]) as postDate,r.key1 as receiptNo,'',r.a1,0.00,
  sum(amount) as PrevApportioned, d.slink, '','','','',0, r.id, 0, d.bsId, 'o' + cast(d.bsId as varchar)  
from dbo.glDetailReports d, glAccounts a, object r 
where d.accountCode=a.accountCode 
 and (dbo.slinkId(d.slink)=r.id)
 and d.[sourcedate]>=@beginDate 
 and d.[sourcedate]<=@endDate 
 and contraId=@miscTaxAccountId
 and isnull(d.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT SPECIAL')
 group by d.[sourcedate],r.key1,r.a1,d.slink,r.id,d.bsId


declare @idToken int
 while exists(select * from @mr where processFlag=0)
 begin
  select top 1 @idToken = id from @mr where processFlag=0
  insert @mrd (mrId,amount,fundCode,sourceCode,[description],bsId)
  select @idToken,amount,creditCode,sourceCode,comment,bsId from dbo.apportionCollectionsWT(@idToken,@endDate,'MISCREPORT',null,null) where creditCode > ' 0' and left(creditcode,1)<>'@' and isnull(contraId,0)=0
  update @mr set processFlag=1 where id=@idToken
 end

update @mrd set alreadyApportioned = 'TRUE' where bsId in (select id from object where typ=4512 and a18='APPORTIONMENT SPECIAL')

 insert @rt
 select postDate, postDate1,mr.receiptNo,f.accountDesc,ReceivedOf,mrd.amount,0,mr.slink,mrd.fundCode,mrd.[description],s.accountDesc,0,mr.recId,mrd.amount, mrId, f.form308 
  from @mr mr, @mrd mrd, glaccounts f, glaccounts s
  where mr.id=mrd.mrId
   and mrd.fundCode=f.accountCode
   and mrd.sourceCode=s.accountCode
   and (isnull(mrd.bsId,0)=0 or isnull(mrd.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT')) 
   and (isnull(mr.bsId,0)=0 or isnull(mr.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT')) 
   
 insert @rt  
 select postDate, postDate1,mr.receiptNo,f.accountDesc,ReceivedOf,g.amount*-1,g.amount*-1,mr.slink,g.accountCode,g.comment,s.accountDesc,0,mr.recId,0 ,0,f.form308
 from @mr mr, gldetail g, glaccounts f, glaccounts s 
  where 
   g.slink = mr.bsSlink
   and g.accountCode=f.accountCode
   and g.sourceCode=s.accountCode
   and f.accountType in (select accountType from dbo.glBankFundTypes('FUND'))
   and isnull(mr.bsId,0) in (select id from object where typ=4512 and a18='APPORTIONMENT SPECIAL')


return
end