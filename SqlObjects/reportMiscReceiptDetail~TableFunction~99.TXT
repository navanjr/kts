create function dbo.reportMiscReceiptDetail(@beginDate int, @endDate int) returns @rt table(postDate int, 
   postDate1 varchar(50),
   ReceiptNo varchar(50),
   FundDesc varchar(60),
   ReceivedOf varchar(60),
   amount money,
   PrevApportioned money,
   slink varchar(16),
   fundCode varchar(60),
   description varchar(150),
   sourceDesc varchar(60),
   detCount int)

as   
begin   

declare @miscCollectionAccountCode varchar(60) = 'MISCTAX',
        @miscTaxAccountId int

select @miscTaxAccountId = accountId from glAccounts where accountCode=@miscCollectionAccountCode


insert @rt
select d.[date],dbo.date1(d.[date]) as postDate,r.key1 as receiptNo,f.accountDesc,r.a1,amount,
  0000000.0000 as PrevApportioned, d.slink, d.accountCode,'','',0 
from dbo.glDetailReports d, glAccounts a, glAccounts f, object r 
where d.accountCode=a.accountCode 
 and a.targetAccountCode=f.accountCode
 and (dbo.slinkId(d.slink)=r.id)
 and d.[date]>=@beginDate 
 and d.[date]<=@endDate 
 and contraId=@miscTaxAccountId

declare @st table(slink varchar(16), fundCode varchar(60), sourceCode varchar(60), sourceDesc varchar(100), Description varchar(150))
insert @st
 select rd.slink, f.accountCode, rd.sourceCode, a.accountDesc, rd.[description]
  from receiptDetail rd, glAccounts a, glAccounts f 
 where 
  rd.sourceCode=a.accountCode
  and rd.fundCode = f.targetAccountCode
  and f.accountType='ACCRUED RECEIVABLE'
  and slink in (select slink from @rt)

update r set detCount=c.cnt
 from @rt r, (select count(*) as cnt,slink,fundCode from @st group by slink,fundCode ) c
 where r.slink=c.slink
  and r.fundCode=c.fundCode

update r set [description]=s.[description], sourceDesc = s.sourceDesc 
from @rt r, @st s 
where 
 r.slink=s.slink
  and r.fundCode=s.fundCode
  and r.detCount=1
  
insert @rt (ReceiptNo, fundCode, [description], sourceDesc, detCount)
 select r.ReceiptNo, r.fundCode, s.[description], s.sourceDesc, 0
 from @rt r, @st s 
where 
 r.slink=s.slink
  and r.fundCode=s.fundCode
  and r.detCount>1



return
end