create procedure dbo.api(
 @nodeScript varchar(100) = null,
 @scratchFile varchar(100) = null,
 @scratchFileName varchar(100) = 'api.tmp',
 @postFile varchar(100) = null,
 @apiKey varchar(50) = null,
 @apiHost varchar(50) = null,
 @apiCode varchar(50) = null,
 @method  varchar(10) = '',
 @resource varchar(250) = '',
 @filter varchar(8000) = '',
 @cmd varchar(8000) = null,
 @postBlob varchar(max) = null,
 @debugMode varchar(5) = 'FALSE',
 @cmdOutput int = null output,
 @dump nvarchar(max) = null output
) as
begin
 set nocount on
 
 declare
  @rawDump varchar(max),
  @gitPath varchar(150),
  @default_nodeScript varchar(100) = '',
  @default_scratchFile varchar(100) = '',
  @tempPath varchar(100),
  @apiOutputFile varchar(1000),
  @postBlobPathAndFileName varchar(100),
  @backslash char(1) = char(92)

 select @tempPath = path from dbo.paths() where name = 'temp'

 select @gitPath = path from dbo.paths() where name = 'gitRepo'

 set @default_nodeScript = @gitPath + @backslash + 'api.js'

 select @default_scratchFile = @tempPath + @backslash + @scratchFileName

-- select optional parameters from site
 declare 
  @site_apiHost varchar(50),
  @site_apiKey varchar(50),
  @site_apiCode varchar(50)
 select top 1
  @site_apiHost = b13,
  @site_apiKey = b11,
  @site_apiCode = b12
 from Object where typ = 40 order by id

-- check resource for leading slash
IF left(@resource,1) != '/'
  SET @resource = '/' + @resource

-- create post file if we are passed a postblob and a post filename
 if isnull(@postblob,'') > '  0' and isnull(@postFile,'') > '  0'
 begin
  set @postBlobPathAndFileName = @tempPath + @backslash + @postFile
  exec dbo.spOverwriteTextFile @postBlobPathAndFileName, @postBlob
 end

 if isnull(@postFile,'') > '  0'
  select @filter = 'file:' + @tempPath + @backslash + @postFile

 set @apiOutputFile = coalesce(@scratchFile,@default_scratchFile)

-- node api.js [key] [method] [host] [resource] [filter]
 
 set @cmd = 'node ' + coalesce(@nodeScript, @default_nodeScript)
  + ' ' + coalesce(@apiKey, @site_apiKey)
  + ' ' +  @method
  + ' ' + coalesce(@apiHost, @site_apiHost)
  + ' ' + @resource
  + ' ' + isnull(@filter,'')
  + ' > ' + @apiOutputFile

 exec dbo.logit @@procid, '@cmd', @cmd

 if @debugMode = 'TRUE'
 begin
  exec dbo.logit @@procid, 'skipping the actual call to the API cause im in debug mode'
 end
 else
 begin
  exec @cmdOutput = master..xp_cmdshell @cmd, no_output

  exec dbo.spReadTextFile
   @fullPath = @apiOutputFile,
   @fileContents = @rawDump output 

  set @dump = dbo.stripChars(@rawDump,'13,10')
 end

 return

end