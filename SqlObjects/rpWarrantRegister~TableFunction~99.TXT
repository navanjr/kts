create function dbo.rpWarrantRegister(@begindate varchar(20),@enddate varchar(20)) returns @rt table(
RegNo varchar(160),
RegDateNo varchar(160),
RegDate varchar(160),
WarNo varchar(160),
WarDateNo varchar(160),
WarDate varchar(160),
Payee varchar(160),
amount money,
FundCode varchar(160),
FundDesc varchar(160),
PayNo varchar(160),
PayDateNo varchar(160),
PayDate varchar(160),
PayAmount money,
fiscalYear varchar(160),
debitCode varchar(160),
reportOrder varchar(160)
)
as begin

declare @wt table(
RegNo varchar(160),
RegDateNo varchar(160),
RegDate varchar(160),
WarNo varchar(160),
WarDateNo varchar(160),
WarDate varchar(160),
Payee varchar(160),
amount money,
FundCode varchar(160),
FundDesc varchar(160),
PayNo varchar(160),
PayDateNo varchar(160),
PayDate varchar(160),
PayAmount money,
fiscalYear varchar(160),
debitCode varchar(160),
reportOrder varchar(160)
)

declare @warrantsHitLedgerWhenRegistered varchar(5)

select @warrantsHitLedgerWhenRegistered = settingvalue from dbo.settings where settingname='site.warrantsHitLedgerWhenRegistered'


if @warrantsHitLedgerWhenRegistered = 'TRUE'
begin
insert @wt 
select controlNumber
      ,postDate
      ,dbo.date1(postDate)
      ,foreignNumber
      ,foreignDate
      ,dbo.date1(foreignDate)
      ,payee
      ,naturalAmount*-1
      ,FundCode
      ,FundDesc
      ,case when contraPaymentType='Cleared Bank' then controlNumber else contraPaymentType end
      ,contraPostDate
      ,dbo.date1(contraPostDate)
      ,case when contraPaymentType='Cleared Bank' then naturalAmount*-1 else 0 end
      ,right(fiscalYear,2)
      ,accountCode
      ,ord 
 from dbo.paymentReports('Bank',@enddate,'TRUE') 
 where postDate <= @endDate

insert @wt 
select contraControlNumber
      ,contraPostDate
      ,dbo.date1(contraPostDate)
      ,contraForeignNumber
      ,contraForeignDate
      ,dbo.date1(contraForeignDate)
      ,case when isnull(contraPaymentType,'NULL') not in ('Cleared Bank','NULL') then contraPaymentType + ' ' + foreignNumber + ' ' + payee else payee end
      ,contraAmount*-1
      ,FundCode
      ,FundDesc
      ,''
      ,''
      ,''
      ,0.00
      ,right(fiscalYear,2)
      ,accountCode
      ,ord 
 from dbo.paymentReports('Bank',@enddate,'TRUE') 
 where contraPostDate <= @endDate and isnull(contraPaymentType,'NULL') not in ('Cleared Bank','NULL')
end
else
begin
insert @wt 
select controlNumber
      ,postDate
      ,dbo.date1(postDate)
      ,foreignNumber
      ,foreignDate
      ,dbo.date1(foreignDate)
      ,payee
      ,naturalAmount
      ,FundCode
      ,FundDesc
      ,case when contraPaymentType='Treasurers Check' then contraControlNumber else contraPaymentType end
      ,contraPostDate
      ,dbo.date1(contraPostDate)
      ,case when contraPaymentType='Treasurers Check' then contraAmount*-1 else 0 end
      ,right(fiscalYear,2)
      ,accountCode
      ,ord 
 from dbo.paymentReports('Warrant',@enddate,'TRUE') 
 where postDate <= @endDate

 if dbo.settingsf('site.warrantRegisterIncludesCancelled','FALSE')='TRUE'
 begin
  insert @wt 
  select contraControlNumber
      ,contraPostDate
      ,dbo.date1(contraPostDate)
      ,contraForeignNumber
      ,contraForeignDate
      ,dbo.date1(contraForeignDate)
      ,case when isnull(contraPaymentType,'NULL') not in ('Treasurers Check','NULL') then contraPaymentType + ' ' + foreignNumber + ' ' + payee else payee end
      ,contraAmount
      ,FundCode
      ,FundDesc
      ,''
      ,''
      ,''
      ,0.00
      ,right(fiscalYear,2)
      ,accountCode
      ,ord 
  from dbo.paymentReports('Warrant',@enddate,'TRUE') 
  where contraPostDate <= @endDate and isnull(contraPaymentType,'NULL') not in ('Treasurers Check','NULL')
 end

end


insert @rt
select [RegNo]
      ,[RegDateNo]
      ,[RegDate]
      ,[WarNo]
      ,[WarDateNo]
      ,[WarDate]
      ,[Payee]
      ,[amount]
      ,[FundCode]
      ,[FundDesc]
      ,case when charindex('cancel',[PayNo])>0 then 'Cancel' else [PayNo] end
      ,[PayDateNo]
      ,[PayDate]
      ,[PayAmount]
      ,right([fiscalYear],2)
      ,[debitCode]
      ,[reportOrder] 
  from @wt where (RegDateNo >= @beginDate and RegDateNo <= @endDate) --or (PayDateNo >= @beginDate and PayDateNo <= @endDate)





 insert @rt 
 select ''
      ,''
      ,''
      ,''
      ,''
      ,''
      ,'Total Carried Forward'
      ,sum(isnull(amount,0))+isnull((select s.amount from dbo.warrantPastPaidSummary() s where right(s.fy,2)=right(w.fiscalYear,2) and s.fundCode=w.fundCode),0)
      ,w.FundCode
      ,w.FundDesc
      ,''
      ,''
      ,''
      ,0.00
      ,right(w.fiscalYear,2)
      ,''
      ,reportOrder
 from @wt w
 where RegDateNo < @beginDate
 and fundcode+fundDesc+right(fiscalYear,2) in (select fundcode+fundDesc+right(fiscalYear,2) from @rt)
 group by right(fiscalYear,2),fundCode,FundDesc,reportOrder


 insert @rt
 select ''
      ,''
      ,''
      ,''
      ,''
      ,''
      ,'Paid in Old System'
      ,amount
      ,FundCode
      ,FundDesc
      ,''
      ,''
      ,''
      ,0.00
      ,right(fy,2)
      ,''
      ,rtrim(fundcode)+' - '+rtrim(fundDesc)
 from dbo.warrantPastPaidSummary()
  where rtrim(fundCode)+right(fy,2) not in (select rtrim(w.fundCode)+right(w.fiscalYear,2) from @rt w where w.Payee = 'Total Carried Forward')
   and rtrim(fundCode)+right(fy,2) in (select rtrim(w.fundCode)+right(w.fiscalYear,2) from @rt w where w.Payee <> 'Total Carried Forward')


 update @rt set fiscalyear = cast(cast('20'+fiscalyear as int)-1 as varchar(4))+'-'+'20'+fiscalyear where fiscalyear > ' 0' and isnumeric(right(fiscalyear,2))=1

return
end