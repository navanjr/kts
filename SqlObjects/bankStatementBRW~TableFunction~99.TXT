create function dbo.bankStatementBRW( @id int, @accountId int, @showFlag varchar(50) ) returns @rt table(
 id int,
 fpid int,
 slink varchar(15),
 description varchar(100),
 subDescription varchar(100),
 dbAmount money,
 crAmount money,
 selectedFlag char(1),
 ord varchar(50)
)
begin

 declare @showTable table(id int)
 insert @showTable select 0
 if left(@showFlag,1) = '1'
  insert @showTable select @id
 
 insert @rt (id,fpid,slink,dbAmount,crAmount,subDescription,selectedFlag)
 select id* -1, fpid, slink,
  case when amount > 0 then amount else 0 end,
  case when amount < 0 then amount else 0 end,
  slink,
  case when isnull(bsId,0) = 0 then '' else 'X' end
 from dbo.glDetail 
 where accountId = @accountId
  and isnull(bsId,0) in (select id from @showTable)

 update a set
  a.description = '   ' + dbo.date1(b.key2),
  a.subDescription = c.template + '# ' + b.key1,
  ord = cast(fpid as varchar) + 'b' 
 from @rt a, object b, template c
 where left(slink,1) = 'o' 
  and cast(substring(slink,2,14) as int) = b.id
  and b.typ = c.id

 insert @rt (id,description,ord)
 select 0,'Period: ' + b.key1 + ' ' + key2,b.id from @rt a, object b where a.fpid = b.id group by b.key1,b.key2,b.id
 
 return
end
