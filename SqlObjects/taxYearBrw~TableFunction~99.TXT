create function dbo.taxYearBrw(@taxYear varchar(10),@switch varchar(4),@batchName varchar(100)) 

returns @rt table 
 (invoiceId int,
  name nvarchar(60),
  printOrder varchar(50),
  parcel nvarchar(34),
  taxYear numeric(5,0),
  item numeric(22,1),
  taxType nvarchar(1),
  amount money,
  due money,
  slink varchar(15),
  selectedFlag char(4),
  methodRate money,
  ord varchar(80),
  fees money,
  penalty money,
  toPay money,
  treamort varchar(5),
  taxrollId int,
  queue varchar(50),
  printed varchar(50))
as
begin

 declare @taxYears table(taxYear int)
 if isnull(@taxYear,'') > '  0'
  insert @taxYears select @taxYear
 else
  insert @taxYears select distinct taxyear from invoices

 if @switch='p'
 begin
  insert @rt
  select 
   a.id*-1,
   a.name,
   a.printOrder,
   a.parcel,
   a.taxYear,
   a.item,
   a.typ,
   a.invoiceAmount,
   a.invoiceDue,
   't'+cast(a.id as varchar),
   '',
   0,
   'b_',case when a.invoiceDue != 0 then a.subInvoiceDue else 0.00 end,
   0,
   0,
   '',
   a.taxrollId,
   a.queue,
   a.printed
  from dbo.invoices a
  where a.taxYear in (select taxYear from @taxYears)
   and a.queue=@batchName
 end


 if @switch='q'
 begin
  insert @rt
  select 
   a.id*-1,
   a.name,
   a.printOrder,
   a.parcel,
   a.taxYear,
   a.item,
   a.typ,
   a.invoiceAmount,
   a.invoiceDue,
   't'+cast(a.id as varchar),
   '',
   0,
   'b_',case when a.invoiceDue != 0 then a.subInvoiceDue else 0.00 end,
   0,
   0,
   '',
   a.taxrollId,
   a.queue,
   a.printed
  from dbo.invoices a
  where a.taxYear in (select taxYear from @taxYears)
   and a.printed='' and a.queue=@batchName
 end


 if @switch='M'
 begin
  insert @rt
  select 
   a.id*-1,
   a.name,
   a.printOrder,
   a.parcel,
   a.taxYear,
   a.item,
   a.typ,
   a.invoiceAmount,
   a.invoiceDue,
   't'+cast(a.id as varchar),
   '',
   0,
   'b_',case when a.invoiceDue != 0 then a.subInvoiceDue else 0.00 end,
   0,
   0,
   '',
   a.taxrollId,
   a.queue,
   a.printed
  from dbo.invoices a
  where a.taxYear in (select taxYear from @taxYears)
   and a.taxrollid in (select id from adtax where realtaxyear in (select taxyear from @taxYears) and (cast(mortgagecode as varchar) > '0' or cast(treamort as varchar) > '0'))
 end


 update @rt set treamort=case when a.treamort>'  0' then cast(a.treamort as varchar) else cast(mortgagecode as varchar) end from adtax a where taxrollid=a.id



return

end