create function dbo.taxYearBrw(@taxYear varchar(10),@switch varchar(4),@ini varchar(4)) 

returns @rt table 
 (invoiceId int,
  name nvarchar(60),
  parcel nvarchar(34),
  taxYear numeric(5,0),
  item numeric(22,1),
  taxType nvarchar(1),
  amount money,
  due money,
  slink varchar(15),
  selectedFlag char(4),
  methodRate money,
  ord varchar(80),
  fees money,
  penalty money,
  toPay money,
  treamort varchar(5),
  taxrollId int,
  queue varchar(50),
  printed varchar(50))
as
begin

if @switch='p'
 begin
   insert @rt
     select 
        id*-1,name,parcel,taxYear,item,typ,invoiceAmount,invoiceDue,'t'+cast(id as varchar),'',0,'b_',case when invoiceDue != 0 then subInvoiceDue else 0.00 end, 0             ,0,'',taxrollId,queue,printed
       from dbo.invoices
      where taxYear = @taxYear  and printed > '  0' --queue=@ini
     order by name 
end


if @switch='q'
 begin
   insert @rt
     select 
        id*-1,name,parcel,taxYear,item,typ,invoiceAmount,invoiceDue,'t'+cast(id as varchar),'',0,'b_',case when invoiceDue != 0 then subInvoiceDue else 0.00 end, 0             ,0,'',taxrollId,queue,printed
       from dbo.invoices
      where taxYear = @taxYear and printed='' and queue=@ini
     order by printed 
end


if @switch='M'
 begin
   insert @rt
     select 
        id*-1,name,parcel,taxYear,item,typ,invoiceAmount,invoiceDue,'t'+cast(id as varchar),'',0,'b_',case when invoiceDue != 0 then subInvoiceDue else 0.00 end, 0             ,0,'',taxrollId,queue,printed
       from dbo.invoices
      where taxYear = @taxYear and taxrollid in (select id from adtax where realtaxyear=@taxyear and (mortgagecode>0 or treamort>0))
     order by printed 
end


update @rt set treamort=case when a.treamort>'  0' then a.treamort else mortgagecode end from adtax a where taxrollid=a.id



return

end