create function dbo.dtypeKeysFromReceivables(
 @keyCode varchar(50),
 @blob varchar(max)
) returns @rt table(
 code varchar(50),
 taxRollDetailId int
) as 
begin

-- bail if not a supported key
 if not @keyCode in ('item','parcel')
  return

 declare
  @invTypeString varchar(50),
  @taxYear varchar(5) = '',
  @paidRatio money = null,
  @switches varchar(10),
  @dtypesBlob varchar(max),
  @dtype varchar(50)

 select 
  @invTypeString = dbo.splitF(@blob, '^', 1),
  @taxYear = dbo.splitF(@blob, '^', 2),
  @paidRatio = case when dbo.splitF(@blob, '^', 3)='null' then @paidRatio else dbo.splitF(@blob, '^', 3) end ,
  @switches = dbo.splitF(@blob, '^', 4),
  @dtypesBlob = dbo.splitF(@blob, '^', 5)

 if @keyCode = 'item'
 begin
  insert @rt 
  select distinct cast(item as varchar), null
  from dbo.docReceivablesBRW(
   'DETAIL', 
   @invTypeString,
   @taxYear,
   null,
   @switches,
   @dtypesBlob
  )

  update a set a.taxrollDetailId = b.id
  from @rt a
  join taxrollDetail b on cast(itemNumber as varchar) = code and dtype = 'TAXWARRANT' and isnull(actionDate,0)=0
 end

 if @keyCode = 'parcel'
 begin
  insert @rt 
  select distinct parcel, null
  from dbo.docReceivablesBRW(
   'DETAIL', 
   @invTypeString,
   @taxYear,
   @paidRatio,
   @switches,
   @dtypesBlob
  )

  update a set a.taxrollDetailId = b.id
  from @rt a
  join taxrollDetail b on parcelNumber = code and dtype = 'RESALE' and isnull(actionDate,0)=0
 end  

 return
end