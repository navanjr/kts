create procedure dbo.receiptPaymentAdd(
 @sourceId int,
 @paycode varchar(50),
 @amount money,
 @checkNumber varchar(50) = '',
 @bankId int = 0,
 @paymentId int = 0
)
as
begin
 
 declare 
  @code int,
  @message varchar(100),
  @receiptType varchar(50),
  @suspenseAccountId int,
  @contraId int,
  @fpId int
  
 select 
  @code = code,
  @message = message,
  @receiptType = receiptType,
  @suspenseAccountId = suspenseAccountId,
  @contraId =contraId,
  @fpId = fpId
 from dbo.receiptCheck(@sourceId,@paycode)


 -- bail if we dont have enough data
 if @code = 1
 begin
  select '@code=1;@message=' + @message + ';'
  return
 end

 -- bail if paycode is CHECK and no check number is offered
 if @paycode = 'CHECK' and @checkNumber < '  0'
 begin
  select '@code=1;@message=Sorry, Check number is required.;'
  return
 end

 begin transaction

  -- add row to paid
  insert paid (paycode,sourceId,amount,checkno,bankId)
   select @paycode,@sourceId,@amount,@checkNumber,@bankId
   
  -- add to the gl stage
  exec dbo.receiptStageGL @sourceId
  
 if (select sum(amount) from dbo.glDetailStage where sourceId = @sourceId) <> 0
   rollback transaction
  else
   commit transaction

 select '@code=0;@message=Payment applied OK.;'
 return

end






