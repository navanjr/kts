create function dbo.auditorReportCollections(@begindate varchar(15),@enddate varchar(15),@ordSeed varchar(10)) 
	returns @rt table(
			auditorReportGroup varchar(50),
			rowstring varchar(250),
			sourceAmt varchar(50),
			rowType char(10),
			ord varchar(250)
			)
as 
begin
declare @wt table(
			auditorReportGroup varchar(50),
			auditReportGroup varchar(60),
			apportionOut money,
			reportOrder varchar(60))

declare @wtdetail table(auditorReportGroup varchar(60),
						auditReportGroup varchar(60),
						amount money,
						reportOrder varchar(60))
						
declare @wttypes table(sourceType varchar(60),
						auditorReportGroup varchar(60),
						detail varchar(60))

insert @wttypes
	select * from dbo.journalTypes()
insert @wttypes
	select * from dbo.paymentTypes()

insert @wtdetail
select 
	'COLLECTIONS' as auditorReportGroup,
	case when a.auditReportGroup > ' 0' then a.auditReportGroup else a.accountDesc end,
	sum(amount),
	a.reportOrder
	from gldetailreports g, glaccounts a
  where g.sourceDate between @begindate and @enddate
	and g.accountType = 'Accrued Receivable'
	and left(g.sourcea18,9) <> 'APPORTION'
	and g.contraId = a.accountId
--	and g.bsId in (select id from object where typ=4512 and key2 between @begindate and @enddate)
	group by case when a.auditReportGroup > ' 0' then a.auditReportGroup else a.accountDesc end,a.reportorder

insert @wtdetail
select 
	'UNAPPORTIONED' as auditorReportGroup,
	'LESS PROTEST HELD',
	sum(amount)*-1,
	'AAAA'
	from gldetailreports g, glaccounts a
  where g.sourceDate between @begindate and @enddate
	and g.accountType = 'Accrued Receivable'
	and left(g.sourcea18,9) <> 'APPORTION'
	and g.contraId = a.accountId
	and isnull(g.bsId,0) not in (select id from object where typ=4512 and key2 between @begindate and @enddate)


insert @wtdetail
select 
	'PREVAPPORTIONED' as auditorReportGroup,
	'LESS PREVIOUS APPORTIONMENTS',
	sum(amount),
	'BBBB'
	from gldetailreports g
  where g.sourceDate between @begindate and @enddate
	and g.accountType = 'Accrued Receivable'
	and g.sourcea18 = 'APPORTIONMENT SPECIAL'

/*
insert @wtdetail
select 
	'PROTEST RELEASE' as auditorReportGroup,
	'PLUS PROTEST RELEASED',
	sum(amount)*-1,
	'CCCC'
	from gldetailreports g, glaccounts a
  where g.sourceDate between @begindate and @enddate
	and g.accountType = 'Accrued Receivable'
	and g.sourcea18 = 'Apportion Protest'
	and g.contraId = a.accountId
*/
insert @wtdetail
select 
	'PROTEST RELEASE' as auditorReportGroup,
	'PLUS PROTEST RELEASED',
	sum(amount),
	'CCCC'
	from gldetailreports g, glaccounts a
  where g.sourceDate < @begindate 
        and g.bsId in (select id from object where typ=4512 and left(upper(a18),5)='APPOR' and key2 between @begindate and @enddate)
	and g.accountType = 'Accrued Receivable'
	and g.contraId = a.accountId





insert @wt
	select 
		auditorReportGroup,
		auditReportGroup,
		sum(amount),
		cast(max(reportOrder) as varchar)
	from @wtdetail 
	group by auditorReportGroup,auditReportGroup

insert @rt
 select 
 auditorReportGroup,
 '   ' + dbo.padRight(auditReportGroup,' ',61),
 dbo.padLeft(dbo.formatCurr(apportionOut),' ',16),
 'detail',
 @ordSeed + case when auditorReportGroup = 'COLLECTIONS' then 'b' 
                                                when auditorReportGroup = 'UNAPPORTIONED' then 'd'
                                                when auditorReportGroup = 'PREVAPPORTIONED' then 'e'
                                                when auditorReportGroup = 'PROTEST RELEASE' then 'f'
                                                else 'g' end
          + cast(reportOrder as varchar) 
 from @wt
----insert subtotals
insert @rt
	select 
            '',
            dbo.padRight('      Total Collections', ' ', 60),
            dbo.padLeft(dbo.formatCurr(SUM(apportionOut)),' ',16),
            'gFooter',
            @ordSeed + 'c' + max(reportOrder) 
	from @wt where auditorReportGroup = 'COLLECTIONS'

insert @rt
	select 
            '',
            dbo.padRight('      To Apportion', ' ', 60),
            dbo.padLeft(dbo.formatCurr(SUM(apportionOut)),' ',16),
            'gFooter',
            @ordSeed + 'h' + max(reportOrder) 
	from @wt 


insert @rt 
	select replicate('=',22),' ' + replicate('=',79),replicate('=',16),'line',@ordSeed + max(reportOrder) + 'h' from @wt

declare @asterisk varchar(50)
select @asterisk = asterisk from dbo.reportCommentsBRW(17,@beginDate,@endDate) where display = 'Collections'
if isnull(@asterisk,'') < '  0'
 set @asterisk = ''
else
 set @asterisk = @asterisk + ' '

----headers
insert @rt 
	select '','','','lineFeed',@ordSeed + '0000a'
insert @rt (rowstring,ord,rowType)
	select ' '+@asterisk+'Collections',@ordSeed + '0000aa','sHeader'	
insert @rt 
	select replicate('=',22),' ' + replicate('=',79),replicate('=',16),'line',@ordSeed + '0000ab'

return
end	
	
	
