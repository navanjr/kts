create function dbo.apportionCollectionsWTIds(
 @accountId int,
 @apportionToDate int,
 @apportionCodeOnly varchar(10),
 @glDetailId int,
 @amount money
) returns @twt table(
	[id] [int] ,
	[fpid] [int],
	[fpCode] [varchar](10),
	[fpDesc] [varchar](50),
	[accountId] [int],
	[accountCode] [varchar](50),
	[accountDesc] [varchar](50),
	[amount] [money],
	[creationdate] [int],
	[creationtime] [int],
	[date] [int],
	[slink] [varchar](15),
	[bsId] [int],
	[slink2] [varchar](15),
	[comment] [varchar](50),
	[contraId] [int],
	[comment2] [varchar](50),
	[sourceCode] [varchar](60),
        contraAccountCode varchar(60),
        contraAccountDesc varchar(60),
        acrAccountId int,
        acrAccountCode varchar(60),
        acrAccountDesc varchar(60),
        stepDesc varchar(50),
        origin int
)
begin

 declare
  @accountType int,
  @accountTypeDesc varchar(50)

 declare @jeType varchar(50)

 if isnull(@glDetailId,0) > 0
 begin

-- TODO: Why use this insert?
  insert into @twt
  select
   a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],
   a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],a.[date],
   a.[slink],a.[bsId], a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode],
   c.accountCode as contraAccountCode,
   c.accountDesc as contraAccountDesc,
   a.accountId as acrAccountId, 
   '' as acrAccountCode,
   '' as acrAccountDesc,
   '',1
   from gldetail a with (NOLOCK), glaccounts c
     where a.id=@glDetailId and 
     contraId > 0 and 
     c.accountId = a.contraId and
     ISNULL(bsId,0) = 0 
 end 
 else 
 begin
  if @accountid < 0
  begin
   select @accountid = @accountid * -1
   select @accountType = typ, @accountTypeDesc=a1 from object with (NOLOCK) where id = @accountId
   select @jeType = a18 from object with (NOLOCK) where id=@accountId
   if @accountType = 4512   
    begin
     insert into @twt
     select
      a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],
      @apportionToDate,a.[slink],null,a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode],
      '' as contraAccountCode,
      '' as contraAccountDesc,
      a.accountId as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',8   
      from gldetailstage a with (NOLOCK), glaccounts c 
       where slink in (select slink from dbo.journalSLinks(@accountId))
        and c.accountId = a.contraId 
        and isnull(a.contraid,0)>0

     insert into @twt
     select
      a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],
      a.[date],a.[slink],a.[bsId],a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode],
      '' as contraAccountCode,
      '' as contraAccountDesc,
      a.accountId as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',8   
      from gldetail a with (NOLOCK) 
       where slink in (select slink from dbo.journalSLinks(@accountId))
        and (a.amount>0 or @apportionCodeOnly='MISCREPORT')
        and (ISNULL(bsId,0) = 0 or @apportionCodeOnly='MISCREPORT')
        and isnull(contraid,0)>0

    end
   select @accountid = 0
  end
   
  if @accountId = 0
  begin

-- TODO: Why use this insert?
   insert into @twt
   select
    a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],
    a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],a.[date],
    a.[slink],a.[bsId], a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode],
    c.accountCode as contraAccountCode,
    c.accountDesc as contraAccountDesc,
    a.accountId as acrAccountId, 
    '' as acrAccountCode,
    '' as acrAccountDesc,
    '',2 
   from gldetailreports a, glaccounts c
     where a.contraId=c.accountId and 
     contraId > 0 and 
     c.accountType='FUND' and 
     ISNULL(bsId,0) = 0 
     and sourceDate <= cast(@apportionToDate as varchar)
     and c.accountcode not like '%PROTEST%'
  end
  else
  begin

-- TODO: Why use this insert?
   select @accountType = typ, @accountTypeDesc=a1 from object where id = @accountId 

   if @accountType = 4701 and @accountTypeDesc <> 'ACCRUED RECEIVABLE'
    begin
 -- Add glDetail when apportioning by account
     insert into @twt
     select
      [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],
      [creationdate],[creationtime],[date],[slink],[bsId], [slink2],[comment],[contraId],[comment2],[sourceCode],
      '' as contraAccountCode,
      '' as contraAccountDesc,
      accountId as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',3
     from gldetailreports 
     where contraId = @accountId and ISNULL(bsId,0) = 0 
      and sourceDate <= cast(@apportionToDate as varchar)
 
   end   

   if @accountType = 4701 and @accountTypeDesc='ACCRUED RECEIVABLE' and @apportionCodeOnly <> 'TRUE' and isnull(@amount,0) < .01
    begin
 -- Add glDetail when apportioning by accrued receivable account
     insert into @twt
     select
      [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],
      [creationdate],[creationtime],[date],[slink],[bsId], [slink2],[comment],[contraId],[comment2],[sourceCode],
      '' as contraAccountCode,
      '' as contraAccountDesc,
      accountId as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',4 
     from gldetailreports 
     where accountId = @accountId and contraId > 0 and ISNULL(bsId,0) = 0 
      and sourceDate <= cast(@apportionToDate as varchar)
    end

   if @accountType = 4701 and @accountTypeDesc='ACCRUED RECEIVABLE' and @apportionCodeOnly = 'TRUE' and isnull(@amount,0) > 0
    begin
 -- Add glDetail when apportioning by accrued receivable account
     insert into @twt
     select
      0,0,'','',accountId,accountCode,accountDesc,@amount,null,null,0,'',0, '','',0,'','',
      '' as contraAccountCode,
      '' as contraAccountDesc,
      0 as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',5
     from glaccounts 
     where accountId = @accountId 
    end

   if @accountType = 4701 and @accountTypeDesc='ACCRUED RECEIVABLE' and @apportionCodeOnly = 'TRUE' and isnull(@amount,0) < .01
    begin
 -- Add glDetail when apportioning by accrued receivable account
     insert into @twt
     select
      0,0,'','',accountId,accountCode,accountDesc,100,null,null,0,'',0, '','',0,'','',
      '' as contraAccountCode,
      '' as contraAccountDesc,
      0 as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',6
     from glaccounts 
     where accountId = @accountId 
    end

   if @accountType = 4512
    begin
     select @jeType = a18 from object where id=@accountId

     insert into @twt
     select
      a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],
      a.[date],a.[slink],a.[bsId],a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode],
      '' as contraAccountCode,
      '' as contraAccountDesc,
      a.accountId as acrAccountId, 
      '' as acrAccountCode,
      '' as acrAccountDesc,
      '',8   
      from gldetail a with (NOLOCK) 
       where slink in (select slink from dbo.journalSLinks(@accountId))
        and (a.amount>0 or @apportionCodeOnly='MISCREPORT')
        and (ISNULL(bsId,0) = 0 or @apportionCodeOnly='MISCREPORT')
        and isnull(contraid,0)>0
    end

   if @accountType = 4502
    begin
      declare @posted varchar(50)
      select @posted = a17 from object where id=@accountId

    -- Add glDetail when special apportioning a receipt
       insert into @twt
       select
        [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],
        [creationdate],[creationtime],[date],[slink],[bsId],            [slink2],[comment],[contraId],[comment2],[sourceCode],
        '' as contraAccountCode,
        '' as contraAccountDesc,
        accountId as acrAccountId, 
        '' as acrAccountCode,
        '' as acrAccountDesc,
        '',9
       from gldetail with (NOLOCK) 
       where slink in (select slink from dbo.receiptSLinks(@accountId)
        union all
        select 'o'+cast(jeId as varchar) from journallink with (NOLOCK) where receiptId=@accountId) and      contraId > 0 and (ISNULL(bsId,0) = 0 or @apportionCodeOnly='MISCREPORT')

      if @posted <> 'Posted'
      begin
       insert into @twt
       select
        [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],
        [creationdate],[creationtime],[date],[slink],0,            [slink2],[comment],[contraId],[comment2],[sourceCode],
        '' as contraAccountCode,
        '' as contraAccountDesc,
        accountId as acrAccountId, 
        '' as acrAccountCode,
        '' as acrAccountDesc,
        '',10
       from gldetailstage with (NOLOCK) 
       where slink in 
        (select slink from dbo.receiptSLinks(@accountId)
         union all select 'o'+cast(jeId as varchar) from journallink with (NOLOCK) where receiptId=@accountId)
        and contraId > 0 

      end

   end
  end
 end

--  delete from @twt where date > @apportionToDate

--  delete from @twt where amount=0.00

 update  @twt set sourcecode = replace(accountcode,'_ACR','') 
   where sourcecode <' 0'
    and left(slink,1)='l'
    and contraAccountCode like '%ADVALOREM%'
    and accountcode like '%_ACR'

 return
end