create function dbo.apportionCollectionsWTIds( @accountId int, @apportionToDate int) returns @twt table(
	[id] [int] ,
	[fpid] [int],
	[fpCode] [varchar](10),
	[fpDesc] [varchar](50),
	[accountId] [int],
	[accountCode] [varchar](50),
	[accountDesc] [varchar](50),
	[amount] [money],
	[creationdate] [int],
	[creationtime] [int],
	[date] [int],
	[slink] [varchar](15),
	[bsId] [int],
	[slink2] [varchar](15),
	[comment] [varchar](50),
	[contraId] [int],
	[comment2] [varchar](50),
	[sourceCode] [varchar](60))

begin

 declare
  @accountType int,
  @accountTypeDesc varchar(50)


  if @accountId = 0
  begin
     insert into @twt select a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],a.[amount],a.[creationdate],a.[creationtime],a.[date],a.[slink],a.[bsId], a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode] 
   from gldetail a, glaccounts c
     where a.contraId=c.accountId and 
     contraId > 0 and 
     c.accountType='FUND' and 
     ISNULL(bsId,0) = 0 
  end
  else
  begin

  select @accountType = typ, @accountTypeDesc=a1 from object where id = @accountId 

  if @accountType = 4701 and @accountTypeDesc<>'ACCRUED RECEIVABLE'
   begin
-- Add glDetail when apportioning by account
    insert into @twt select [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],[creationdate],[creationtime],[date],[slink],[bsId],[slink2],[comment],[contraId],[comment2],[sourceCode] from gldetail 
    where contraId = @accountId and ISNULL(bsId,0) = 0 
   end

  if @accountType = 4701 and @accountTypeDesc='ACCRUED RECEIVABLE'
   begin
-- Add glDetail when apportioning by accrued receivable account
    insert into @twt select [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],[creationdate],[creationtime],[date],[slink],[bsId],[slink2],[comment],[contraId],[comment2],[sourceCode] from gldetail 
    where accountId = @accountId and contraId > 0 and ISNULL(bsId,0) = 0 
   end

  if @accountType = 4512
   begin
-- Add glDetail when apportioning protest by journal entry
    insert into @twt select a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],cast(b.key3 as money),a.[creationdate],a.[creationtime],a.[date],a.[slink],a.[bsId],a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode] from gldetail a, object b where b.typ=4775 and a.slink2=b.olink2 and b.link1=@accountId 
 union all
    select a.[id],a.[fpid],a.[fpCode],a.[fpDesc],a.[accountId],a.[accountCode],a.[accountDesc],a.amount,a.[creationdate],a.[creationtime],a.[date],a.[slink],a.[bsId],a.[slink2],a.[comment],a.[contraId],a.[comment2],a.[sourceCode] from gldetail a where left(slink,1)='o' and dbo.slinkId(a.slink)=@accountId and a.amount>0
   end

  if @accountType = 4502
   begin
--    declare @slink varchar(15) = 'o'+cast(@accountId as varchar(15)) 

-- Add glDetail when special apportioning a receipt
    insert into @twt select [id],[fpid],[fpCode],[fpDesc],[accountId],[accountCode],[accountDesc],[amount],[creationdate],[creationtime],[date],[slink],[bsId],[slink2],[comment],[contraId],[comment2],[sourceCode] from gldetail 
      where slink in (select slink from dbo.receiptSLinks(@accountId)) and contraId > 0 and ISNULL(bsId,0) = 0 
   end
  end
  update a set date=case when isnumeric(b.key2)=1 then cast(b.key2 as int) else 0 end from @twt a, object b where a.slink='o'+cast(b.id as varchar)
  update a set date=case when isnumeric(b.key2)=1 then cast(b.key2 as int) else 0 end from @twt a, object b, receiptLink c where a.slink='l'+cast(c.id as varchar) and c.receiptId = b.id

  delete from @twt where date > @apportionToDate

  delete from @twt where amount=0.00

 return
end