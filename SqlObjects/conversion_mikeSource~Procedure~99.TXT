create proc dbo.conversion_mikeSource(
 @mode varchar(50) = 'conversion',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as 
begin
 set nocount on

 if @mode != 'conversion'
  return

 declare @st table(
  SRCINC varchar(8),
  NAME varchar(30),
  BANK varchar(8),
  FUND varchar(8),
  SECA varchar(5),
  PL varchar(1)
 )

 declare
  @mikeTableName varchar(50) = 'SOURCE',
  @mikePath varchar(max),
  @sql nvarchar(max)

 select
  @mikePath = dbo.settingsF('git.mikepath','') + '\' + @mikeTableName + '.dbf',
  @sql = 'select * from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT * FROM ' + @mikeTableName + ' where !deleted()'')'

 insert @st exec(@sql)

 if @method = 'GET'
 begin  
  select 
   @class = 'conversion',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = COUNT(*),  
   @message = 'mike_Source not found in KTS'
  from @st
  where SRCINC not in (select accountCode from dbo.glAccounts)
 end

 if @method = 'SHOW'
 begin  

  select * 
  from @st
  where SRCINC not in (select accountCode from dbo.glAccounts)

 end

 if @method = 'FIX'
 begin  
  declare
   @acctTypeId int,
   @acctTypeCode varchar(50),
   @acctTypeDesc varchar(50),
   @acctTypeRepo varchar(50)
  
  select
   @acctTypeId = id,
   @acctTypeCode = key1,
   @acctTypeDesc = key2,
   @acctTypeRepo = key3
  from object where typ = 4702 and key1 = 'SOURCE'

  if not isnull(@acctTypeId,0) > 0
  begin
   select @code=1, @message='Sorry you are missing a SOURCE account type'
   exec dbo.logit @@procid, '@code',@code,'@message',@message
   return
  end
  insert object (typ,key1,key2,a19,a1,a2,link1,a3)
  select 4701, SRCINC, name, SECA, @acctTypeCode, @acctTypeDesc, @acctTypeId, @acctTypeRepo
   from @st where SRCINC not in (select accountCode from dbo.glAccounts)
  select @code=0, @message='Sorry you are missing a FUND account type', @tally = @@rowCount
  exec dbo.logit @@procid, '@code', @code, '@message', @message, '@tally', @tally
  
  return

 end

end
