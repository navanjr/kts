create view warrants

as

select 
w.key1 as RegNo,
w.key2 as RegDateNo,
dbo.date1(w.key2) as RegDate,
w.key3 as WarNo,
w.a1 as WarDateNo,
dbo.date1(w.a1) as WarDate,
w.a2 as Payee,
isnull((select sum(amount) from gldetail where slink='o'+cast(w.id as varchar) and accountcode=l.accountcode),0) as amount,
f.accountCode as FundCode,
f.accountDesc as FundDesc,
tc.key3 as PayNo,
tc.key2 as PayDateNo,
dbo.date1(tc.key2) as PayDate,
isnull((select sum(amount) from gldetail where slink='o'+cast(tc.id as varchar) and accountcode=f.accountcode),0) as PayAmount,
case when isnumeric(right(w.c10,2))=1 and w.c10 >' 0' then cast(cast('20'+right(w.c10,2) as int)-1 as varchar(4))+'-'+'20'+right(w.c10,2) else w.c10 end as fiscalYear,
w.a4 as debitCode,
f.reportOrder
from object w, glaccounts l, glaccounts f, object tc 
where 
w.typ=4771 
and tc.typ=4771
and w.link1 = tc.id
and w.a4 = l.accountCode
and l.targetaccountCode = f.accountCode
and w.a18='Warrant'
and tc.a18 = 'Treasurers Check'

union all

select 
w.key1 as RegNo,
w.key2 as RegDateNo,
dbo.date1(w.key2) as RegDate,
w.key3 as WarNo,
w.a1 as WarDateNo,
dbo.date1(w.a1) as WarDate,
w.a2 as Payee,
isnull((select sum(amount) from gldetail where slink='o'+cast(w.id as varchar) and accountcode=l.accountcode),0) as amount,
f.accountCode as FundCode,
f.accountDesc as FundDesc,
'' as PayNo,
'' as PayDateNo,
'' as PayDate,
0.00 as PayAmount,
case when isnumeric(right(w.c10,2))=1 and w.c10 >' 0' then cast(cast('20'+right(w.c10,2) as int)-1 as varchar(4))+'-'+'20'+right(w.c10,2) else w.c10 end as fiscalYear,
w.a4 as debitCode,
f.reportOrder
from object w, glaccounts l, glaccounts f 
where 
w.typ=4771 
and a4 = l.accountCode
and l.targetaccountCode = f.accountCode
and w.a18='Warrant'
and w.link1 not in (select id from object where typ=4771 and a18='Treasurers Check')