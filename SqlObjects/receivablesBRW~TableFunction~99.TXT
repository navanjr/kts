create function dbo.receivablesBRW() returns @rt table(
 id int,
 ord varchar(50),
 display varchar(max),
 blob varchar(max),
 count int,
 invoiceAmount money,
 invoiceDue money,
 feesDue money,
 taxyear varchar(4),
 typ varchar(5),
 paidRatio money,
 rowType int
) as
begin

 declare @wt table(
  id int,
  name varchar(50),
  parcel varchar(50),
  amount money,
  due money,
  fees money,
  taxyear varchar(4),
  typ varchar(5),
  paidRatio money
)

 insert @wt
 select
  id,
  name,
  PARCEL,
  invoiceAmount,
  invoiceDue,
  subInvoiceDue,
  taxyear,
  typ,
  abs(round(invoiceDue / invoiceAmount, 1) - 1)
 from invoices 
 where invoiceDue != 0
  and invoiceId = 0

 insert @rt
 select
  0,
  cast(9999 - cast(taxyear as int) as varchar) + 'c|' + right('aaaa' + typ,4) + '|' + cast(paidRatio as varchar),
  '      Paid Ratio: ' + cast(paidRatio as varchar),
  '',
  COUNT(*) as count,
  sum(amount) as amount,
  sum(due) as due,
  sum(fees) as fees,
  taxyear,
  typ,
  paidRatio,
  1
 from @wt
 group by 
  taxyear, typ,
  paidRatio
 order by 
  taxyear desc,
  typ,
  paidRatio

-- insert group headers
-- Typ
 insert @rt (id, ord, display, count, invoiceDue, feesDue, rowType)
 select
  0,
  dbo.splitF(ord,'|',1) + '|' + dbo.splitF(ord,'|',2),
  '   Invoice Type: ' + max(typ),
  sum(count),
  sum(invoiceDue),
  sum(feesDue),
  2
 from @rt
 where rowType = 1
 group by
  dbo.splitF(ord,'|',1) + '|' + dbo.splitF(ord,'|',2)

-- Taxyear
 insert @rt (id, ord, display, count, invoiceDue, feesDue, rowType)
 select
  0,
  cast(9999 - cast(taxyear as int) as varchar) + 'b',
  'Taxyear: ' + taxyear,
  sum(count),
  sum(invoiceDue),
  sum(feesDue),
  3
 from @rt
 where rowType = 1
 group by
  taxyear

 insert @rt (id, ord, display, rowType)
 select
  0,
  cast(9999 - cast(taxyear as int) as varchar) + 'a',
  '',
  4
 from @rt
 where rowType = 1
 group by
  taxyear

 return 
end