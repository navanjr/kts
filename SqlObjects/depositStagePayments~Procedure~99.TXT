create procedure dbo.depositStagePayments (
 @depositId int,
 @debugMode varchar(50) = 'FALSE'
) as
begin

 exec dbo.logit @@procId, '@depositId', @depositId, '@debugMode', @debugMode
 
 declare @accounts table(id int identity(1,1),
  accountId int,
  amount money,
  BankStatementGroup varchar(60),
  paycode varchar(60),
  checkno varchar(50),
  drawnon varchar(50),
  location varchar(50)
 )
 
 declare @styp char(1) = 'o'
 declare 
  @slink varchar(15) = @styp + cast(@depositId as varchar),
  @contraId int,
  @tokenId int,
  @tokenAccountId int,
  @tokenAmount money,
  @tokenpaycode varchar(60),
  @tokenBankStatementGroup varchar(60),
  @tokencheckno varchar(50),
  @tokendrawnon varchar(50),
  @tokenlocation varchar(50)
 
 select @contraId = link1 from object where id = @depositId

 declare @slinks table(slink varchar(16),
   paycode varchar(60),
   paidid int,
   BankStatementGroup varchar(60),
   checkno varchar(50),
   drawnon varchar(50),
   location varchar(50),
   amount money,
   origin int
)

 insert @slinks (slink,paycode,paidid,checkno,drawnon,location,amount,origin)
  select slink,paycode,id,checkno,drawnon,location,amount,1 from paid a where a.depositId = @depositId   

 insert @slinks (slink,paycode,paidid,checkno,drawnon,location,amount,origin)
  select 
   'o'+cast(officialDepositId as varchar(15)),paycode,id,checkno,drawnon,location,amount,2 from paid a where a.depositId = @depositId and a.officialdepositId > 0

 update s set BankStatementGroup = rtrim(s.paycode) + cast(paidid as varchar)
  from @slinks s, object o 
  where o.typ=4505 
  and s.paycode=o.key1
  and o.a2 in ('E','C')

 update s set 
  paycode = '',
  paidid = 0,
  checkno = '',
  drawnon = '',
  location  = '',
  BankStatementGroup = '' 
  from @slinks s, object o 
  where o.typ=4505 
  and s.paycode=o.key1
  and o.a2 not in ('E','C')

 if @debugMode = 'TRUE'
  select * from @slinks

 -- get the credits
 insert @accounts (accountId, amount)
 select
  accountId,
  SUM(amount) * -1
 from gldetail where slink in (select slink from @slinks) 
   and accountId in (select accountId from dbo.glAccounts where accountType = 'SUSPENSE')
 group by accountId

/*
 select
  b.link1, sum(a.amount) * -1
 from paid a, object b 
 where a.paycode = b.key1 and b.typ = 4505 and a.depositId = @depositId 
 group by b.link1
*/

 -- get the debits
 if exists(select * from paid where depositId = @depositId)
  insert @accounts (accountid,amount,paycode,checkno,drawnon,location)
  select 
   @contraId, sum(p.amount), s.paycode, s.checkno, s.drawnon, s.location
  from paid p, @slinks s 
  where depositId = @depositId
    and p.id = s.paidid
  group by s.BankStatementGroup, s.paycode, s.checkno, s.drawnon, s.location

  insert @accounts (accountid,amount)
  select 
   @contraId, sum(p.amount)
  from paid p
  where depositId = @depositId
    and p.id not in (select paidid from @slinks)
 
 -- remove 
 delete glDetailStage where slink = @slink --and accountId not in (select accountId from @accounts)

/* -- update
 update a set a.amount = b.amount
 from glDetailStage a, @accounts b
 where a.accountId = b.accountId
  and a.slink = @slink

 delete @accounts where accountId in (select accountId from glDetailStage where slink = @slink)
 */
 -- insert
 while (select count(*) from @accounts) > 0
 begin
  select top 1 
    @tokenId = id, 
    @tokenAccountId = accountId,
    @tokenAmount = amount, 
    @tokenpaycode = paycode,
    @tokencheckno = checkno,
    @tokendrawnon = drawnon,
    @tokenlocation = location
  from @accounts
  insert gldetailstage (slink,accountId,amount,contraId,comment,comment2)
    select @slink,
      @tokenAccountId,
      @tokenAmount,
      @contraId,
      isnull(rtrim(@tokenpaycode),''),
      left(isnull(rtrim(@tokencheckno),'')+
      case when len(isnull(rtrim(@tokendrawnon),''))>0 then '/' else '' end
      +isnull(rtrim(@tokendrawnon),'')+
      case when len(isnull(rtrim(@tokenlocation),''))>0 then '/' else '' end
      +isnull(rtrim(@tokenlocation),''),50)

  delete @accounts where id = @tokenId
 end
 
 update a set
  a.accountCode = b.key1,
  a.accountDesc = b.key2
 from glDetailStage a, object b
 where a.accountId = b.id
  and b.typ = 4701
  and a.slink = @slink 

end