create function dbo.bankStatementBlob( @id int ) returns varchar(1000) as
begin

 declare
  @retvar varchar(1000),
  @accountId int,
  @bBalance money,
  @eBalance money,
  @deposits money,
  @credits money,
  @variance money,
  @varianceItemTotal money,
  @sBDate int,
  @sEDate int,
  @tally int
 
 declare @priorBS table(id int)

 declare @voucherSLinks table(slink varchar(16))

 insert @voucherSLinks
   select 'o'+cast(id as varchar) from object where typ=4771

 select 
  @accountId = link1,
  @sBDate = cast(a1 as int),
  @sEDate = cast(a2 as int)
 from object where typ = 4780 and id = @id

 insert @priorBS select id from object where typ = 4780 and a2 < @sBDate and a2>'0'

 select 
  @bBalance = isnull(sum(case when bsId = @id then 0 else amount end),0),
  @eBalance = isnull(sum(amount),0)
 from glDetail where accountId = @accountId and bsId in (select id from @priorBS union all select @id)

 select 
  @tally = count(*)
 from glDetail where accountId = @accountId and bsId = @id

 select @deposits = isnull(sum(amount),0) 
 from gldetail 
 where 
  accountId = @accountId 
   and bsId = @id
   and (amount > 0) 
   and slink not in (select slink from @voucherSLinks)
 
 select @credits = isnull(sum(amount),0) 
 from gldetail 
 where 
  accountId = @accountId 
   and bsId = @id
   and ((amount < 0) or slink in (select slink from @voucherSLinks))

 select @variance = case when isnumeric(a3)=1 then cast(a3 as money) else 0 end-@eBalance from object where typ = 4780 and id = @id

 select @varianceItemTotal = sum(cast(key2 as money)) from object where typ = 4781 and link1 = @id

 set @retvar = 
  '@bBalance=' + cast(@bBalance as varchar)
  + ';@eBalance=' + cast(@eBalance as varchar)
  + ';@tally=' + cast(@tally as varchar)
  + ';@deposits=' + cast(@deposits as varchar)
  + ';@credits=' + cast(@credits as varchar)
  + ';@variance=' + cast(@variance as varchar)+';'
  + ';@varianceItemTotal=' + cast(isnull(@varianceItemTotal,0) as varchar)+';'
 
 return @retvar

end
