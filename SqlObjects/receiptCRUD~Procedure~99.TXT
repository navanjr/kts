create procedure dbo.receiptCRUD( @mode int, @receiptId int ) as
/*
 remember
  C = 0
  R = 1
  U = 2
  D = 3
*/
begin
 
 declare 
  @slink varchar(15) = 'o' + cast(@receiptId as varchar) 

-- Create
 if @mode = 0
 begin

  -- bail if posted
  if dbo.isPosted(@slink) = 'TRUE'
   return

  -- bail if number exists
  if (select case when key1>'00000' then 'abort' else 'continue' end from object where id=@receiptId)='abort'
   return

  -- Set Number 
  declare 
    @retval nvarchar(max),
    @series varchar(50)

  select @series=key3 from object where typ=4502 and id=@receiptId
  
  -- bail if no series
  if len(@series)<3
   return
  
   
  exec dbo.nextObjectAutoNumber 4502, @series, @retval output

  update object set key1=@retval where typ=4502 and id=@receiptId
 end

-- Delete
 if @mode = 3
 begin

  -- bail if posted
  if dbo.isPosted(@slink) = 'TRUE'
   return

  declare
   @receiptLinkId int,
   @invoiceToken int

  -- remove receipt and receiptDetail
  update object set typ = -4502 where typ = 4502 and id = @receiptId
  delete receiptDetail where slink = @slink
 
  -- remove penalty Invoices
  while exists(select * from receiptLink where receiptId = @receiptId)
  begin

   select top 1
    @receiptLinkId = id,
    @invoiceToken = invoiceId
   from receiptLink
   where receiptId = @receiptId

   if (select isnull(invoiceId,0) from invoices where id = @invoiceToken) > 0
    exec invoiceCRUD 3, @invoiceId = @invoiceToken, @postCheckOverride = 0
  
   delete receiptLink where id = @receiptLinkId

  end
  
 end

 return
end
