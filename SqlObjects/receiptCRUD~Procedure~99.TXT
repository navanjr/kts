create procedure dbo.receiptCRUD( @mode int, @receiptId int = 0, @series varchar(50) = '', @newReceiptId int = 0 output) as
/*
 remember
  C = 0
  R = 1
  U = 2
  D = 3
*/
begin
 
 declare 
  @slink varchar(15) = 'o' + cast(@receiptId as varchar) 

-- Create
 if @mode = 0
 begin

  -- bail if no series
  if len(@series)<2
   return

  declare 
    @retval nvarchar(max)
   
  exec dbo.nextObjectAutoNumber 4502, @series, @retval output

  insert object (typ,key1,key3,olink1) select 4502,@retval,upper(@series),'newReceipt'
  
  set @newReceiptId = (select top 1 id from object where typ=4502 and olink1='newReceipt' order by id desc)
  
  update object set olink1 = '' where typ=4502 and id = @newReceiptId

 end

-- Delete
 if @mode = 3
 begin

  -- bail if posted
  if dbo.isPosted(@slink) = 'TRUE'
   return

  declare
   @receiptLinkId int,
   @invoiceToken int

  -- remove receipt and receiptDetail
  update object set typ = -4502 where typ = 4502 and id = @receiptId
  delete receiptDetail where slink = @slink
 
  -- remove penalty Invoices
  while exists(select * from receiptLink where receiptId = @receiptId)
  begin

   select top 1
    @receiptLinkId = id,
    @invoiceToken = invoiceId
   from receiptLink
   where receiptId = @receiptId

   if (select isnull(invoiceId,0) from invoices where id = @invoiceToken) > 0
    exec invoiceCRUD 3, @invoiceId = @invoiceToken, @postCheckOverride = 0
  
   delete receiptLink where id = @receiptLinkId

  end
  
 end

 return
end
