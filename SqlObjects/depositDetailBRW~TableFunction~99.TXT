create function dbo.depositDetailBRW(@depositId int, @showGL int, @showUnLinked int) returns 
@rt table(
 ord varchar(50),
 id int,
 description varchar(50), 
 subdescription varchar(50), 
 amount money
)
begin
 declare @styp char(1) = 'o',
         @depositDate int
 declare @slink varchar(15) = @styp + cast(@depositId as varchar)

 select @depositDate = cast(key2 as int) 
  from object 
  where id = @depositId
 
 if exists(select * from dbo.depositPaidAndPosted() where isnull(depositId,0) = 0)
 begin
  insert @rt
  select 'c ',0,'','',0

  if @showUnLinked = 1
  begin
   insert @rt
   select 'ca',0,'Un-linked Payment(s)','',0

   insert @rt
   select 'cb'+receiptType,cast('-9' + cast(receiptTypeId as varchar) as int),'   ' + receiptType,'',0 from dbo.depositPaidAndPosted() where isnull(depositId,0) = 0 and depositDate <= @depositDate group by receiptType, receiptTypeId

   insert @rt
   select 'cb'+receiptType+slink,cast('-1' + cast(id as varchar) as int),'      ' + dbo.date1(depositDate),lower(paycode)+case when checkno > '  0' then ' - '+checkno else '' end,amount from dbo.depositPaidAndPosted() where isnull(depositId,0) = 0 and depositDate <= @depositDate 
  end
 end

 if exists(select * from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId)
 begin
  insert @rt
  select 'ab',0,'linked Payment(s)','',0
  insert @rt
  select 'ac',cast('-1' + cast(id as varchar) as int),'   '+receiptPostDate1,paycode+case when checkno > '  0' then ' - '+checkno else '' end,amount from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId
 end

 if @showGL = 1
 begin
  if exists(select * from dbo.glDetailStage where slink = @slink)
  begin
   insert @rt
   select 'ba',0,'','',0
   insert @rt
   select 'bb',0,'GL Detail (staged)','',0
   insert @rt
   select 'bc',0,'   '+accountDesc,'',amount from dbo.glDetailStage where slink = @slink
  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rt
   select 'ba',0,'','',0
   insert @rt
   select 'bb',0,'GL Detail (posted)','',0
   insert @rt
   select 'bc',0,'   '+accountDesc,'',amount from dbo.glDetail where slink = @slink
  end
 end


 return
end
