create function dbo.depositDetailBRW(@depositId int, @showGL int, @showUnLinked int) returns 
@rt table(
 ord varchar(50),
 id int,
 description varchar(50), 
 subdescription varchar(50), 
 amount money,
 colorFlag int
)
begin
 declare @styp char(1) = 'o',
         @depositDate int,
  @suspenseMethod varchar(50)
 declare @slink varchar(15) = @styp + cast(@depositId as varchar)

 select @suspenseMethod = suspenseMethod from dbo.site
 if @suspenseMethod < '  0'
   set @suspenseMethod = 'C'

 select @depositDate = cast(key2 as int) 
  from object 
  where id = @depositId
 

-- Unlinked Payments
 if exists(select * from dbo.depositPaidAndPosted() where isnull(depositId,0) = 0)
 begin
  insert @rt
  select 'c ',0,'','',0,0

  if @showUnLinked = 1
  begin
   insert @rt
   select 'ca',0,'Un-linked Payment(s)','',0,0

 -- receiptType Grouping
   insert @rt
   select 'cb'+receiptType,cast('-9' + cast(receiptTypeId as varchar) as int),'   ' + receiptType,cast(count(*) as varchar)+' payment(s)',cast(sum(amount) as varchar),1
    from dbo.depositPaidAndPosted() 
    where isnull(depositId,0) = 0 
     and depositDate <= @depositDate 
--remove TRUST Receipts from deposit Detail BRW.
     and receiptType <> 'TRUST'
    group by receiptType, receiptTypeId


   insert @rt
   select 'cb'++receiptType+slink,cast('-1' + cast(id as varchar) as int),'      ' + dbo.date1(depositDate) + ' - ' + parentControlNumber,
     lower(paycode)+case when checkno > '  0' then ' - '+checkno else '' end,amount,0
    from dbo.depositPaidAndPosted() where isnull(depositId,0) = 0 and depositDate <= @depositDate 
  end
 end

-- Linked Payments
 if exists(select * from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId)
 begin
  insert @rt
  select 'ab',0,'linked Payment(s)','',0,0

  insert @rt
  select 'ac'+receiptType,cast('-8' + cast(receiptTypeId as varchar) as int),'   '+receiptType,cast(count(*) as varchar)+' payment(s)',sum(amount),1 
   from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId group by receiptType, receiptTypeId

-- TODO: this will work for suspenseMode:U
  if @suspenseMethod in ('U','c')
  begin
   insert @rt
   select 'ac'+receiptType+deputy,cast('-7' + cast(receiptTypeId as varchar) as int),'      '+deputy,'   '+cast(count(*) as varchar)+' payment(s)',sum(amount),2
    from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId group by receiptType, receiptTypeId, deputy

   insert @rt
   select 'ac'+receiptType+deputy+slink,cast('-1' + cast(id as varchar) as int),'         '+receiptPostDate1 + ' - ' + parentControlNumber,
     paycode+case when checkno > '  0' then ' - '+checkno else '' end,amount,0
    from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId
  end
  if @suspenseMethod = 'S'
  begin
   insert @rt
   select 'ac'+receiptType+station,cast('-7' + cast(receiptTypeId as varchar) as int),'      Station: '+station,'   '+cast(count(*) as varchar)+' payment(s)',sum(amount),2
    from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId group by receiptType, receiptTypeId, station

   insert @rt
   select 'ac'+receiptType+station+slink,cast('-1' + cast(id as varchar) as int),'         '+receiptPostDate1,
     paycode+case when checkno > '  0' then ' - '+checkno else '' end,amount,0
    from dbo.depositAvailablePayments where isnull(depositId,0) = @depositId
  end

 end

 if @showGL = 1
 begin
  if exists(select * from dbo.glDetailStage where slink = @slink)
  begin
   insert @rt
   select 'ba',0,'','',0,0
   insert @rt
   select 'bb',0,'GL Detail (staged)','',0,0
   insert @rt
   select 'bc',0,'   '+accountDesc,'',amount,0 from dbo.glDetailStage where slink = @slink
  end

  if exists(select * from dbo.glDetail where slink = @slink)
  begin
   insert @rt
   select 'ba',0,'','',0,0
   insert @rt
   select 'bb',0,'GL Detail (posted)','',0,0
   insert @rt
   select 'bc',0,'   '+accountDesc,'',amount,0 from dbo.glDetail where slink = @slink
  end
 end


 return
end
