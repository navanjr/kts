create procedure dbo.stateTaxStageGL(@objectId int=999999, @date int=null)
as
begin
declare @wt table(id int,
 accountcode varchar(60),
 accountdesc varchar(50),
 schoolpagescat varchar(50),
 amount money,
 contraAccountCode varchar(60),
 contraId int,
 schdist varchar(50),
 taxrate varchar(50))
 
declare @appvworksum money,
        @wtsum money,
        @slink varchar(20) = 'o'+cast(@objectId as varchar)

if isnull(@date,0)=0
select @date = dbo.clariondate(dateadd(month, datediff(month, 0, getdate()), -1))

exec dbo.importAppvwork 

insert @wt
select * from dbo.stateTaxImport() 

select @appvworksum = sum(taxcoll) from temp_appvwork
select @wtsum = sum(amount) from @wt

if @appvworksum <> @wtsum
begin
 select '@code=1;@message=Does Not Balance, additional setup needed;'
 return
end

declare @ct table(id int identity(1,1),
                  yearcode varchar(20),
                  comment varchar(100),
                  sourceCode varchar(60),
                  sourceDesc varchar(50),
                  fundCode varchar(60),
                  fundDesc varchar(50),
                  ACRCode varchar(60),
                  contraId int,
                  amount money)

declare @pt table(id int identity(1,1),
                  yearcode varchar(20),
                  comment varchar(100),
                  sourceCode varchar(60),
                  sourceDesc varchar(50),
                  fundCode varchar(60),
                  fundDesc varchar(50),
                  ACRCode varchar(60),
                  contraId int,
                  amount money,
                  glbalance money,
                  processcode int)

insert @ct
select '',max(comment),sourcecode,'','','',accountCode,contraId,SUM(amount) 
 from gldetail 
 where [date]<=@date 
  and ISNULL(bsId,0)=0 
  and contraId in (select contraId from @wt)
  and accountCode in (select accountCode from glAccounts where accountType='ACCRUED RECEIVABLE')
 group by sourcecode,accountCode,contraId
  having SUM(amount)<> 0.00
 
 update c set sourceDesc = accountDesc from @ct c, glAccounts a where sourceCode=accountcode
 update c set fundCode = case when aptabletype > ' 0' and aptabletype not in ('T','L') then 'TABLE' when targetAccountCode  in (select accountcode from glCollectionAccount where collectionDescription like '%Ad%') then '' else targetAccountCode end from @ct c, glAccounts a where ACRCode=accountcode
 update c set fundDesc = accountDesc from @ct c, glAccounts a where fundCode=accountcode
 update c set yearcode = ty.yearcode from @ct c, glaccounts a, (select * from dbo.taxyears(@date)) ty 
  where c.contraid = a.accountid
   and left(a.accountcode,4)=ty.year
 
insert @pt
select isnull((select yearcode from dbo.taxyears(@date) where year=ISNULL((select left(accountcode,4) from glaccounts where accountid=w.contraId),'')),''),isnull((select yearcode from dbo.taxyears(@date) where year=ISNULL((select left(accountcode,4) from glaccounts where accountid=w.contraId),'')),'')+' Tax','','','','',
 'State Tax '
 +cast(YEAR(dbo.date1(@date)) as varchar)
 +cast(MONTH(dbo.date1(@date)) as varchar)
 +cast(DAY(dbo.date1(@date)) as varchar)
 +' '
 +ISNULL((select left(accountcode,4) from glaccounts where accountid=w.contraId),'')+'_ACR',
 contraId,SUM(amount),ISNULL((select sum(amount) from gldetail where [date]<=@date and accountcode=(select accountcode from glaccounts where accountid=w.contraId)),0),0
 from @wt w
 group by contraId

declare @accountStage table(id int identity(1,1),
                            accountcode varchar(60),
                            comment varchar(50),
                            sourceCode varchar(60),
                            contraId int,
                            amount money,
                            pamount money,
                            processcode int,
                            yearcode varchar(20))

insert @accountStage
 select ACRCode,comment,sourceCode,contraId,amount*-1,0,0,yearcode from @ct c where fundCode = ''

declare @idToken int,
        @contraIdToken int,
        @yearcodeToken varchar(20),
        @sourcecodetoken varchar(60),
        @contraAmountToken money,
        @appliedAmountToken money = 0,
        @ACRCodeToken varchar(100),
        @pIdToken int,
        @pAmountToken money

while exists(select * from @accountstage where processcode=0)
begin
 select top 1 @idToken = id, @contraAmountToken = amount * -1, @yearcodeToken = yearcode, @appliedAmountToken = 0, 
              @contraIdToken = contraId, @sourcecodetoken = sourcecode from @accountstage where processcode=0 order by contraid desc
  while exists(select * from @pt where yearcode=@yearcodeToken and processcode=0)
  begin
   select top 1 @pIdToken = id, @ACRCodeToken = ACRCode,@pAmountToken = amount from @pt where yearcode=@yearcodeToken and processcode=0 order by contraid
     insert @accountStage select @ACRCodeToken, @yearcodeToken+' Tax', @sourcecodetoken, @contraIdToken, @pAmountToken,0,2,@yearcodeToken
     select @appliedAmountToken = @appliedAmountToken + @pAmountToken
   update @pt set processcode = 1 where id = @pIdToken
  end
 select @contraIdToken 
 update @accountstage set pamount = @appliedAmountToken, processcode=1 where id = @idToken
end

insert @accountStage
 select sourcecode,comment,'',null, (pamount+amount)*-1,0,0,yearcode from @accountStage where pamount+amount <> 0.00 and processcode=1

update p set sourceCode = c.sourceCode from @pt p, @ct c where c.fundCode='' and c.contraId=p.contraId

delete from @ct where fundCode=''

delete from receiptDetail where slink=@slink
delete from gldetailStage where slink=@slink and isnull(comment2,'')<>'Adjusted'

insert receiptDetail (description,sourceCode,fundCode,amount,altContraId,slink,subdescription)
select comment,sourceCode,fundCode,amount,contraId,@slink,ACRCode from @ct
insert gldetailStage (accountCode,comment,sourcecode,contraId,amount,slink)
select accountCode,comment,sourcecode,contraId,amount,@slink from @accountStage

update g set accounttype=a.accounttype from gldetailstage g, glaccounts a where g.accountcode=a.accountcode and slink=@slink
--update g set sourceid=a.accountid from gldetailstage g, glaccounts a where g.sourcecode=a.accountcode and slink=@slink and g.sourcecode>' 0'
select * from @pt

delete from object where TYP=4022 and Key1 in (select LEFT(ACRCode,LEN(ACRCode)-4) from @pt)

insert object (Typ,Key1,Key2,Key3,a1,k2)
select 4022,LEFT(p.ACRCode,LEN(p.ACRCode)-4),w.accountcode,cast(w.amount as varchar(50)),w.schoolpagescat,left(rtrim(LEFT(p.ACRCode,LEN(p.ACRCode)-4))+w.accountcode,29) 
 from @wt w, @pt p where p.contraId=w.contraId

declare @accountcodeToken varchar(60)
while exists(select * from object where typ = 4022 and rtrim(Key1)+'_ACR' not in (select accountcode from glaccounts) and   rtrim(Key1)+'_ACR' in (select p.ACRCode from @pt p))
begin
 select top 1 @accountcodeToken=rtrim(key1) from object where typ = 4022 and rtrim(Key1)+'_ACR' not in (select accountcode    from glaccounts) and rtrim(Key1)+'_ACR' in (select p.ACRCode from @pt p)
 exec dbo.apportionTableFundReceivableVerification @accountcodeToken
end

update g set accountid=a.accountid, accountdesc=a.accountdesc 
 from gldetailStage g, glAccounts a 
 where g.accountCode=a.accountCode 
  and slink=@slink

 select '@code=0;@message=Tax Information staged for Import;'

end