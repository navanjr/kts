create function dbo.dailyDataCollections(@theDate int, @days int, @ordSeed varchar(50), @filterFlag varchar(10)) returns 
@rt table (
 id int,
 ord varchar(250),
 rowstring varchar(250),
 glBalanceString varchar(50),
 rowstring1 varchar(250),
 sourceNo varchar(50),
 recordCnt varchar(50),
 sourceAmt varchar(50),
 rowType char(10),
 brwBGColor int,
 minControlNumber varchar(50),
 maxControlNumber varchar(50),
 minTicketNumber varchar(50),
 maxTicketNumber varchar(50),
 dptno varchar(50),
 electronicAmount varchar(50),
 otherAmount varchar(50),
 blob varchar(max)
)
begin

 declare @wt table(
  id int,
  ord varchar(50),
  description varchar(50),
  subDescription varchar(50),
  minControlNumber varchar(50),
  maxControlNumber varchar(50),
  rowCnt int,
  amount money,
  glBalance money,
  minTicketNumber varchar(50),
  maxTicketNumber varchar(50),
  dptno varchar(50),
  electronicAmount money,
  otherAmount money
 )
 declare @wtRaw table(
  id int,
  ord varchar(50),
  description varchar(50),
  subDescription varchar(50),
  receiptNumber varchar(50),
  amount money,
  slink2 varchar(15),
  ticketNumber varchar(50),
  dptno varchar(50),
  receiptId int,
  countit int,
  electronicAmount money,
  otherAmount money
 )
  declare @accounts table(
  accountId int,
  collectionDescription varchar(50),
  reportOrder varchar(50),
  dptno varchar(50)
 )

-- this is a test
 insert @accounts select accountId,collectionDescription,reportOrder,'' from dbo.glBankAccounts

-- get the collection accounts 
 insert @accounts select accountId,collectionDescription,reportOrder,dptno  from dbo.glCollectionAccount

-- get the apportionment account, maybe :)
 if substring(@filterFlag,2,1) = '1'
 insert @accounts 
  select accountId, 'Apportionment Receivable', '02z', '' 
   from dbo.glAccounts where accountId not in (select accountId from paycodes)
   and accountType in ('RECEIVABLE','FUND') 
   and accountId not in (select accountId from @accounts)

-- insert all raw receipt data
 insert @wtRaw
 select
  b.accountId,
  a.reportOrder,
  a.collectionDescription,
  b.accountDesc,
  case when c.key3 = 'TAX' then null when c.key3 = 'SUMMARY' then left(c.d1,49) when c.typ=4502 and collectionDescription='Depository' then isnull(nullif((select d.key1 from object d where d.ID  in (select distinct officialDepositId  from dbo.paid where slink = b.slink)),''),'*****') else c.key1 end,
  b.amount,
  b.slink,
  case when c.typ=4522 then c.B2 else '' end,
  a.dptno,
  c.id,
  1,
  case when isnull(b.comment,'') in (select key1 from object where typ=4505 and a2 in ('E','C','B')) then b.amount else 0 end as electronicAmount,
  case when isnull(b.comment,'') not in (select key1 from object where typ=4505 and a2 in ('E','C','B')) then b.amount else 0 end as otherAmount
 from @accounts a, glDetail b, object c
 where a.accountId = b.accountId
  and c.typ in (4502,4522) --,4512,4522
  and dbo.slinkType(b.slink) = 'o'
  and substring(b.slink,2,14) = c.id
  and case when isnumeric(c.key2)=1 then cast(c.key2 as int) else 0 end between @theDate and @theDate + @days


-- insert all raw receipt data Tax
 insert @wtRaw (receiptNumber,subDescription,receiptId) 
 select l.receiptNumber, acct.accountDesc, l.receiptId
  from gldetail g
  join receiptlink l on  dbo.slinkType(g.slink) = 'l' and dbo.slinkId(g.slink) = l.id
  join glAccounts acct on acct.accountId = g.contraId
 where 
   l.receiptId in (select receiptId from @wtRaw)
   and l.receiptNumber > '  0'

-- insert void tax receipt data
 insert @wtRaw --(receiptNumber,subDescription,receiptId) 
 select 
  b.accountId,
  a.reportOrder,
  a.collectionDescription,
  b.accountDesc,
  r.recnum,
  0.00,
  '',
  '',
  '',
  recId,
  1,
  0.00,
  0.00
  from taxreceipt r, glaccounts b, @accounts a
 where 
   b.accountcode = cast(r.taxyear as varchar)+'_ADVALOREM'
   and b.accountId = a.accountId
   and r.recStatus = 'VOID'
   and case when isnumeric(r.postDate)=1 then cast(r.postDate as int) else 0 end between @theDate and @theDate + @days
   and r.recNum > '  0'

--- insert all raw into @wt
insert @wt
 select
  max(id),
  max(ord),
  max(description),
  subDescription,
  min(isnull(receiptNumber,'9999999999')),
  max(receiptNumber),
  sum(countit),
  abs(SUM(amount)),
  0,
  min(ticketNumber),
  max(ticketNumber),
  max(dptno),
  abs(SUM(electronicAmount)),
  abs(SUM(otherAmount))
 from @wtRaw --where  slink2 = 'o29091'
 group by
  subDescription

 update @wt set minControlNumber = dbo.splitf(minControlNumber,'-',1)  where charindex('-',minControlNumber)>0

 update @wt set maxControlNumber = dbo.splitf(maxControlNumber,'-',2) where charindex('-',maxControlNumber)>0

 update a set a.glBalance = (select sum(amount) from glDetail where accountId = a.id) from @wt a

--insert main data
 insert @rt
 select
--REMOVED By Nate  cast(case when description = 'Apportionment Receivable' then '8' else '9' end + cast(id as varchar) as int), 
  cast(case when description = 'depository' then '8' else '9' end + cast(id as varchar) as int),
  @ordSeed + ord + 'b',
  case when description = 'Apportionment Receivable' 
   then '   ' + dbo.padRight(subDescription,' ',61) + dbo.padLeft('',' ',16)
   else dbo.dailyDataFormatCollections(subDescription,minControlNumber,maxControlNumber,rowCnt,amount,case when description='Depository' then 43 else 28 end)+case when description='Depository' then '' else dbo.padLeft(convert(varchar,glBalance*-1,1),' ',16) end
  end,  
  dbo.padLeft(convert(varchar,glBalance,1),' ',16),
  '   ' + dbo.padRight(subDescription,' ',61),  
  case when description = 'Apportionment Payable' 
   then '   ' 
   else     dbo.padLeft(minControlNumber, 0, 5) + ' - ' + dbo.padLeft(maxControlNumber, 0, 5) 
  end,
  case when description = 'Apportionment Payable' 
   then '   '
   else     dbo.padLeft(cast(rowCnt as varchar), ' ', 4)
  end,
  case when description = 'Apportionment Payable' 
   then '   '
   else     dbo.padLeft(convert(varchar,amount,1),' ',16)
  end,
  'detail',0,
  minControlNumber,
  maxControlNumber,
  minTicketNumber,
  maxTicketNumber,
  dptno,
  dbo.padLeft(convert(varchar,electronicAmount,1),' ',16),
  dbo.padLeft(convert(varchar,otherAmount,1),' ',16),
  case when description = 'depository' then '@action=browse;@objectTyp=4522;@browseFilter=b1=''' + replace(subDescription,'''','''''') + ''';' else null end
 from @wt

-- insert subtotals
 insert @rt
 select
  0,
  @ordSeed + ord + 'c',
  ' ' + replicate('-',79),
  replicate('-',16),
  ' ' + replicate('-',79),
  replicate('-',22),
  replicate('-',10),
  replicate('-',16),
  'line',0,'','','','','','','',null
 from @wt 
 group by ord,description

 insert @rt
 select
  0,
  @ordSeed + ord + 'd',
  dbo.padRight('      Total ' + description, ' ', case when description='Depository' then 60 else 45 end)
  + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
  + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16)+case when description='Depository' then '' else dbo.padLeft(convert(varchar,sum(glBalance)*-1,1),' ',16) end,
  '',
  dbo.padRight('      Total ' + description, ' ', 60),
  '',
  dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
  dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
  'gFooter',0,'','','','','',
  dbo.padLeft(convert(varchar,sum(electronicAmount),1), ' ', 16),
  dbo.padLeft(convert(varchar,sum(otherAmount),1), ' ', 16),
  null
 from @wt 
 group by ord,description

 insert @rt
 select
  0,
  @ordSeed + ord + 'e',
  replicate(' ',80),
  '',
  '',
  '',
  '',
  '',
  'lineFeed',0,'','','','','','','',null
 from @wt 
 group by ord,description

 -- headers
 insert @rt select 0,@ordSeed+'00a','','','','','','','lineFeed',0,'','','','','','','',null
 insert @rt select 0,@ordSeed+'00aa','  Collections','','  Collections','','','','sHeader',1,'','','','','','Electronic','Regular',null
 insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,'','','','','','','',null

 if exists(select * from @wt where description = 'Depository')
 begin
  declare @reportSub varchar(50)
  select @reportSub = max(ord) from @wt where description = 'Depository'
  insert @rt select 0,@ordSeed+@reportSub+'a','','','','','','','lineFeed',0,'','','','','','','',null
  insert @rt select 0,@ordSeed+@reportSub+'aa','  Deposits by Officers','','  Deposits by Officers','','','','sHeader',1,'','','','','','','',null
  insert @rt select 0,@ordSeed+@reportSub+'ab',' ' + replicate('=',79),replicate('=',16),' ' + replicate('=',79),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,'','','','','','','',null
 end

-- insert grand total
 if exists(select * from @wt)
 begin
  insert @rt select 0,@ordSeed+'da',dbo.padLeft(replicate('=',20),' ',80),replicate('=',16),dbo.padLeft(replicate('=',20),' ',80),replicate('=',22),replicate('=',10),replicate('=',16),'line',0,'','','','','','','',null

  insert @rt
  select
   0,
   @ordSeed + 'db',
   dbo.padLeft('Total Collections  ', ' ', 60)
   + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
   + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   dbo.padLeft(convert(varchar,sum(glBalance),1), ' ', 16),
   dbo.padLeft('Total Collections  ', ' ', 50),
   '',
   dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4),
   dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16),
   'grandTotal',0,'','','','','',
   dbo.padLeft(convert(varchar,sum(electronicAmount),1), ' ', 16),
   dbo.padLeft(convert(varchar,sum(otherAmount),1), ' ', 16),
   null
  from @wt 
 end
 return
end