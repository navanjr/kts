create function dbo.taxyearTrioBRW(@taxyear varchar(50)) returns @rt table(
 id int identity(1,1),
 count int,
 district varchar(50),
 rateName varchar(50),
 millcount int,
 millTotal decimal(19,10),
 adtaxBalanceDue money,
 invoiceBalanceDue money,
 invoiceAmount money,
 blob varchar(max),
 ord varchar(max)
) as 
begin
 insert @rt 
 select
  count(*),
  SCHOOLDISTRICTMAIN,
  SCHOOLDISTRICTTAXRATE,
  null,null,
  sum(balancedue),
  null,
  null,
  '@district=' + schoolDistrictMain + ';@taxRate=' + schooldistrictTaxRate + ';',
   SCHOOLDISTRICTMAIN+SCHOOLDISTRICTTAXRATE+'b'
 from adtax 
 where realtaxyear = @taxyear and origin = 'Original Invoice'
 group by SCHOOLDISTRICTMAIN, SCHOOLDISTRICTTAXRATE 
 order by SCHOOLDISTRICTMAIN, SCHOOLDISTRICTTAXRATE
 
 declare @wt table(
  district varchar(50),
  rateName varchar(50),
  millcount int,
  millTotal decimal(19,10)
 )
 insert @wt
 select
  key1,
  key2,
  COUNT(*),
  SUM(case when isnumeric(a2)=1 then CAST(a2 as decimal(19,10)) else 0 end) 
 from Object
 where typ = 4012 and key3 = @taxyear
 group by Key1,key2

 update a set a.millCount = b.millCount, a.millTotal = b.millTotal 
 from @rt a, @wt b
 where a.district = b.district and a.rateName = b.rateName

 update @rt set 
  invoiceBalanceDue = (
   select sum(a.invoiceDue)
   from invoices a, adtax b
   where a.taxrollid = b.id
    and a.taxyear = @taxyear
    and b.SCHOOLDISTRICTMAIN = district
    and b.SCHOOLDISTRICTTAXRATE = rateName
  ),
  invoiceAmount = (
   select sum(a.invoiceAmount)
   from invoices a, adtax b
   where a.taxrollid = b.id
    and a.taxyear = @taxyear
    and b.SCHOOLDISTRICTMAIN = district
    and b.SCHOOLDISTRICTTAXRATE = rateName
  )

 insert @rt 
 select
  sum(count),
  'Total',
  '',
  sum(isnull(millcount,0)),
  sum(isnull(millTotal,0)),
  sum(adtaxBalanceDue),
  sum(invoiceBalanceDue),
  sum(invoiceAmount),
  '',
  'zzzzz'
 from @rt

 return
end