create proc dbo.mortgageLinkGet (
 @taxYear varchar(4),
 @siteId varchar(50) = null -- this parameter will default to the natural SiteId. only included so we can debug from a dev environment
) as 
begin
 set nocount on

 if not exists(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'temp_mortgageLink' and COLUMN_NAME = 'mortgage_Code')
   alter table temp_mortgageLink add mortgage_Code varchar(10)

 if not exists(select * from dbo.sysobjects where id = object_id(N'[dbo].[temp_mortgageLink]') and OBJECTPROPERTY(id, N'IsTable') = 1)
  create table temp_mortgageLink(
   id int identity(1,1),
   company varchar(100), 
   details varchar(max), 
   parcel varchar(100),
   record_id int,
   year varchar(50),
   site_id int,
   createDate varchar(50),
   taxrollId int,
   companyId varchar(50),
   mortgage_code varchar(10)
  )

  delete from temp_mortgageLink

  declare 
   @typ int = 4,
   @apiwt JSONHierarchy,
   @filter varchar(500),
   @apiHost varchar(50),
   @apiKey varchar(50),
   @apiResource varchar(50),
   @apiFields varchar(max),
   @dump varchar(max),
   @log varchar(max),
   @scratchFile varchar(1000)

  select @scratchFile = path + '\apiMortgageLink.tmp' from dbo.paths() where name = 'temp'
  if @siteId is null
   select @siteId = apiSiteCode from dbo.site
  select @filter = '"site_id=' + @siteId + '&year=' + @taxYear + '"'
   
  exec dbo.api
   @scratchFile = @scratchFile,
   @method = 'get', 
   @resource = '/v2/treasurer/mortgagelink',
   @debugmode='false',
   @filter = @filter,
   @dump = @dump output

  if len(@dump) > 0
  begin

   begin try
    insert into @apiwt
    select * from dbo.parseJSON(@dump) where name is not null and parent_id is not null
   end try
   begin catch
    set @log = error_message()
    exec dbo.logit @@procid, 'Failed Insert in to @apiwt', @log
    select '@code=1;@message=Failed Insert in to @apiwt:' + @log + ';'
    return
   end catch

   declare @token int, @tally int

   while exists(select * from @apiwt)
   begin
    select @token = min(parent_id) from @apiwt
    insert temp_mortgageLink select 
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'company'),''),
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'details'),''),
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'parcel'),''),
     (select stringValue from @apiwt where parent_id = @token and name = 'id'),
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'year'),''),
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'site_id'),''),
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'created_date'),''),
     null,null,null,0,
     isnull((select stringValue from @apiwt where parent_id = @token and name = 'mortgage_code'),'')
    delete @apiwt where parent_id = @token
   end

   select @tally = count(*) from temp_mortgageLink
   exec dbo.logit @@procid, 'total rows received from the API', @tally   

-- little data cleanup
-- remove hyphens 
   exec dbo.logit @@procid, 'removing Hyphens'   
   update temp_mortgageLink set parcel = dbo.stripChars(parcel,'45') 

-- update customerNumber if we have it
   exec dbo.logit @@procid, 'gleening CustomerNumber'   
   declare
    @tokenId int,
    @tokenBlob varchar(max)
 
   update temp_mortgageLink set processFlag = 0
   while exists(select * from temp_mortgageLink where processFlag = 0)
   begin
    select top 1
     @tokenId = id,
     @tokenBlob = dbo.stripChars(details,'45')
    from temp_mortgageLink
    where processFlag = 0 order by id

    update temp_mortgageLink set
     customerNumber = (select top 1 dbo.stripChars(dbo.splitF(data,':',2),'34') from dbo.split(@tokenBlob,',') where data like '%customerNumber%'),
     processFlag = 1
    where id = @tokenId 
   end

-- lets get the taxrollId
   exec dbo.logit @@procid, 'looking up TaxrollId'   
   declare @parcelLookup table(
    taxrollId int, 
    parcel varchar(50) 
   )

   insert @parcelLookup
    select id, dbo.stripChars(FULLPIDNUMBER,'45') from AdTax where REALTAXYEAR = @taxYear
 
   update a 
    set a.taxrollId = b.taxrollId
   from temp_mortgageLink a, @parcelLookup b
   where a.parcel = b.parcel
    and a.taxrollId is null

-- lets get the mort companyId
   exec dbo.logit @@procid, 'looking up Mortgage Codes'   
   declare @mortLookup table(
    objectId int, 
    mortCode varchar(50) 
   )
   insert @mortLookup select id, a17 from object where typ = 4030
   update a 
    set a.companyId = b.objectId
   from temp_mortgageLink a, @mortLookup b
   where a.customerNumber = b.mortCode
    and a.companyId is null

   select @tally = count(*) from temp_mortgageLink
   exec dbo.logit @@procid, 'total rows received from the API', @tally 

 end
end