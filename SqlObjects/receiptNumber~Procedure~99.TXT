create procedure dbo.receiptNumber(
 @receiptId int,
 @series varchar(50),
 @clobberUpdate varchar(5) = 'FALSE'
) as
begin
  declare 
    @retval nvarchar(max),
    @objectType int,
    @date varchar(20),
    @fiscalYear varchar(20),
    @additionalWhereClause varchar(250)=null

   select @objectType=typ from object where id=@receiptId

  if @objectType in (4522,4502,4514)
  begin
   select @date = key2 from object where id = @receiptId
   select @fiscalYear = fiscalYear from dbo.fiscalCalendar where @date between startDate and endDate

   set @additionalWhereClause = ' olink1 = ''' + @fiscalYear + ''' '
  end

  exec dbo.logit @@procid, '@receiptId', @receiptId, '@series', @series, '@objectType', @objectType, '@additionalWhereClause', @additionalWhereClause

  exec dbo.nextObjectAutoNumber @objectType, @series, @ignoreDeleted='TRUE', @additionalWhereClause = @additionalWhereClause, @objectId = @receiptId, @newNumber = @retval output


  select @retval

  if @clobberUpdate != 'TRUE'
   update object set key1 = @retval,
      k2 = case when @objectType = 4502 then cast(999999-cast(key2 as int) as varchar)+rtrim(key3)+cast(999999-cast(@retval as int) as varchar) else k2 end,  
      k3 = case when @objectType = 4502 then left(k3,8)+@retval else k3 end  
   where typ = @objectType and id = @receiptId

end