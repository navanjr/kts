create function dbo.docUnpaidSumSF(@invoiceId int,@interestDate varchar(50)) returns varchar(max)
as
begin

declare         @taxYear varchar(4),
		@item varchar(50),
		@parcel varchar(50),
                @interestDateInt int = dbo.clariondate(@interestDate)

select	        @taxYear = taxYear, 
		@item = ITEM, 
		@parcel = PARCEL
		from invoices where ID = @invoiceID
		
		
declare @wt table(invoiceId int,
                  taxrollId int,
		  taxYear varchar(4),
		  parcel varchar(50),
		  invoiceAmt money,
		  invoiceDue money,
		  fees money,
		  penalty money,
		  interestDate varchar(10),
		  invoiceType varchar(10),
                  perTyp varchar(10))
	
insert @wt
	select	id,
		taxrollId,
		taxYear,
		parcel,
		isnull(invoiceAmount,0),
		isnull(invoiceDue,0),
		0,
		0,
		interestDate,
		TYP,
	        ''   					
	from invoices where (ITEM = @item) and invoiceDue <> 0 and taxyear <= @taxYear

insert @wt
	select	id,
		taxrollId,
		taxYear,
		parcel,
		isnull(invoiceAmount,0),
		isnull(invoiceDue,0),
		0,
		0,
		interestDate,
		TYP,
	        ''   					
	from invoices where statementId = @invoiceId and id not in (select invoiceId from @wt)

update w set w.perTyp = a.perTyp from adtax a, @wt w where w.taxrollId = a.id
			
update a set			
	 a.fees = isnull((select sum(i.invoiceAmount) from invoices i where i.invoiceId=a.invoiceId and i.typ='f'),0),
	 a.penalty = round((cast(a.invoiceDue as money)*dbo.penaltyPercent(invoiceId,dbo.date1(@interestDateInt))/100),2)
    from @wt a

declare @ret varchar(max) = ''
   
   /*select @ret = @ret + dbo.padleft('','_',45)	+ CHAR(13) + char(10) + CHAR(13) + char(10)*/
	
   select @ret = @ret 
		+ ' ' + dbo.padRight('Taxes assessed:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(case when taxYear = @taxYear then invoiceAmt else 0 end)),' ',14) + CHAR(13) + CHAR(10) 
		+ ' ' + dbo.padRight('Taxes unpaid:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(case when taxYear = @taxYear then invoiceDue else 0 end)),' ',14) + CHAR(13) + CHAR(10) 
		+ ' ' + dbo.padRight('Int/Pen:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(case when taxYear = @taxYear then penalty else 0 end)),' ',14) + CHAR(13) + CHAR(10) 
		+ ' ' + dbo.padRight('Fees:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(case when taxYear = @taxYear then fees else 0 end)),' ',14) + CHAR(13) + CHAR(10) 
		+ ' ' + dbo.padRight('BackTaxes:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(case when taxYear < @taxYear then invoiceDue + fees + penalty else 0 end)),' ',14) + CHAR(13) + CHAR(10) 
		+ ' ' + dbo.padRight('TOTAL DUE:',' ',24)
			+ dbo.padLeft(dbo.formatCurr(sum(invoiceDue + fees + penalty)),' ',14) 
 
       from @wt 


			
return @ret			
--select * from @wt order by taxYear

end

				