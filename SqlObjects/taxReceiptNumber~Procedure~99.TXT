create procedure taxReceiptNumber(@receiptId int)
as
begin
 -- assign receipt numbers to the receipt links
 declare @idToken int
 while exists(select * from receiptLink where receiptId = @receiptId and isnull(receiptNumber,'') < '  0' and 0 = (select invoiceId from invoices where id=receiptLink.invoiceId))
 begin
  select top 1 @idToken = id from receiptLink where receiptId = @receiptId and isnull(receiptNumber,'') < '  0'  and 0 = (select invoiceId from invoices where id=receiptLink.invoiceId) order by invoiceId
  update a set a.receiptNumber = dbo.nextTaxReceiptAutoNumber(b.taxYear)
  from receiptLink a, invoices b
  where a.invoiceId = b.id and a.id = @idToken
 end
end