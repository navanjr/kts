create procedure taxReceiptNumber( @receiptId int )
as
begin

 -- assign receipt numbers to the receipt links
 declare @idToken int,
         @specialAssessmentsGetOwnReceiptNumber varchar(5),
         @invoicetype varchar(10)

 select @specialAssessmentsGetOwnReceiptNumber = settingvalue from settings with (NOLOCK) where settingname='site.specialAssessmentsGetOwnReceiptNumber'


 while exists(select * from receiptLink with (NOLOCK) where receiptId = @receiptId and isnull(receiptNumber,'') < '  0' and 0 = (select invoiceId from invoices with (NOLOCK) where id=receiptLink.invoiceId))
 begin

  select top 1 @idToken = id 
   from receiptLink with (NOLOCK)
   where receiptId = @receiptId
    and isnull(receiptNumber,'') < '  0'
    and 0 = (select invoiceId from invoices where id=receiptLink.invoiceId)
   order by invoiceId

  if @specialAssessmentsGetOwnReceiptNumber = 'TRUE'
   begin
    select @invoicetype = b.typ 
     from receiptLink a with (NOLOCK), invoices b with (NOLOCK)
     where a.invoiceId = b.id and a.id = @idToken
   end
  else
   begin
    select @invoicetype = null
   end

  update a set a.receiptNumber = dbo.nextTaxReceiptAutoNumber(b.taxYear,@invoicetype)
   from receiptLink a, invoices b
   where a.invoiceId = b.id and a.id = @idToken

 end
end