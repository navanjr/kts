create procedure receiptNew(
 @receiptType varchar(50), 
 @receiptId int = null,
 @blob varchar(8000) = '' 
) as 
-- this is a proc wrapper. it uses receiptCRUD to do the heavy lifting and just returns the new object id number of the receipt
begin

 -- if this is a tax receipt, check to see if there are items select first.
 if @receiptType = 'TAX'
 begin
 
  if not exists(select * from dbo.invoices a with (NOLOCK), receiptLink b with (NOLOCK) where a.id = b.invoiceId and b.receiptId = @receiptId)
  begin
   exec dbo.logit @@procid, 'Someone tried to create a new Tax receipt with out taxroll items selected'
   select '@code=1;@message=Sorry, No Taxroll items were selected for this New Receipt.;'
   return
  end 

 end

 if @receiptType = 'MTG'
 begin
 
  if not exists(select * from object td with (NOLOCK), glaccounts s, glaccounts f  where td.typ=4504 and s.accountcode=td.key2 and f.accountcode=td.key3 and td.a1='MTG' and td.key1 like'%TAX%')
  begin
   exec dbo.logit @@procid, 'Someone tried to create a new Mortgage receipt with out the appropriate Mortgage Tax Tax Description.'
   select '@code=1;@message=Sorry, The Mortgage Tax, Tax Descripiton has not been properly setup.;'
   return
  end 

  if not exists(select * from object td with (NOLOCK), glaccounts s, glaccounts f  where td.typ=4504 and s.accountcode=td.key2 and f.accountcode=td.key3 and td.a1='MTG' and td.key1 like'%FEE%')
  begin
   exec dbo.logit @@procid, 'Someone tried to create a new Mortgage receipt with out the appropriate Mortgage Fee Tax Description.'
   select '@code=1;@message=Sorry, The Mortgage Fee, Tax Descripiton has not been properly setup.;'
   return
  end 
 end

 declare @newId int

 exec dbo.receiptCRUD
  @mode = 0,
  @series=@receiptType,
  @newReceiptId = @newId output,
  @blob = @blob

  exec dbo.logit @@procid, '@series', @receiptType,'@newReceiptId',@newId, '@blob', @blob

 select @newId

end