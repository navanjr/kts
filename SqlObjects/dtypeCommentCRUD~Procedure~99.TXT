 create procedure dbo.dtypeCommentCRUD(
 @mode varchar(50),
 @dtype varchar(50) = null,
 @parcel varchar(50) = null,
 @item numeric(7,1) = null,
 @docReceivablesBRWBlob varchar(max) = null,
 @taxRollDetailId int = null,
 @invoiceId int = null
) as 
begin

 exec dbo.logit @@procid, '@mode', @mode, '@dtype', @dtype, '@parcel', @parcel, '@item', @item

 declare 
  @keyFieldName varchar(50),
  @invoiceTyp varchar(10)

 select
  @keyFieldName = case when @dtype = 'RESALE' then 'parcel' else 'item' end

 if @mode = 'REMOVE'
 begin
  exec dbo.logit @@procid, 'deleting @taxrollDetailId', @taxRollDetailId
  delete taxrollDetail where id = @taxrollDetailId
 end

 if @mode = 'CREATEBYINVOICE'
 begin

  select
   @invoiceTyp = typ,
   @parcel = parcel,
   @item = item 
  from invoices where id = @invoiceId 

  exec dbo.logit @@procid, '@invoiceId', @invoiceId, '@invoiceTyp', @invoiceTyp, '@parcel', @parcel, '@item', @item

  if @invoiceTyp in ('R','O','S') and isnull(@parcel,'') > '  0'
  begin
   set @dtype = 'RESALE'
   if not exists(select * from taxrollDetail where parcelNumber = @parcel and dtype = @dtype)
    insert taxRollDetail (parcelNumber, dtype, comments) select @parcel, @dtype, 'initiated: ' + @dtype
  end

  if @invoiceTyp in ('I','B','P') and isnull(@item,0) > 0
  begin
   set @dtype = 'TAXWARRANT'
   if not exists(select * from taxrollDetail where itemNumber = @item and dtype = @dtype)
    insert taxRollDetail (itemNumber, dtype, comments) select @item, @dtype, 'initiated: ' + @dtype
  end

  return
 end

 if @mode = 'CREATE'
 begin

-- bail if we dont have our receivables blob
  if isnull(@docReceivablesBRWBlob,'') < '  0'
   return

 if @dtype = 'RESALE'
  insert taxRollDetail (parcelNumber, dtype, comments)
  select code, @dtype, 'initiated: ' + @dtype
  from dbo.dtypeKeysFromReceivables(@keyFieldName, @docReceivablesBRWBlob)
  where taxRollDetailId is null
 else
  insert taxRollDetail (itemNumber, dtype, comments)
  select cast(code as numeric(7,1)), @dtype, 'initiated: ' + @dtype
  from dbo.dtypeKeysFromReceivables(@keyFieldName, @docReceivablesBRWBlob)
  where taxRollDetailId is null

  exec dbo.logit @@procid, 'We just inserted records...', @@rowcount

  return
 end

 if @dtype = 'ABSTRACT'
 begin
  select @parcel = parcelNumber from taxrollDetail where id = @taxRollDetailId
  if not exists(select * from taxrollDetail where parcelNumber = @parcel and dtype = @dtype) and @parcel>'  0'
   insert taxRollDetail (parcelNumber, dtype, comments) select @parcel, @dtype, 'Sent to Abstracter: ' + @mode

 return
 end

end