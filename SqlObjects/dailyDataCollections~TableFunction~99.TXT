CREATE function dbo.dailyDataCollections(@theDate int, @days int, @ordSeed varchar(50)) returns 
@rt table (
 id int,
 ord varchar(10),
 rowstring varchar(250)
)
begin

 declare @wt table(
  id int,
  ord varchar(50),
  description varchar(50),
  subDescription varchar(50),
  minControlNumber varchar(50),
  maxControlNumber varchar(50),
  rowCnt int,
  amount money
 )

 insert @wt
 select
  0,
  a.reportOrder,
  a.collectionDescription,
  b.accountDesc,
  min(c.key1),
  max(c.key1),
  COUNT(c.id),
  abs(SUM(b.amount))
 from dbo.glCollectionAccount a, glDetail b, object c
 where a.accountId = b.accountId
  and substring(b.slink,2,14) = c.id
  and b.date between @theDate and @theDate + @days
 group by
  a.reportOrder,
  a.collectionDescription,
  b.accountDesc
 order by
  a.reportOrder

 insert @rt
 select
  id,
  @ordSeed + ord + 'b',
  dbo.dailyDataFormatCollections(subDescription,minControlNumber,maxControlNumber,rowCnt,amount)
 from @wt

 insert @rt
 select
  0,
  @ordSeed + ord + 'c',
  ' ' + replicate('-',79)
 from @wt 
 group by ord,description

 insert @rt
 select
  0,
  @ordSeed + ord + 'd',
  dbo.padRight('      Total ' + description, ' ', 60)
  + dbo.padLeft(cast(sum(rowCnt) as varchar), ' ', 4)
  + dbo.padLeft(convert(varchar,sum(amount),1), ' ', 16)
 from @wt 
 group by ord,description

 insert @rt
 select
  0,
  @ordSeed + ord + 'e',
  replicate(' ',80)
 from @wt 
 group by ord,description

 insert @rt select 0,@ordSeed+'00a',''
 insert @rt select 0,@ordSeed+'00aa','  Collections'
 insert @rt select 0,@ordSeed+'00ab',' ' + replicate('=',79)

 if exists(select * from @wt where description = 'Depository')
 begin
  declare @reportSub varchar(50)
  select @reportSub = max(ord) from @wt where description = 'Depository'
  insert @rt select 0,@ordSeed+@reportSub+'a',''
  insert @rt select 0,@ordSeed+@reportSub+'aa','  Deposits by Officers'
  insert @rt select 0,@ordSeed+@reportSub+'ab',' ' + replicate('=',79)
 end

 return
end
