create procedure dbo.bankStatementCRUD(
 @date varchar(20),
 @accountId int = null,
 @newBSId int = null output,
 @mode int = null,
 @bankStatementId int = null
) as 

begin

 declare @datetime datetime = dbo.date1(@date)
 declare @firstDay varchar(20),
         @lastDay varchar(20)

 select @firstDay = dbo.clariondate(dateadd(month, datediff(month, 0, @datetime), 0))
 select @lastDay = dbo.clariondate(dateadd(month, datediff(month, 0, @datetime) + 1, 0) - 1)

-- Delete Bank Statement
 if isnull(@mode,0) = 3
 begin
  -- Check for items cleared to this statement
  if exists(select * from gldetail where bsId = @bankStatementId)
   begin
    select '@code=1;@message=This bank statement has items cleared to it and may not be deleted.;'
    return
   end
  else
   begin
    update object set typ = -4780 where typ = 4780 and id = @bankStatementId
    select '@code=0;!message=Deleting bank statement.;'
    return
   end
 end

 if isnull(@accountId,0) > 0
 begin

  declare @newIdWt newIdWt

  insert object (typ,link1,key1,key2,a1,a2,k2,e2,a3)
  output inserted.id into @newIdWt
  select 4780,accountid,accountcode,accountdesc,@firstDay,@lastDay,left(cast(999999-cast(@firstDay as int) as varchar)+accountcode,29),
  case when accounttype in ('INVESTMENT','CASH') then cast(isnull((select sum(gldetail.amount) from gldetail where gldetail.accountcode = glaccounts.accountcode),0.00) as varchar) else '' end,
  case when accounttype in ('INVESTMENT','CASH') then cast(isnull((select sum(gldetail.amount) from gldetail where gldetail.accountcode = glaccounts.accountcode),0.00) as varchar) else '' end  
  from glaccounts 
  where accounttype in (select accounttype from dbo.glbankfundtypes('BANK') where accounttype not in  ('SUSPENSE')) 
   and accountCode not in (select key1 from object where typ=4780 and a1=@firstDay)
   and accountId = @accountId

  select @newBSId = max(id) from @newIdWt
  exec dbo.logit @@procid, '@newBSId', @newBSId

 end
 else
 begin

  insert object (typ,link1,key1,key2,a1,a2,k2,e2,a3)
  select 4780,accountid,accountcode,accountdesc,@firstDay,@lastDay,left(cast(999999-cast(@firstDay as int) as varchar)+accountcode,29),
  case when accounttype in ('INVESTMENT','CASH') then cast(isnull((select sum(gldetail.amount) from gldetail where gldetail.accountcode = glaccounts.accountcode),0.00) as varchar) else '' end,
  case when accounttype in ('INVESTMENT','CASH') then cast(isnull((select sum(gldetail.amount) from gldetail where gldetail.accountcode = glaccounts.accountcode),0.00) as varchar) else '' end    
  from glaccounts 
  where accounttype in (select accounttype from dbo.glbankfundtypes('BANK') where accounttype not in  ('SUSPENSE')) 
   and accountCode not in (select key1 from object where typ=4780 and a1=@firstDay)
   and inactive <> 1

 end
end