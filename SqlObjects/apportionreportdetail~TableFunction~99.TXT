create function dbo.apportionreportdetail(@beginDate int, @endDate int) returns @sd table(id int identity(1,1), district varchar(60), taxpaid money, 
  col1 money, col2 money, col3 money, col4 money, col5 money, col6 money, 
  col7 money, col8 money, col9 money, col10 money, col11 money, col12 money, col13 money, col14 money, col15 money, journalDesc varchar(60))
as begin

declare @det table(
    id int identity(1,1),
	[accountType] [varchar](50) NULL,
	[accountId] [int] NULL,
	[accountCode] [varchar](60) NULL,
	[accountDesc] [varchar](50) NULL,
	[comment] [varchar](50) NULL,
	[comment2] [varchar](50) NULL,
	[sourceCode] [varchar](60) NULL,
	[amount] [money] NULL,
	[journalType] [varchar](50) NULL,
	[sourceDesc] [varchar](50) NULL,
	[sourceSECA] [varchar](50) NULL,
	[journalDesc] [varchar](50) NULL
)

insert @det
select * from rpMonthEndDetail(@beginDate,@endDate) where isnull(comment2,'Not Found') in (select key1 from object where typ=4008)
  

insert @sd (district, taxpaid, journalDesc)
select comment,sum(amount*-1),journalDesc from rpMonthEndDetail(@beginDate,@endDate) where isnull(comment2,'Not FOund') in (select key1 from object where typ=4008)
 group by comment, journalDesc

update a set col1=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=1 
  and b.heading=c.comment2

update a set col2=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=2 
  and b.heading=c.comment2

update a set col3=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=3 
  and b.heading=c.comment2

update a set col4=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=4 
  and b.heading=c.comment2

update a set col5=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=5 
  and b.heading=c.comment2

update a set col6=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=6 
  and b.heading=c.comment2

update a set col7=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=7 
  and b.heading=c.comment2

update a set col8=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=8 
  and b.heading=c.comment2

update a set col9=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=9 
  and b.heading=c.comment2

update a set col10=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=10 
  and b.heading=c.comment2

update a set col11=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=11 
  and b.heading=c.comment2

update a set col12=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=12 
  and b.heading=c.comment2

update a set col13=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=13 
  and b.heading=c.comment2

update a set col14=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=14 
  and b.heading=c.comment2

update a set col15=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select comment, comment2, sum(amount*-1) as amount from @det group by comment, comment2) c
 where rtrim(a.district) = left(comment,len(rtrim(a.district)))
  and b.ord=15 
  and b.heading=c.comment2

return
end
