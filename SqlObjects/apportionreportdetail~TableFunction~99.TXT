create function dbo.apportionreportdetail(@beginDate int, @endDate int) returns @sd table(id int identity(1,1),
  sourceCode varchar(60), district varchar(60), rate varchar(60), taxpaid money, 
  col1 money, col2 money, col3 money, col4 money, col5 money, col6 money, 
  col7 money, col8 money, col9 money, col10 money, col11 money, col12 money,
  col13 money, col14 money, col15 money, total money, journalDesc varchar(60))
as begin

declare @det table(
    id int identity(1,1),
	[accountType] [varchar](50) NULL,
	[accountId] [int] NULL,
	[accountCode] [varchar](60) NULL,
	[accountDesc] [varchar](50) NULL,
	[comment] [varchar](50) NULL,
	[comment2] [varchar](50) NULL,
	[sourceCode] [varchar](60) NULL,
	[amount] [money] NULL,
	[journalType] [varchar](50) NULL,
	[sourceDesc] [varchar](50) NULL,
	[sourceSECA] [varchar](50) NULL,
	[journalDesc] [varchar](50) NULL
)

insert @det
select * from rpMonthEndDetail(@beginDate,@endDate) 
 where isnull(sourceCode,'Not Found') in (select accountCode from glAccounts)
  and journalDesc like '%ADVALOREM%'
  
update d set comment2=left(comment2,len(b.heading)) from @det d, (select * from dbo.apportionHeadings()) b
   where b.heading=left(d.comment2, len(b.heading))

  

insert @sd (sourceCode, taxpaid, journalDesc)
select sourceCode,sum(amount*-1),journalDesc from rpMonthEndDetail(@beginDate,@endDate) 
 where isnull(sourceCode,'Not Found') in (select accountCode from glAccounts)
  and journalDesc like '%ADVALOREM%'
 group by sourceCode, journalDesc

update a set col1=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=1 
  and b.heading=left(c.comment2, len(b.heading))

update a set col2=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=2 
  and b.heading=left(c.comment2, len(b.heading))

update a set col3=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=3 
  and b.heading=left(c.comment2, len(b.heading))

update a set col4=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=4 
  and b.heading=left(c.comment2, len(b.heading))

update a set col5=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=5 
  and b.heading=left(c.comment2, len(b.heading))

update a set col6=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=6 
  and b.heading=left(c.comment2, len(b.heading))

update a set col7=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=7 
  and b.heading=left(c.comment2, len(b.heading))

update a set col8=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=8 
  and b.heading=left(c.comment2, len(b.heading))

update a set col9=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=9 
  and b.heading=left(c.comment2, len(b.heading))

update a set col10=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=10 
  and b.heading=left(c.comment2, len(b.heading))

update a set col11=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=11 
  and b.heading=left(c.comment2, len(b.heading))

update a set col12=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=12 
  and b.heading=left(c.comment2, len(b.heading))

update a set col13=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=13 
  and b.heading=left(c.comment2, len(b.heading))

update a set col14=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=14 
  and b.heading=left(c.comment2, len(b.heading))

update a set col15=c.amount 
 from @sd a, (select * from dbo.apportionHeadings()) b, (select sourceCode, comment2, sum(amount*-1) as amount, journalDesc from @det group by sourceCode, comment2, journalDesc) c
 where a.sourceCode = c.sourceCode
  and a.journalDesc = c.journalDesc
  and b.ord=15 
  and b.heading=left(c.comment2, len(b.heading))

 update a set district = ac.apdistrict, rate = ac.aprate from @sd a, glAccounts ac where a.sourceCode=left(ac.accountCode,len(a.sourceCode))

 update a set total=isnull(col1,0)+isnull(col2,0)+isnull(col3,0)+isnull(col4,0)+isnull(col5,0)+isnull(col6,0)+isnull(col7,0)+
 isnull(col8,0)+isnull(col9,0)+isnull(col10,0)+isnull(col11,0)+isnull(col12,0)+isnull(col13,0)+isnull(col14,0)+isnull(col15,0) from @sd a


return
end
