Create function dbo.taxReceiptTaxPaid(@recId int,@invoiceId int,@switch int = 0) returns money
	as 
begin
declare @retVal money
declare @wt table (taxAmount money,AccCode varchar(50),AccType varchar(50))
declare @slinks table(slink varchar(15))

if @switch = 0 
     begin
     insert @slinks
      select 'l'+cast(b.id as varchar) from receiptlink b 
        WHERE b.invoiceId = @invoiceId  
			and b.receiptId = @recId
	insert into @wt  
		select g.amount,g.accountCode,a.accountType
			from gldetail g, @slinks b, glAccounts a
			where g.slink=b.slink
			 and g.accountcode=a.accountcode
			 and a.accountType='Receivable'
			
    delete from @wt where taxAmount > 0
    delete from @slinks where slink>'0'

	select @retVal = isnull(SUM(abs(taxAmount)),0) from @wt

     end

if @switch = 1
     begin
     insert @slinks
      select 'l'+cast(b.id as varchar) from receiptlink b 
        WHERE b.invoiceId = @invoiceId  
		and b.receiptId = @recId

	insert into @wt  
		select g.amount,g.accountCode,a.accounttype
			from gldetail g, @slinks b, glAccounts a  
			where g.slink=b.slink
                         and g.accountcode=a.accountcode
                         and a.accounttype='Receivable'

	delete from @wt where taxAmount > 0
        delete from @slinks where slink>'0'

	select @retVal = isnull(SUM(abs(taxAmount)),0) from @wt
     end

if @switch = 2
     begin
        insert into @slinks 
                select 'l'+cast(b.id as varchar) 
                        from receiptlink b
                        where
				b.invoiceId = @invoiceId  
					and b.receiptId = @recId

        insert into @slinks 
                select 'l'+cast(rl.id as varchar) 
                        from receiptlink b, invoices i, receiptlink rl
                        where
                                rl.invoiceId = i.id
                                        and i.invoiceId = b.invoiceId
                                        and i.typ='A'
					and b.invoiceId = @invoiceId  
					and b.receiptId = @recId


	insert into @wt  
		select a.amount,a.accountCode,''
			from gldetail a, @slinks b
			where	
                                a.slink=b.slink


	update w set AccType = accountType from @wt w, glAccounts a where w.AccCode=a.accountcode and accountType='Receivable'
	
	delete from @wt where AccType<>'Receivable' or taxAmount > 0
        delete from @slinks where slink>'0'

	select @retVal = isnull(SUM(abs(taxAmount)),0) from @wt
     end

if @switch = 3 -- Penalty Sub invoices
begin

        insert into @slinks 
                select 'l'+cast(b.id as varchar) 
                        from receiptlink b, invoices i
                        where   b.invoiceId = i.Id  
					and i.invoiceId = @invoiceId  
					and b.receiptId = @recId
                                        and i.typ='P'
                                        and isnull(i.invoiceId,0) > 0



	insert into @wt  
		select amount,accountCode,''
			from gldetail a, @slinks b
			where	
                                a.slink=b.slink

	update w set AccType = accountType from @wt w,glAccounts a where w.AccCode=a.accountcode
	
	delete from @wt where AccType<>'RECEIVABLE'
        delete from @slinks where slink>'0'

	select @retVal = isnull(SUM(taxAmount*-1),0) from @wt
end

if @switch = 4 -- Fee Sub invoices
begin
        insert into @slinks 
                select 'l'+cast(b.id as varchar) 
                        from receiptlink b, invoices i
                        where   b.invoiceId = i.Id  
					and i.invoiceId = @invoiceId  
					and b.receiptId = @recId
                                        and i.typ not in ('P','A')
                                        and isnull(i.invoiceId,0) > 0
	insert into @wt  
		select amount,accountCode,''
			from gldetail a, @slinks b
			where	
                                a.slink=b.slink

	update w set AccType = accountType from @wt w,glAccounts a where w.AccCode=a.accountcode
	
	delete from @wt where AccType<>'RECEIVABLE'
        delete from @slinks where slink>'0'

	select @retVal = isnull(SUM(taxAmount*-1),0) from @wt
end

return @retVal
end
