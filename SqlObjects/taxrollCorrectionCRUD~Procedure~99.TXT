create proc dbo.taxrollCorrectionCRUD(
 @mode int,
 @fieldNumber int,
 @fieldName varchar(50) = '',
 @fieldData varchar(max),
 @taxInvoiceId int = null,
 @taxrollId int = null,
 @originalData varchar(max) = '',
 @comment varchar(max) = ''
) as 
begin
 
 If @fieldName<'  0'
  select @fieldName = fieldName
   from dbo.taxrollItemFields('') where cast(ord as int) = @fieldNumber

  select @originalData = replace(replace(@originalData,'~{~~{~',''''''),'~{~',''''),
         @fieldData = replace(replace(@fieldData,'~{~~{~',''''''),'~{~','''')

 if @taxrollId is null
  select @taxrollId = taxrollId from invoices where id=@taxInvoiceId 

 if @mode = 0
 begin
--TODO: dont forget to add taxrollCorrections to the devPurgeData routines
  insert taxrollCorrections (taxrollId, fieldNumber, fieldName, originalData, fieldData, correctionDate, ini, comment)
  select @taxrollId, @fieldNumber, @fieldName, @originalData, @fieldData, dbo.clariondate(getdate()),dbo.readstring('@ini=',dbo.whoAmI()),@comment
  if isnull(@taxrollId,0) > 0
   update adtax set apiupdated = null, apiupdatedlegal = null where id = @taxrollId
  return
 end


end
