create function dbo.depositBalanceTF(@d1 int,@d2 int,@deputy varchar(50),@depositId int,@station varchar(50),@recTyp varchar(50),@bankAccount varchar(50),@forceDetail varchar(1)) returns @rt
		table (	receivedOf varchar(60),
			Amount varchar(50),
			ref varchar(50),
			bankRef varchar(100),
			paycode varchar(50),
			recTyp varchar(50),
			recNo varchar(50),
			Deputy varchar(50),
			ord varchar(50),
                        recId int,
                        checkNo varchar(50),
                        bankName varchar(100),
                        payor varchar(50),
                        paidid int,
                        imagecnt int,
                        processcode int
)
as
begin
declare @bankDesc varchar(50) 

select @bankDesc = accountdesc from glaccounts where accountcode=@bankAccount

if @depositId = 0
 begin

  insert @rt
   select   
     receiptType+': '+receiptNo,
     dbo.formatCurr(amount),
     paycode+' '+checkno,
     rtrim(drawnon)+case when drawnon>'  0' then ' / ' else '' end+location,    
     case when paycodeDepositType>'  0' then case when paycodeDepositType='E' then 'ETR' else 'CCard' end else paycode end,
     receiptType,
     receiptNo,
     case when @station!='0' then station else deputy end,
     case when @station!='0' then station else deputy end+paycode+receiptType+': '+receiptNo+'bbb',
     receiptId,
     checkno,
     drawnon,
     receivedOf,
     id,
     isnull((select count(o.id) from object o where o.typ=3209 and o.key1 = 'p'+cast(a.id as varchar)),0),
     0
     from dbo.depositAvailablePayments a where 
     isnull(depositId,0) = case when @depositId!=0 then @depositId else isnull(depositId,0) end 
     and deputy like case when @deputy!='0' then '%'+@deputy+'%' else deputy end 
     and station like case when @station!='0' then @station else station end
     and receiptType = case when @recTyp!='0' then @recTyp else receiptType end
     and receipttype in (select code from receiptType where depositAccount = case when @bankAccount>'  0' then @bankAccount else depositAccount end)
     and receiptPostDate between @d1 and @d2
     and (isnull(depositId,0) not in (select id from object where typ=4513 and a1<> @bankDesc) or isnull(@bankDesc,'')<'0')
     order by receiptType, deputy, paycode, receiptNo



 insert @rt (receivedOf,ord)
	select  recTyp,Deputy+recTyp+'bbbccc'
	from @rt  where RIGHT(ord,3)='bbb' group by deputy,recTyp
         
  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select paycode,'',dbo.formatCurr(SUM(cast(amount as money))),Deputy+recTyp+paycode+'ccc1',Deputy+' '+paycode, sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' group by deputy,paycode,recTyp

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select Deputy+' '+recTyp,'',dbo.formatCurr(SUM(cast(amount as money))),Deputy+recTyp+'zzzzccc3',Deputy+' Total', sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' group by deputy,recTyp		

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select paycode,'',dbo.formatCurr(SUM(cast(amount as money))),'zzz'+paycode+'ddd1',paycode, sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' group by paycode	
	
  insert @rt (receivedOf,ref,Amount,ord,imagecnt)
	select 'Report Total','',dbo.formatCurr(SUM(cast(amount as money))),'zzzzeee', sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' 
	
 end
 else
 begin
 
  insert @rt
   select   
     receiptType+': '+receiptNo,
     dbo.formatCurr(amount),
     paycode+' '+checkno,
     rtrim(drawnon)+case when drawnon>'  0' then ' / ' else '' end+location,    
          case when paycodeDepositType>'  0' then case when paycodeDepositType='E' then 'ETR' else 'CCard' end else paycode end,
     receiptType,
     receiptNo,
     case when @station!='0' then station else deputy end,
     receiptType+': '+receiptNo+'bbb',
     receiptId,
     checkno,
     drawnon,
     receivedOf,
     id,
     isnull((select count(o.id) from object o where o.typ=3209 and o.key1 = 'p'+cast(a.id as varchar)),0),
     0
     from dbo.depositAvailablePayments a where 
     isnull(depositId,0) = @depositId
     and paycodeDepositType not in ('E','B')
     order by receiptType, deputy, paycode, receiptNo		


  insert @rt (receivedOf,ord)
	select  '','zzCheckbbbccc'
	

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select paycode,'',dbo.formatCurr(SUM(cast(amount as money))),'zzz'+paycode+'ccc1',paycode,sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' group by paycode

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select 'To Bank Total','',dbo.formatCurr(SUM(cast(amount as money))),'zzzzCheckccc3','To Bank Total',sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' 

  insert @rt (receivedOf,ord)
	select top 2 '','zzzzz    ccc'

  insert @rt (paycode,ord)
   select 'List Of Payments:','zzzzz   aaa'


  insert @rt (paycode,Amount,checkno,payor,receivedOf,bankName,ord)
   select 'Paycode','Amount','Check No.','Payor','Receipt','Bank Name','zzzzz  Checkaaa1'

  insert @rt
   select   
     receiptType+': '+receiptNo,
     dbo.formatCurr(amount),
     paycode+' '+checkno,
     rtrim(drawnon)+case when drawnon>'  0' then ' / ' else '' end+location,    
     paycode,
     receiptType,
     receiptNo,
     case when @station!='0' then station else deputy end,
     'zzzzz'+receiptType+': '+receiptNo+'bbb',
     receiptId,
     checkno,
     drawnon,
     receivedOf,
     id,
     isnull((select count(o.id) from object o where o.typ=3209 and o.key1 = 'p'+cast(a.id as varchar)),0),
     0
     from dbo.depositAvailablePayments a where 
     isnull(depositId,0) = @depositId
     and paycodeDepositType in ('E','B')
     order by receiptType, deputy, paycode, receiptNo		

  insert @rt (receivedOf,ord)
	select  '','zzzzzz+paycode+bbbccc'
         from @rt where left(ord,6)='zzzzzz' group by paycode

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select paycode,'',dbo.formatCurr(SUM(cast(amount as money))),'zzzzzzz'+paycode+'ccc3',paycode+' Total',sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' and left(ord,5)='zzzzz' group by paycode	
	
  insert @rt (receivedOf,ord)
	select top 2 '','zzzzzzzzz+paycode+bbbccc'
         from @rt group by paycode

  insert @rt (receivedOf,ref,Amount,ord,paycode,imagecnt)
	select 'Grand Total','',dbo.formatCurr(SUM(cast(amount as money))),'zzzzzzzzzeee','Grand Total',sum(imagecnt)
	from @rt  where RIGHT(ord,3)='bbb' 

 end

 declare @detailCashonDeposit varchar(5) = dbo.settingsf('site.detailCashonDeposit','FALSE'),
         @depositBank varchar(60),
         @officialBank varchar(5)

 if @forceDetail = 'Y'
  set @detailCashonDeposit = 'TRUE'

 if @detailCashonDeposit != 'TRUE'
   delete from @rt where paycode in ('cash','coin') and RIGHT(ord,3)='bbb'

 return 
end   
