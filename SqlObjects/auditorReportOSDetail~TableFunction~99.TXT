create function dbo.auditorReportOSDetail(@beginDate varchar(20), @endDate varchar(20), @bankAccountCode varchar(50))
returns
 @rt table(
 auditReportGroup varchar(60),
 amount money,
 comment varchar(250))

as
begin
declare @wt table(
 fpCode varchar(60),
 fpDesc varchar(60),
 accountCode varchar(60),
 accountDesc varchar(60),
 amount money,
 debit varchar(60),
 credit varchar(60),
 [date] int,
 slink varchar(60),
 sourceKey1 varchar(60),
 sourceDate varchar(60), 
 sourceKey3 varchar(60),
 sourceType varchar(60),
 sourcea18 varchar(60),
 accountType varchar(60),
 contraId int,
 slink2 varchar(60),
 id int,
 accountId int,
 sourceCode varchar(60),
 bsId int,
 auditReportGroup varchar(60),
 reportOrder varchar(60),
 comment varchar(250)
)
insert @wt (fpCode, fpDesc, accountCode, accountDesc, amount, debit, credit, [date], slink, sourceKey1, sourceDate, sourceKey3, sourceType, sourcea18, accountType, contraId, slink2, id, accountId, sourceCode, bsId, auditReportGroup, reportOrder,comment)
select fpCode, fpDesc, accountCode, accountDesc, amount, debit, credit, [date], slink, sourceKey1, sourceDate, sourceKey3, sourceType, sourcea18, accountType, contraId, slink2, id, accountId, sourceCode, bsId, auditReportGroup, reportOrder,
 case when sourcetype='4513' then comment else '' end
 from gldetailreports 
where 
accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType<>'SUSPENSE')
and isnull(bsId,0)<1
and sourceDate <= @endDate  
and (isnull(@bankAccountCode,'')<' 0' or @bankAccountCode=accountCode)

union all

select fpCode, fpDesc, accountCode, accountDesc, amount, debit, credit, [date], slink, sourceKey1, sourceDate, sourceKey3, sourceType, sourcea18, accountType, contraId, slink2, id, accountId, sourceCode, bsId, auditReportGroup, reportOrder,
 case when sourcetype='4513' then comment else '' end from gldetailreports 
where 
accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType<>'SUSPENSE')
and isnull(bsId,0) in (select id from object where typ=4780 and a2 > @endDate)
and sourceDate <=@endDate 
and (isnull(@bankAccountCode,'')<' 0' or @bankAccountCode=accountCode)


-- Get warrants whose treasurers checks were created the first day of the month but were cleared to the last months bank statement
union all

select fpCode, fpDesc, accountCode, accountDesc, amount*-1, debit, credit, [date], slink, sourceKey1, sourceDate, sourceKey3, sourceType, sourcea18, accountType, contraId, slink2, id, accountId, sourceCode, bsId, auditReportGroup, reportOrder,
 case when sourcetype='4513' then comment else '' end from gldetailreports 
where 
accountType in (select accountType from dbo.glBankFundTypes('BANK') where accountType<>'SUSPENSE')
and isnull(bsId,0) in (select id from object where typ=4780 and a2 >= @beginDate and a2 <= @endDate)
and sourceDate > @endDate 
and (isnull(@bankAccountCode,'')<' 0' or @bankAccountCode=accountCode)


update @wt set auditReportGroup='OS Journals' where auditReportGroup<' 0' and sourceType = '4512'

update @wt set auditReportGroup='OS Official Vouchers' where auditReportGroup<' 0' and sourceType = '4771' and sourcea18 in ('Official Voucher','Trust Voucher')

update @wt set auditReportGroup='OS Cancelled Vouchers' where auditReportGroup<' 0' and sourceType = '4771' and sourcea18 in ('Cancel Voucher','Void Voucher')

update @wt set auditReportGroup='OS MISC Payments' where auditReportGroup<' 0' and sourceType = '4771' and sourcea18 = 'Miscellaneous'

update @wt set auditReportGroup='OS Treasurers Checks' where auditReportGroup<' 0' and sourceType = '4771' and sourcea18 = 'Treasurers Check' and sourceDate <= @enddate

update @wt set auditReportGroup='Treasurers Checks not in Ledger' where auditReportGroup<' 0' and sourceType = '4771' and sourcea18 = 'Treasurers Check' and sourceDate > @enddate

update @wt set auditReportGroup='OS Payments' where auditReportGroup<' 0' and sourceType = '4771'

update @wt set auditReportGroup='OS Deposits' where auditReportGroup<' 0' and sourceType = '4513'

insert @wt (auditReportGroup, amount, comment)
        select key1, 
               case when isnumeric(key2)=1 then cast(key2 as money) else 0 end,
               d1 
          from object where typ=4781 
          and link1 in (select id from object where typ=4780 and a2 >= @beginDate and a2 <= @endDate and (isnull(@bankAccountCode,'')<' 0' or @bankAccountCode=key1))



insert @rt
select auditReportGroup,sum(amount),comment from @wt group by auditReportGroup,comment

return
end