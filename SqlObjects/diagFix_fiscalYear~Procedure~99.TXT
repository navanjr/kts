create proc dbo.diagFix_fiscalYear(
 @mode varchar(5) = 'heavy',
 @method varchar(5) = 'GET',
 @blockAutoFix varchar(5) = 'FALSE',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as
begin
 set nocount on

 if @method = 'GET'
 begin  

  select
   @class = 'General',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = count(o.id),  
   @message = 'object records with the wrong fiscalyear.'
  from object o
   join gldetail g on dbo.slinkId(g.slink)=o.id and dbo.slinktype(g.slink)='o'
   join dbo.fiscalCalendar f on f.fpCode = g.fpCode
  where o.olink1 <> f.fiscalYear and (olink1 <> olink2 or olink1<' 0')
   and f.fiscalYear > ' 0'

  exec dbo.diagnosticsAutoHelper @@procid, @blockAutoFix

  return
 end

 if @method = 'SHOW'
 begin  

  select 
   o.*,
   g.slink,
   g.fpCode, f.fpCode,
   g.fpid, f.fpid,
   f.startDate, f.endDate, g.date,
   dbo.date1(g.date)
  from object o
   join gldetail g on dbo.slinkId(g.slink)=o.id and dbo.slinktype(g.slink)='o'
   join dbo.fiscalCalendar f on f.fpCode = g.fpCode
  where o.olink1 <> f.fiscalYear and (olink1 <> olink2 or olink1<' 0')
   and f.fiscalYear > ' 0'

  return
 end

 if @method = 'FIX'
 begin 

  declare @ids table(id int, fiscalYear varchar(12))
  insert @ids
  select distinct
   o.id,
   f.fiscalYear
  from object o
   join gldetail g on dbo.slinkId(g.slink)=o.id and dbo.slinktype(g.slink)='o'
   join dbo.fiscalCalendar f on f.fpCode = g.fpCode
  where o.olink1 <> f.fiscalYear and (olink1 <> olink2 or olink1<' 0')
   and f.fiscalYear > ' 0'
union all
  select distinct
   o.id,
   f.fiscalYear
  from object o
   join dbo.fiscalCalendar f on f.startdate <= o.key2 and f.enddate >= o.key2
  where o.typ=4514 and o.olink1 <> f.fiscalYear and (olink1 <> olink2 or olink1<' 0')
   and f.fiscalYear > ' 0'
  
  update o set
   o.olink1 = i.fiscalYear
  from object o, @ids i
  where o.id=i.id

  return  
 end


end
