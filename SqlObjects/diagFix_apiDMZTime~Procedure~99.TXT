create proc dbo.diagFix_apiDMZTime(
 @mode varchar(5) = 'heavy',
 @method varchar(5) = 'GET',
 @blockAutoFix varchar(5) = 'FALSE',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as
begin
 set nocount on

 declare @dmzTime int
 select @dmzTime = dbo.settingsF('site.apiDMZTime', 0)

 declare @wt table(
  id int,
  apiResource varchar(50)
 )

--taxroll
  INSERT @wt
  SELECT id, 'taxroll'
    FROM adtax
    WHERE DATEDIFF(mi, isnull(apiupdated, 0), modified) between @dmzTime and 0

--legal 
  INSERT @wt
  SELECT id, 'legal'  
    FROM adtax 
    WHERE OWNERNAME>'  0' and id > 0 
      AND DATEDIFF(mi, isnull(apiupdatedLegal, 0), modified) between @dmzTime and 0
      
--invoices
  INSERT @wt
  SELECT id, 'invoices' 
    FROM invoices
     WHERE DATEDIFF(mi, isnull(apiupdated, 0), modified) between @dmzTime and 0

--receipts
  INSERT @wt
  SELECT id, 'receipts'
    FROM Object 
    WHERE typ = 4502 
      AND Key3 = 'TAX' 
      AND DATEDIFF(mi, isnull(cast(k7 as datetime), 0), dbo.date112(LastEditDate)) between @dmzTime and 0
      AND a17 in ('void','posted')

--mortgageCodes
  INSERT @wt
  SELECT id, 'mortgageCodes'
    FROM object 
    WHERE typ = 4030
      AND DATEDIFF(mi, isnull(k7,0), dbo.date112(lasteditDate)) between @dmzTime and 0

--mortgageLinks
  INSERT @wt 
  SELECT id, 'mortgageLinks'
    FROM mortgageLinksImported 
    WHERE DATEDIFF(mi, isnull(apiUpdated,0), modified) between @dmzTime and 0
  
 if @method = 'GET'
 begin  

  select
   @class = 'Tax',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = count(*),  
   @message = 'records within the apiDMZTime exist'
  from @wt

  exec dbo.diagnosticsAutoHelper @@procid, @blockAutoFix

  return
 end

 if @method = 'SHOW'
 begin  

  SELECT count(id), apiResource FROM @wt GROUP BY apiResource

  return
 end

 if @method = 'FIX'
 begin  
  
  SELECT * FROM @wt
  
  return  
 end


end


