create view dbo.glDetailReports as

-----MAKE SURE YOU ALSO ALTER TAXROLLAUDITDETAIL WHEN YOU ADD ADDITIONAL COLUMNS TO THIS VIEW. OTHER WISE THE YEAREND REPORTS WILL BE BREAK

select
 a.fpCode,a.fpDesc,
 a.accountCode,
 c.accountDesc,
 amount,
 debit = case when amount > 0.00 then cast(amount as varchar) else '' end,
 credit = case when amount < 0.00 then cast(abs(amount) as varchar) else '' end,
 date,
 slink,
 sourceKey1 = b.key1,
 sourceDate = b.key2, 
 sourceKey3 = b.key3,
 sourceType = cast(b.typ as varchar(15)),
 sourcea1 = b.a1,
 sourcea2 = b.a2,
 sourcea18 = b.a18,
 c.accountType,
 a.contraId,
 a.slink2,
 a.id,
 a.accountId,
 a.sourceCode,
 a.bsId,
 c.auditReportGroup,
 c.reportOrder,
 c.ledgerGroup,
 c.apdistrict,
 c.aprate,
 c.apyear,
 a.[fpid],a.[creationdate],a.[creationtime],a.[comment],a.[comment2],a.dateCleared,
 left(cast(b.e1 as varchar(100)),100) as sourcee1,
 null as invoiceId,
 null as origin,
 sourceD1 = b.d1,
 a.apportionContraCode,
 c.psAccountCode,
 c.chartnumber
from gldetail a with (NOLOCK), object b with (NOLOCK), glaccounts c with (NOLOCK)
where
  a.slink='o'+cast(b.id as varchar)
 and a.accountcode = c.accountcode
 and b.typ > 0

union all

select
 a.fpCode,a.fpDesc,
 a.accountCode,
 c.accountDesc,
 amount,
 debit = case when amount > 0.00 then cast(amount as varchar) else '' end,
 credit = case when amount < 0.00 then cast(abs(amount) as varchar) else '' end,
 date,
 slink,
 sourceKey1 = cast(b.item as varchar),
 sourceDate = cast(b.postdate as varchar(50)), 
 sourceKey3 = b.typ,
 sourceType = 'Invoice',
 sourcea1 = '',
 sourcea2 = '',
 sourcea18 = c.a18,
 c.accountType,
 a.contraId,
 a.slink2,
 a.id,
 a.accountId,
 a.sourceCode,
 a.bsId,
 c.auditReportGroup,
 c.reportOrder,
 c.ledgerGroup,
 c.apdistrict,
 c.aprate,
 c.apyear,
 a.[fpid],a.[creationdate],a.[creationtime],a.[comment],a.[comment2],a.dateCleared,'',
 null as invoiceId,
 b.origin,
 sourceD1 = '',
 a.apportionContraCode,
 c.psAccountCode,
 c.chartnumber
from gldetail a with (NOLOCK), invoices b with (NOLOCK), glaccounts c with (NOLOCK)
where
 a.slink='t'+cast(b.id as varchar)
 and a.accountcode = c.accountcode

union all

select
 a.fpCode,a.fpDesc,
 a.accountCode,
 c.accountDesc,
 amount,
 debit = case when amount > 0.00 then cast(amount as varchar) else '' end,
 credit = case when amount < 0.00 then cast(abs(amount) as varchar) else '' end,
 date,
 slink,
 sourceKey1 = d.key1,
 sourceDate = d.key2, 
 sourceKey3 = d.key3,
 sourceType = cast(d.typ as varchar(15)),
 sourcea1 = d.a1,
 sourcea2 = d.a2,
 sourcea18 = d.a18,
 c.accountType,
 a.contraId,
 a.slink2,
 a.id,
 a.accountId,
 a.sourceCode,
 a.bsId,
 c.auditReportGroup,
 c.reportOrder,
 c.ledgerGroup,
 c.apdistrict,
 c.aprate,
 c.apyear,
 a.[fpid],a.[creationdate],a.[creationtime],a.[comment],a.[comment2],a.dateCleared,
 left(cast(d.e1 as varchar(100)),100) as sourcee1,
 b.invoiceId,
 null as origin,
 sourceD1 = d.d1,
 a.apportionContraCode,
 c.psAccountCode,
 c.chartnumber
from gldetail a with (NOLOCK), receiptLink b with (NOLOCK), object d with (NOLOCK), glaccounts c with (NOLOCK)
where
 a.slink='l'+cast(b.id as varchar)
 and d.id = b.receiptId
 and a.accountcode = c.accountcode
 and d.typ > 0

union all

select
 a.fpCode,a.fpDesc,
 a.accountCode,
 c.accountDesc,
 amount,
 debit = case when amount > 0.00 then cast(amount as varchar) else '' end,
 credit = case when amount < 0.00 then cast(abs(amount) as varchar) else '' end,
 date,
 slink,
 sourceKey1 = d.key1,
 sourceDate = d.key2, 
 sourceKey3 = d.key3,
 sourceType = cast(d.typ as varchar(15)),
 sourcea1 = d.a1,
 sourcea2 = d.a2,
 sourcea18 = d.a18,
 c.accountType,
 a.contraId,
 a.slink2,
 a.id,
 a.accountId,
 a.sourceCode,
 a.bsId,
 c.auditReportGroup,
 c.reportOrder,
 c.ledgerGroup,
 c.apdistrict,
 c.aprate,
 c.apyear,
 a.[fpid],a.[creationdate],a.[creationtime],a.[comment],a.[comment2],a.dateCleared,
 left(cast(d.e1 as varchar(100)),100) as sourcee1,
 b.invoiceId,
 null as origin,
 sourceD1 = d.d1,
 a.apportionContraCode,
 c.psAccountCode,
 c.chartnumber
from gldetail a with (NOLOCK), journalLink b with (NOLOCK), object d with (NOLOCK), glaccounts c with (NOLOCK)
where
 a.slink='j'+cast(b.id as varchar)
 and d.id = b.jeId
 and a.accountcode = c.accountcode
 and d.typ > 0
