create function dbo.receiptList( 
 @beginReceiptNo varchar(50),
        @endReceiptNo varchar(50),
        @beginDate varchar(50),
        @endDate varchar(50)
)

returns @wt table(id int identity(1,1),
                  recType varchar(50),
                  recNum varchar(50),
                  recDate varchar(50),
                  recdate1 varchar(50),
                  postDate varchar(50),
                  postdate1 varchar(50),
                  recFrom varchar(50),
                  paid money default 0,
                  taxYear varchar(50),
                  itemNumber varchar(50),
                  parcelNumber varchar(50),
                  school varchar(50),
                  rate varchar(50), 
                  penalty money default 0, 
                  fee money default 0,
                  perTyp varchar(10),
                  invoiceType varchar(50),
                  taxType varchar(50),
                  invoiceId int,
                  parentInvoiceId int,
                  slink varchar(16),
                  recId int,
                  deputy varchar(50),
                  ownerName varchar(60),
                  SAtyp varchar(50),
                  station varchar(60),
                  recStatus varchar(50),
                  parentInvoiceSlink varchar(15),
                  assessmentCityCode varchar(60),
                  assessmentCityDesc varchar(50))
                  
as 
begin                  

-- here we get all rows from object where typ = 4502 and the receiptType is NOT Tax
 insert @wt (recType,recNum,recDate,recdate1,recFrom,paid,slink,deputy, postdate, postdate1,station,recStatus,recId)
 select recType,recNum,recDate,recdate1,recFrom,paid,'o'+cast(recId as varchar),Deputy, postdate, postdate1, station, recStatus, recId
 from receipt 
 where 
  postDate>=@beginDate and postDate<=@endDate and recStatus in ('Posted','VOID','EXEMPT')
  and recType<>'TAX'

-- dont know for sure but i think this gets all object records that are typ 4502 and receipt Type is tax
 insert @wt (recType,recNum,recDate,recdate1,recFrom,invoiceType,invoiceId,parentInvoiceId,slink,recId,deputy, postdate, postdate1,station,taxyear,recStatus,parentInvoiceSlink)
 select recType,recNum,recDate,recdate1,recFrom,invoiceType,invoiceId,parentInvoiceId,
   'l'+cast(linkId as varchar(15)),recId,Deputy, postdate, postdate1, station, taxyear, recStatus,case when parentInvoiceId>0 then 't'+cast(parentInvoiceId as varchar) else null end
  from taxReceipt where 
   postDate>=@beginDate and postDate<=@endDate and recStatus in ('Posted','VOID','EXEMPT')
   and parentInvoiceId<1
   order by recNum

-- another dip into object for tax receipts i think
 insert @wt (recType,recNum,recdate1,recFrom,invoiceType,invoiceId,parentInvoiceId,slink,recId,deputy,taxyear,recStatus,parentInvoiceSlink)
 select recType,recNum,recdate1,recFrom,invoiceType,invoiceId,parentInvoiceId,
  'l'+cast(linkId as varchar(15)),recId, Deputy,taxyear, recStatus,case when parentInvoiceId>0 then 't'+cast(parentInvoiceId as varchar) else null end
  from taxReceipt where recId in (select recId from @wt)
   and parentInvoiceId>0
   order by recNum

if dbo.settingsf('site.receiptListUseOwnerName','FALSE') = 'TRUE'
  update w
   set recFrom = name
  from @wt w, invoices i
  where i.id = w.invoiceId and w.recType='TAX'


 update w 
 set paid = amount, 
     taxYear = apyear, 
     school = apdistrict, 
     rate = aprate,
     assessmentCityCode = case when invoiceType in ('S','O') then (select top 1 accountCode from dbo.targetFund(b.accountcode) order by apportionPercent desc) else ''  end,
     assessmentCityDesc = case when invoiceType in ('S','O') then (select top 1 accountDesc from dbo.targetFund(b.accountcode) order by apportionPercent desc) else '' end
 from @wt w,gldetail a, glaccounts b 
 where a.accountCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE' 
   and a.slink=w.slink 
   and left(w.recType,3) = 'TAX'
   and parentInvoiceId=0

 update w 
 set taxYear = apyear, 
     school = apdistrict, 
     rate = aprate 
 from @wt w, receiptdetail a, glaccounts b 
 where a.fundCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE' 
   and a.slink=w.parentInvoiceSlink
   and left(w.recType,3) = 'TAX'
   and parentInvoiceId>0

 update w 
 set fee = amount 
 from @wt w,gldetail a, glaccounts b 
 where a.accountCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE' 
   and a.slink=w.slink 
   and parentInvoiceId>0
   and invoiceType not in ('A','P')

 update w 
 set penalty = amount
 from @wt w,gldetail a, glaccounts b 
 where a.accountCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE' 
   and a.slink=w.slink 
   and parentInvoiceId>0
   and invoiceType ='P'

 update w 
 set paid = amount
 from @wt w,gldetail a, glaccounts b 
 where a.accountCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE' 
   and a.slink=w.slink 
   and parentInvoiceId>0
   and invoiceType ='A'

 update w
  set itemNumber = cast(b.ITEMNUMBER as varchar(50)),
      parcelNumber = cast(b.FullPIDNUMBER as varchar(50)),
      ownerName = b.ownername,
      w.perTyp = B.perTyp
 from @wt w, invoices a, adtax b
 where w.invoiceId=a.id 
  and a.taxrollId=b.id
  and invoiceType <> 'S'

 update w
  set taxYear = cast(a.taxyear as varchar(50)),
      itemNumber = cast(a.ITEM as varchar(50)),
      parcelNumber = cast(a.PARCEL as varchar(50)),
      ownerName = a.name,
      perTyp = ''
 from @wt w, invoices a
 where w.invoiceId=a.id 
  and invoiceType = 'S'

 declare @wt2 table(penalty money,
                   fee money,
                   adjust money,
                   parentInvoiceId int,
                   recId int,
                   slink varchar(30))

 declare @wt3 table(fee money,
                   adjust money,
                   parentInvoiceId int,
                   slink varchar(30))

insert @wt2
     select
   sum(isnull(c.penalty,0)),
   sum(isnull(c.fee,0)),
   sum(isnull(c.paid,0)),
   c.parentInvoiceId,
   c.recId,
   ''
  from @wt c
 where c.parentInvoiceId > 0
     group by c.parentInvoiceId, recId

update w set
  paid=isnull(w.paid,0)+isnull(a.adjust,0),   
  penalty=isnull(a.penalty,0), 
  fee=isnull(a.fee,0) 
  from @wt w, @wt2 a
 where a.parentInvoiceId=w.invoiceId 
  and a.parentInvoiceId>0 
  and w.recId=a.recId

delete from @wt2 where parentInvoiceId > 0

--Collect information on Tax Receipts with more than one line of receiptDetail
insert @wt2 (slink,adjust,recId,parentInvoiceId)
     select
           c.slink,
           d.amount,
           c.recId,
           c.invoiceId
  from @wt c, (select a.slink,sum(a.amount) as amount,a.accountCode from gldetail a, glaccounts b 
 where a.accountCode=b.accountCode 
   and b.accountType='ACCRUED RECEIVABLE'
   group by a.slink,a.accountCode) d
 where c.recType='TAX' and c.slink=d.slink and c.slink in 
  (select d.slink from @wt w, gldetail d, glaccounts a 
    where d.slink=w.slink and d.accountCode=a.accountCode and a.accountType='ACCRUED RECEIVABLE' and w.recType='TAX' group by d.slink having count(*)>1)

update w set fee = adjust, adjust=0 from @wt2 w where adjust not in (select top 1 adjust from @wt2 where slink=w.slink order by adjust desc)

insert @wt3 
  select sum(isnull(fee,0)),sum(isnull(adjust,0)),parentInvoiceId,slink from @wt2 group by parentInvoiceId,slink

update w set
  paid=isnull(a.adjust,0),
  fee=isnull(a.fee,0)+isnull(w.fee,0)
  from @wt w, @wt3 a
 where a.parentInvoiceId=w.invoiceId 
  and a.parentInvoiceId>0 
  and a.slink=w.slink

update w set 
  taxYear=case when isnull(w.taxYear,'NULL')='NULL' then d.taxYear else w.taxYear end,
  school=case when isnull(w.school,'NULL')='NULL' then d.school else w.school end,
  rate=case when isnull(w.rate,'NULL')='NULL' then d.rate else w.rate end,
  taxType=case when isnull(w.taxType,'NULL')='NULL' then d.taxType else w.taxType end
 from @wt w, @wt d
  where w.parentinvoiceId<=0
   and d.parentInvoiceId=w.invoiceId
   and w.recId=d.recId 
   and isnull(w.taxYear,'NULL')='NULL'
   and isnull(d.taxYear,'NULL')<>'NULL'
 
update w set
  w.fee = isnull((select sum(amount) from gldetail 
  where slink=w.slink 
   and accountcode in (select a.accountCode from object o,glaccounts a 
   where o.typ=4504 and o.key3=a.targetAccountCode and o.a1='MTG' and o.key1 like '%Fee%')),0)
  from @wt w where w.recType='MTG'

delete from @wt where parentInvoiceId>0

update @wt set
  recType=recType+' '+isnull(taxYear,''),
  taxType = case when invoiceType not in ('B','I','R','P','A') then case when perTyp!='F' then 'Special - '+assessmentCityDesc else 'Fire' end else '' end,
  SAtyp = case when invoiceType not in ('B','I','R','P', 'A')  then case when perTyp!='F' then 'Weed' else 'Fire' end else '' end
where recType='TAX'

update @wt set 
 paid=isnull(paid,0)-isnull(fee,0) 
 where left(recType,3)<>'TAX'

return 
end
