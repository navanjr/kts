Create Function penaltyPercent (
 @invoiceId int,
 @paydate varchar(10)
) returns decimal(21,9) 
as 
begin
 declare @gracesetting varchar(50),
        @grace int,
        @months int,
        @days int,
        @rate int,
        @defaultdate varchar (10),
        @begindate varchar (10),
        @beginday int,
        @enddate varchar (10),
        @typ varchar (1),
        @calcMethod varchar (1),
        @interestpercent decimal (21,9),
        @interestDate int,
        @taxYear varchar(10),
        @applyGraceOnlyInJanuary varchar(5)
        
        
        
 select @typ = [typ], @interestDate = interestDate,@taxYear = taxYear from invoices where id=@invoiceId

 select top 1
  @calcMethod = a19, 
  @gracesetting = a20,
  @rate  = cast(b1 as int)
 from object
 where typ=40

 select @applyGraceOnlyInJanuary = settingvalue from settings where settingname='site.applyGraceOnlyInJanuary'

 select @defaultdate = '12/31/' + @taxYear
 select @begindate = dbo.date1(@interestDate)

 
 if @interestDate > 0 and @defaultdate <> @begindate
 begin
  select @begindate = dbo.date1(@interestDate)
 end
 else 
 begin
   declare @totalDue money, @balanceDue money
  select 
       @totalDue = sum(case when accountType = 'SOURCE' then amount * -1 else 0 end),
       @balanceDue = sum(case when accountType = 'RECEIVABLE' then amount else 0 end)
       from dbo.invoiceGLTotalTF(@invoiceId)
         where status='Posted'   



-- we look to see if a half payment is made  
   if @balanceDue-.01 <= @totalDue/2
   begin
    select @begindate = '03/31/' + cast(@taxYear+1 as varchar)
   end
   else
   begin
    select @begindate = '12/31/' + @taxYear
   end

 end

 if datepart(m,@paydate) = 12
 begin
  select @enddate = case when day(@paydate) <= 16 then @paydate else '01/01/' + cast(year(@paydate) + 1 as varchar) end
 end
 else
 begin
  select @enddate = case when day(@paydate) <= 16 then @paydate else cast(datepart(m,@paydate) + 1 as varchar) + '/01/' + cast(year(@paydate) as varchar) end
 end

 set @days = datediff(d, @begindate, @enddate)

 if isnumeric(@gracesetting)=1
   set @grace = cast(@gracesetting as int)
 else
  begin
   if @applyGraceOnlyInJanuary='TRUE' and datepart(m,@paydate) <> 1
    begin
     set @grace = 0
    end
   else 
    begin
     set @grace = case when isnumeric(left(@gracesetting,2))=1 then cast(left(@gracesetting,2) as int) else 0 end
    end
  end


 set @months = datediff(m, @begindate, @paydate) 

 if dbo.settingsf('site.AssessmentPenaltySameAsAdvalorem','FALSE')='FALSE'
 begin
  if @typ in ('O','S')
   begin
    select @beginday = day(dbo.date1(@interestDate))
    set @months = @months + 1
   end
 end

 if day(@paydate) < case when isnull(@beginday,0) > 0 then @beginday else @grace end
 begin
  set @months = @months - 1
 end

 

 if @calcMethod = 'M'
 begin
  set @interestpercent = @months * @rate / 12.0
 end
 else
 begin
  set @interestpercent = @days * @rate / 365.0
 end 

 if @interestpercent > 100
  set @interestpercent = 100

 if @interestpercent < 0
  set @interestpercent = 0

 return @interestpercent

end
