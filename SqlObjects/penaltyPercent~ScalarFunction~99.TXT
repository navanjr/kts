Create Function penaltyPercent (
 @invoiceId int,
 @paydate varchar(10)
) returns decimal(21,9) 
as 
begin
 declare @grace int,
        @months int,
        @days int,
        @rate int,
        @begindate varchar (10),
        @enddate varchar (10),
        @typ varchar (1),
        @calcMethod varchar (1),
        @interestpercent decimal (21,9)
        
        
 select @typ = [typ] from invoices where id=@invoiceId
 select top 1
  @calcMethod = a19, 
  @grace = cast(a20 as int),
  @rate  = cast(b1 as int)
 from object
 where typ=40

 if @typ in ('P','R','B','I')
 begin
  select @begindate = '12/31/' + cast(taxyear as varchar) from invoices where id = @invoiceId
 end 
 else
 begin
  select @begindate = dbo.date1(postdate) from invoices where id = @invoiceId
 end

 if datepart(m,@paydate) = 12
 begin
  select @enddate = case when day(@paydate) <= 16 then @paydate else '01/01/' + cast(year(@paydate) + 1 as varchar) end
 end
 else
 begin
  select @enddate = case when day(@paydate) <= 16 then @paydate else cast(datepart(m,@paydate) + 1 as varchar) + '/01/' + cast(year(@paydate) as varchar) end
 end

 set @days = datediff(d, @begindate, @enddate)

 set @months = datediff(m, @begindate, @paydate) 
 if day(@paydate) < @grace
 begin
  set @months = @months - 1
 end

 if @calcMethod = 'M'
 begin
  set @interestpercent = @months * @rate / 12.0
 end
 else
 begin
  set @interestpercent = @days * @rate / 365.0
 end 

 if @interestpercent > 100
  set @interestpercent = 100

 return @interestpercent

end
