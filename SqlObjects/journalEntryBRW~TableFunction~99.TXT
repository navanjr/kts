create function dbo.journalEntryBRW(@id int, @showGL int) returns @rt table(
 ord varchar(50),
 id int,
 accountid int,
 accountDesc varchar(50),
 amount money,
 comment varchar(100),
 importFlag int,
 rowType int,
 accountType varchar(60)
)
begin
 declare 
  @slink varchar(15) = 'o'+cast(@id as varchar),
  @importData varchar(max)

 if exists(select * from glDetailStage where slink = @slink)
  insert @rt
  select 'a_' + cast(id as varchar), id*-1 as id, accountId, accountDesc, amount, comment2, 0, case when accountType = 'ACCRUED RECEIVABLE' and isnull(contraId,0)<1 then 1 else 0 end, accountType 
  from glDetailStage where slink in (select slink from journalSlinks(@id) where left(slink,1)<>'t') 
 else
  insert @rt
  select 'a_' + cast(id as varchar), id*-1 as id, accountId, accountDesc, amount, comment2, 0, 0, ''
  from glDetail where slink in (select slink from journalSlinks(@id) where left(slink,1)<>'t') 

-- import features
 select @importData = e2 from object where id = @id and typ = 4512
 if (@importData > '  0')
  begin

	declare @wt table(
		id int identity(1,1),
		rowData varchar(1000),
		accountId int,
		accountCode varchar(50),
		accountDesc varchar(50),
		amount varchar(50),
		comments varchar(250),
                rowType int)
		
	insert @wt (rowData, accountDesc)
	select replace(data,'"',''), 'Unknown Account' from dbo.split( @importData, char(10)) 

	update @wt set
		accountCode = (select data from dbo.split(rowData,',') where id = 1),
		amount = (select data from dbo.split(rowData,',') where id = 2),
		comments = (select data from dbo.split(rowData,',') where id = 3)

	update a set a.accountDesc = b.accountDesc, a.accountId = b.accountId
		from @wt a, glAccounts b where a.accountCode = b.accountCode
 
	if exists(select * from @wt where isnumeric(amount) = 1 and accountDesc <> 'Unknown Account')
		begin
		   insert @rt (ord, id, accountDesc) select 'b_0', 0, '' 
		   insert @rt (ord, id, accountDesc) select 'bb_0', 0, ' These Items can be Imported... '
		   insert @rt select 'bb_' + cast(id as varchar), 0 as id, accountId, accountDesc, amount, comments, 1, 0, '' from @wt where isnumeric(amount) = 1 and accountDesc <> 'Unknown Account'
		end
	if exists(select * from @wt where isnumeric(amount) = 1 and accountDesc = 'Unknown Account')
		begin
		   insert @rt (ord, id, accountDesc) select 'c_0', 0, '' 
		   insert @rt (ord, id, accountDesc) select 'cc_0', 0, ' These Items CAN''T be Imported... '
		   insert @rt select 'cc_' + cast(id as varchar), 0 as id, accountId, accountDesc, amount, comments, 0, 0, '' from @wt where isnumeric(amount) = 1 and accountDesc = 'Unknown Account'
		end
  end

/*if @showGl = 1
  begin

if exists(select * from dbo.journalLink where jeId = @id)
		begin

		declare @taxInvoices table (
			  slink varchar(15),
			  realslink varchar(15),
			  description varchar(50),
			  subDescription varchar(50),
			  subInvoiceId int,
			  ord char(1))

  -- get the taxInvoices
		insert @taxInvoices
			select
				slink,
				realslink,
				description,
				subDescription,
				invoiceId,
				ord
			from invoiceAll where id in (select invoiceId from journalLink where jeid = @id)

		update @taxInvoices set description = (select top 1 description from receiptDetail where slink = realslink) 
			where description = 'sub invoice'

		insert @rt (ord,id,accountDesc,amount)
				select 'ea',0,'',0
		insert @rt (ord,id,accountDesc,amount)
				select 'eb',0,'GL Detail (posted via Tax Invoice)',0

  --Invoice Header
		 insert @rt (ord,id,accountDesc,amount)
			select
				'ec' + slink + ord + min(realslink) + 'a',
				0,
				'   ' + description,
				0
			from @taxInvoices
			group by slink,description,subdescription, ord

  -- invoice GL Detail
		insert @rt (ord,id,accountDesc,amount)
			select
				'ec' + c.slink + c.ord + max(c.realslink) + 'b',
				0,
				left('      '+case when isnull(a.comment2,'')>' 0' then a.comment2 else a.accountDesc end,50),
				sum(a.amount)
			from dbo.glDetail a, glaccounts b, @taxInvoices c
			where a.accountId = b.accountId
			and a.slink = c. realslink
			group by c.slink,a.accountDesc,b.accountType, c.ord, a.comment2 

	end
*/ 

 return
end