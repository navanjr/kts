create function dbo.depositPaidUnPosted() returns @rt table(
 id int identity,
 slink varchar(15),
 objLinkId int,
 receiptType varchar(50),
 paycode varchar(10),
 checkno varchar(50),
 amount money,
 depositId int,
 depositDate int,
 drawnon varchar(50),
 location varchar(50),
 officialDepositId int,
 origin int,
 objectTyp int,
 status varchar(50),
 depositAccountCode varchar(50),
 depositAccountDesc varchar(50)
)
begin


-- get the unposted deposit ids
 declare @depIds table(id int)
 insert @depids select 0
 union 
 select id from object where typ=4513 and a17 != 'Posted'

-- get the posted official deposit ids
 declare @offIds table(id int)
 insert @offids select 0 union select id from object where typ = 4522 and a17 in ( 'Posted', '' )

-- Lets get the records linked to posted receipts and not linked to a posted deposit
-- and  get the paid records linked to official deposits and not linked to a posted deposit
 insert @rt 
 select slink, substring(slink,2,14), o.key3, paycode, checkno, amount, depositId, cast(o.key2 as int), drawnon, location, officialDepositId, 1, o.typ, o.a17,
  coalesce(nullif(official.a4,''),a.accountCode,b.key2),
  coalesce(nullif(official.b3,''),a.accountDesc,b.a18) 
 from paid p with (NOLOCK) 
  left join Object o with (NOLOCK) on o.id = dbo.slinkId(p.slink)
  left join object b with (NOLOCK) on b.typ = 4503 and o.key3 = b.key1 -- lets get the depositAccountCode from the receiptType template
  left join Object d with (NOLOCK) on d.typ = 4513 and p.depositId = d.id  -- lets get the actual depositAccountCode from the deposit
  left join dbo.glAccounts a with (NOLOCK)  on a.accountId = d.link1
  left join Object official with (NOLOCK)  on official.typ = 4601 and official.id = case when o.typ = 4522 then o.link2 else 0 end  -- lets get the actual depositAccountCode from the Official Deposit
 where
  left(p.slink,1) = 'o'
  and o.typ in (4502,4522)
  and o.a17 = 'Posted'
  and isnull(depositId,0) in (select id from @depids)
  and isnull(officialDepositId,0) in (select id from @offids)
  and p.amount <> 0
order by p.id

-- Lets tweak the trust items that are not linked to an official deposit yet
 update @rt set 
  receiptType = 'AAATRUST',
  depositAccountCode = 'AAATRUST',
  depositAccountDesc = '--> Create an Official Deposit for Trust'
 where receiptType = 'TRUST'
  and officialDepositId in (select 0 union select id from object where typ = 4522 and a17 != 'Posted')


 return
end