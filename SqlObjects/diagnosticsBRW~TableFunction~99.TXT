create function dbo.diagnosticsBRW(
 @mode varchar(50),
 @id int
)
 returns @rt table(
  brwid int identity(1,1),
  id int,
  class varchar(50),
  display varchar(max),
  method varchar(50),
  code int,
  tally int,
  message varchar(250),
  timeStamp datetime,
  ord varchar(50),
  colorFlag int,
  menuInt int,
  fixProc varchar(1000)
) as 
begin

 if @mode = 'INSPECT'
 begin
  insert @rt (id, class, method, code, tally, message, timeStamp)
  select
   id,
   class,
   replace(method,'diagFix_',''),
   code,
   tally,
   guideBlob,
   timeStamp
  from dbo.diagnosticResults
  where id = @id
 end

 if @mode in ('HEAVY','LIGHT','conversion')
 begin
  if not isnull(@id,0) > 0
   select @id = max(trialId) from dbo.diagnosticResults where mode = @mode

  insert @rt (id, class, method, code, tally, message, timeStamp, fixProc)
  select
   id,
   class,
   replace(method,'diagFix_',''),
   code,
   tally,
   message,
   timeStamp,
   method
  from dbo.diagnosticResults
  where trialId = @id
  order by testId

  update @rt set 
   menuInt = brwid,
   display = dbo.padRight(' ' + method, ' ',50) + case when tally > 0 then dbo.padLeft(convert(varchar, tally,1), ' ', 12) else '' end,
   ord = 'a' + method

  update @rt set 
   colorFlag = 1 
  where tally > 0

  insert @rt (id, display, ord, class, tally, code, colorFlag)
  select 
   id,
   '   ~ ' + message,
   'a' + method + 'z',
   class,
   tally,
   code,
   1 
  from @rt
  where colorFlag = 1

  insert @rt (display, ord, tally)
  select
   upper(@mode) + ' - ' + cast(max(timeStamp) as varchar) + ' (' + dbo.formatAge(max(timeStamp),getdate()) + ' old)',
   'a',
   1 
  from @rt 
 end

 return
end