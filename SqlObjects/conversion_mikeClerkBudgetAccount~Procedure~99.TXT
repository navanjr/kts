create proc dbo.conversion_mikeClerkBudgetAccount(
 @mode varchar(50) = 'conversion',
 @method varchar(5) = 'GET',
 @class varchar(50) = null output,
 @code int = 0 output,
 @message varchar(100) = null output,
 @tally int = 0 output,
 @fixProc varchar(100) = null output,
 @guide varchar(100) = null output
) as 
begin
 set nocount on

 if @mode != 'conversion'
  return

 declare
  @mikeTableName varchar(50),
  @mikePath varchar(max),
  @sql nvarchar(max),
  @conversionDate varchar(50) = dbo.settingsF('conversion.conversiondate','')

 declare @accounts table(
  fund varchar(50),
  account varchar(50),
  name varchar(50)
 )
 set @mikeTableName = 'APPRACCT'
 select
  @mikePath = dbo.settingsF('conversion.mikepath','') + '\' + @mikeTableName + '.dbf',
  @sql = 'select * from openrowset(''VFPOLEDB'',''' + @mikePath + ''';'''';'''',''SELECT * FROM ' + @mikeTableName + ' where !deleted()'')'

 insert @accounts exec(@sql)


 if @method = 'GET'
 begin  
  select 
   @class = 'conversion',
   @guide = 'GET|SHOW|FIX',
   @code = case when count(*) > 0 then 1 else 0 end,
   @tally = COUNT(*),  
   @message = 'budget accounts not found in KTS'
  from @accounts a
   left join dbo.glAccounts b on a.fund = b.accountCode 
  where a.account not in (select key1 from object where typ = 4705)
   and a.account > '  0' and a.fund > '  0'
 end

 if @method = 'SHOW'
 begin  

  select
   a.account,
   a.name,
   isnull(b.accountCode,''),
   isnull(b.accountDesc,'')
  from @accounts a
   left join dbo.glAccounts b on a.fund = b.accountCode 
  where a.account not in (select key1 from object where typ = 4705)
   and a.account > '  0' and a.fund > '  0'

 end

 if @method = 'FIX'
 begin  

-- create the clerk budget accounts
  insert object (typ,key1,key2,key3,a1)
  select 4705, a.account, a.name, isnull(b.accountCode,''), isnull(b.accountDesc,'')
  from @accounts a
   left join dbo.glAccounts b on a.fund = b.accountCode 
  where a.account not in (select key1 from object where typ = 4705)
   and a.account > '  0' and a.fund > '  0'

  exec dbo.logit @@procid, 'inserted typ 4705 records into object...  @@rowCount', @@rowCount

  return

 end

end


