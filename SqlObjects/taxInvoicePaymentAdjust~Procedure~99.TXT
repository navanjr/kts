create procedure dbo.taxInvoicePaymentAdjust(@invoiceId int, @amount money, @comment varchar(max) = '')
as begin

declare @postDate varchar(20) = dbo.clariondate(getdate()),
        @newJeId int, 
        @newjlinkId int,
        @contraId int,
        @expAccountCode varchar(60),
        @arAccountCode varchar(60),
        @ACRAccountCode varchar(60),
        @SourceAccountCode varchar(60),
        @year varchar(4),
        @district varchar(50),
        @rate varchar(50)

select top 1 @arAccountCode = ac.accountCode,
       @expAccountCode = ac.targetaccountCode+'_EXP',
       @contraId = ISNULL((select a.accountId from glaccounts a where a.accountcode=ac.targetaccountCode),0)
  from gldetail g, glaccounts ac
  where slink='t'+CAST(@invoiceId as varchar) 
   and g.accountcode=ac.accountcode
   and ac.accountcode in (select accountCode from glAccounts where accountType='RECEIVABLE')

select top 1 @SourceAccountCode = accountcode, 
             @ACRAccountCode = accountCode+'_ACR'
  from gldetail 
  where 
   slink='t'+CAST(@invoiceId as varchar)
   and accountcode in (select accountCode from glAccounts where accountType='SOURCE')

if @ACRAccountCode not in (select accountcode from glaccounts where accounttype='ACCRUED RECEIVABLE')
begin
 select @year = apyear,
        @district = apdistrict,
        @rate = aprate
   from glaccounts where accountcode=@SourceAccountCode

 exec dbo.pilotFundReceivableVerification @year, @district, @rate, '' 
end

if @ACRAccountCode not in (select accountcode from glaccounts where accounttype='ACCRUED RECEIVABLE')
 select @ACRAccountCode = a.accountcode from glaccounts a where a.accounttype='ACCRUED RECEIVABLE' 
  and targetaccountcode = (select top 1 accountcode from dbo.targetFundInvoice(@invoiceId) order by apportionpercent desc)


if @ACRAccountCode not in (select accountcode from glaccounts where accounttype='ACCRUED RECEIVABLE')
begin
 select '@code=1;@message=Accrued Receivable does not exist Posting Failed!;'
 return
end
begin transaction
--Insert JE
exec dbo.journalEntryCRUD 0,
  @postdate = @postDate,
  @description='Show Payment Made on MISC Receipt.',
  @jeType='Tax Payment Adjust',
  @comment=@comment,
  @newId=@newJeId output

--Insert journallink
insert journalLink (invoiceId,jeId)
 select @invoiceId, @newJeId

select @newjlinkId = ID from journalLink where invoiceId=@invoiceId and jeId = @newJeId


--Insert gldetailstage linked to journallink
--Check to be sure we can find a receivable account
if isnull((select count(*)
  from glaccounts a, dbo.invoiceTotalARTF(@invoiceId,@amount,0) ar
  where a.accountId = ar.accountId and partialamount <> 0
),0) > 1 
begin
insert gldetailStage (accountId, accountCode, accountDesc,amount,slink)
 select a.accountId, a.accountcode, a.accountdesc, ar.partialamount*-1,'j'+CAST(@newjlinkId as varchar)
  from glaccounts a, dbo.invoiceTotalARTF(@invoiceId,@amount,0) ar
  where a.accountId = ar.accountId and partialamount <> 0
end
else
begin
insert gldetailStage (accountId, accountCode, accountDesc,amount,slink)
 select top 1 a.accountId, a.accountcode, a.accountdesc, @amount*-1,'j'+CAST(@newjlinkId as varchar)
  from glaccounts a, dbo.invoiceTotalARTF(@invoiceId,@amount,0) ar
  where a.accountId = ar.accountId
end


insert gldetailStage (accountId, accountCode, accountDesc,amount,slink)
 select top 1 a.accountId, a.accountcode, a.accountdesc, @amount,'j'+CAST(@newjlinkId as varchar)
  from glAccounts a
  where a.accountCode=@ACRAccountCode
   
--insert gldetailstage linked to JE
insert gldetailStage (accountId, accountCode, accountDesc,amount,slink)
 select top 1 a.accountId, a.accountcode, a.accountdesc, @amount*-1,'o'+CAST(@newJeId as varchar)
  from glAccounts a
  where a.accountCode=@ACRAccountCode
   
insert gldetailStage (accountId, accountCode, accountDesc,amount,slink)
 select top 1 a.accountId, a.accountcode, a.accountdesc, @amount,'o'+CAST(@newJeId as varchar)
  from glAccounts a
  where a.accountCode=@expAccountCode
   
exec glPost @newJeId, 'o'


 if exists(select * from object where id=@newJeId and a17='Posted')
  begin
   commit transaction
  end
 else
  begin
   rollback transaction 
  end

exec invoiceUpdate @invoiceId

end