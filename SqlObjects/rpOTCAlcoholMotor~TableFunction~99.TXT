create function dbo.rpOTCAlcoholMotor(@begindate varchar(20),@enddate varchar(20)) 
returns @rt table(
  accountId int,
  accountCode varchar(60),
  accountDesc varchar(60),
  alcoholAmount money,
  motorVehicleAmount money,
  journalType varchar(60),
  MonthDistributed varchar(60),
  MonthApportioned varchar(60),
  schooldistrict varchar(60),
  schoolname varchar(60),
  accounttype varchar(50)
)
as
begin

declare @det table(
    id int identity(1,1),
	[accountType] [varchar](50) NOT NULL default '',
	[accountId] [int] NOT NULL default 0,
	[accountCode] [varchar](60) NOT NULL default '',
	[accountDesc] [varchar](50) NOT NULL default '',
	[comment] [varchar](50) NOT NULL default '',
	[comment2] [varchar](50) NOT NULL default '',
	[sourceCode] [varchar](60) NOT NULL default '',
	[amount] [money] NOT NULL default 0,
	[journalType] [varchar](50) NOT NULL default '',
	[sourceDesc] [varchar](50) NOT NULL default '',
	[sourceSECA] [varchar](50) NOT NULL default '',
	[journalDesc] [varchar](50) NOT NULL default ''
)

insert @det
select isnull(accountType,''),
	isnull(accountId,0),
	isnull(accountCode,''),
	isnull(accountDesc,''),
	isnull((select code from glaccounts where accountcode=sourceCode),''),
	isnull(comment2,''),
	isnull(sourceCode,''),
	isnull(amount,0),
	isnull(journalType,''),
	isnull(sourceDesc,''),
	isnull(sourceSECA,''),
	isnull(journalDesc,'') from rpMonthEndDetail(@beginDate,@endDate, 'FALSE') 
 where isnull(sourceCode,'Not Found') in (select accountCode from glAccounts where code in ('MOTORCITY','BEVERAGE'))
  and accountType = 'CITY'
  and left(journalType,13) = 'APPORTIONMENT'


insert @rt 
select accountid,accountcode,accountdesc,
  sum(case when comment='BEVERAGE' then amount*-1 else 0 end),
  sum(case when comment='MOTORCITY' then amount*-1 else 0 end),
  journaltype, 
 case when right(journalType,7)='SPECIAL' then upper(datename(M,dbo.date1(@enddate))) 
         else upper(datename(M,dbo.date1(@enddate+20))) end+' - '+
 case when right(journalType,7)='SPECIAL' then cast(year(dbo.date1(@enddate)) as varchar) 
         else cast(year(dbo.date1(@enddate+20)) as varchar) end,
         upper(datename(M,dbo.date1(@enddate)))+' - '+cast(year(dbo.date1(@enddate)) as varchar),
 case when len(isnull((select max(a1) from object where typ=4010 and key2=accountcode),''))>0 then isnull((select max(a1) from object where typ=4010 and key2=accountcode),'') else accountcode end,
 case when len(isnull((select max(a2) from object where typ=4010 and key2=accountcode),''))>0 then isnull((select max(a2) from object where typ=4010 and key2=accountcode),'') else accountdesc end,
 accounttype
 from @det 
  group by accountid,accountcode,accountdesc,journaltype,accounttype
  


 delete from @rt where alcoholAmount= 0 and  motorVehicleAmount=0.00

  return
end