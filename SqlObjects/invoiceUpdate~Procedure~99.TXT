create procedure dbo.invoiceUpdate(@invoiceId int) as
-- this proc is used by post routines to keep invoice sub totals accurate
begin

 if exists(select * from invoices where id = @invoiceId)
 begin
  declare 
   @amount money = 0,
   @due money = 0,
   @subDue money = 0

  select 
   @amount = sum(case when accountType = 'SOURCE' then amount * -1 else 0 end),
   @due = sum(case when accountType = 'RECEIVABLE' then amount else 0 end)
  from dbo.invoiceTotalTF(@invoiceId)

  select @subDue = sum(dbo.invoiceTotalAR(id)) 
  from invoices where invoiceId = @invoiceId
   
  update invoices set
   invoiceAmount = isnull(@amount,0),
   invoiceDue = isnull(@due,0),
   subInvoiceDue = isnull(@subDue,0)
  where id = @invoiceId
 end

 return

end

