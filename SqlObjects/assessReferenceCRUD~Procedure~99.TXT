create procedure [dbo].[assessReferenceCRUD](
 @assessmentId int,
 @newId int = null output,
 @newAdtaxId int = null output
) as
begin
 declare @existingInvoiceId int,
         @invoiceId int,
         @adtaxId int

 select @adtaxId = id from adtax where id=@assessmentId and [RECORDTYPE]='S'
 select @invoiceId = id from invoices where taxrollId=@assessmentId and [TYP]='S'

 -- insert adtax record
 if isnull(@adtaxId,0) = 0
  begin
   insert adtax (
[FULLPIDNUMBER],
[ITEMNUMBER],
[RECORDTYPE],
[OWNERNAME],
[ADDRESS1],
[ADDRESS2],
[ADDRESS3],
[CITY],
[STATE],
[ZIP1],
[REALTAXYEAR],
[ORGSCHOOLDISTRICTMAIN],
[SCHOOLDISTRICTMAIN],
[ORGSCHOOLDISTRICTTAXRATE],
[SCHOOLDISTRICTTAXRATE],
[ORIGINALTOTALDUE],
[TOTALDUE],
[LEGALDESCRIPTION],
origin,
[ADDITIONNUMBER],
[TOWNSHIPBLOCK],
[RANGELOT],
[SECTIONNUMBER],
[QTRSECTIONNUMBER],
[PARCELNUMBER],
[PROPERTYSPLIT],
[PIDSORTNUMBER],
[BUSINESSNAME],
[ZIP2],
[ZIP3],
[COUNTRY],
[FIREDISTRICT],
[MORTGAGECODE],
[OWNERNUMBER],
[ACRES],
[LOTS],
[MFGHOMEASSESSED],
[GROSSASSESSED],
[FREEPORTEXEMPTION],
[BASEEXEMPTION],
[DBLEXEMPTION],
[EXEMPTION1],
[EXEMPTION2],
[EXEMPTION3],
[NETASSESSEDVALUE],
[TOTALTAXRATE],
[BALANCEDUE],
[CERTIFICATENUMBER],
[PAIDOFFDATE],
[PROPERTYLIENCODE1],
[PROPERTYLIENAMOUNT1],
[PROPERTYLIENCODE2],
[PROPERTYLIENAMOUNT2],
[LASTTRANDATE],
[TAXCORRECTIONDATE],
[TAXCORRECTIONINITIALS],
[FLAG1],
[FLAG2],
[FLAG3]
)
    select key1 as [FULLPIDNUMBER], 
           case when isnumeric(key3)=1 and key3 not like '%*%'  then cast(key3 as numeric(7,1)) else 0.0 end as [ITEMNUMBER],
           'S' as [RECORDTYPE], 
           a1 as [OWNERNAME], 
           a2 as [ADDRESS1], 
           a3 as [ADDRESS2], 
           a4 as [ADDRESS3], 
           a5 as [CITY], 
           a6 as [STATE], 
           a7 as [ZIP1], 
           case when isnumeric(a18)=1 and a18 not like '%*%' then cast(a18 as numeric(5,0)) else 0 end as [REALTAXYEAR], 
           a19 as [ORGSCHOOLDISTRICTMAIN],
           a19 as [SCHOOLDISTRICTMAIN],
           a20 as [ORGSCHOOLDISTRICTTAXRATE],  
           a20 as [SCHOOLDISTRICTTAXRATE],
           case when isnumeric(b1)=1 and b1 not like '%*%'  then cast(b1 as numeric(11,2)) else 0.0 end as [ORIGINALTOTALDUE], 
           case when isnumeric(b1)=1 and b1 not like '%*%'  then cast(b1 as numeric(11,2)) else 0.0 end as [TOTALDUE], 
           e1 as [LEGALDESCRIPTION],
           'assessment' as origin,
           '' as [ADDITIONNUMBER],
           '' as [TOWNSHIPBLOCK],
           '' as [RANGELOT],
           '' as [SECTIONNUMBER],
           '' as [QTRSECTIONNUMBER],
           '' as [PARCELNUMBER],
           '' as [PROPERTYSPLIT],
           '' as [PIDSORTNUMBER],
           '' as [BUSINESSNAME],
           '' as [ZIP2],
           '' as [ZIP3],
           '' as [COUNTRY],
           '' as [FIREDISTRICT],
           0 as [MORTGAGECODE],
           0 as [OWNERNUMBER],
           0 as [ACRES],
           0 as [LOTS],
           0 as [MFGHOMEASSESSED],
           0 as [GROSSASSESSED],
           0 as [FREEPORTEXEMPTION],
           0 as [BASEEXEMPTION],
           0 as [DBLEXEMPTION],
           0 as [EXEMPTION1],
           0 as [EXEMPTION2],
           0 as [EXEMPTION3],
           0 as [NETASSESSEDVALUE],
           0 as [TOTALTAXRATE],
           0 as [BALANCEDUE],
           '' as [CERTIFICATENUMBER],
           0 as [PAIDOFFDATE],
           '' as [PROPERTYLIENCODE1],
           0 as [PROPERTYLIENAMOUNT1],
           '' as [PROPERTYLIENCODE2],
           0 as [PROPERTYLIENAMOUNT2],
           0 as [LASTTRANDATE],
           0 as [TAXCORRECTIONDATE],
           '' as [TAXCORRECTIONINITIALS],
           '' as [FLAG1],
           '' as [FLAG2],
           '' as [FLAG3]

    from object where id = @assessmentId

   set @newAdtaxId = @@identity

   exec dbo.logit @@procId, 'inserted into adtax typ = S.... @newAdtaxId', @newAdtaxId
 end
else 
 begin
  set @newAdtaxId = @adtaxId
 end

 -- insert tax reference invoice
 if isnull(@invoiceId,0) = 0
  begin
   insert invoices ([TAXROLLID],[TYP],[PARCEL],[ITEM],[TAXYEAR],[NAME],[BUSINESSNAME],[POSTDATE],[STATUS],[interestDate])        select
     case when isnull(@newAdtaxId,0) > 0 then @newAdtaxId else [ID] end,
     'S',
     key1,
     cast(key3 as numeric(7,1)),
     cast(a18 as numeric (5)),
     a1,
     '',
     key2,
     a17,
     case when isnumeric(b3)=1 then cast(b3 as int)-1 else 0 end
    from object where id = @assessmentId

   set @newId = @@identity

   exec dbo.logit @@procId, 'inserted into object.... @newId', @newId
  end
 else
  begin
   if isnull(@newAdtaxId,0) > 0
   begin
    update invoices set taxrollid = @newAdtaxId where id = @invoiceId
   end
   else
   begin
    if not exists(select * from object where id = @assessmentId)
    begin
     update invoices set taxrollid = 0 where id = @invoiceId
    end
   end
  end

end