create function [dbo].[getTaxInvoiceBlob](@InvId int) returns varchar(max) as
begin

 declare @retval varchar(max), @invoiceType varchar(1), @invoiceDue money
 
  select 
  
  @retval =  '@taxrollid=' + rtrim(max(TAXROLLID)) + ';'
  + '@TYP=' + rtrim(max(case when invoiceId>0 then '' else TYP end)) + ';'
  + '@PARCEL=' + rtrim(max(PARCEL)) + ';'
  + '@ITEM=' + rtrim(max(case when invoiceId>0 then 0.0 else ITEM end)) + ';'
  + '@TAXYEAR=' + rtrim(max(TAXYEAR)) + ';'
  + '@POSTDATE=' + rtrim(max(case when invoiceId>0 then '' else POSTDATE end)) + ';'
  + '@STATUS=' + rtrim(max(case when invoiceId>0 then '' else [STATUS] end)) + ';'
  + '@INVOICEAMT=' + rtrim(sum(case when typ in ('P','F') then 0 else invoiceAmount end)) + ';'
  + '@PENALTY=' + rtrim(sum(case when typ='P' then invoiceAmount else 0 end)) + ';'
  + '@FEE=' + rtrim(sum(case when typ in ('F','A') then invoiceAmount else 0 end)) + ';'
  + '@CURRENTDUE=' + rtrim(sum(invoiceDue)) + ';'
  + '@QUEUE=' + rtrim(max(queue)) + ';',
  @invoiceType = rtrim(max(case when invoiceId>0 then '' else TYP end)) 
  from invoices where (ID=@InvId or invoiceId=@InvId) 
  group by case when invoiceId>0 then invoiceId else ID end

 
 select top 1 @retval = @retval + dbo.taxRollAddressBlob(dbo.readstring('@TAXYEAR=',@retval),dbo.readstring('@Item=',@retval))
	

if @invoiceType<>'S'
begin
select @retval = @retval
 
 + '@GROSSASSESSED=' + rtrim(GROSSASSESSED) + ';'
 + '@EXEMPTION3=' + rtrim(EXEMPTION3) + ';'
 + '@NETASSESSEDVALUE=' + rtrim(NETASSESSEDVALUE) + ';'
 + '@SCHOOLDISTRICTMAIN=' + rtrim(SCHOOLDISTRICTMAIN) + ';'
 + '@SCHOOLDISTRICTTAXRATE=' + rtrim(SCHOOLDISTRICTTAXRATE) + ';'
 + '@ACRES=' + rtrim(ACRES) + ';'
 + '@TWP=' + rtrim(TOWNSHIPBLOCK) + ';'
 + '@SEC=' + rtrim(SECTIONNUMBER) + ';'
 + '@RNG=' + rtrim(RANGELOT) + ';'
 + '@TOTALDUE=' + rtrim(TOTALDUE) + ';'
 + '@LEGALDESCRIPTION=' + rtrim(replace(cast(LEGALDESCRIPTION as varchar(4000)),'''','`')) + ';'
 + dbo.readStringSanitizer('ORGSCHOOLDISTRICTMAIN', ORGSCHOOLDISTRICTMAIN)
 + dbo.readStringSanitizer('ORGSCHOOLDISTRICTTAXRATE', ORGSCHOOLDISTRICTTAXRATE)
 + dbo.readStringSanitizer('MFGHOMEASSESSED', MFGHOMEASSESSED)+';'
 + '@MortgageCode=' + rtrim(case when cast(treamort as varchar) > '  0' then cast(treamort as varchar) else cast(mortgagecode as varchar)
 end) + ';'
+ '@OwnerNumber=' + cast(OwnerNumber as varchar(50)) + ';'
 from AdTax where ID = dbo.readstring('@taxrollid=',@retval)
end

select @retval = @retval
 + '@HideMrtgMsg=' + c2 + ';'
 from object where typ=4030 and key1=dbo.readstring('@MortgageCode=',@retval)

 return @retval

end

--select dbo.getTaxInvoiceBlob(433)
