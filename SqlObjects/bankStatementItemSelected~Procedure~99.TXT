create procedure dbo.bankStatementItemSelected(
 @id int,
 @bsId int,
 @idsBlob varchar(max) = null,
 @clearedDate int = null
) as
begin

 declare
  @accountId int,
  @tokenId int,
  @bsDate1 int,
  @bsDate2 int,
  @amiLinked varchar(5) = 'FALSE'

 select
  @accountId = link1,
  @bsDate1 = a1,
  @bsDate2 = a2
 from object
 where id = @bsId


 if exists (select * from dbo.glDetail where id = @id and isnull(bsId,0) > 0)
  set @amiLinked = 'TRUE'
 
 set @clearedDate = coalesce(@clearedDate, dbo.clariondate(getdate()))

 exec dbo.logit @@procid, '@id', @id, '@bsid', @bsid, '@clearedDate', @clearedDate, '@amiLinked', @amiLinked
 exec dbo.logit @@procid, '@accountId', @accountId, '@bsDate1', @bsDate1, '@bsDate2', @bsDate2

 if @amiLinked = 'FALSE'
 begin
-- ok lets check to see what bank statements need to get this link
  if not @clearedDate between @bsDate1 and @bsDate2
  begin
   exec dbo.logit @@procid, 'we will have to attach this to another bank statement. this one wont do.'
   set @bsId = null
   select @bsId = id from object where typ = 4780 and link1 = @accountId and @clearedDate between a1 and a2
   if not isnull(@bsId,0) > 0
   begin
    exec dbo.logit @@procid, 'Failed to locate a bank statement, I will have to create a new one...'
    exec dbo.bankStatementCRUD @clearedDate, @accountId, @newBSId = @bsId output
    select '@code=1;@message=This item was cleared to a new bank statement;'
   end
   else 
   begin
    exec dbo.logit @@procid, 'ok we found one... @bsid', @bsid
    select '@code=1;@message=This item was cleared to another bank statement;'
   end
  end
 end

 if @id is null
  declare ids cursor for select data from dbo.split(@idsBlob,'|')
 else
  declare ids cursor for select @id

 open ids
 fetch next from ids into @tokenId
 while @@FETCH_STATUS = 0
 begin

-- if the item is already linked to THIS bank statement then unlink it
  if exists(select * from dbo.glDetail where id = @tokenId and accountId = @accountId and bsId = @bsId)
  begin
   update dbo.glDetail set bsId = Null, dateCleared = '' where id = @tokenId and accountId = @accountId and bsId = @bsId
  end
  else
  begin
-- link the item to the BankStatement only if it is not linked already
   if exists(select * from dbo.glDetail where id = @tokenId and accountId = @accountId and isnull(bsId,0) = 0)
    update dbo.glDetail set bsId = @bsId, dateCleared = @clearedDate where accountId = @accountId and id = @tokenId
  end

  fetch next from ids into @tokenId
 end
 close ids
 deallocate ids

 return
end