create function dbo.taxYearPrintBRW( @taxYear varchar(50) ) returns @rt table(
 brwid int identity(-1,-1),
 ord varchar(50),
 code varchar(50),
 theRealMortCode varchar(50),
 tally int,
 tallyPrinted int,
 blob varchar(max)
) as 
begin

 declare @tally int

-- invoices processing
 if exists(select * from taxrollInvoiceProcessing where taxyear = @taxyear)
 begin
  insert @rt (ord,code) select '9a', '--Invoice Batches--'
  insert @rt (ord,code,tally,blob)
   select '9b', '   ' + processCode, count(*), '@mode=invoice;@code=' + processCode + ';' from taxrollInvoiceProcessing where taxyear = @taxyear group by processCode
  insert @rt (ord) select '9c'
 end

-- un-invoiced
 if exists(select * from adtax where realtaxyear = @taxyear and id not in (select taxrollid from invoices))
 begin
  insert @rt (ord,code) select 'a0 ','Un-Invoiced'
  insert @rt 
   select 'a0'+recordType,'   Type: ' + recordType,'',count(*),0, '' from adtax where realtaxyear = @taxyear and id not in (select taxrollid from invoices) 
   group by recordType

  insert @rt 
   select 'a1','      Total','',count(*),0, '' from adtax where realtaxyear = @taxyear and id not in (select taxrollid from invoices)
 end

-- all invoices
 insert @rt (ord,code) select 'aa1 ',''
 insert @rt 
  select 'aa2','Total Invoiced','',count(*),sum(case when printed > '  0' then 1 else 0 end), '@mode=batch;@scope=all;' from invoices where taxyear = @taxyear
 -- Zero Balance Issue
 select @tally = count(*) from invoices where taxyear = @taxyear and invoiceDue = 0
 if @tally > 0
  insert @rt (ord,code,tally,blob) select 'ab','   Zero Balance Issue', @tally,'@mode=pass;@code=exec dbo.invoiceUpdate @taxyear=' + @taxyear + ';'
 -- no GL Detail Issue
 select @tally = count(*) from invoices where 't'+cast(id as varchar) not in (select slink from gldetail)
 if @tally > 0
  insert @rt (ord,code,tally,blob)
   select 'ac','   Invoice(s) without glDetail', @tally,'@mode=pass;@code=exec dbo.invoiceCRUD @mode=3, @taxyear=' + @taxyear + ', @noGLDetailIssue=''TRUE'';'

-- mortgage codes
 insert @rt (ord) select 'ba'
 insert @rt (ord,code) select 'bb', '--Mortgage Codes--'

 insert @rt 
 select
  'bb', '   ' + mortgageCode,max(theRealMortCode),count(*),sum(case when printed > '  0' then 1 else 0 end), '@mode=batch;@scope=mortgage;@code=' + theRealMortCode + ';'
 from taxYearPrintMortCodeView
 where taxyear = @taxyear
 group by mortgageCode,brwid,theRealMortCode

-- Batches
 insert @rt (ord) select 'ca'
 insert @rt (ord,code) select 'cb', '--Print Batches--'

 insert @rt (ord,code,tally,tallyPrinted,blob)
 select
  'cc', '   ' + queue, count(*),
  sum(case when isnull(printed,'') in ('Failed','') then 0 else 1 end),
  '@mode=queue;@code=' + queue + ';@unPrinted=' + cast(sum(case when isnull(printed,'') in ('Failed','') then 1 else 0 end) as varchar) + ';'
 from invoices where queue > '  0' and taxyear = @taxYear group by queue

 insert @rt (ord) select 'cd'

 insert @rt (ord,code,tally,tallyPrinted)
 select
  'ce', '', count(*), sum(case when isnull(printed,'') in ('Failed','') then 0 else 1 end)
 from invoices where queue > '  0' and taxyear = @taxYear

 return
end