create function dbo.taxYearPrintBRW( @taxYear varchar(50) ) returns @rt table(
 brwid int identity(-1,-1),
 ord varchar(50),
 code varchar(50),
 theRealMortCode varchar(50),
 tally int,
 tallyPrinted int,
 blob varchar(max)
) as 
begin

-- invoices processing
 if exists(select * from taxrollInvoiceProcessing where taxyear = @taxyear)
 begin
  insert @rt (ord,code) select '9a', '--Invoice Batches--'
  insert @rt (ord,code,tally,blob)
   select '9b', '   ' + processCode, count(*), '@mode=invoice;@code=' + processCode + ';' from taxrollInvoiceProcessing where taxyear = @taxyear group by processCode
  insert @rt (ord) select '9c'
 end

-- all invoices
 insert @rt 
  select 'aa','Total Invoices','',count(*),sum(case when printed > '  0' then 1 else 0 end), '@mode=batch;@scope=all;' from invoices where taxyear = @taxyear
 insert @rt (ord,code,tally,blob) 
  select 'ab','   Zero Balance Issue', count(*),'@mode=pass;@code=exec dbo.invoiceUpdate @taxyear=' + @taxyear + ';' from invoices where taxyear = @taxyear and invoiceDue = 0
 insert @rt (ord,code,tally,blob) 
  select 'ac','   Invoice(s) without glDetail', count(*),'' from invoices where 't'+cast(id as varchar) not in (select slink from gldetail)

-- mortgage codes
 insert @rt (ord) select 'ba'
 insert @rt (ord,code) select 'bb', '--Mortgage Codes--'

 insert @rt 
 select
  'bb', '   ' + mortgageCode,max(theRealMortCode),count(*),sum(case when printed > '  0' then 1 else 0 end), '@mode=batch;@scope=mortgage;@code=' + theRealMortCode + ';'
 from taxYearPrintMortCodeView
 where taxyear = @taxyear
 group by mortgageCode,brwid,theRealMortCode

-- Batches
 insert @rt (ord) select 'ca'
 insert @rt (ord,code) select 'cb', '--Print Batches--'

 insert @rt (ord,code,tally,tallyPrinted,blob)
 select
  'cc', '   ' + queue, count(*),
  sum(case when isnull(printed,'') in ('Failed','') then 0 else 1 end),
  '@mode=queue;@code=' + queue + ';@unPrinted=' + cast(sum(case when isnull(printed,'') in ('Failed','') then 1 else 0 end) as varchar) + ';'
 from invoices where queue > '  0' and taxyear = @taxYear group by queue

 insert @rt (ord) select 'cd'

 insert @rt (ord,code,tally,tallyPrinted)
 select
  'ce', '', count(*), sum(case when isnull(printed,'') in ('Failed','') then 0 else 1 end)
 from invoices where queue > '  0' and taxyear = @taxYear

 return
end