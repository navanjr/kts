create function dbo.apiControlBRW() returns @rt table(
 id int identity(-1,-1),
 resource varchar(50),
 total int,
 stale int,
 rate money,
 blob varchar(1000),
 jobEnabled int,
 ord varchar(50)
) as
begin
 
 declare @apiControlString varchar(500)
 declare @apiControl table( resource varchar(50), batchSize int ) 
 select top 1 @apiControlString = b14 from object where typ = 40 order by id    
 insert @apiControl select dbo.splitF(data,':',1), dbo.splitF(data,':',2) from dbo.split(@apiControlString,',') 

--taxrolls
 insert @rt
 select 'taxroll',
  count(*),
  sum(case when modified > isnull(apiUpdated,0) then 1 else 0 end),
  null,
  '@resource=taxrolls;',
  null,
  'a' 
 from adtax

--legal
 insert @rt
 select 'legal',
  count(*),
  sum(case when modified > isnull(apiUpdatedLegal,0) then 1 else 0 end),
  null,
  '@resource=legal;',
  null,
  'b' 
 from adtax
 where ltrim(cast(legalDescription as varchar(max))) > '  0'

--invoices
 insert @rt
 select 'invoices',
  count(*),
  sum(case when modified > isnull(apiUpdated,0) then 1 else 0 end),
  null,
  '@resource=invoices;',
  null,
  'c'
 from invoices

--receipts
 insert @rt
 select 'receipts',
  count(id),
  sum(case when dbo.date112(lasteditDate) > isnull(k7,0) then 1 else 0 end),
  null,
  '@resource=receipts;',
  null,
  'd'
 from object where typ=4502 and key3='TAX' and a17 = 'posted'

--mortgageCodes
 insert @rt
 select 'mortgagecodes',
  count(id),
  sum(case when dbo.date112(lasteditDate) > isnull(k7,0) then 1 else 0 end),
  null,
  '@resource=mortgagecodes;',
  null,
  'e'
 from object where typ=4030


 update @rt set rate = ( (total - cast(stale as money))  / total ) * 100.0
 update @rt set blob = blob + '@batchSize=' + cast(batchSize as varchar) + ';' from @rt a, @apiControl b where a.resource = b.resource

 update r set r.jobEnabled = j.enabled from @rt r, msdb..sysjobs j where 'apiJob_' + r.resource = j.name 

 return
end