create function dbo.apiControlBRW() returns @rt table(
 id int identity(-1,-1),
 resource varchar(50),
 total int,
 stale int,
 rate money,
 blob varchar(1000),
 jobEnabled int,
 ord varchar(50)
) as
begin
 
 declare @apiControlString varchar(500)
 declare @apiControl table( resource varchar(50), batchSize int ) 
 select top 1 @apiControlString = b14 from object where typ = 40 order by id    
 insert @apiControl select dbo.splitF(data,':',1), dbo.splitF(data,':',2) from dbo.split(@apiControlString,',') 
 declare @receipts table(total int, stale int)

--taxrolls
 insert @rt
 select 'taxroll',
  count(*),
  sum(case when modified > isnull(apiUpdated,0) then 1 else 0 end),
  null,
  '@resource=taxrolls;',
  null,
  'a' 
 from adtax

--legal
 insert @rt
 select 'legal',
  count(*),
  sum(case when modified > isnull(apiUpdatedLegal,0) then 1 else 0 end),
  null,
  '@resource=legal;',
  null,
  'b' 
 from adtax
 where ltrim(cast(legalDescription as varchar(max))) > '  0'

--invoices
 insert @rt
 select 'invoices',
  (select count(*) from invoices)
  + (select count(distinct slink) from apiDeleted where apiResource = 'invoices'),
  count(*),
  null,
  '@resource=invoices;',
  null,
  'c'
 from dbo.apiInvoiceIds()

--receipts
 insert @receipts
  select 
   (select COUNT(*) from object where typ=4502 and key3='TAX' and a17 = 'posted')
   + (select COUNT(distinct slink) from dbo.apiDeleted where apiResource = 'receipts'),
   count(distinct slink)
  from dbo.apiReceiptIds()

 insert @rt
 select 'receipts',
  sum(total),
  sum(stale),
  null,
  '@resource=receipts;',
  null,
  'd'
 from @receipts

--mortgageCodes
 insert @rt
 select 'mortgagecodes',
  count(id),
  sum(case when dbo.date112(lasteditDate) > isnull(k7,0) then 1 else 0 end),
  null,
  '@resource=mortgagecodes;',
  null,
  'e'
 from object where typ=4030


 update @rt set rate = ( (total - cast(stale as money))  / total ) * 100.0
 update @rt set blob = blob + '@batchSize=' + cast(batchSize as varchar) + ';' from @rt a, @apiControl b where a.resource = b.resource

 update @rt set jobEnabled = 1 where 'kp.' + db_name() + '.api' + resource in (select name from scheduledTasks where status = 'ready')

 return
end