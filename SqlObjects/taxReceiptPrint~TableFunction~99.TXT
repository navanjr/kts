create function [dbo].[taxReceiptPrint](@recId varchar(50)) returns   
          @rt table(
			recId varchar(50),
			InvoiceId int,
			taxRollid int,
			typ varchar(10),
			parcel varchar(50),
			item varchar(50),
			taxyear varchar(50),
			receiptNo varchar(20),
			receiptDate varchar(20),
			schoolDistrict varchar(50),
			legal varchar(max),
			acres varchar(10),
			blk varchar(10),
			sec varchar(10),
			twp varchar(10),
			rng varchar(10),
			recOf varchar(max),
			paidBy varchar(100),
			TaxAmt money,
			TaxDue money,
			TaxPaid money,
			TotPaid money,
			Penalty  money,
			mail  money,
			lien  money,
			adv  money,
			mowing  money,
			other  money,
			ckoth  money,
			cash  money,
			change  money,
			blob varchar(max),
                        deputy varchar(50),
                        invoiceLink int,
                        checkno varchar(50) ,
                        GrandTotal money,
                        Comments varchar(250),
                        recCount int default 0 )             

as 
begin

	insert @rt (recId,invoiceId,taxRollid,parcel,item,taxyear,paidBy,TaxAmt,TaxDue,taxPaid,Penalty,mail,lien,adv,mowing,other,typ)
					select  @recId, 
					case when invoiceId>0 then invoiceId else ID end,
					max(i.TAXROLLID),
					max(i.PARCEL),
					max(i.ITEM),
					i.TAXYEAR,
					max(i.NAME),
					sum(case when i.invoiceId=0 then i.invoiceAmount else 0 end),
					sum(case when i.invoiceId=0 then i.invoiceAmount else 0 end),
                                        0,
                                        sum(case when i.invoiceId>0 and i.TYP='P' then i.invoiceamount else 0 end),
					0,
					0,
					0,
					0,
					sum(case when i.invoiceId>0 and i.TYP<>'P' then i.invoiceamount else 0 end),
                                        max(case when invoiceId>0 then '' else typ end)
                                       
					
					 from dbo.receiptSLinks(@recId),invoices i where LEFT(slink,1)='t' and right(slink,LEN(slink)-1)=i.id 
					  group by case when invoiceId>0 then invoiceId else ID end,i.TAXYEAR
	
	update @rt set 
                                receiptDate = Key2,
                                paidBy = case when a1>'  0' then a1 else paidBy end,
                                deputy = a18,
                                grandTotal = cast(c9 as money),
                                comments = d1
                         from Object where ID = @recid

        update r set 
                                receiptNo = a.receiptNumber 
                         from receiptlink a,@rt r where r.invoiceId = a.invoiceId and r.recId = a.receiptId and r.recId = @recId

	update r set 
				r.schoolDistrict = a.SCHOOLDISTRICTMAIN,
				r.legal = cast(a.LEGALDESCRIPTION as varchar(max))+CHAR(13)+CHAR(10)+A.SCHOOLDISTRICTMAIN,
				r.acres = a.ACRES,			
				r.blk = a.TOWNSHIPBLOCK,
				r.sec = a. SECTIONNUMBER,
				r.twp = '',
				r.rng = a.RANGELOT
				
			from @rt r, AdTax a where r.taxRollid = a.ID
				
						

	update @rt set
			taxPaid = dbo.taxReceiptTaxPaid(recid,invoiceId),TotPaid = dbo.taxReceiptTaxPaid(recid,invoiceId) + Penalty + mail + lien + adv + mowing + other

--Update Paid
 

	declare @paidBlob varchar(max) 
			select @paidBlob = isnull(@paidBlob,'') 
                                           + '@'+case when paycode='Cash' then paycode else 'Check' end+'='+cast(SUM(case when checkno='Cash Returned' then 0 else amount end) as varchar)+';'
                                           + '@checkno=  '+case when count(id)>1 then cast(count(id) as varchar(10))+' Chks' else max(checkno) end+';'
                                           + '@change=  '+cast(SUM(case when checkno='CASH RETURNED' then amount else 0 end) as varchar)+';'

		                      from paid where slink = 'o'+@recid 
                                         group by case when paycode='Cash' then paycode else 'Check' end
			
	update r set
			r.ckoth = cast(dbo.readstring('@check=',@paidBlob) as money),
			r.cash = cast(dbo.readstring('@cash=',@paidBlob) as money),
			r.checkno = case when cast(dbo.readstring('@check=',@paidBlob) as money)>0 then dbo.readstring('@checkno=',@paidBlob) else '' end,
                        r.grandtotal = cast(dbo.readstring('@check=',@paidBlob) as money)+cast(dbo.readstring('@cash=',@paidBlob) as money),
                        r.change = cast(dbo.readstring('@change=',@paidBlob) as money)
		from @rt r, paid p where 'o'+r.recId = p.slink 

--set record Count
   
   declare @recCount int
   
     select @recCount = count(recid) from @rt
      
     update @rt set recCount = @recCount			

 return					
end