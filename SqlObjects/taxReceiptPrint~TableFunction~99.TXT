create function [dbo].[taxReceiptPrint](@recId varchar(50)) returns   
          @rt table(
			recId varchar(50),
			InvoiceId int,
			taxRollid int,
			typ varchar(10),
			parcel varchar(50),
			item varchar(50),
			taxyear varchar(50),
			receiptNo varchar(20),
			receiptDate varchar(20),
			schoolDistrict varchar(50),
			legal varchar(max),
			acres varchar(10),
			blk varchar(10),
			sec varchar(10),
			twp varchar(10),
			rng varchar(10),
			recOf varchar(max),
			paidBy varchar(100),
			TaxAmt money,
			TaxDue money,
			TaxPaid money,
			TotPaid money,
			Penalty  money,
			mail  money,
			lien  money,
			adv  money,
			mowing  money,
			other  money,
			ckoth  money,
			cash  money,
			change  money,
			blob varchar(max),
                        deputy varchar(50),
                        invoiceLink int,
                        checkno varchar(50),
                        grandTotal money                 )
begin		
	insert @rt (recId,invoiceId)
					select  @recId, right(slink,LEN(slink)-1) from dbo.receiptSLinks(@recId) where LEFT(slink,1)='t'
					
    update r set
                  r.taxRollid = i.TAXROLLID,
                  r.typ = i.typ,
                  r.parcel = i.parcel,
                  r.item = i.ITEM,
                  r.taxYear = i.taxyear,
                  r.paidBy = i.NAME,
                  r.invoiceLink = i.invoiceId
                from invoices i, @rt r where r.InvoiceId = i.ID
                  
					
	delete from @rt where typ in ('P','F') and invoiceLink > 0
	
	update @rt set receiptDate = Key2, paidBy = case when a1>'  0' then a1 else paidBy end, deputy = a18, grandTotal = cast(c9 as money)  from Object where ID = @recid

        update r set receiptNo = a.receiptNumber from receiptlink a,@rt r where r.invoiceId = a.invoiceId and r.recId = a.receiptId and r.recId = @recId

	update r set 
				r.schoolDistrict = a.SCHOOLDISTRICTMAIN,
				r.legal = cast(a.LEGALDESCRIPTION as varchar(max))+CHAR(13)+CHAR(10)+A.SCHOOLDISTRICTMAIN,
				r.acres = a.ACRES,			
				r.blk = a.TOWNSHIPBLOCK,
				r.sec = a. SECTIONNUMBER,
				r.twp = '',
				r.rng = a.RANGELOT,
				r.blob = dbo.getTaxInvoiceBlob(r.invoiceId)			
			from @rt r, AdTax a where r.taxRollid = a.ID


				
	update @rt set
			recOf = dbo.readstring('@NAME=',blob)+CHAR(13)+CHAR(10)+dbo.parseAddress(blob),
			TaxAmt = cast(dbo.readstring('INVOICEAMT=',blob) as money),
			TaxDue =  cast(dbo.readstring('INVOICEAMT=',blob) as money),
			TaxPaid =  cast(dbo.readstring('INVOICEAMT=',blob) as money),
			TotPaid = 0,
			Penalty = cast(dbo.readstring('PENALTY=',blob) as money),
			mail = 0,
			lien = 0,
			adv = 0,
			mowing = 0,
			other = cast(dbo.readstring('FEE=',blob) as money)						
			
	update @rt set
			TotPaid = TaxDue + Penalty + mail + lien + adv + mowing + other

--Update Paid

	declare @paidBlob varchar(max) 
			select @paidBlob = isnull(@paidBlob,'') + '@'+paycode+'='+cast(SUM(amount) as varchar)+';@'+paycode+'NO='+checkno+';'
		from paid where slink = 'o'+@recid group by paycode,checkno
			
	update r set
			r.ckoth = cast(dbo.readstring('@check=',@paidBlob) as money),
			r.cash = cast(dbo.readstring('@cash=',@paidBlob) as money),
			r.change =  cast(dbo.readstring('@coin=',@paidBlob) as money),
                        r.checkno = dbo.readstring('@checkno=',@paidBlob)
		from @rt r, paid p where 'o'+r.recId = p.slink 
							
 return					
end