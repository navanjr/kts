create procedure dbo.apportionCollections(
 @accountId int
) as
begin

 declare
  @accountDesc varchar(50),
  @resultCode int,
  @resultMessage varchar(50),
  @newId int,
  @slink varchar(15),
  @accountType int,
  @jeType varchar(50)

 select @accountType = typ from object where id = @accountId 

 if @accountType = 4701 
  select @accountDesc = accountDesc from dbo.glAccounts where accountId = @accountId

 if @accountType = 4502
  select top 1 @accountDesc = a.accountDesc from dbo.glAccounts a, gldetail b where a.accountId = b.contraId and b.contraId > 0
    and b.slink in (select slink from dbo.receiptSLinks(@accountId))
    and ISNULL(b.bsId,0) = 0

 
-- create new JE
  set @jeType = 'APPORTIONMENT'+case when @accountType=4502 then ' SPECIAL' else '' end  
 exec dbo.journalEntryCRUD
  @mode = 0,
  @description = @accountDesc,
  @jeType = @jeType,
  @resultCode = @resultCode output,
  @resultMessage = @resultMessage output,
  @newId = @newId output

 select @slink = 'o' + cast(@newId as varchar)

-- create stage 
 insert glDetailStage ( accountId, accountCode, accountDesc, amount, slink, comment, comment2, sourceCode)
 select accountId, accountCode, accountDesc, amount, @slink, comment, comment2, sourceCode
  from dbo.apportionCollectionsBRW( @accountId )

-- post to the gl
 exec dbo.glPost @newId, 'o'
 exec dbo.journalEntryUpdate @newId
 

-- link origional apportion postngs to this JE
 if @accountType = 4701
 begin
  update glDetail set bsId = @newId
  where 
    contraId = @accountId
    and ISNULL(bsId,0) = 0
 end

 if @accountType = 4502
 begin
  update glDetail set bsId = @newId
  where 
    contraId > 0
    and slink in (select slink from dbo.receiptSLinks(@accountId))
    and ISNULL(bsId,0) = 0
 end
 
 
 return
end


