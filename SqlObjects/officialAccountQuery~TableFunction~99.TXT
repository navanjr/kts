create function dbo.officialAccountQuery(@beginDate varchar(50),@endDate varchar(50))
returns @rt table(id int, 
OfficerName varchar(50), 
OfficerTitle varchar(50), 
Department varchar(50),
AccountCode varchar(60),
BeginBalance money,
CancelVoid money,
Journals money,
Deposits money,
Vouchers money,
EndBalance money,
bankAccountCode varchar(50),
electronicAmount money,
otherAmount money
)
as 
begin

declare @wt table(AccountCode varchar(60),
                  BeginBalance money,
                  CancelVoid money,
                  Journals money,
                  Deposits money,
                  Vouchers money,
                  EndBalance money,
                  electronicAmount money,
                  otherAmount money)

declare @wt2 table(AccountCode varchar(60),
                  BeginBalance money,
                  CancelVoid money,
                  Journals money,
                  Deposits money,
                  Vouchers money,
                  EndBalance money,
                  electronicAmount money,
                  otherAmount money)


insert @wt (accountcode,BeginBalance)
 select accountcode,sum(amount*-1) 
 from dbo.glDetailReports 
 where sourceDate<@beginDate
  and accounttype = 'OFFICIAL'
 group by accountcode

insert @wt (accountcode,CancelVoid)
 select accountcode,sum(amount*-1) 
 from dbo.glDetailReports 
 where 
  sourceType='4771'
   and sourceDate>=@beginDate 
   and sourceDate<=@endDate
   and accounttype = 'OFFICIAL'
   and amount < 0.00
   and left(sourcea18,4)<>'Void'
 group by accountcode

insert @wt (accountcode,Vouchers)
 select accountcode,sum(amount) 
 from dbo.glDetailReports 
 where 
  sourceType='4771'
   and sourceDate>=@beginDate 
   and sourceDate<=@endDate
   and accounttype = 'OFFICIAL'
   and amount < 0.00
   and left(sourcea18,4)='Void'
 group by accountcode


insert @wt (accountcode,Journals)
 select accountcode,sum(amount*-1) 
 from dbo.glDetailReports 
 where 
  sourceType in ('4512')
   and sourceDate>=@beginDate 
   and sourceDate<=@endDate
   and accounttype = 'OFFICIAL'
 group by accountcode

insert @wt (accountcode,Deposits,electronicAmount,otherAmount)
 select accountcode,sum(amount*-1),
   case when isnull(comment,'') in (select key1 from object where typ=4505 and a2 in ('E','C','B')) then sum(amount*-1) else 0 end as electronicAmount,
   case when isnull(comment,'') not in (select key1 from object where typ=4505 and a2 in ('E','C','B')) then sum(amount*-1) else 0 end as otherAmount 
 from dbo.glDetailReports 
 where 
  sourceType not in ('4771','4512')
   and sourceDate>=@beginDate 
   and sourceDate<=@endDate
   and accounttype = 'OFFICIAL'
 group by accountcode,isnull(comment,'')

insert @wt (accountcode,Vouchers)
 select accountcode,sum(amount) 
 from dbo.glDetailReports 
 where 
  sourceType='4771'
   and sourceDate>=@beginDate 
   and sourceDate<=@endDate
   and accounttype = 'OFFICIAL'
   and amount > 0
 group by accountcode

insert @wt (accountcode,EndBalance)
 select accountcode,sum(amount*-1) 
 from dbo.glDetailReports 
 where sourceDate<=@endDate
  and accounttype = 'OFFICIAL'
 group by accountcode

insert @wt2 
 select accountcode,
            sum(isnull(BeginBalance,0)),
            sum(isnull(CancelVoid,0)),
            sum(isnull(Journals,0)),
            sum(isnull(Deposits,0)),
            sum(isnull(Vouchers,0)),
            sum(isnull(EndBalance,0)),
            sum(isnull(electronicAmount,0)),
            sum(isnull(otherAmount,0))
            from @wt
            group by accountcode

insert @rt
 select id,key2,key1,a1,
 AccountCode,
 BeginBalance,
 CancelVoid,
 Journals,
 Deposits,
 Vouchers,
 EndBalance,
 a4,
 electronicAmount,
 otherAmount
 from object o, @wt2 w where o.typ=4601 and o.a3=w.accountcode
 
 union 
 select id,key2,key1,a1,
 a3 AccountCode,
 0.00 BeginBalance,
 0.00 CancelVoid,
 0.00 Journals,
 0.00 Deposits,
 0.00 Vouchers,
 0.00 EndBalance,
 a4,
 0.00 electronicAmount,
 0.00 otherAmount
 from object
 where typ=4601 and a3 >' 0' and a3 not in (select accountcode from @wt2)
 return
 end