create function dbo.warrantExport(
 @begindate varchar(20),
 @enddate varchar(20)
)returns @rt table(
 slink varchar(20),
 accountCode varchar(60),
 fiscalYear varchar(20),
 fund varchar(50),
 warNo varchar(50),
 payDate varchar(50),
 amount money,
 interest money,
 payNo varchar(50),
 payee varchar(50),
 issueDate varchar(50),
 comments varchar(max)
) as 
begin

 declare @warrantsHitLedgerWhenRegistered varchar(5)

 select @warrantsHitLedgerWhenRegistered = settingvalue from dbo.settings where settingname='site.warrantsHitLedgerWhenRegistered'

 if @warrantsHitLedgerWhenRegistered = 'TRUE'
  begin
  insert @rt
   select 
    slink,
    accountcode,
    '',
    '',
    sourcekey3,
    dbo.date112(dateCleared),
    amount*-1 as amount,
    0.00,
    sourceKey1,
    sourcea2,
    dbo.date112(date),
    ''
   from dbo.gldetailreports 
   where sourcetype='4771' 
     and sourcea18='Warrant' 
     and accounttype = 'BANK'
     and dateCleared >= @beginDate
     and dateCleared <= @enddate

  update r set fund = c.key2
  from @rt r, object w, object c
   where left(r.slink,1)='o'
     and dbo.slinkid(r.slink)=w.id
     and w.typ = 4771
     and c.typ = 4704
     and c.a2=w.a4


  end
 else
 begin
  insert @rt
   select 
    slink,
    accountCode,
    '',
    '',
    foreignNumber,
    dbo.date112(contraPostDate),
    naturalAmount,
    0.00,
    contraControlNumber,
    payee,
    dbo.date112(foreignDate),
    comments
   from dbo.paymentreports('Warrant',@enddate,'TRUE')
   where contraPostDate >= @beginDate
     and contraPostDate <= @enddate
     and paymentType='warrant'
     and contraPaymentType not in ('Cancel Warrant','Void Warrant')

  update r set fund = c.key2
  from @rt r, glaccounts a, object c
   where r.accountCode=a.accountCode
     and c.typ = 4704
     and c.a2=a.targetaccountCode

 end 

  update r set fiscalYear = dbo.stripChars(o.c10,'10,13') 
   from @rt r, object o 
    where dbo.slinkId(r.slink)=o.id

  update @rt set 
   fiscalYear = cast(cast(fiscalYear as int) + 1999 as varchar)
    + '-' + cast(cast(fiscalYear as int) + 2000 as varchar)
   where len(fiscalYear) = 2

 return
end
