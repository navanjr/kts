create procedure dbo.apiSite (
 @method varchar(10) = 'GET',
 @postData varchar(max) = ''
) as
begin
 set nocount on

 exec dbo.logit @@procid, '@method', @method

 declare
   @wt JSONHierarchy,
   @dump nvarchar(max),
   @dumpOut nvarchar(max),
   @apiKey varchar(50),
   @apiCode varchar(50),
   @apiUrl varchar(50),
   @filter varchar(500),
   @resource varchar(250),
   @applyGraceOnlyInJanuary varchar(5)

 select @applyGraceOnlyInJanuary = dbo.settingsf('site.applyGraceOnlyInJanuary','FALSE')

 select @resource = dbo.readKeyCode(40,'@apiResource=')
 exec dbo.logit @@procid, '@resource', @resource

 declare @fields table (
  name varchar(50),
  objectName varchar(10)
 )
 insert @fields select 'name','key1'
 insert @fields select 'tax_method','a19'
 insert @fields select 'tax_grace','a20'
 insert @fields select 'tax_rate','b1'

 select
  @apiKey = apiKey,
  @apiCode = apiSiteCode,
  @filter = 'code=' + apiSiteCode,
  @apiUrl = apiUrl
 from dbo.site

 if @method = 'GET'
 begin

  exec dbo.api
   @apiKey = @apiKey,
   @apiHost = @apiURL,
   @method = @method,
   @resource = @resource,
   @filter = @filter,
   @dump = @dump output
 
  exec dbo.logit @@procid, '@dump', @dump

  insert into @wt
  select * from dbo.parseJSON(@dump)

  declare @blob varchar(max) = '{'

  select @blob = @blob + b.name + ':' + a.stringValue + ','
  from @wt a, @fields b
  where a.name = b.name

  select left(@blob,len(@blob) - 1) + '}'

  return
 end

 if @method = 'POST'
 begin
  if @postData < '  0' 
   select top 1
    @postData = '"code=' + @apiCode + '&'
     + 'name=' + key1 + '&'
     + 'tax_method=' + a19 + '&'
     + 'tax_grace=' + case when isnumeric(right(a20,1))=0 then left(a20,len(a20)-1) else a20 end + '&'
     + 'tax_rate=' + b1 + '&'
     + 'january_only_grace=' + case when @applyGraceOnlyInJanuary = 'TRUE' then '1' else '0' end + '&'
     + 'tax_year_searchable=' + dbo.settingsf('site.tax_year_searchable','2014') + '&'
     + 'tax_year_payable=' + dbo.settingsf('site.tax_year_payable','2014')
     + '"'
    from object with (NOLOCK) where typ = 40 order by id

  exec dbo.api
   @apiKey = @apiKey,
   @apiHost = @apiUrl,
   @method = @method,
   @resource = @resource,
   @filter = @postData,
   @dump = @dump output

  exec dbo.logit @@procid, '@dump', @dump
  
  if @dump is not null
  begin
   insert into @wt
   select * from dbo.parseJSON(@dump)

   if (select stringValue from @wt where name = 'code') = @apiCode
    select '@code=0;@message=OK;'
   else
    select '@code=1;@message=Attempt to update the API failed.  Contact Support.;'
  end
 end

end