create procedure dbo.invoiceCRUD(
 @mode int,
 @invoiceId int = null,
 @postCheckOverride int = 1,
 @taxyear varchar(10) = null,
 @origin varchar(50) = null,
 @noGLDetailIssue varchar(5) = 'FALSE' ,
 @ids ids readonly
) as
/*
 remember
  C = 0
  R = 1
  U = 2
  D = 3
*/
begin

 set nocount on

 exec dbo.logit @@procid, '@invoiceId', @invoiceId, '@taxyear', @taxyear

 declare @tokenId int, @tally int
 declare @wt table(invoiceid int)


-- delete all invoices that were passed in the ids datatype
 if @mode = 3 and @invoiceId is null and exists(select * from @ids)
 begin

  insert @wt select id from @ids

  select @tally = count(*) from @wt
  exec dbo.logit @@procid, 'deleting from ids... @tally', @tally

  while exists(select * from @wt)
  begin
   exec dbo.logit @@procid, 'Countdown... @tally', @tally

   select top 1 @tokenId = invoiceId from @wt 
   exec dbo.invoiceCRUD @mode=3, @invoiceId = @tokenId, @postCheckOverride = 0
   delete @wt where invoiceId = @tokenId
 
   set @tally = @tally - 1

  end
  return
 end


-- delete all invoices in a tax year or just the ones with the no gl issue
 if @mode = 3 and isnull(@taxyear,'') > '  0' and @origin is null
 begin

  if @noGLDetailIssue = 'FALSE'
   insert @wt select id from invoices where taxyear = @taxyear
  else
   insert @wt select id from invoices where taxyear = @taxyear and 't' + cast(id as varchar) not in (select slink from gldetail)

  select @tally = count(*) from @wt

  while exists(select * from @wt)
  begin
   exec dbo.logit @@procid, 'Countdown... @tally', @tally

   select top 1 @tokenId = invoiceId from @wt 
   exec dbo.invoiceCRUD @mode=3, @invoiceId = @tokenId, @postCheckOverride = 0
   delete @wt where invoiceId = @tokenId
 
   set @tally = @tally - 1

  end
  return
 end

-- delete all invoices in a tax year with specific origin
 if @mode = 3 and isnull(@taxyear,'') > '  0' and isnull(@origin,'') > '  0'
 begin

  insert @wt select id from invoices where taxyear = @taxyear and origin = @origin

  select @tally = count(*) from @wt

  while exists(select * from @wt)
  begin
   exec dbo.logit @@procid, 'Countdown... @tally', @tally

   select top 1 @tokenId = invoiceId from @wt 
   exec dbo.invoiceCRUD @mode=3, @invoiceId = @tokenId, @postCheckOverride = 0
   delete @wt where invoiceId = @tokenId
 
   set @tally = @tally - 1

  end
  return
 end


 
 declare 
  @slink varchar(15) = 't' + cast(@invoiceId as varchar),
  @fpId int 
 
 exec dbo.glGetPostDateFromSlink @slink, @fpId = @fpId output

-- Delete
 if @mode = 3
 begin
  -- bail if period is closed
  if isnull(@fpId,0) < 1
   return

  -- bail if posted unless postCheckOverride = 0
  if @postCheckOverride = 1 and dbo.isPosted(@slink) = 'TRUE'
  begin
   exec dbo.logit @@procid, 'invoice is posted can not delete... unless you override'
   return
  end

  -- delete invoice, stage and gl
  if isnull(@invoiceId,0) > 0
  begin
   begin transaction
   delete glDetailStage where slink = @slink
   delete glDetail where slink = @slink
   delete invoices where id = @invoiceId
   commit transaction
   return
  end
  
  return
 end

end