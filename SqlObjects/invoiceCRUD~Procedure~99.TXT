create procedure dbo.invoiceCRUD( @mode int, @invoiceId int = null, @postCheckOverride int = 1, @taxyear varchar(10) = null ) as
/*
 remember
  C = 0
  R = 1
  U = 2
  D = 3
*/
begin


-- delete all invoices in a tax year
 if @mode = 3 and isnull(@taxyear,'') > '  0'
 begin
  declare @tokenId int
  declare @wt table(invoiceid int)
  insert @wt select id from invoices where taxyear = @taxyear
  while exists(select * from @wt)
  begin

   select top 1 @tokenId = invoiceId from @wt 
   exec dbo.invoiceCRUD @mode=3, @invoiceId = @tokenId, @postCheckOverride = 0
   delete @wt where invoiceId = @tokenId

  end
  return
 end



 
 declare 
  @slink varchar(15) = 't' + cast(@invoiceId as varchar),
  @fpId int 
 
 exec dbo.glGetPostDateFromSlink @slink, @fpId = @fpId output

-- Delete
 if @mode = 3
 begin
  -- bail if period is closed
  if isnull(@fpId,0) < 1
   return

  -- bail if posted unless postCheckOverride = 0
  if @postCheckOverride = 1 and dbo.isPosted(@slink) = 'TRUE'
    return
  
  -- delete invoice, stage and gl
  if isnull(@invoiceId,0) > 0
  begin
   begin transaction
   delete glDetailStage where slink = @slink
   delete glDetail where slink = @slink
   delete invoices where id = @invoiceId
   commit transaction
   return
  end
  
  return
 end

end