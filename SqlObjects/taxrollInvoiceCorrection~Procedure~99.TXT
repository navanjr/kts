create procedure dbo.taxrollInvoiceCorrection(@taxrollId int, @payments money)
as begin
  declare @slink varchar(16),
    @newInvoiceId int

 exec dbo.createAdtaxMillageSources
 exec dbo.createAdtaxMillageReceivables
 exec dbo.createAdtaxCollectionReceivables

  begin transaction
-- create a brand new invoice
   exec dbo.taxCorrectionReferenceCRUD @taxrollId, @newInvoiceId = @newInvoiceId output

   exec dbo.taxrollInvoiceCRUD @taxrollId, 1, '', @invoiceId=@newInvoiceId, @priorPayments=@payments, @correctionInvoice = 'TRUE'
   exec dbo.taxRollAddressInsert @taxrollId, ''
  
  select @slink = slink from dbo.taxrollCheck(@taxrollId,'',@newInvoiceId)

-- relocate any receipts to the newly created invoice
  if exists(select * from receiptlink where invoiceId in (select id from invoices where taxrollId=@taxrollId))
  begin
   update receiptlink set invoiceId=@newInvoiceId where invoiceId in (select id from invoices where taxrollId=@taxrollId)
  end

-- relocate any journals to the newly created invoice
  if exists(select * from journallink where invoiceId in (select id from invoices where taxrollId=@taxrollId))
  begin
   update journallink set invoiceId=@newInvoiceId where invoiceId in (select id from invoices where taxrollId=@taxrollId)
  end
 

-- now lets check to see if we are all good
  if dbo.glPostCheck(@slink) = 0
   begin
    commit transaction
    select '@code=0;@message=OK;@newId='+cast(@newInvoiceId as varchar)+';'
   end
  else
   begin 
    if not exists (select * from invoices where id = @newInvoiceId and invoiceDue=0)
      select '@code=1;@message=Assessment failed to process correctly, Contact Support. (as.inv);'
    rollback transaction
  
   end
end