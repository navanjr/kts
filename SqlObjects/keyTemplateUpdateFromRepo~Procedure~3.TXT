create procedure dbo.keyTemplateUpdateFromRepo(
 @id int,
 @debugMode varchar(5) = 'FALSE'
) as
begin
 set nocount on

 exec dbo.logit @@procid, 'Started... @id', @id

 declare
  @txt nvarchar(max),
  @path varchar(1000),
  @fullPath varchar(1000),
  @objectId int,
  @sql nvarchar(max),
  @params nvarchar(max),
  @data varchar(max),
  @logBlob varchar(max),
  @idToken int,
  @updateTally int,
  @ImportTally int,
  @deleteTally int,
  @totalRepoFiles int

 declare @wt table(
  id int,
  template varchar(60),
  fullPath varchar(1000),
  data varchar(max),
  processFlag int,
  errors varchar(50)
 )
 
 select @path = dbo.settingsF('git.gitpath','')
 
 if isnull(@id,0) = 0
  insert @wt
  select
   0,
   objectName,
   objectPath,
   '',0,''
  from dbo.dir(@path + '\templates')
  where isnull(objectType,'') > '  0'
 else
  insert @wt
  select
   0,
   objectName,
   objectPath,
   '',0,''
  from dbo.dir(@path + '\templates')
  where objectName = '~' + cast(@id as varchar) + '.txt'

  update @wt set template = replace(replace(replace(reverse(left(reverse(fullpath),charindex('\',reverse(fullpath)))),'\',''),'T_',''),'.TXT','')
  update @wt set id = case when isnumeric(dbo.splitF(template,'~',2)) = 1 then dbo.splitF(template,'~',2) else dbo.splitF(template,'~',1) end
  update @wt set template = (select data from dbo.split(template,'~') where id = 1)

 while exists(select * from @wt where processFlag = 0)
 begin
  select top 1 @idToken = id, @fullPath = fullPath from @wt where processFlag = 0
  exec dbo.spReadTextFile @fullPath, @fileContents = @data out
  update @wt set processflag = 1, data = @data where id = @idToken 
 end
 
-- bail if we dont have anything to import
 if not exists(select * from @wt where id > 0 and isnull(data,'') > '  0' and isnull(template,'') > '  0')
 begin
  exec dbo.logit @@procid, 'not ready to read from Repo...'
  select '@code=1;@message=Nothing to import;'
  return
 end

 update @wt set errors = 'dups' where id in (select id from @wt group by id having count(*) > 1)

 select @totalRepoFiles = count(*) from @wt
 select @updateTally = count(a.id) from template a, @wt b where a.id = b.id


 if not @debugMode = 'TRUE'
 begin
  select @logBlob = 'updating ' + cast(@updateTally as varchar) + ' of ' + cast(@totalRepoFiles as varchar) + ' Templates from Repo...'
  exec dbo.logit @@procid, @logBlob

-- turn off the trigger on template
  alter table template disable trigger keyTemplateWriteToRepoTR

-- update existing Templates
  update a set
   a.template = b.template,
   a.options = b.data,
   a.security = 'Key',
   a.securityLevel = 1,
   a.lastEdit = dbo.clarionKeyLastEditDateTime(getdate())
  from template a, @wt b
  where a.id = b.id and b.errors < '  0'

-- add the Templates we dont have
  select @importTally = count(*) from @wt where id not in (select id from template)
  select @logBlob = 'importing ' + cast(@importTally as varchar) + ' of ' + cast(@totalRepoFiles as varchar) + ' Templates from Repo...'
  exec dbo.logit @@procid, @logBlob
  insert template (id, template, options, security, securityLevel,lastEdit)
  select id, template, data, 'Key', 1, dbo.clarionKeyLastEditDateTime(getdate()) from @wt where id not in (select id from template) 

-- delete the templates that are not in the repo
  select @deleteTally = count(*) from template where id not in (select id from @wt)
  select @logBlob = 'deleting ' + cast(@deleteTally as varchar) +' Templates...'
  exec dbo.logit @@procid, @logBlob
  delete template where id not in (select id from @wt)

-- turn the trigger back on
  alter table template enable trigger keyTemplateWriteToRepoTR

  select '@code=0;@message=Just updated/imported ' + cast(@updateTally as varchar) + ' + ' + cast(@importTally as varchar) + ' = ' + cast(@updateTally + @importTally as varchar) + ' of ' + cast(@totalRepoFiles as varchar) + ' Templates from the repo;'

 end

 if @debugMode = 'TRUE'
 begin
  select * from @wt 
  order by id 
 end

end