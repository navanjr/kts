create proc dbo.taxStatementQueueGrab (
 @taxYear varchar(50),
 @ini varchar(10),
 @count int,
 @mortCode varchar(50)
) as

begin
 exec dbo.logit @@procid, '@taxyear', @taxyear, '@ini', @ini, '@count', @count, '@mortCode', @mortcode

 declare @batchName varchar(50) 
 if exists(select * from invoices where dbo.splitF(queue,'.',1) = @ini)
  select
   @batchName = @ini + '.' + right('000' +cast(cast(max(dbo.splitF(queue,'.',2)) as int) + 1 as varchar),3)
  from invoices where dbo.splitF(queue,'.',1) = @ini
 else
  set @batchName = @ini + '.001'

 declare @sql nvarchar(max)

 if @mortCode = 'Grouped'
 begin

  update invoices set queue = @batchName where taxrollid in 
   (select top( @count ) i.taxrollid 
    from invoices i, adtax x 
    where i.taxrollid = x.id
     and x.mortgageCode in (select cast(key1 as int) from object where typ = 4030 and c1 != '1')
     and i.taxyear = @taxyear
     and i.printed = ''
     and i.queue = ''
     and i.invoiceId = 0
     and i.invoiceDue != 0
    order by i.name + cast(i.item as varchar))

  return
 end

 if @mortCode > '  0'
 begin
   update invoices set queue = @batchName where taxrollid in 
    (select top( @count ) i.taxrollid 
     from invoices i, adtax x 
     where i.taxrollid = x.id
      and cast(x.mortgageCode as varchar) = cast(@mortCode as varchar)  
      and i.taxyear = @taxyear
      and i.printed = ''
      and i.queue = ''
      and i.invoiceId = 0
      and i.invoiceDue != 0
     order by i.name + cast(i.item as varchar))
  return
 end

  update invoices set queue = @batchName where taxrollid in 
   (select top( @count ) i.taxrollid 
    from invoices i, adtax x 
    where i.taxrollid = x.id
     and case when x.treamort > '  0' then x.treamort else cast(x.mortgageCode as varchar) end <= '0'
     and i.taxyear = @taxyear
     and i.printed = ''
     and i.queue = ''
     and i.invoiceId = 0
     and i.typ not in ('O')
     and i.invoiceDue != 0
    order by i.name + cast(i.item as varchar))

end